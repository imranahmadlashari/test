<section class="grants-listing-section" data-section-id="grants-main-listing">
  <style>
    .grants-listing-section {
      max-width: 98%; /* Increased from var(--grantaura-max-width) to take more width */
      margin: 0 auto;
      padding: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
      background-color: var(--grantaura-gray-50);
      position: relative;
    }
    
    @media (min-width: 640px) {
      .grants-listing-section {
        padding: 1rem;
      }
    }
    
    @media (min-width: 768px) {
      .grants-listing-section {
        padding: 1.5rem;
        max-width: 96%; /* Further adjusted for medium screens */
      }
    }
    
    @media (min-width: 1280px) {
      .grants-listing-section {
        max-width: 95%; /* Adjusted for large screens */
      }
    }
    
    @media (min-width: 1600px) {
      .grants-listing-section {
        max-width: 90%; /* For very large screens, allow some margin but use more space */
      }
    }
  </style>
  
  <!-- Progressive Filter System -->
  <div class="grants-filter-container">
    <style>
      .grants-filter-container {
        width: 100%;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 100;
      }
      
      /* Primary Filter Button */
      .grants-filter-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
        color: white !important;
        border: none;
        padding: 0.75rem 1.25rem;
        border-radius: var(--grantaura-border-radius);
        font-weight: 600;
        font-size: clamp(0.85rem, 3vw, 0.95rem);
        cursor: pointer;
        transition: var(--grantaura-transition);
        box-shadow: var(--grantaura-box-shadow);
        position: relative;
        overflow: hidden;
      }
      
      .grants-filter-button:hover {
        box-shadow: var(--grantaura-box-shadow-lg);
        transform: translateY(-2px);
      }
      
      .grants-filter-button::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
      
      .grants-filter-button:hover::after {
        opacity: 1;
      }
      
      .grants-filter-button.active {
        background: var(--grantaura-secondary);
      }
      
      .grants-filter-button .filter-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--grantaura-secondary-light);
        color: var(--grantaura-primary-dark);
        font-size: 0.7rem;
        font-weight: 700;
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        margin-left: 0.25rem;
        transform: scale(0);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      
      .grants-filter-button .filter-count.active {
        transform: scale(1);
      }

      /* Filter Panel - Progressive Design */
      .grants-filter-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 200;
        display: none;
        flex-direction: column;
        overflow: hidden;
      }
      
      .grants-filter-panel.active {
        display: flex;
      }
      
      .grants-filter-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--grantaura-gray-200);
        background: linear-gradient(to right, var(--grantaura-gray-50), white);
        position: sticky;
        top: 0;
        z-index: 5;
      }
      
      .grants-filter-panel-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .grants-filter-panel-title svg {
        width: 18px;
        height: 18px;
        color: var(--grantaura-primary);
      }
      
      .grants-filter-close {
        background: transparent;
        border: none;
        color: var(--grantaura-gray-700);
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-close:hover {
        background-color: var(--grantaura-gray-200);
        color: var(--grantaura-primary);
      }
      
      /* Progress indicator */
      .grants-filter-progress {
        display: flex;
        padding: 0.75rem 1rem;
        overflow-x: auto;
        background-color: var(--grantaura-gray-50);
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
        position: relative;
      }
      
      .grants-filter-progress::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }
      
      .grants-filter-progress::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--grantaura-gray-200);
        z-index: 1;
      }
      
      .grants-filter-progress-steps {
        display: flex;
        gap: 0.5rem;
        position: relative;
        z-index: 2;
      }
      
      .grants-filter-step {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 0.85rem;
        border-radius: var(--grantaura-border-radius);
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
        position: relative;
        cursor: pointer;
        color: var(--grantaura-gray-600);
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-step::after {
        content: "";
        position: absolute;
        bottom: -0.75rem;
        left: 0;
        right: 0;
        height: 3px;
        background: transparent;
        border-radius: 3px 3px 0 0;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-step svg {
        width: 16px;
        height: 16px;
      }
      
      .grants-filter-step.active {
        color: var(--grantaura-primary);
        font-weight: 600;
      }
      
      .grants-filter-step.active::after {
        background: var(--grantaura-primary);
      }
      
      .grants-filter-step.completed {
        color: var(--grantaura-success);
      }
      
      .grants-filter-step.completed::after {
        background: var(--grantaura-success);
      }
      
      .grants-filter-step-separator {
        display: flex;
        align-items: center;
        color: var(--grantaura-gray-400);
        padding: 0 0.3rem;
      }
      
      /* Step content area */
      .grants-filter-step-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }
      
      .grants-filter-step-container {
        display: none;
        flex-direction: column;
        gap: 1.25rem;
      }
      
      .grants-filter-step-container.active {
        display: flex;
      }
      
      .grants-filter-step-heading {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        margin: 0 0 0.5rem;
      }
      
      .grants-filter-step-description {
        font-size: 0.85rem;
        color: var(--grantaura-gray-600);
        margin: 0 0 1.25rem;
        line-height: 1.5;
      }
      
      /* Filter options styling */
      .grants-filter-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      /* Radio/Checkbox style options */
      .grants-filter-checkbox, 
      .grants-filter-radio {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: var(--grantaura-border-radius);
        transition: var(--grantaura-transition);
        border: 1px solid var(--grantaura-gray-200);
        background-color: white;
      }
      
      .grants-filter-checkbox:hover,
      .grants-filter-radio:hover {
        border-color: var(--grantaura-primary-light);
        background-color: rgba(90, 59, 140, 0.02);
      }
      
      .grants-filter-checkbox.selected,
      .grants-filter-radio.selected {
        border-color: var(--grantaura-primary);
        background-color: rgba(90, 59, 140, 0.05);
      }
      
      .grants-filter-checkbox input[type="checkbox"],
      .grants-filter-radio input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid var(--grantaura-gray-400);
        outline: none;
        cursor: pointer;
        position: relative;
        transition: var(--grantaura-transition);
        background-color: white;
        flex-shrink: 0;
        margin-top: 0.25rem;
      }
      
      .grants-filter-checkbox input[type="checkbox"] {
        border-radius: 4px;
      }
      
      .grants-filter-radio input[type="radio"] {
        border-radius: 50%;
      }
      
      .grants-filter-checkbox input[type="checkbox"]:checked,
      .grants-filter-radio input[type="radio"]:checked {
        background-color: var(--grantaura-primary);
        border-color: var(--grantaura-primary);
      }
      
      .grants-filter-checkbox input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 5px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }
      
      .grants-filter-radio input[type="radio"]:checked::after {
        content: "";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: white;
      }
      
      .grants-filter-option-content {
        flex: 1;
      }
      
      .grants-filter-option-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--grantaura-gray-800);
        margin-bottom: 0.25rem;
      }
      
      .grants-filter-option-description {
        font-size: 0.8rem;
        color: var(--grantaura-gray-600);
        line-height: 1.5;
      }
      
      .grants-filter-option-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        background-color: var(--grantaura-gray-100);
        color: var(--grantaura-gray-600);
        padding: 0.2rem 0.4rem;
        border-radius: 12px;
        margin-left: 0.5rem;
      }
      
      /* Range filter */
      .grants-filter-range-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid var(--grantaura-gray-200);
        border-radius: var(--grantaura-border-radius);
        background-color: white;
      }
      
      .grants-filter-range-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--grantaura-gray-800);
        margin: 0 0 0.5rem;
      }
      
      .grants-filter-range-inputs {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      
      .grants-filter-range-group {
        flex: 1;
      }
      
      .grants-filter-range-label {
        display: block;
        font-size: 0.8rem;
        color: var(--grantaura-gray-600);
        margin-bottom: 0.35rem;
      }
      
      .grants-filter-range-inputs input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border: 1px solid var(--grantaura-gray-300);
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.9rem;
        outline: none;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-range-inputs input:focus {
        border-color: var(--grantaura-primary);
        box-shadow: 0 0 0 2px rgba(90, 59, 140, 0.1);
      }
      
      .grants-filter-range-inputs span {
        color: var(--grantaura-gray-500);
        font-size: 0.9rem;
      }
      
      /* Search options */
      .grants-filter-search {
        position: relative;
        margin-bottom: 1rem;
      }
      
      .grants-filter-search input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--grantaura-gray-300);
        border-radius: var(--grantaura-border-radius);
        font-size: 0.9rem;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-search input:focus {
        border-color: var(--grantaura-primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(90, 59, 140, 0.1);
      }
      
      .grants-filter-search svg {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: var(--grantaura-gray-400);
        pointer-events: none;
      }
      
      /* Filter chips for selected options */
      .grants-filter-selected {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      
      .grants-filter-chip {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        background-color: rgba(90, 59, 140, 0.08);
        border: 1px solid rgba(90, 59, 140, 0.15);
        border-radius: 20px;
        padding: 0.35rem 0.65rem 0.35rem 0.75rem;
        font-size: 0.75rem;
        color: var(--grantaura-primary-dark);
        font-weight: 500;
      }
      
      .grants-filter-chip-remove {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background-color: rgba(90, 59, 140, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 0.7rem;
        cursor: pointer;
        border: none;
        padding: 0;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-chip-remove:hover {
        background-color: var(--grantaura-primary);
      }
      
      .grants-filter-no-results {
        padding: 1.5rem;
        text-align: center;
        color: var(--grantaura-gray-600);
        font-size: 0.9rem;
        background-color: var(--grantaura-gray-50);
        border-radius: var(--grantaura-border-radius);
        margin-top: 1rem;
      }
      
      /* Filter Panel Footer */
      .grants-filter-panel-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--grantaura-gray-200);
        background-color: white;
        position: sticky;
        bottom: 0;
        z-index: 5;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
      
      .grants-filter-panel-actions {
        display: flex;
        gap: 0.75rem;
      }
      
      .grants-filter-secondary-btn {
        background: transparent;
        border: 1px solid var(--grantaura-gray-300);
        color: var(--grantaura-gray-700);
        padding: 0.65rem 1rem;
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-secondary-btn:hover {
        background-color: var(--grantaura-gray-100);
        color: var(--grantaura-gray-900);
      }
      
      .grants-filter-primary-btn {
        background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
        border: none;
        color: white;
        padding: 0.65rem 1.25rem;
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--grantaura-transition);
        position: relative;
        overflow: hidden;
      }
      
      .grants-filter-primary-btn:hover {
        box-shadow: 0 2px 8px rgba(90, 59, 140, 0.3);
      }
      
      .grants-filter-primary-btn::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
      
      .grants-filter-primary-btn:hover::after {
        opacity: 1;
      }
      
      .grants-filter-primary-btn:disabled,
      .grants-filter-secondary-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      
      .grants-filter-result-count {
        font-size: 0.85rem;
        color: var(--grantaura-gray-700);
      }
      
      .grants-filter-result-count strong {
        color: var(--grantaura-primary);
      }
      
      /* Active filters display */
      .grants-active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
        transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        max-height: 0;
        opacity: 0;
        margin: 0;
        overflow: hidden;
      }
      
      .grants-active-filters.active {
        max-height: 300px;
        opacity: 1;
        margin-top: 1rem;
        margin-bottom: 1rem;
      }
      
      .grants-active-filter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--grantaura-gray-100);
        border: 1px solid var(--grantaura-gray-200);
        padding: 0.25rem 0.75rem;
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.8rem;
        color: var(--grantaura-gray-800);
        transition: var(--grantaura-transition);
      }
      
      .grants-active-filter strong {
        color: var(--grantaura-primary);
        margin-right: 0.25rem;
      }
      
      .grants-active-filter-remove {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--grantaura-gray-300);
        border-radius: 50%;
        cursor: pointer;
        color: white;
        font-size: 0.7rem;
        transition: var(--grantaura-transition);
        border: none;
        padding: 0;
        margin-left: 0.25rem;
      }
      
      .grants-active-filter-remove:hover {
        background-color: var(--grantaura-danger);
      }
      
      .grants-active-filter:hover {
        background-color: var(--grantaura-gray-200);
      }
      
      /* Loading state */
      .grants-filter-loading {
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 50;
        backdrop-filter: blur(3px);
      }
      
      .grants-filter-loading.active {
        display: flex;
      }
      
      .grants-filter-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--grantaura-gray-200);
        border-top-color: var(--grantaura-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      /* Summary view in the last step */
      .grants-filter-summary {
        padding: 1rem;
        border: 1px solid var(--grantaura-gray-200);
        border-radius: var(--grantaura-border-radius);
        background-color: white;
      }
      
      .grants-filter-summary-section {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--grantaura-gray-100);
      }
      
      .grants-filter-summary-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      
      .grants-filter-summary-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        margin: 0 0 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
      }
      
      .grants-filter-summary-title svg {
        width: 16px;
        height: 16px;
        color: var(--grantaura-primary);
      }
      
      .grants-filter-summary-content {
        font-size: 0.85rem;
        color: var(--grantaura-gray-700);
      }
      
      .grants-filter-summary-empty {
        font-style: italic;
        color: var(--grantaura-gray-500);
      }
      
      .grants-filter-match-count {
        margin-top: 1.25rem;
        padding: 1rem;
        background-color: rgba(90, 59, 140, 0.05);
        border-radius: var(--grantaura-border-radius);
        text-align: center;
      }
      
      .grants-filter-match-count strong {
        font-size: 1.1rem;
        color: var(--grantaura-primary-dark);
        font-weight: 700;
      }
      
      .grants-filter-match-label {
        font-size: 0.85rem;
        color: var(--grantaura-gray-600);
        margin-top: 0.25rem;
      }
      
      /* Responsive adjustments */
      @media (min-width: 768px) {
        .grants-filter-step-content {
          padding: 1.5rem;
        }
        
        .grants-filter-options {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
        }
        
        .grants-filter-range-container {
          grid-column: 1 / -1;
        }
        
        .grants-filter-summary {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }
        
        .grants-filter-summary-section {
          margin-bottom: 0;
          padding-bottom: 0;
          border-bottom: none;
        }
        
        .grants-filter-match-count {
          grid-column: 1 / -1;
        }
      }
      
      @media (min-width: 1024px) {
        .grants-filter-options {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .grants-filter-summary {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      
      /* Animations */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      
      /* Reduce motion based on user preference */
      @media (prefers-reduced-motion: reduce) {
        .grants-filter-button,
        .grants-filter-panel,
        .grants-filter-checkbox input[type="checkbox"],
        .grants-filter-radio input[type="radio"],
        .grants-filter-loading-spinner {
          transition: none;
          animation: none;
        }
      }
    </style>
    
    <!-- Filter Button -->
    <button type="button" class="grants-filter-button" id="grants-filter-toggle" aria-label="Toggle grant filters">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
      Filter Grants
      <span class="filter-count" id="filter-count"></span>
    </button>
    
    <!-- Active Filters Display -->
    <div class="grants-active-filters" id="grants-active-filters"></div>
    
    <!-- Progressive Filter Panel -->
    <div class="grants-filter-panel" id="grants-filter-panel">
      <div class="grants-filter-panel-header">
        <h3 class="grants-filter-panel-title">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          Find Your Perfect Grant
        </h3>
        <button type="button" class="grants-filter-close" id="grants-filter-close" aria-label="Close filters panel">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <!-- Progress Steps -->
      <div class="grants-filter-progress">
        <div class="grants-filter-progress-steps">
          <div class="grants-filter-step active" data-step="1">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Amount
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="2">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Timeframe
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="3">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Eligibility
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="4">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
              <polyline points="2 17 12 22 22 17"></polyline>
              <polyline points="2 12 12 17 22 12"></polyline>
            </svg>
            Categories
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="5">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            Locations
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="6">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Summary
          </div>
        </div>
      </div>
      
      <!-- Step Content Area -->
      <div class="grants-filter-step-content">
        <!-- Step 1: Amount -->
        <div class="grants-filter-step-container active" data-step-container="1">
          <h4 class="grants-filter-step-heading">Grant Amount</h4>
          <p class="grants-filter-step-description">Filter grants based on your funding needs. You can specify a minimum and maximum amount, or include grants with non-monetary or variable benefits.</p>
          
          <div class="grants-filter-range-container">
            <div class="grants-filter-range-title">Funding Range</div>
            <div class="grants-filter-range-inputs">
              <div class="grants-filter-range-group">
                <label class="grants-filter-range-label" for="amount-min">Minimum Amount</label>
                <input type="number" id="amount-min" placeholder="$0" min="0" data-filter-group="amount">
              </div>
              <span>to</span>
              <div class="grants-filter-range-group">
                <label class="grants-filter-range-label" for="amount-max">Maximum Amount</label>
                <input type="number" id="amount-max" placeholder="No limit" min="0" data-filter-group="amount">
              </div>
            </div>
          </div>
          
          <div class="grants-filter-options">
            <label class="grants-filter-checkbox" for="amount-varies">
              <input type="checkbox" id="amount-varies" name="amount" value="varies" data-filter-group="amount">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Include "Various Benefits" Grants</span>
                <p class="grants-filter-option-description">Include grants that offer non-monetary benefits or have variable funding amounts</p>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Step 2: Timeframe -->
        <div class="grants-filter-step-container" data-step-container="2">
          <h4 class="grants-filter-step-heading">Grant Timeframe</h4>
          <p class="grants-filter-step-description">Filter grants by their deadline. Select one or more options to see grants ending within those time periods.</p>
          
          <div class="grants-filter-options">
            <label class="grants-filter-checkbox" for="timeframe-today">
              <input type="checkbox" id="timeframe-today" name="timeframe" value="today" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending Today</span>
                <p class="grants-filter-option-description">Grants with deadlines within the next 24 hours</p>
              </div>
            </label>
            
            <label class="grants-filter-checkbox" for="timeframe-week">
              <input type="checkbox" id="timeframe-week" name="timeframe" value="week" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending This Week</span>
                <p class="grants-filter-option-description">Grants with deadlines in the next 7 days</p>
              </div>
            </label>
            
            <label class="grants-filter-checkbox" for="timeframe-month">
              <input type="checkbox" id="timeframe-month" name="timeframe" value="month" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending This Month</span>
                <p class="grants-filter-option-description">Grants with deadlines in the next 30 days</p>
              </div>
            </label>
            
            <label class="grants-filter-checkbox" for="timeframe-quarter">
              <input type="checkbox" id="timeframe-quarter" name="timeframe" value="quarter" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending This Quarter</span>
                <p class="grants-filter-option-description">Grants with deadlines in the next 90 days</p>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Step 3: Eligibility -->
        <div class="grants-filter-step-container" data-step-container="3">
          <h4 class="grants-filter-step-heading">Eligibility Requirements</h4>
          <p class="grants-filter-step-description">Filter by who can apply. Select the entities that match your profile to find grants you're eligible for.</p>
          
          <div class="grants-filter-search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="eligibility-search" placeholder="Search eligible entities..." aria-label="Search eligible entities">
          </div>
          
          <div id="eligibility-loading" class="grants-filter-loading active">
            <div class="grants-filter-loading-spinner"></div>
          </div>
          
          <div class="grants-filter-options" id="eligibility-options">
            <!-- Dynamically populated via JavaScript -->
          </div>
          
          <div class="grants-filter-selected" id="eligibility-selected"></div>
        </div>
        
        <!-- Step 4: Categories -->
        <div class="grants-filter-step-container" data-step-container="4">
          <h4 class="grants-filter-step-heading">Grant Categories</h4>
          <p class="grants-filter-step-description">Filter by grant type or industry. Select categories to find grants in your area of interest.</p>
          
          <div class="grants-filter-search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="category-search" placeholder="Search categories..." aria-label="Search categories">
          </div>
          
          <div id="category-loading" class="grants-filter-loading active">
            <div class="grants-filter-loading-spinner"></div>
          </div>
          
          <div class="grants-filter-options" id="category-options">
            <!-- Dynamically populated via JavaScript -->
          </div>
          
          <div class="grants-filter-selected" id="category-selected"></div>
        </div>
        
        <!-- Step 5: Locations -->
        <div class="grants-filter-step-container" data-step-container="5">
          <h4 class="grants-filter-step-heading">Grant Locations</h4>
          <p class="grants-filter-step-description">Filter by geographic availability. Select locations to find grants available in your area.</p>
          
          <div class="grants-filter-search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="location-search" placeholder="Search locations..." aria-label="Search locations">
          </div>
          
          <div id="location-loading" class="grants-filter-loading active">
            <div class="grants-filter-loading-spinner"></div>
          </div>
          
          <div class="grants-filter-options" id="location-options">
            <!-- Dynamically populated via JavaScript -->
          </div>
          
          <div class="grants-filter-selected" id="location-selected"></div>
        </div>
        
        <!-- Step 6: Summary -->
        <div class="grants-filter-step-container" data-step-container="6">
          <h4 class="grants-filter-step-heading">Filter Summary</h4>
          <p class="grants-filter-step-description">Review your selected filters before applying them to find grants that match your criteria.</p>
          
          <div class="grants-filter-summary">
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                Amount Range
              </h5>
              <div class="grants-filter-summary-content" id="summary-amount">
                <span class="grants-filter-summary-empty">No amount filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Timeframe
              </h5>
              <div class="grants-filter-summary-content" id="summary-timeframe">
                <span class="grants-filter-summary-empty">No timeframe filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Eligibility
              </h5>
              <div class="grants-filter-summary-content" id="summary-eligibility">
                <span class="grants-filter-summary-empty">No eligibility filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                  <polyline points="2 17 12 22 22 17"></polyline>
                  <polyline points="2 12 12 17 22 12"></polyline>
                </svg>
                Categories
              </h5>
              <div class="grants-filter-summary-content" id="summary-categories">
                <span class="grants-filter-summary-empty">No category filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                Locations
              </h5>
              <div class="grants-filter-summary-content" id="summary-locations">
                <span class="grants-filter-summary-empty">No location filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-match-count">
              <strong id="matching-grants-count">0</strong>
              <div class="grants-filter-match-label">Matching Grants</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer Actions -->
      <div class="grants-filter-panel-footer">
        <div class="grants-filter-result-count" id="grants-filter-result-count">
          Ready to filter grants
        </div>
        <div class="grants-filter-panel-actions">
          <button type="button" class="grants-filter-secondary-btn" id="grants-filter-back" disabled>
            Back
          </button>
          <button type="button" class="grants-filter-secondary-btn" id="grants-filter-reset">
            Reset All
          </button>
          <button type="button" class="grants-filter-primary-btn" id="grants-filter-next">
            Next
          </button>
        </div>
      </div>
      
      <!-- Loading Overlay -->
      <div class="grants-filter-loading" id="grants-filter-loading">
        <div class="grants-filter-loading-spinner"></div>
      </div>
    </div>
  </div>
  
  <div class="grants-container" id="grants-container">
    <style>
      .grants-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
        width: 100%;
        min-height: 300px;
        position: relative;
      }
      
      @media (min-width: 640px) {
        .grants-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }
      }
      
      @media (min-width: 1024px) {
        .grants-container {
          grid-template-columns: repeat(3, 1fr);
          gap: 1.75rem; /* Reduced gap slightly */
        }
      }
      
      @media (min-width: 1440px) {
        .grants-container {
          grid-template-columns: repeat(4, 1fr);
          gap: 1.5rem; /* Further reduced gap for 4 columns */
        }
      }
      /* No grants message */
      .no-filtered-grants {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 1.5rem;
        background-color: var(--grantaura-gray-50);
        border-radius: var(--grantaura-border-radius);
        border: 1px solid var(--grantaura-gray-200);
        display: none;
      }
      
      .no-filtered-grants.active {
        display: block;
      }
      
      .no-filtered-grants h3 {
        font-size: clamp(1.5rem, 5vw, 1.75rem);
        margin-bottom: 1.25rem;
        color: var(--grantaura-gray-800);
        position: relative;
        display: inline-block;
      }
      
      .no-filtered-grants h3::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: -10px;
        transform: translateX(-50%);
        width: 70px;
        height: 3px;
        background-color: var(--grantaura-primary-light);
      }
      
      .no-filtered-grants p {
        font-size: clamp(0.95rem, 4vw, 1.1rem);
        color: var(--grantaura-gray-600);
        max-width: 600px;
        margin: 0 auto 1.5rem;
        line-height: 1.6;
      }
      
      .no-filtered-grants button {
        background: var(--grantaura-primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--grantaura-border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--grantaura-transition);
      }
      
      .no-filtered-grants button:hover {
        background: var(--grantaura-primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--grantaura-box-shadow);
      }
      
      /* Loading overlay for grants container */
      .grants-container-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      .grants-container-loading.active {
        opacity: 1;
        pointer-events: auto;
      }
      
      .grants-container-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--grantaura-gray-200);
        border-top-color: var(--grantaura-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    </style>
    <!-- No Filtered Grants Message -->
    <div class="no-filtered-grants" id="no-filtered-grants">
      <h3>No Matching Grants Found</h3>
      <p>We couldn't find any grants matching your filter criteria. Try adjusting your filters or reset them to see all available grants.</p>
      <button type="button" id="reset-filters-btn">Reset All Filters</button>
    </div>
    
    <div class="grants-container-loading" id="grants-container-loading">
      <div class="grants-container-loading-spinner"></div>
    </div>
    
    [php]
    // Set up pagination variables
    $paged = get_query_var('paged') ? get_query_var('paged') : 1;
    $posts_per_page = 12; // Number of posts to show per page
    
    // First, get featured grants
    $featured_args = array(
      'post_type' => 'at_biz_dir',
      'posts_per_page' => -1, // Get all featured posts
      'meta_query' => array(
        'relation' => 'OR',
        // Check for featured meta with value 1
        array(
          'key' => 'featured',
          'value' => array('1', 'yes', 'true', 'on'),
          'compare' => 'IN',
        ),
        // Check for _featured meta with value 1
        array(
          'key' => '_featured',
          'value' => array('1', 'yes', 'true', 'on'),
          'compare' => 'IN',
        ),
      ),
      'orderby' => 'date',
      'order' => 'DESC'
    );
    
    // Run query for featured grants
    $featured_query = new WP_Query($featured_args);
    $has_featured_posts = $featured_query->have_posts();
    $featured_post_ids = array();
    
    // Store featured post IDs
    if ($has_featured_posts) {
      while ($featured_query->have_posts()) {
        $featured_query->the_post();
        $featured_post_ids[] = get_the_ID();
      }
      wp_reset_postdata();
    }
    
    // Fallback: If no featured posts found with direct meta keys, 
    // search for any meta key containing 'featured'
    if (empty($featured_post_ids)) {
      global $wpdb;
      $query = "
        SELECT DISTINCT post_id 
        FROM $wpdb->postmeta 
        WHERE meta_key LIKE '%featured%' 
        AND meta_value IN ('1', 'yes', 'true', 'on')
        AND post_id IN (
          SELECT ID FROM $wpdb->posts 
          WHERE post_type = 'at_biz_dir' 
          AND post_status = 'publish'
        )
      ";
      $fallback_results = $wpdb->get_results($query);
      
      $has_fallback_results = !empty($fallback_results);
      if ($has_fallback_results) {
        foreach ($fallback_results as $result) {
          $featured_post_ids[] = $result->post_id;
        }
      }
    }
    
    // Get all regular (non-featured) posts to determine statuses
    $regular_args = array(
      'post_type' => 'at_biz_dir',
      'posts_per_page' => -1, // Get all posts to sort them
      'post__not_in' => $featured_post_ids,
      'orderby' => 'date',
      'order' => 'DESC'
    );
    
    $regular_query = new WP_Query($regular_args);
    $has_regular_posts = $regular_query->have_posts();
    
    // Arrays to hold active/ongoing and expired grants
    $active_ongoing_posts = array();
    $expired_posts = array();
    
    // Process regular posts to determine status and sort them
    if ($has_regular_posts) {
      while ($regular_query->have_posts()) {
        $regular_query->the_post();
        $post_id = get_the_ID();
        $post = get_post($post_id);
        
        // Get deadline date
        $deadline = get_post_meta($post_id, '_custom-date', true);
        $has_deadline = !empty($deadline);
        
        // Determine grant status
        $status = 'ongoing'; // Default status if no deadline
        
        if ($has_deadline) {
          $current_time = time();
          $deadline_time = strtotime($deadline);
          $is_future_deadline = $deadline_time > $current_time;
          
          if ($is_future_deadline) {
            $status = 'active';
          } else {
            // Get expiration date
            $expiry_date = get_post_meta($post_id, '_expiry_date', true);
            $has_expiry_date = !empty($expiry_date);
            
            if ($has_expiry_date) {
              $status = 'expired_with_notice';
            } else {
              $status = 'expired_no_notice';
            }
          }
        }
        
        // Group posts by status
        $is_expired = $status == 'expired_with_notice' || $status == 'expired_no_notice';
        
        if ($is_expired) {
          $expired_posts[] = array(
            'post' => $post,
            'is_featured' => false,
            'status' => $status
          );
        } else {
          $active_ongoing_posts[] = array(
            'post' => $post,
            'is_featured' => false,
            'status' => $status
          );
        }
      }
      wp_reset_postdata();
    }
    
    // Process featured posts to determine their status
    $featured_active_ongoing = array();
    $featured_expired = array();
    
    foreach ($featured_post_ids as $post_id) {
      $post = get_post($post_id);
      $is_valid_post = !empty($post) && $post->post_type === 'at_biz_dir';
      
      if ($is_valid_post) {
        // Get deadline date
        $deadline = get_post_meta($post_id, '_custom-date', true);
        $has_deadline = !empty($deadline);
        
        // Determine grant status
        $status = 'ongoing'; // Default status if no deadline
        
        if ($has_deadline) {
          $current_time = time();
          $deadline_time = strtotime($deadline);
          $is_future_deadline = $deadline_time > $current_time;
          
          if ($is_future_deadline) {
            $status = 'active';
          } else {
            // Get expiration date
            $expiry_date = get_post_meta($post_id, '_expiry_date', true);
            $has_expiry_date = !empty($expiry_date);
            
            if ($has_expiry_date) {
              $status = 'expired_with_notice';
            } else {
              $status = 'expired_no_notice';
            }
          }
        }
        
        // Group featured posts by status
        $is_expired = $status == 'expired_with_notice' || $status == 'expired_no_notice';
        
        if ($is_expired) {
          $featured_expired[] = array(
            'post' => $post,
            'is_featured' => true,
            'status' => $status
          );
        } else {
          $featured_active_ongoing[] = array(
            'post' => $post,
            'is_featured' => true,
            'status' => $status
          );
        }
      }
    }
    
    // Combine all posts in the desired order
    $combined_posts = array_merge(
      $featured_active_ongoing,   // Featured active/ongoing first
      $featured_expired,          // Featured expired second
      $active_ongoing_posts,      // Regular active/ongoing third
      $expired_posts              // Regular expired last
    );
    
    // Apply pagination to combined posts
    $total_posts = count($combined_posts);
    $total_pages = ceil($total_posts / $posts_per_page);
    
    // Calculate offset for the current page
    $offset = ($paged - 1) * $posts_per_page;
    
    // Get the posts for the current page
    $current_page_posts = array_slice($combined_posts, $offset, $posts_per_page);
    
    // Now we have all posts combined and paginated, display them
    $has_any_posts = !empty($current_page_posts);
    
    // Create arrays to store unique filter values
    $all_categories = array();
    $all_locations = array();
    $all_eligible_entities = array();
    $grant_data_json = array();
    
    if ($has_any_posts) {
      foreach ($current_page_posts as $post_data) {
        $post = $post_data['post'];
        $is_featured = $post_data['is_featured'];
        $status = isset($post_data['status']) ? $post_data['status'] : 'ongoing';
        $post_id = $post->ID;
        
        // Get basic grant information
        $title = get_the_title($post_id);
        $permalink = get_permalink($post_id);
        
        // Get excerpt/tagline
        $tagline = get_post_meta($post_id, 'tagline', true);
        $is_tagline_empty = empty($tagline);
        if ($is_tagline_empty) {
          $tagline = get_the_excerpt($post_id);
        }
        
        // Get amount - use "Varies" or "Various Benefits" instead of N/A
        $amount = get_post_meta($post_id, '_price', true);
        $is_amount_empty = empty($amount);
        if ($is_amount_empty) {
          $amount_display = 'Various Benefits';
          $amount_value = 'varies';
        } else {
          $amount_display = '$' . number_format($amount);
          $amount_value = $amount;
        }
        
        // Get deadline date
        $deadline = get_post_meta($post_id, '_custom-date', true);
        $has_deadline = !empty($deadline);
        $deadline_display = $has_deadline ? date('F j, Y', strtotime($deadline)) : 'Ongoing';
        $deadline_timestamp = $has_deadline ? strtotime($deadline) : '';
        
        // Get expiration date
        $expiry_date = get_post_meta($post_id, '_expiry_date', true);
        $has_expiry_date = !empty($expiry_date);
        
        // Recalculate time remaining for active grants
        $time_remaining = array(
          'days' => 0,
          'hours' => 0,
          'minutes' => 0,
          'seconds' => 0,
          'total_seconds' => 0,
          'display_type' => 'days' // Default to days
        );
        
        $status_is_active = $status == 'active';
        $status_is_ongoing = $status == 'ongoing';
        
        if ($status_is_active && $has_deadline) {
          $current_time = time();
          $deadline_time = strtotime($deadline);
          $time_diff = $deadline_time - $current_time;
          
          // Calculate time components
          $time_remaining['days'] = floor($time_diff / (60 * 60 * 24));
          $time_remaining['hours'] = floor(($time_diff % (60 * 60 * 24)) / (60 * 60));
          $time_remaining['minutes'] = floor(($time_diff % (60 * 60)) / 60);
          $time_remaining['seconds'] = $time_diff % 60;
          $time_remaining['total_seconds'] = $time_diff;
          
          // Determine display type based on time remaining
          if ($time_remaining['days'] < 1) {
            $time_remaining['display_type'] = 'countdown';
          } else {
            $time_remaining['display_type'] = 'days';
          }
        }
        
        // Get status display text and color
        $status_text = '';
        $status_color = '';
        
        if ($status_is_active) {
          $status_text = 'Active';
          $status_color = 'var(--grantaura-success)';
        } else if ($status_is_ongoing) {
          $status_text = 'Ongoing';
          $status_color = 'var(--grantaura-secondary)';
        } else {
          $status_text = 'Expired';
          $status_color = 'var(--grantaura-danger)';
        }
        
        // Enhanced eligible entities fetching with multiple fallbacks
        $eligible_entities = get_post_meta($post_id, 'custom-checkbox', true);
        $is_eligible_entities_not_array = !is_array($eligible_entities);
        $is_eligible_entities_not_empty = !empty($eligible_entities);
        
        // Fallback 1: Try to unserialize if it's not already an array
        if ($is_eligible_entities_not_array && $is_eligible_entities_not_empty) {
          $eligible_entities = maybe_unserialize($eligible_entities);
        }
        
        // Fallback 2: Check for alternate meta key names if still not an array
        if (!is_array($eligible_entities) || empty($eligible_entities)) {
          $alternate_keys = array(
            'eligibility', '_eligibility', 'eligible_entities', '_eligible_entities',
            'entity', '_entity', 'entities', '_entities', 'eligible', '_eligible',
            'who_can_apply', '_who_can_apply', 'applicants', '_applicants'
          );
          
          foreach ($alternate_keys as $alt_key) {
            $alt_value = get_post_meta($post_id, $alt_key, true);
            if (!empty($alt_value)) {
              if (!is_array($alt_value)) {
                $alt_value = maybe_unserialize($alt_value);
              }
              
              if (is_array($alt_value) && !empty($alt_value)) {
                $eligible_entities = $alt_value;
                break;
              }
            }
          }
        }
        
        // Fallback 3: Search in post content for eligibility information
        if (!is_array($eligible_entities) || empty($eligible_entities)) {
          $content = $post->post_content;
          $eligibility_patterns = array(
            '/eligib\w+\s*(?::|for|to)\s*((?:[^,.]+,\s*)*[^,.]+)/i',
            '/who\s*can\s*apply\s*(?::|for|to)\s*((?:[^,.]+,\s*)*[^,.]+)/i',
            '/available\s*(?:to|for)\s*((?:[^,.]+,\s*)*[^,.]+)/i'
          );
          
          foreach ($eligibility_patterns as $pattern) {
            if (preg_match($pattern, $content, $matches)) {
              if (!empty($matches[1])) {
                $entities_str = $matches[1];
                $extracted_entities = array_map('trim', explode(',', $entities_str));
                if (!empty($extracted_entities)) {
                  $eligible_entities = $extracted_entities;
                  break;
                }
              }
            }
          }
        }
        
        // Fallback 4: Check for eligibility in categories
        if (!is_array($eligible_entities) || empty($eligible_entities)) {
          $cats = get_the_terms($post_id, 'at_biz_dir-category');
          if (is_array($cats) && !empty($cats)) {
            $extracted_entities = array();
            
            foreach ($cats as $cat) {
              if (strpos(strtolower($cat->name), 'grant') !== false && 
                  (strpos(strtolower($cat->name), 'for') !== false || 
                   strpos(strtolower($cat->name), 'to') !== false)) {
                // Extract entity from "Grants for X" or "Grants to X"
                $name_parts = explode(' for ', strtolower($cat->name));
                if (count($name_parts) > 1) {
                  $extracted_entities[] = ucwords($name_parts[1]);
                  continue;
                }
                
                $name_parts = explode(' to ', strtolower($cat->name));
                if (count($name_parts) > 1) {
                  $extracted_entities[] = ucwords($name_parts[1]);
                }
              }
            }
            
            if (!empty($extracted_entities)) {
              $eligible_entities = $extracted_entities;
            }
          }
        }
        
        // Fallback 5: Default entities if all else fails
        if (!is_array($eligible_entities) || empty($eligible_entities)) {
          $eligible_entities = array('All Applicants');
        }
        
        // Collect all eligible entities for filter
        if (is_array($eligible_entities) && !empty($eligible_entities)) {
          foreach ($eligible_entities as $entity) {
            $entity = trim($entity);
            if (!empty($entity)) {
              if (!isset($all_eligible_entities[$entity])) {
                $all_eligible_entities[$entity] = 1;
              } else {
                $all_eligible_entities[$entity]++;
              }
            }
          }
        }
        
        // Get featured image - First check for preview image
        $listing_preview_id = get_post_meta($post_id, 'listing_prv_img', true);
        $has_preview_image = !empty($listing_preview_id);
        $featured_image = '';
        
        if ($has_preview_image) {
          $featured_image = wp_get_attachment_image_url($listing_preview_id, 'large');
        }
        
        // If no preview image, check for featured image
        $has_featured_image = !empty($featured_image);
        if (!$has_featured_image) {
          $featured_image = get_the_post_thumbnail_url($post_id, 'large');
          $has_featured_image = !empty($featured_image);
        }
        
        // If still no image, check gallery/slider images
        if (!$has_featured_image) {
          $gallery_ids = get_post_meta($post_id, '_listing_img', true);
          $is_gallery_ids_array = is_array($gallery_ids);
          
          if ($is_gallery_ids_array && !empty($gallery_ids)) {
            $first_gallery_image = wp_get_attachment_image_url($gallery_ids[0], 'large');
            if (!empty($first_gallery_image)) {
              $featured_image = $first_gallery_image;
              $has_featured_image = true;
            }
          } else if (!empty($gallery_ids) && !$is_gallery_ids_array) {
            // Try to parse if it's a comma-separated string
            $gallery_ids_array = explode(',', $gallery_ids);
            if (!empty($gallery_ids_array[0])) {
              $first_gallery_image = wp_get_attachment_image_url(trim($gallery_ids_array[0]), 'large');
              if (!empty($first_gallery_image)) {
                $featured_image = $first_gallery_image;
                $has_featured_image = true;
              }
            }
          }
        }
        
        // Fallback image if no images found
        if (!$has_featured_image) {
          $featured_image = 'https://grantaura.com/wp-content/uploads/2024/11/Transparent-bg-deep-Purple-AURA-and-dark-Gold-ff914d-GRANT-1-e1731246494496.png';
        }
        
        // Enhanced locations fetching with fallbacks
        $locations = get_the_terms($post_id, 'at_biz_dir-location');
        $is_locations_valid = is_array($locations) && !empty($locations);
        $location_data = array();
        $location_names = array(); // For JSON data
        
        if (!$is_locations_valid) {
          // Fallback 1: Check for location in custom fields
          $location_meta_keys = array(
            'location', '_location', 'locations', '_locations', 
            'grant_location', '_grant_location', 'area', '_area', 
            'region', '_region', 'country', '_country', 'state', '_state'
          );
          
          foreach ($location_meta_keys as $meta_key) {
            $meta_location = get_post_meta($post_id, $meta_key, true);
            if (!empty($meta_location)) {
              // Handle both string and array values
              if (is_array($meta_location)) {
                foreach ($meta_location as $loc) {
                  if (!empty($loc)) {
                    $location_data[] = array(
                      'name' => $loc,
                      'url' => '#',
                      'slug' => sanitize_title($loc)
                    );
                    $location_names[] = $loc;
                    
                    // Add to all locations for filter
                    if (!isset($all_locations[$loc])) {
                      $all_locations[$loc] = array(
                        'count' => 1,
                        'slug' => sanitize_title($loc)
                      );
                    } else {
                      $all_locations[$loc]['count']++;
                    }
                  }
                }
              } else {
                // Split by commas if it's a string
                $location_parts = explode(',', $meta_location);
                foreach ($location_parts as $loc) {
                  $loc = trim($loc);
                  if (!empty($loc)) {
                    $location_data[] = array(
                      'name' => $loc,
                      'url' => '#',
                      'slug' => sanitize_title($loc)
                    );
                    $location_names[] = $loc;
                    
                    // Add to all locations for filter
                    if (!isset($all_locations[$loc])) {
                      $all_locations[$loc] = array(
                        'count' => 1,
                        'slug' => sanitize_title($loc)
                      );
                    } else {
                      $all_locations[$loc]['count']++;
                    }
                  }
                }
              }
              
              if (!empty($location_data)) {
                break; // Stop once we've found locations
              }
            }
          }
          
          // Fallback 2: Check title or content for location information
          if (empty($location_data)) {
            $title_content = $title . ' ' . $post->post_content;
            $common_locations = array(
              'Global', 'Worldwide', 'United States', 'USA', 'U.S.', 'Canada', 'UK', 'Europe',
              'Australia', 'Africa', 'Asia', 'Latin America', 'South America', 'North America'
            );
            
            // US States
            $us_states = array(
              'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 
              'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 
              'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 
              'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 
              'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 
              'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota', 
              'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'West Virginia', 
              'Wisconsin', 'Wyoming'
            );
            
            $locations_to_check = array_merge($common_locations, $us_states);
            
            foreach ($locations_to_check as $loc) {
              // Check for whole word match
              if (preg_match('/\b' . preg_quote($loc, '/') . '\b/i', $title_content)) {
                $location_data[] = array(
                  'name' => $loc,
                  'url' => '#',
                  'slug' => sanitize_title($loc)
                );
                $location_names[] = $loc;
                
                // Add to all locations for filter
                if (!isset($all_locations[$loc])) {
                  $all_locations[$loc] = array(
                    'count' => 1,
                    'slug' => sanitize_title($loc)
                  );
                } else {
                  $all_locations[$loc]['count']++;
                }
              }
            }
          }
          
          // Fallback 3: Default to Global if still empty
          if (empty($location_data)) {
            $default_location = 'Global';
            $location_data[] = array(
              'name' => $default_location,
              'url' => '#',
              'slug' => sanitize_title($default_location)
            );
            $location_names[] = $default_location;
            
            // Add to all locations for filter
            if (!isset($all_locations[$default_location])) {
              $all_locations[$default_location] = array(
                'count' => 1,
                'slug' => sanitize_title($default_location)
              );
            } else {
              $all_locations[$default_location]['count']++;
            }
          }
        } else {
          // Process locations from taxonomy
          foreach ($locations as $location) {
            $location_link = get_term_link($location, 'at_biz_dir-location');
            $is_error = is_wp_error($location_link);
            if (!$is_error) {
              $location_data[] = array(
                'name' => $location->name,
                'url' => $location_link,
                'slug' => $location->slug
              );
              $location_names[] = $location->name;
              
              // Add to all locations for filter
              if (!isset($all_locations[$location->name])) {
                $all_locations[$location->name] = array(
                  'count' => 1,
                  'slug' => $location->slug
                );
              } else {
                $all_locations[$location->name]['count']++;
              }
            }
          }
        }
        
        // Enhanced categories fetching with fallbacks
        $categories = get_the_terms($post_id, 'at_biz_dir-category');
        $is_categories_valid = is_array($categories) && !empty($categories);
        $category_data = array();
        $category_names = array(); // For JSON data
        
        if (!$is_categories_valid) {
          // Fallback 1: Check for categories in custom fields
          $category_meta_keys = array(
            'category', '_category', 'categories', '_categories', 
            'grant_category', '_grant_category', 'type', '_type', 
            'segment', '_segment', 'industry', '_industry'
          );
          
          foreach ($category_meta_keys as $meta_key) {
            $meta_category = get_post_meta($post_id, $meta_key, true);
            if (!empty($meta_category)) {
              // Handle both string and array values
              if (is_array($meta_category)) {
                foreach ($meta_category as $cat) {
                  if (!empty($cat)) {
                    $category_data[] = array(
                      'name' => $cat,
                      'url' => '#',
                      'slug' => sanitize_title($cat)
                    );
                    $category_names[] = $cat;
                    
                    // Add to all categories for filter
                    if (!isset($all_categories[$cat])) {
                      $all_categories[$cat] = array(
                        'count' => 1,
                        'slug' => sanitize_title($cat)
                      );
                    } else {
                      $all_categories[$cat]['count']++;
                    }
                  }
                }
              } else {
                // Split by commas if it's a string
                $category_parts = explode(',', $meta_category);
                foreach ($category_parts as $cat) {
                  $cat = trim($cat);
                  if (!empty($cat)) {
                    $category_data[] = array(
                      'name' => $cat,
                      'url' => '#',
                      'slug' => sanitize_title($cat)
                    );
                    $category_names[] = $cat;
                    
                    // Add to all categories for filter
                    if (!isset($all_categories[$cat])) {
                      $all_categories[$cat] = array(
                        'count' => 1,
                        'slug' => sanitize_title($cat)
                      );
                    } else {
                      $all_categories[$cat]['count']++;
                    }
                  }
                }
              }
              
              if (!empty($category_data)) {
                break; // Stop once we've found categories
              }
            }
          }
          
          // Fallback 2: Extract from title
          if (empty($category_data)) {
            // Common prefixes in grant category titles
            $prefixes = array(
              'Grants for ', 'Funding for ', 'Support for ', 
              'Grants to ', 'Funding to ', 'Support to '
            );
            
            foreach ($prefixes as $prefix) {
              if (stripos($title, $prefix) === 0) {
                $cat_name = trim(str_ireplace($prefix, '', $title));
                if (!empty($cat_name)) {
                  $category_data[] = array(
                    'name' => "Grants for " . $cat_name,
                    'url' => '#',
                    'slug' => sanitize_title("grants-for-" . $cat_name)
                  );
                  $category_names[] = "Grants for " . $cat_name;
                  
                  // Add to all categories for filter
                  $full_cat_name = "Grants for " . $cat_name;
                  if (!isset($all_categories[$full_cat_name])) {
                    $all_categories[$full_cat_name] = array(
                      'count' => 1,
                      'slug' => sanitize_title("grants-for-" . $cat_name)
                    );
                  } else {
                    $all_categories[$full_cat_name]['count']++;
                  }
                  
                  break;
                }
              }
            }
          }
          
          // Fallback 3: Default category if still empty
          if (empty($category_data)) {
            $default_category = 'General Grants';
            $category_data[] = array(
              'name' => $default_category,
              'url' => '#',
              'slug' => sanitize_title($default_category)
            );
            $category_names[] = $default_category;
            
            // Add to all categories for filter
            if (!isset($all_categories[$default_category])) {
              $all_categories[$default_category] = array(
                'count' => 1,
                'slug' => sanitize_title($default_category)
              );
            } else {
              $all_categories[$default_category]['count']++;
            }
          }
        } else {
          // Process categories from taxonomy
          foreach ($categories as $category) {
            $category_link = get_term_link($category, 'at_biz_dir-category');
            $is_error = is_wp_error($category_link);
            if (!$is_error) {
              $category_data[] = array(
                'name' => $category->name,
                'url' => $category_link,
                'slug' => $category->slug
              );
              $category_names[] = $category->name;
              
              // Add to all categories for filter
              if (!isset($all_categories[$category->name])) {
                $all_categories[$category->name] = array(
                  'count' => 1,
                  'slug' => $category->slug
                );
              } else {
                $all_categories[$category->name]['count']++;
              }
            }
          }
        }
        
        // Store data for JavaScript filtering
        $grant_data = array(
          'id' => $post_id,
          'title' => $title,
          'status' => $status,
          'status_display' => $status_text,
          'is_featured' => $is_featured,
          'amount' => $amount_value,
          'amount_display' => $amount_display,
          'deadline' => $deadline_timestamp,
          'deadline_display' => $deadline_display,
          'locations' => $location_names,
          'categories' => $category_names,
          'eligible_entities' => is_array($eligible_entities) ? $eligible_entities : array(),
          'time_remaining' => $time_remaining,
          'permalink' => $permalink
        );
        
        $grant_data_json[] = $grant_data;
        
        // Generate a unique ID for countdown timer
        $countdown_id = 'g-countdown-' . $post_id;
        
        // Add featured class if post is featured
        $featured_class = $is_featured ? 'g-card--featured' : '';
        
        // Determine expired status for data attribute
        $is_expired_status = strpos($status, 'expired') !== false ? 'true' : 'false';
        
        // Output HTML for each grant listing with filter data attributes
        ?>
        <div class="g-card <?php echo esc_attr($featured_class); ?>" 
             data-grant-id="<?php echo esc_attr($post_id); ?>" 
             data-status="<?php echo esc_attr($status); ?>"
             data-featured="<?php echo $is_featured ? 'true' : 'false'; ?>"
             data-amount="<?php echo esc_attr($amount_value); ?>"
             data-deadline="<?php echo esc_attr($deadline_timestamp); ?>"
             data-expired="<?php echo esc_attr($is_expired_status); ?>"
             data-locations="<?php echo esc_attr(implode('|', $location_names)); ?>"
             data-categories="<?php echo esc_attr(implode('|', $category_names)); ?>"
             data-eligible-entities="<?php echo esc_attr(is_array($eligible_entities) ? implode('|', $eligible_entities) : ''); ?>"
             <?php if ($status_is_active && $time_remaining['display_type'] == 'countdown') echo 'data-countdown-time="' . esc_attr($deadline_time) . '"'; ?>>
          <style>
            .g-card {
              display: flex;
              flex-direction: column;
              border-radius: var(--grantaura-border-radius-lg);
              overflow: hidden;
              background-color: var(--grantaura-white);
              box-shadow: var(--grantaura-box-shadow);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
              border: 1px solid var(--grantaura-gray-300);
              transform: translateY(0);
              height: 100%;
              max-height: none;
              will-change: transform, box-shadow;
              position: relative;
            }
            
            .g-card:hover {
              transform: translateY(-5px);
              box-shadow: var(--grantaura-box-shadow-xl);
            }
            
            /* Featured card styling - UPDATED VERSION */
            .g-card--featured {
              position: relative;
              z-index: 2;
              border: none !important;
              overflow: visible !important; /* This is critical to show the border */
            }
            
            .g-card--featured::before {
              content: "";
              position: absolute;
              top: -3px;
              left: -3px;
              right: -3px;
              bottom: -8px;
              background: linear-gradient(90deg, 
                #5A3B8C 0%, 
                #FFA366 25%, 
                #FFB888 50%, 
                #FFA366 75%, 
                #5A3B8C 100%);
              border-radius: 1px 1px 15px 15px;
              z-index: -1;
              background-size: 300% 300%;
              box-shadow: 0 0 15px rgba(90, 59, 140, 0.4);
              animation: border-animation 6s ease infinite;
            }
            
            @keyframes border-animation {
              0% { background-position: 0% 0%; }
              25% { background-position: 100% 0%; }
              50% { background-position: 100% 100%; }
              75% { background-position: 0% 100%; }
              100% { background-position: 0% 0%; }
            }
            
            .g-card--featured::after {
              content: "";
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: var(--grantaura-white);
              border-radius: var(--grantaura-border-radius-lg);
              z-index: -1;
            }
            
            /* Add this keyframes definition for the border animation */
            @keyframes border-shine {
              0% {
                background-position: 100% 0;
              }
              100% {
                background-position: -100% 0;
              }
            }
            
            @media (prefers-reduced-motion: reduce) {
              .g-card {
                transition: none;
              }
              .g-card:hover {
                transform: none;
              }
              .g-card--featured::before {
                animation: none;
              }
            }
          </style>
          
          <div class="g-card__img-container">
            <style>
              .g-card__img-container {
                position: relative;
                width: 100%;
                padding-bottom: 90%; /* Maintain exact 1:1 aspect ratio */
                overflow: hidden;
              }
              
              /* Crisp image loading effect */
              .g-card__img-loaded {
                opacity: 1;
                transform: scale(1);
                filter: contrast(1.05);
                transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.4s ease;
              }
            </style>
            
            <div class="g-card__img-wrapper">
              <style>
                .g-card__img-wrapper {
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  overflow: hidden;
                  z-index: 1;
                }
                
                .g-card__img-wrapper img {
                  width: 100%;
                  height: 100%;
                  object-fit: cover;
                  display: block;
                  transform: scale(1);
                  transition: transform 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
                  will-change: transform;
                }
              </style>
              
              <a href="<?php echo esc_url($permalink); ?>" title="<?php echo esc_attr($title); ?>" aria-label="View details of <?php echo esc_attr($title); ?>">
                <img 
                  src="<?php echo esc_url($featured_image); ?>" 
                  alt="<?php echo esc_attr($title); ?>" 
                  loading="lazy"
                  class="g-card__image"
                  onload="this.classList.add('g-card__img-loaded')"
                  width="500"
                  height="500"
                >
              </a>
            </div>
            
            <div class="g-card__status-badge" style="background-color: <?php echo esc_attr($status_color); ?>;">
              <style>
                .g-card__status-badge {
                  position: absolute;
                  top: 12px;
                  left: 12px;
                  padding: 6px 14px;
                  border-radius: 100px;
                  font-size: clamp(0.65rem, 2.5vw, 0.75rem);
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  color: white !important;
                  z-index: 5;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  transition: transform 0.3s ease;
                }
                
                
                .g-card__status-badge::before {
                  content: "";
                  display: inline-block;
                  width: 6px;
                  height: 6px;
                  border-radius: 50%;
                  background-color: rgba(255, 255, 255, 0.8);
                  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
                  animation: pulse 2s infinite;
                }
                
                .g-card__status-badge[style*="var(--grantaura-success)"]::before {
                  animation: pulse-success 2s infinite;
                }
                
                .g-card__status-badge[style*="var(--grantaura-secondary)"]::before {
                  animation: none;
                }
                
                .g-card__status-badge[style*="var(--grantaura-danger)"]::before {
                  animation: none;
                  background-color: rgba(255, 255, 255, 0.6);
                  box-shadow: none;
                }
                
                @keyframes pulse {
                  0% {
                    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.5);
                  }
                  70% {
                    box-shadow: 0 0 0 4px rgba(255, 255, 255, 0);
                  }
                  100% {
                    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
                  }
                }
                
                @keyframes pulse-success {
                  0% {
                    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5);
                  }
                  70% {
                    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
                  }
                  100% {
                    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
                  }
                }
                
                /* Mobile optimizations */
                @media (max-width: 640px) {
                  .g-card__status-badge {
                    top: 10px;
                    left: 10px;
                    padding: 5px 12px;
                  }
                }
                
                /* Reduce motion based on user preference */
                @media (prefers-reduced-motion: reduce) {
                  .g-card__status-badge::before {
                    animation: none !important;
                  }
                  
                  .g-card:hover .g-card__status-badge {
                    transform: none;
                  }
                }
              </style>
              <?php echo esc_html($status_text); ?>
            </div>
            
            <?php if ($is_featured): ?>
            <div class="g-card__featured-badge">
              <style>
                .g-card__featured-badge {
                  position: absolute;
                  right: -8px;
                  top: 18vw;
                  z-index: 20;
                  transform-origin: top right;
                }
                
                .g-card__featured-badge-inner {
                  background: linear-gradient(135deg, #FFD700, #FFA500);
                  color: #000;
                  font-weight: 700;
                  font-size: 0.75rem;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  padding: 6px 8px 6px 12px;
                  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                  position: relative;
                  clip-path: polygon(0 0, 100% 0, 100% 100%, 8px 100%);
                  display: flex;
                  align-items: center;
                  gap: 4px;
                }
                
                .g-card__featured-badge-inner::before {
                  content: "";
                  position: absolute;
                  bottom: -8px;
                  right: 0;
                  width: 8px;
                  height: 8px;
                  background: #A67C00;
                  clip-path: polygon(0 0, 100% 0, 100% 100%);
                }
                
                .g-card__featured-badge-inner svg {
                  width: 14px;
                  height: 14px;
                  color: #000;
                  filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
                }
                
                .g-card__featured-badge-shine {
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: linear-gradient(
                    45deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.5) 50%,
                    rgba(255, 255, 255, 0) 100%
                  );
                  background-size: 200% 200%;
                  animation: shine 2s ease-in-out infinite;
                }
                
                @keyframes shine {
                  0% {
                    background-position: -100% -100%;
                  }
                  100% {
                    background-position: 100% 100%;
                  }
                }
                
                @media (prefers-reduced-motion: reduce) {
                  .g-card__featured-badge-shine {
                    animation: none;
                  }
                }
              </style>
              <div class="g-card__featured-badge-inner">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2l2.2 6.6h7.1l-5.7 4.2 2.2 6.6-5.8-4.2-5.7 4.2 2.2-6.6-5.8-4.2h7.1z"/>
                </svg>
                Featured
                <div class="g-card__featured-badge-shine"></div>
              </div>
            </div>
            <?php endif; ?>
            
            <?php if ($status_is_active): ?>
            <div class="g-card__countdown-wrapper">
              <style>
                .g-card__countdown-wrapper {
                  position: absolute;
                  top: 12px;
                  right: 12px;
                  z-index: 5;
                }
                
                .g-card__countdown {
                  background: rgba(90, 59, 140, 0.95);
                  backdrop-filter: blur(5px);
                  -webkit-backdrop-filter: blur(5px);
                  border-radius: 3px;
                  padding: 8px 10px;
                  color: white;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 5px;
                  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
                  border: 1px solid rgba(255, 255, 255, 0.15);
                  transition: transform 0.3s ease;
                }
                
                .g-card:hover .g-card__countdown {
                  transform: translateY(-2px);
                }
                
                .g-card__countdown-label {
                  font-size: 0.55rem;
                  text-transform: uppercase;
                  opacity: 0.85;
                  margin-right: 0.25rem;
                  letter-spacing: 0.5px;
                }
                
                .g-card__countdown-unit {
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  position: relative;
                }
                
                .g-card__countdown-unit:not(:last-child)::after {
                  content: ":";
                  position: absolute;
                  right: -4px;
                  top: 2px;
                  color: rgba(255, 255, 255, 0.7);
                  font-weight: 700;
                }
                
                .g-card__countdown-number {
                  font-size: clamp(0.80rem, 2vw, 0.75rem);
                  font-weight: 700;
                  background: rgba(255, 255, 255, 0.15);
                  border-radius: 6px;
                  min-width: clamp(1.8rem, 6vw, 2rem);
                  text-align: center;
                  padding: 2px 4px;
                  position: relative;
                  overflow: hidden;
                }
                
                /* Pulse effect for seconds */
                .g-card__countdown-unit:last-child .g-card__countdown-number {
                  position: relative;
                }
                
                .g-card__countdown-unit:last-child .g-card__countdown-number::after {
                  content: "";
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: rgba(255, 163, 102, 0.85);
                  opacity: 0;
                  animation: pulse-countdown 1s infinite;
                }
                
                @keyframes pulse-countdown {
                  0% {
                    opacity: 0;
                  }
                  50% {
                    opacity: 1;
                  }
                  100% {
                    opacity: 0;
                  }
                }
                
                .g-card__countdown-label-unit {
                  font-size: 0.6rem;
                  text-transform: uppercase;
                  margin-top: 2px;
                  color: rgba(255, 255, 255, 0.8);
                  letter-spacing: 0.5px;
                }
                
                .g-card__deadline-days {
                  background: rgba(90, 59, 140, 0.95);
                  backdrop-filter: blur(5px);
                  -webkit-backdrop-filter: blur(5px);
                  border-radius: 3px;
                  padding: 6px 10px;
                  color: white;
                  display: flex;
                  align-items: center;
                  font-weight: 600;
                  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
                  border: 1px solid rgba(255, 255, 255, 0.15);
                  transition: transform 0.3s ease;
                  gap: 5px;
                }
                
                .g-card:hover .g-card__deadline-days {
                  transform: translateY(-2px);
                }
                
                .g-card__deadline-days-num {
                  font-size: clamp(0.75rem, 2vw, 1rem);
                  font-weight: 800;
                  background: rgba(255, 255, 255, 0.15);
                  border-radius: 6px;
                  min-width: 1.8rem;
                  text-align: center;
                  padding: 2px 6px;
                  color: var(--grantaura-secondary-light);
                }
                
                /* Adjust position for featured cards */
                .g-card--featured .g-card__countdown-wrapper {
                  right: 12px;
                }
                
                /* Mobile optimizations */
                @media (max-width: 640px) {
                  .g-card__countdown-wrapper {
                    top: 10px;
                    right: 10px;
                  }
                  
                  .g-card__countdown, 
                  .g-card__deadline-days {
                    padding: 4px 6px;
                  }
                }
                
                /* Reduce motion based on user preference */
                @media (prefers-reduced-motion: reduce) {
                  .g-card__countdown-unit:last-child .g-card__countdown-number::after {
                    animation: none;
                  }
                  
                  .g-card:hover .g-card__countdown,
                  .g-card:hover .g-card__deadline-days {
                    transform: none;
                  }
                }
              </style>
              
              <?php if ($time_remaining['display_type'] == 'countdown'): ?>
              <div class="g-card__countdown" id="<?php echo esc_attr($countdown_id); ?>" data-deadline="<?php echo esc_attr($deadline_time); ?>">
                <div class="g-card__countdown-unit">
                  <div class="g-card__countdown-number" data-hours><?php echo sprintf('%02d', $time_remaining['hours']); ?></div>
                  <div class="g-card__countdown-label-unit">Hrs</div>
                </div>
                
                <div class="g-card__countdown-unit">
                  <div class="g-card__countdown-number" data-minutes><?php echo sprintf('%02d', $time_remaining['minutes']); ?></div>
                  <div class="g-card__countdown-label-unit">Min</div>
                </div>
                
                <div class="g-card__countdown-unit">
                  <div class="g-card__countdown-number" data-seconds><?php echo sprintf('%02d', $time_remaining['seconds']); ?></div>
                  <div class="g-card__countdown-label-unit">Sec</div>
                </div>
              </div>
              <?php else: ?>
              <div class="g-card__deadline-days">
                <span class="g-card__deadline-days-num"><?php echo $time_remaining['days']; ?></span>
                <span>Days Left</span>
              </div>
              <?php endif; ?>
            </div>
            <?php endif; ?>
            
            <div class="g-card__gradient-overlay">
              <style>
                .g-card__gradient-overlay {
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  height: 55%;
                  background: linear-gradient(to top, 
                    rgba(17, 24, 39, 0.98) 30%, 
                    rgba(90, 59, 140, 0.90) 45%,
                    rgba(90, 59, 140, 0.65) 65%, 
                    rgba(90, 59, 140, 0.2) 85%,
                    rgba(90, 59, 140, 0) 100%);
                  z-index: 3;
                  pointer-events: none;
                  border-radius: 0 0 12px 12px;
                  mix-blend-mode: multiply;
                }
                
                /* Add subtle lighting effect on the gradient */
                .g-card__gradient-overlay::after {
                  content: "";
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  height: 60%;
                  background: linear-gradient(135deg, 
                    rgba(255, 163, 102, 0.25) 0%, 
                    rgba(90, 59, 140, 0) 50%,
                    rgba(255, 163, 102, 0.15) 100%);
                  z-index: 1;
                  opacity: 0;
                  transition: opacity 0.5s ease;
                }
                
                /* Reduce motion based on user preference */
                @media (prefers-reduced-motion: reduce) {
                  .g-card:hover .g-card__gradient-overlay::after {
                    transition: none;
                  }
                }
              </style>
            </div>
            
            <h2 class="g-card__title">
              <style>
                .g-card__title {
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  z-index: 4;
                  padding: 1.25rem 1.25rem 1.5rem;
                  margin: 0;
                  font-size: clamp(1.1rem, 5vw, 1.35rem);
                  font-weight: 700;
                  line-height: 1.3;
                  color: white !important;
                  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
                  transition: transform 0.3s ease;
                }
                
                .g-card:hover .g-card__title {
                  transform: translateY(-5px);
                }
                
                .g-card__title a {
                  color: white !important;
                  text-decoration: none !important;
                  transition: var(--grantaura-transition);
                  display: block;
                  width: 100%;
                  position: relative;
                  padding-left: 0;
                  overflow: hidden;
                }
                
                .g-card__title a:hover {
                  color: var(--grantaura-secondary-light) !important;
                }
                
                /* Hover underline effect */
                .g-card__title a::after {
                  content: "";
                  position: absolute;
                  bottom: -5px;
                  left: 0;
                  width: 0;
                  height: 2px;
                  background: var(--grantaura-secondary);
                  transition: width 0.3s ease;
                }
                
                .g-card:hover .g-card__title a::after {
                  width: 40px;
                }
                
                /* Add subtle enhancement to first letter */
                .g-card__title a::first-letter {
                  font-size: 110%;
                  color: var(--grantaura-secondary-light);
                }
                
                /* Special styling for featured titles */
                .g-card--featured .g-card__title a::first-letter {
                  color: #FFD700;
                }
                
                /* Reduce motion based on user preference */
                @media (prefers-reduced-motion: reduce) {
                  .g-card:hover .g-card__title {
                    transform: none;
                  }
                  
                  .g-card:hover .g-card__title a::after {
                    transition: none;
                  }
                }
              </style>
              
              <a href="<?php echo esc_url($permalink); ?>" title="<?php echo esc_attr($title); ?>" aria-label="View details of <?php echo esc_attr($title); ?>">
                <?php echo esc_html($title); ?>
              </a>
            </h2>
            
            <!-- Accessibility features -->
            <div class="g-card__img-accessibility" aria-hidden="true">
              <style>
                .g-card__img-accessibility {
                  position: absolute;
                  width: 1px;
                  height: 1px;
                  padding: 0;
                  margin: -1px;
                  overflow: hidden;
                  clip: rect(0, 0, 0, 0);
                  white-space: nowrap;
                  border-width: 0;
                }
              </style>
              <div class="g-card__screen-reader-info">
                <p>Grant: <?php echo esc_html($title); ?></p>
                <p>Status: <?php echo esc_html($status_text); ?></p>
                <?php if ($is_featured): ?>
                  <p>Featured Grant</p>
                <?php endif; ?>
                <?php if ($status_is_active && $has_deadline): ?>
                  <p>Deadline: <?php echo esc_html($deadline_display); ?></p>
                <?php endif; ?>
                <p>Amount: <?php echo esc_html($amount_display); ?></p>
              </div>
            </div>
          </div>
          <div class="g-card__content">
            <style>
              .g-card__content {
                display: flex;
                flex-direction: column;
                flex: 1;
                padding: clamp(0.75rem, 3vw, 1.25rem);
                height: auto;
                overflow: visible;
              }
            </style>
            
            <div class="g-card__amount">
              <style>
                .g-card__amount {
                  font-size: clamp(1.1rem, 4vw, 1.3rem);
                  font-weight: 700;
                  position: relative;
                  padding: 0.25rem 0;
                  margin-bottom: 0.75rem;
                  color: var(--grantaura-primary);
                }
                
                .g-card__amount::before {
                  content: "";
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  width: 100%;
                  height: 2px;
                  background: linear-gradient(90deg, var(--grantaura-primary), var(--grantaura-secondary-dark));
                  opacity: 0.2;
                }
                
                /* Enhanced styling for featured card amounts */
                .g-card--featured .g-card__amount {
                  color: var(--grantaura-primary-dark);
                }
                
                .g-card--featured .g-card__amount::before {
                  background: linear-gradient(90deg, var(--grantaura-primary-dark), #FFD700);
                  opacity: 0.3;
                  height: 3px;
                }
              </style>
              
              <?php echo esc_html($amount_display); ?>
            </div>
            
            <div class="g-card__deadline-info">
              <style>
                .g-card__deadline-info {
                  display: flex;
                  align-items: center;
                  font-size: clamp(0.8rem, 3vw, 0.85rem);
                  color: var(--grantaura-gray-700);
                  margin-bottom: 0.75rem;
                  gap: 0.5rem;
                }
                
                .g-card__deadline-info svg {
                  color: var(--grantaura-primary);
                  flex-shrink: 0;
                  width: clamp(14px, 4vw, 16px);
                  height: clamp(14px, 4vw, 16px);
                }
                
                .g-card__deadline-info strong {
                  font-weight: 600;
                  margin-right: 0.25rem;
                  color: var(--grantaura-gray-800);
                }
                
                .g-card__deadline-value {
                  font-weight: 500;
                }
                
                .g-card__deadline-value--ongoing {
                  color: var(--grantaura-secondary-dark);
                  font-weight: 600;
                }
                
                .g-card__deadline-value--expired {
                  color: var(--grantaura-danger);
                  font-weight: 500;
                }
                
                /* Enhanced styling for featured deadlines */
                .g-card--featured .g-card__deadline-info svg {
                  color: var(--grantaura-primary-dark);
                }
              </style>
              
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              
              <div>
                <strong>Deadline:</strong>
                <span class="g-card__deadline-value <?php echo $status_is_ongoing ? 'g-card__deadline-value--ongoing' : ($status_is_active ? '' : 'g-card__deadline-value--expired'); ?>">
                  <?php echo esc_html($deadline_display); ?>
                </span>
              </div>
            </div>
            
            <div class="g-card__excerpt">
              <style>
                .g-card__excerpt {
                  margin-bottom: 1rem;
                  font-size: clamp(0.8rem, 3vw, 0.9rem);
                  color: var(--grantaura-gray-600);
                  line-height: 1.6;
                  overflow: hidden;
                  position: relative;
                  display: -webkit-box;
                  -webkit-line-clamp: 3;
                  -webkit-box-orient: vertical;
                  max-height: 4.8em; /* Approximately 3 lines */
                }
                
                .g-card__excerpt::first-letter {
                  font-size: 1.1em;
                  font-weight: 500;
                  color: var(--grantaura-primary);
                }
                
                /* Enhanced styling for featured excerpts */
                .g-card--featured .g-card__excerpt {
                  color: var(--grantaura-gray-700);
                }
                
                .g-card--featured .g-card__excerpt::first-letter {
                  color: var(--grantaura-primary-dark);
                  font-weight: 600;
                }
              </style>
              
              <?php echo esc_html($tagline); ?>
            </div>
            
            <div class="g-card__meta">
              <style>
                .g-card__meta {
                  display: grid;
                  grid-template-columns: 1fr;
                  gap: 0.75rem;
                  margin-top: auto;
                  position: relative;
                }
                
                .g-card__meta::before {
                  content: "";
                  position: absolute;
                  top: -10px;
                  left: 0;
                  right: 0;
                  height: 1px;
                  background: linear-gradient(90deg, var(--grantaura-gray-300), transparent);
                }
                
                .g-card__meta-item {
                  display: flex;
                  align-items: center;
                  font-size: clamp(0.75rem, 3vw, 0.85rem);
                  color: var(--grantaura-gray-700);
                  gap: 0.35rem;
                  flex-wrap: wrap;
                }
                
                .g-card__meta-item svg {
                  color: var(--grantaura-primary);
                  flex-shrink: 0;
                  width: clamp(14px, 4vw, 16px);
                  height: clamp(14px, 4vw, 16px);
                }
                
                .g-card__meta-item strong {
                  font-weight: 600;
                  margin-right: 0.25rem;
                  color: var(--grantaura-gray-800);
                }
                
                /* Location links styling */
                .g-card__location-link {
                  color: var(--grantaura-gray-700) !important;
                  text-decoration: none !important;
                  transition: color 0.2s ease;
                  display: inline-block;
                }
                
                .g-card__location-link:hover {
                  color: var(--grantaura-primary) !important;
                  text-decoration: underline !important;
                }
                
                .g-card__location-list {
                  display: flex;
                  flex-wrap: wrap;
                  gap: 0.25rem;
                }
                
                .g-card__location-more {
                  display: inline-flex;
                  color: var(--grantaura-secondary-dark);
                  font-weight: 500;
                  font-size: 0.75rem;
                  margin-left: 0.25rem;
                }
                
                /* Responsive location display */
                .g-card__location-item--extra {
                  display: none;
                }
                
                @media (min-width: 768px) {
                  .g-card__location-item--extra-md {
                    display: inline;
                  }
                  
                  .g-card__location-more--mobile {
                    display: none;
                  }
                  
                  .g-card__location-more--tablet {
                    display: inline-flex;
                  }
                }
                
                @media (min-width: 1024px) {
                  .g-card__location-item--extra-lg {
                    display: inline;
                  }
                  
                  .g-card__location-more--tablet {
                    display: none;
                  }
                  
                  .g-card__location-more--desktop {
                    display: inline-flex;
                  }
                }
                
                .g-card__tags {
                  display: flex;
                  flex-wrap: wrap;
                  gap: 0.5rem;
                  margin-top: 0.75rem;
                }
                
                .g-card__tag {
                  font-size: 0.75rem;
                  padding: 3px 10px;
                  background-color: var(--grantaura-gray-100);
                  border-radius: 20px;
                  color: var(--grantaura-gray-700) !important;
                  border: 1px solid var(--grantaura-gray-200);
                  transition: var(--grantaura-transition);
                  text-decoration: none !important;
                  display: inline-block;
                }
                
                .g-card__tag:hover {
                  background-color: var(--grantaura-primary-light);
                  color: white !important;
                  border-color: var(--grantaura-primary-light);
                }
                
                .g-card__tag--more {
                  background: var(--grantaura-gray-200);
                  color: var(--grantaura-gray-800) !important;
                  cursor: default;
                }
                
                .g-card__tag--more:hover {
                  background: var(--grantaura-gray-200);
                  color: var(--grantaura-gray-800) !important;
                  border-color: var(--grantaura-gray-200);
                }
                
                /* Responsive category tag display */
                .g-card__tag--extra {
                  display: none;
                }
                
                @media (min-width: 768px) {
                  .g-card__tag--extra-md {
                    display: inline-block;
                  }
                  
                  .g-card__tag--more-mobile {
                    display: none;
                  }
                  
                  .g-card__tag--more-tablet {
                    display: inline-block;
                  }
                }
                
                @media (min-width: 1024px) {
                  .g-card__tag--extra-lg {
                    display: inline-block;
                  }
                  
                  .g-card__tag--more-tablet {
                    display: none;
                  }
                  
                  .g-card__tag--more-desktop {
                    display: inline-block;
                  }
                }
                
                /* Enhanced styling for featured meta */
                .g-card--featured .g-card__meta::before {
                  background: linear-gradient(90deg, var(--grantaura-primary-light), transparent);
                  opacity: 0.3;
                }
                
                .g-card--featured .g-card__meta-item svg {
                  color: var(--grantaura-primary-dark);
                }
                
                .g-card--featured .g-card__tag {
                  border-color: var(--grantaura-primary-light);
                  background-color: rgba(90, 59, 140, 0.05);
                }
                .g-card--featured .g-card__tag:hover {
                  color: white !important;
                  background-color: var(--grantaura-primary-light);
                }
              </style>
              
              <?php if (!empty($location_data)): ?>
              <div class="g-card__meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <strong>Location:</strong> 
                <div class="g-card__location-list">
                  <?php 
                  $location_count = count($location_data);
                  $mobile_limit = 2;
                  $tablet_limit = 4;
                  $desktop_limit = 6;
                  
                  foreach ($location_data as $index => $location):
                    // Determine which responsive class to use
                    $extra_class = '';
                    if ($index >= $mobile_limit) {
                      $extra_class = 'g-card__location-item--extra';
                      if ($index < $tablet_limit) {
                        $extra_class .= ' g-card__location-item--extra-md';
                      } else if ($index < $desktop_limit) {
                        $extra_class .= ' g-card__location-item--extra-md g-card__location-item--extra-lg';
                      }
                    }
                    
                    // Output comma for items after the first
                    if ($index > 0) {
                      echo ($index < $mobile_limit || $extra_class) ? '<span class="' . $extra_class . '">, </span>' : '';
                    }
                    
                    // Output the location link with appropriate class
                    echo '<a href="' . esc_url($location['url']) . '" class="g-card__location-link ' . $extra_class . '">' . esc_html($location['name']) . '</a>';
                  endforeach;
                  
                  // Show "+X more" indicators for different screen sizes
                  if ($location_count > $mobile_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--mobile">+' . ($location_count - $mobile_limit) . ' more</span>';
                  }
                  
                  if ($location_count > $tablet_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--tablet g-card__location-item--extra g-card__location-item--extra-md">+' . ($location_count - $tablet_limit) . ' more</span>';
                  }
                  
                  if ($location_count > $desktop_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--desktop g-card__location-item--extra g-card__location-item--extra-md g-card__location-item--extra-lg">+' . ($location_count - $desktop_limit) . ' more</span>';
                  }
                  ?>
                </div>
              </div>
              <?php endif; ?>
              
              <?php if (!empty($eligible_entities) && is_array($eligible_entities)): ?>
              <div class="g-card__meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <strong>Eligible:</strong> 
                <div class="g-card__location-list">
                  <?php 
                  $entity_count = count($eligible_entities);
                  $mobile_limit = 2;
                  $tablet_limit = 4;
                  $desktop_limit = 6;
                  
                  foreach ($eligible_entities as $index => $entity):
                    // Determine which responsive class to use
                    $extra_class = '';
                    if ($index >= $mobile_limit) {
                      $extra_class = 'g-card__location-item--extra';
                      if ($index < $tablet_limit) {
                        $extra_class .= ' g-card__location-item--extra-md';
                      } else if ($index < $desktop_limit) {
                        $extra_class .= ' g-card__location-item--extra-md g-card__location-item--extra-lg';
                      }
                    }
                    
                    // Output comma for items after the first
                    if ($index > 0) {
                      echo ($index < $mobile_limit || $extra_class) ? '<span class="' . $extra_class . '">, </span>' : '';
                    }
                    
                    // Output the entity with appropriate class - not linking as we don't have entity archive pages
                    echo '<span class="' . $extra_class . '">' . esc_html($entity) . '</span>';
                  endforeach;
                  
                  // Show "+X more" indicators for different screen sizes
                  if ($entity_count > $mobile_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--mobile">+' . ($entity_count - $mobile_limit) . ' more</span>';
                  }
                  
                  if ($entity_count > $tablet_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--tablet g-card__location-item--extra g-card__location-item--extra-md">+' . ($entity_count - $tablet_limit) . ' more</span>';
                  }
                  
                  if ($entity_count > $desktop_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--desktop g-card__location-item--extra g-card__location-item--extra-md g-card__location-item--extra-lg">+' . ($entity_count - $desktop_limit) . ' more</span>';
                  }
                  ?>
                </div>
              </div>
              <?php endif; ?>
              
              <?php if (!empty($category_data)): ?>
              <div class="g-card__tags">
                <?php 
                $category_count = count($category_data);
                $mobile_limit = 2;
                $tablet_limit = 4;
                $desktop_limit = 6;
                
                foreach ($category_data as $index => $category):
                  // Determine which responsive class to use
                  $extra_class = '';
                  if ($index >= $mobile_limit) {
                    $extra_class = 'g-card__tag--extra';
                    if ($index < $tablet_limit) {
                      $extra_class .= ' g-card__tag--extra-md';
                    } else if ($index < $desktop_limit) {
                      $extra_class .= ' g-card__tag--extra-md g-card__tag--extra-lg';
                    }
                  }
                  
                  // Output category link
                  echo '<a href="' . esc_url($category['url']) . '" class="g-card__tag ' . $extra_class . '">' . esc_html($category['name']) . '</a>';
                endforeach;
                
                // Show "+X more" indicators for different screen sizes
                if ($category_count > $mobile_limit) {
                  echo '<span class="g-card__tag g-card__tag--more g-card__tag--more-mobile">+' . ($category_count - $mobile_limit) . ' more</span>';
                }
                
                if ($category_count > $tablet_limit) {
                  echo '<span class="g-card__tag g-card__tag--more g-card__tag--more-tablet g-card__tag--extra g-card__tag--extra-md">+' . ($category_count - $tablet_limit) . ' more</span>';
                }
                
                if ($category_count > $desktop_limit) {
                  echo '<span class="g-card__tag g-card__tag--more g-card__tag--more-desktop g-card__tag--extra g-card__tag--extra-md g-card__tag--extra-lg">+' . ($category_count - $desktop_limit) . ' more</span>';
                }
                ?>
              </div>
              <?php endif; ?>
            </div>
          </div>
        </div>
        <?php
      }
      
      // Store all filter data in a global JS variable for client-side filtering
      ?>
      <script type="text/javascript">
      // <![CDATA[
        // Store grant data for client-side filtering
        var grantauraGrantsData = <?php echo json_encode($grant_data_json); ?>;
        
        // Store available filter options
        var grantauraFilterOptions = {
          categories: <?php echo json_encode($all_categories); ?>,
          locations: <?php echo json_encode($all_locations); ?>,
          eligibleEntities: <?php echo json_encode($all_eligible_entities); ?>
        };
      // ]]>
      </script>
      <?php
      
      // Calculate the total number of posts and pages for pagination
      $has_multiple_pages = $total_pages > 1;
      
      if ($has_multiple_pages) {
        ?>
        <div class="g-pagination">
          <style>
            .g-pagination {
              grid-column: 1 / -1;
              display: flex;
              justify-content: center;
              margin-top: 2.5rem;
              margin-bottom: 4.5rem;
              padding-top: 1.5rem;
              border-top: 1px solid var(--grantaura-gray-200);
              position: relative;
            }
            
            .g-pagination::before {
              content: "";
              position: absolute;
              top: -2px;
              left: 50%;
              transform: translateX(-50%);
              width: 60px;
              height: 3px;
              background: linear-gradient(90deg, var(--grantaura-primary), var(--grantaura-secondary));
            }
            
            .g-pagination__list {
              display: flex;
              list-style: none;
              padding: 0;
              margin: 0;
              gap: clamp(0.2rem, 1vw, 0.35rem);
              flex-wrap: wrap;
              justify-content: center;
            }
            
            .g-pagination__item a,
            .g-pagination__item span {
              display: inline-flex;
              align-items: center;
              justify-content: center;
              min-width: clamp(2rem, 6vw, 2.25rem);
              height: clamp(2rem, 6vw, 2.25rem);
              padding: 0 clamp(0.5rem, 2vw, 0.75rem);
              border-radius: var(--grantaura-border-radius-sm);
              font-size: clamp(0.8rem, 3vw, 0.9rem);
              font-weight: 500;
              text-decoration: none !important;
              transition: var(--grantaura-transition);
            }
            
            .g-pagination__item a {
              background-color: var(--grantaura-gray-100);
              color: var(--grantaura-gray-700) !important;
              border: 1px solid var(--grantaura-gray-200);
            }
            
            .g-pagination__item a:hover {
              background-color: var(--grantaura-primary-light);
              color: white !important;
              border-color: var(--grantaura-primary-light);
            }
            
            .g-pagination__item--current span {
              background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
              color: white;
              box-shadow: 0 3px 6px rgba(90, 59, 140, 0.2);
            }
            
            .g-pagination__item--prev a,
            .g-pagination__item--next a {
              display: flex;
              align-items: center;
              gap: 4px;
            }
            
            @media (max-width: 640px) {
              .g-pagination__list {
                padding: 0 0.5rem;
              }
              
              .g-pagination__item--prev a,
              .g-pagination__item--next a {
                padding: 0 0.5rem;
              }
              
              .g-pagination__item--prev svg,
              .g-pagination__item--next svg {
                width: 14px;
                height: 14px;
              }
            }
          </style>
          
          <ul class="g-pagination__list">
            <?php
            $current_page = max(1, get_query_var('paged'));
            $is_not_first_page = $current_page > 1;
            
            // Previous page
            if ($is_not_first_page) {
              echo '<li class="g-pagination__item g-pagination__item--prev">
                      <a href="' . esc_url(get_pagenum_link($current_page - 1)) . '">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Prev
                      </a>
                    </li>';
            }
            
            // Page numbers
            $start_page = max(1, $current_page - 2);
            $end_page = min($start_page + 4, $total_pages);
            $is_start_page_after_first = $start_page > 1;
            
            if ($is_start_page_after_first) {
              echo '<li class="g-pagination__item">
                      <a href="' . esc_url(get_pagenum_link(1)) . '">1</a>
                    </li>';
                    
              $is_gap_needed = $start_page > 2;
              if ($is_gap_needed) {
                echo '<li class="g-pagination__item g-pagination__item--dots">
                        <span>...</span>
                      </li>';
              }
            }
            
            for ($i = $start_page; $i <= $end_page; $i++) {
              $is_current = $i == $current_page;
              if ($is_current) {
                echo '<li class="g-pagination__item g-pagination__item--current">
                        <span>' . $i . '</span>
                      </li>';
              } else {
                echo '<li class="g-pagination__item">
                        <a href="' . esc_url(get_pagenum_link($i)) . '">' . $i . '</a>
                      </li>';
              }
            }
            
            $is_end_before_last = $end_page < $total_pages;
            if ($is_end_before_last) {
              $is_gap_needed = $end_page < $total_pages - 1;
              if ($is_gap_needed) {
                echo '<li class="g-pagination__item g-pagination__item--dots">
                        <span>...</span>
                      </li>';
              }
              
              echo '<li class="g-pagination__item">
                      <a href="' . esc_url(get_pagenum_link($total_pages)) . '">' . $total_pages . '</a>
                    </li>';
            }
            
            // Next page
            $is_not_last_page = $current_page < $total_pages;
            if ($is_not_last_page) {
              echo '<li class="g-pagination__item g-pagination__item--next">
                      <a href="' . esc_url(get_pagenum_link($current_page + 1)) . '">
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                      </a>
                    </li>';
            }
            ?>
          </ul>
        </div>
        <?php
      }
    } else {
      // No grants found
      ?>
      <div class="no-grants-message">
        <style>
          .no-grants-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 1.5rem;
            background-color: var(--grantaura-gray-50);
            border-radius: var(--grantaura-border-radius);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--grantaura-gray-200);
          }
          
          .no-grants-message::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--grantaura-primary), var(--grantaura-secondary));
          }
          
          .no-grants-message h3 {
            font-size: clamp(1.5rem, 5vw, 1.75rem);
            margin-bottom: 1.25rem;
            color: var(--grantaura-gray-800);
            position: relative;
            display: inline-block;
          }
          
          .no-grants-message h3::after {
            content: "";
            position: absolute;
            left: 50%;
            bottom: -10px;
            transform: translateX(-50%);
            width: 70px;
            height: 3px;
            background-color: var(--grantaura-primary-light);
          }
          
          .no-grants-message p {
            font-size: clamp(0.95rem, 4vw, 1.1rem);
            color: var(--grantaura-gray-600);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
          }
        </style>
        
        <h3>No Grants Available</h3>
        <p>We're currently updating our grants database. Please check back soon for new grant opportunities, or contact us to learn about our custom grant research services.</p>
      </div>
      <?php
    }
    [/php]
  </div>
</section>
<!-- Progressive filtering JavaScript -->
<script>
// <![CDATA[
document.addEventListener('DOMContentLoaded', function() {
  // Function to check if values in an array are all true - safer alternative to && operator
  function checkConditions(conditions) {
    for (var i = 0; i < conditions.length; i++) {
      if (!conditions[i]) {
        return false;
      }
    }
    return true;
  }
  
  // Initialize countdown timers
  function initCountdowns() {
    const countdownElements = document.querySelectorAll('[data-countdown-time]');
    
    countdownElements.forEach(function(element) {
      const deadline = parseInt(element.dataset.countdownTime, 10) * 1000;
      const countdownEl = element.querySelector('.g-card__countdown');
      
      if (!countdownEl) return;
      
      const hoursElement = countdownEl.querySelector('[data-hours]');
      const minutesElement = countdownEl.querySelector('[data-minutes]');
      const secondsElement = countdownEl.querySelector('[data-seconds]');
      
      function updateCountdown() {
        const now = new Date().getTime();
        const distance = deadline - now;
        
        if (distance <= 0) {
          // Handle expired timer
          if (hoursElement) hoursElement.textContent = '00';
          if (minutesElement) minutesElement.textContent = '00';
          if (secondsElement) secondsElement.textContent = '00';
          return;
        }
        
        // Calculate time units
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Update the elements
        if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
        if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
        if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
      }
      
      // Initial update
      updateCountdown();
      
      // Update every second
      setInterval(updateCountdown, 1000);
    });
  }
  
  // Filter Setup
  const filterToggle = document.getElementById('grants-filter-toggle');
  const filterPanel = document.getElementById('grants-filter-panel');
  const filterClose = document.getElementById('grants-filter-close');
  const filterReset = document.getElementById('grants-filter-reset');
  const filterNext = document.getElementById('grants-filter-next');
  const filterBack = document.getElementById('grants-filter-back');
  const resetFiltersBtn = document.getElementById('reset-filters-btn');
  const filterCount = document.getElementById('filter-count');
  const activeFilters = document.getElementById('grants-active-filters');
  const filterResultCount = document.getElementById('grants-filter-result-count');
  const noFilteredGrants = document.getElementById('no-filtered-grants');
  const grantsContainer = document.getElementById('grants-container');
  const grantsContainerLoading = document.getElementById('grants-container-loading');
  
  // Step navigation elements
  const filterSteps = document.querySelectorAll('.grants-filter-step');
  const filterStepContainers = document.querySelectorAll('.grants-filter-step-container');
  
  // Current active step
  let currentStep = 1;
  
  // Track active filters
  let activeFilterState = {
    status: [],
    featured: [],
    amount: {
      min: null,
      max: null,
      includeVaries: false
    },
    timeframe: [],
    eligibleEntities: [],
    categories: [],
    locations: []
  };
  
  // Helper function to show loading state
  function showLoading() {
    grantsContainerLoading.classList.add('active');
  }
  
  // Helper function to hide loading state
  function hideLoading() {
    grantsContainerLoading.classList.remove('active');
    
    // Re-initialize countdowns after filtering
    initCountdowns();
    
    // Re-initialize lazy loading for images
    handleIntersectionForVisible();
  }
  
  // Toggle filter panel
  if (filterToggle) {
    filterToggle.addEventListener('click', function() {
      filterPanel.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Initialize data for first step
      initFilterData();
      
      // Reset to first step when opening
      navigateToStep(1);
    });
  }
  
  // Close filter panel
  if (filterClose) {
    filterClose.addEventListener('click', function() {
      filterPanel.classList.remove('active');
      document.body.style.overflow = '';
    });
  }
  
  // Initialize filter data
  function initFilterData() {
    // Show loading states
    document.getElementById('eligibility-loading').classList.add('active');
    document.getElementById('category-loading').classList.add('active');
    document.getElementById('location-loading').classList.add('active');
    
    // Fetch and populate filter options
    setTimeout(function() {
      populateEligibilityOptions();
      populateCategoryOptions();
      populateLocationOptions();
      
      // Hide loading states
      document.getElementById('eligibility-loading').classList.remove('active');
      document.getElementById('category-loading').classList.remove('active');
      document.getElementById('location-loading').classList.remove('active');
    }, 300);
  }
  
  // Navigate between steps
  function navigateToStep(step) {
    // Validate step
    if (step < 1 || step > filterSteps.length) return;
    
    // Update current step
    currentStep = step;
    
    // Update step indicators
    filterSteps.forEach(function(stepEl) {
      const stepNum = parseInt(stepEl.dataset.step, 10);
      stepEl.classList.remove('active', 'completed');
      
      if (stepNum === currentStep) {
        stepEl.classList.add('active');
      } else if (stepNum < currentStep) {
        stepEl.classList.add('completed');
      }
    });
    
    // Show current step content
    filterStepContainers.forEach(function(container) {
      container.classList.remove('active');
      if (parseInt(container.dataset.stepContainer, 10) === currentStep) {
        container.classList.add('active');
      }
    });
    
    // Update navigation buttons
    filterBack.disabled = currentStep === 1;
    
    if (currentStep === filterSteps.length) {
      filterNext.textContent = 'Apply Filters';
      // Update summary view
      updateSummaryView();
      // Update matching grants count
      updateMatchingGrantsCount();
    } else {
      filterNext.textContent = 'Next';
    }
  }
  
  // Step navigation - next button
  if (filterNext) {
    filterNext.addEventListener('click', function() {
      if (currentStep === filterSteps.length) {
        // Last step - apply filters
        applyFilters();
        filterPanel.classList.remove('active');
        document.body.style.overflow = '';
      } else {
        // Go to next step
        navigateToStep(currentStep + 1);
      }
    });
  }
  
  // Step navigation - back button
  if (filterBack) {
    filterBack.addEventListener('click', function() {
      navigateToStep(currentStep - 1);
    });
  }
  
  // Step navigation - click on step indicators
  filterSteps.forEach(function(step) {
    step.addEventListener('click', function() {
      navigateToStep(parseInt(this.dataset.step, 10));
    });
  });
  
  // Update summary view in the last step
  function updateSummaryView() {
    // Amount summary
    const summaryAmount = document.getElementById('summary-amount');
    let amountSummary = '<span class="grants-filter-summary-empty">No amount filters selected</span>';
    
    if (activeFilterState.amount.min !== null || activeFilterState.amount.max !== null || activeFilterState.amount.includeVaries) {
      const parts = [];
      
      if (activeFilterState.amount.min !== null) {
        parts.push(`Minimum: $${activeFilterState.amount.min.toLocaleString()}`);
      }
      
      if (activeFilterState.amount.max !== null) {
        parts.push(`Maximum: $${activeFilterState.amount.max.toLocaleString()}`);
      }
      
      if (activeFilterState.amount.includeVaries) {
        parts.push("Including various benefits grants");
      }
      
      amountSummary = parts.join('<br>');
    }
    
    summaryAmount.innerHTML = amountSummary;
    
    // Timeframe summary
    const summaryTimeframe = document.getElementById('summary-timeframe');
    let timeframeSummary = '<span class="grants-filter-summary-empty">No timeframe filters selected</span>';
    
    if (activeFilterState.timeframe.length > 0) {
      const timeframeLabels = {
        'today': 'Ending Today',
        'week': 'Ending This Week',
        'month': 'Ending This Month',
        'quarter': 'Ending This Quarter'
      };
      
      const parts = activeFilterState.timeframe.map(function(tf) {
        return timeframeLabels[tf] || tf;
      });
      
      timeframeSummary = parts.join('<br>');
    }
    
    summaryTimeframe.innerHTML = timeframeSummary;
    
    // Eligibility summary
    const summaryEligibility = document.getElementById('summary-eligibility');
    let eligibilitySummary = '<span class="grants-filter-summary-empty">No eligibility filters selected</span>';
    
    if (activeFilterState.eligibleEntities.length > 0) {
      eligibilitySummary = activeFilterState.eligibleEntities.join('<br>');
    }
    
    summaryEligibility.innerHTML = eligibilitySummary;
    
    // Categories summary
    const summaryCategories = document.getElementById('summary-categories');
    let categoriesSummary = '<span class="grants-filter-summary-empty">No category filters selected</span>';
    
    if (activeFilterState.categories.length > 0) {
      categoriesSummary = activeFilterState.categories.join('<br>');
    }
    
    summaryCategories.innerHTML = categoriesSummary;
    
    // Locations summary
    const summaryLocations = document.getElementById('summary-locations');
    let locationsSummary = '<span class="grants-filter-summary-empty">No location filters selected</span>';
    
    if (activeFilterState.locations.length > 0) {
      locationsSummary = activeFilterState.locations.join('<br>');
    }
    
    summaryLocations.innerHTML = locationsSummary;
  }
  
  // Update matching grants count based on current filters
  function updateMatchingGrantsCount() {
    const matchingCountEl = document.getElementById('matching-grants-count');
    if (!matchingCountEl) return;
    
    // Get all grant cards
    const grantCards = document.querySelectorAll('.g-card');
    
    // Check if any filters are active
    const hasActiveFilters = 
      activeFilterState.status.length > 0 ||
      activeFilterState.featured.length > 0 ||
      activeFilterState.amount.min !== null ||
      activeFilterState.amount.max !== null ||
      activeFilterState.amount.includeVaries ||
      activeFilterState.timeframe.length > 0 ||
      activeFilterState.eligibleEntities.length > 0 ||
      activeFilterState.categories.length > 0 ||
      activeFilterState.locations.length > 0;
    
    // If no filters, show all grants count
    if (!hasActiveFilters) {
      matchingCountEl.textContent = grantCards.length;
      return;
    }
    
    // Count matches
    let matchCount = 0;
    
    grantCards.forEach(function(card) {
      // Get data from card attributes
      const status = card.dataset.status;
      const isFeatured = card.dataset.featured === 'true';
      const amount = card.dataset.amount;
      const deadlineTimestamp = card.dataset.deadline ? parseInt(card.dataset.deadline, 10) : 0;
      const locations = card.dataset.locations ? card.dataset.locations.split('|') : [];
      const categories = card.dataset.categories ? card.dataset.categories.split('|') : [];
      const eligibleEntities = card.dataset.eligibleEntities ? card.dataset.eligibleEntities.split('|') : [];
      
      // Check each filter category
      const passesStatusFilter = activeFilterState.status.length === 0 || activeFilterState.status.includes(status);
      
      const passesFeaturedFilter = activeFilterState.featured.length === 0 || 
        (activeFilterState.featured.includes('true') && isFeatured) || 
        (activeFilterState.featured.includes('false') && !isFeatured);
      
      // Amount filter logic
      let passesAmountFilter = true;
      if (amount !== 'varies') {
        const amountValue = parseInt(amount, 10);
        if (activeFilterState.amount.min !== null) {
          passesAmountFilter = passesAmountFilter && amountValue >= activeFilterState.amount.min;
        }
        if (activeFilterState.amount.max !== null) {
          passesAmountFilter = passesAmountFilter && amountValue <= activeFilterState.amount.max;
        }
      } else {
        // If "varies" and includeVaries is false, and we have min/max filters, this should not pass
        if ((activeFilterState.amount.min !== null || activeFilterState.amount.max !== null) && !activeFilterState.amount.includeVaries) {
          passesAmountFilter = false;
        }
      }
      
      // Time frame filter
      let passesTimeframeFilter = true;
      if (activeFilterState.timeframe.length > 0 && deadlineTimestamp > 0) {
        const now = Math.floor(Date.now() / 1000);
        const hasToday = activeFilterState.timeframe.includes('today');
        const hasWeek = activeFilterState.timeframe.includes('week');
        const hasMonth = activeFilterState.timeframe.includes('month');
        const hasQuarter = activeFilterState.timeframe.includes('quarter');
        
        const dayEnd = now + (24 * 60 * 60);
        const weekEnd = now + (7 * 24 * 60 * 60);
        const monthEnd = now + (30 * 24 * 60 * 60);
        const quarterEnd = now + (90 * 24 * 60 * 60);
        
        passesTimeframeFilter = false;
        
        if (hasToday && deadlineTimestamp <= dayEnd) {
          passesTimeframeFilter = true;
        } else if (hasWeek && deadlineTimestamp <= weekEnd) {
          passesTimeframeFilter = true;
        } else if (hasMonth && deadlineTimestamp <= monthEnd) {
          passesTimeframeFilter = true;
        } else if (hasQuarter && deadlineTimestamp <= quarterEnd) {
          passesTimeframeFilter = true;
        }
      }
      
      // Eligible entities filter
      const passesEligibleFilter = activeFilterState.eligibleEntities.length === 0 || 
        activeFilterState.eligibleEntities.some(entity => eligibleEntities.includes(entity));
      
      // Categories filter
      const passesCategoryFilter = activeFilterState.categories.length === 0 || 
        activeFilterState.categories.some(category => categories.includes(category));
      
      // Locations filter
      const passesLocationFilter = activeFilterState.locations.length === 0 || 
        activeFilterState.locations.some(location => locations.includes(location));
      
      // Combined filter result
      const isVisible = checkConditions([
        passesStatusFilter,
        passesFeaturedFilter,
        passesAmountFilter,
        passesTimeframeFilter,
        passesEligibleFilter,
        passesCategoryFilter,
        passesLocationFilter
      ]);
      
      if (isVisible) {
        matchCount++;
      }
    });
    
    matchingCountEl.textContent = matchCount;
  }
  
  // Populate eligibility options
  function populateEligibilityOptions() {
    const eligibilityOptions = document.getElementById('eligibility-options');
    const eligibilitySelected = document.getElementById('eligibility-selected');
    
    if (!eligibilityOptions || !eligibilitySelected) return;
    
    if (typeof grantauraFilterOptions === 'undefined' || !grantauraFilterOptions.eligibleEntities) {
      // Fallback for missing data
      eligibilityOptions.innerHTML = `
        <div class="grants-filter-no-results">
          <p>Could not load eligibility data. Please select other filter criteria or try again later.</p>
        </div>`;
      return;
    }
    
    const entities = grantauraFilterOptions.eligibleEntities;
    eligibilityOptions.innerHTML = '';
    
    // Sort entities by count (descending)
    const sortedEntities = Object.entries(entities)
      .sort((a, b) => b[1] - a[1])
      .map(([entity, count]) => ({ entity, count }));
    
    // Create option for each entity
    sortedEntities.forEach(function(item) {
      const option = document.createElement('label');
      option.className = 'grants-filter-checkbox';
      option.htmlFor = `entity-${item.entity.replace(/\s+/g, '-').toLowerCase()}`;
      option.innerHTML = `
        <input type="checkbox" id="entity-${item.entity.replace(/\s+/g, '-').toLowerCase()}" name="eligibleEntities" value="${item.entity}" data-filter-group="eligibleEntities">
        <div class="grants-filter-option-content">
          <span class="grants-filter-option-label">${item.entity}</span>
          <span class="grants-filter-option-count">${item.count}</span>
        </div>
      `;
      
      eligibilityOptions.appendChild(option);
      
      // Add event listener
      const checkbox = option.querySelector('input[type="checkbox"]');
      
      // Check if this entity is already selected
      if (activeFilterState.eligibleEntities.includes(item.entity)) {
        checkbox.checked = true;
        option.classList.add('selected');
      }
      
      checkbox.addEventListener('change', function() {
        option.classList.toggle('selected', this.checked);
        
        if (this.checked) {
          // Add to filter state
          if (!activeFilterState.eligibleEntities.includes(item.entity)) {
            activeFilterState.eligibleEntities.push(item.entity);
          }
          
          // Add chip to selected section
          addFilterChip(item.entity, 'eligibleEntities', eligibilitySelected);
        } else {
          // Remove from filter state
          const index = activeFilterState.eligibleEntities.indexOf(item.entity);
          if (index !== -1) {
            activeFilterState.eligibleEntities.splice(index, 1);
          }
          
          // Remove chip from selected section
          removeFilterChip(item.entity, eligibilitySelected);
        }
        
        // Update matching grants count
        updateMatchingGrantsCount();
      });
    });
    
    // Add search functionality
    const eligibilitySearch = document.getElementById('eligibility-search');
    if (eligibilitySearch) {
      eligibilitySearch.addEventListener('input', debounce(function() {
        filterOptions(eligibilityOptions, this.value);
      }, 200));
    }
    
    // If there are already selected items, show them
    if (activeFilterState.eligibleEntities.length > 0) {
      updateSelectedChips(activeFilterState.eligibleEntities, 'eligibleEntities', eligibilitySelected);
    }
  }
  
  // Populate category options
  function populateCategoryOptions() {
    const categoryOptions = document.getElementById('category-options');
    const categorySelected = document.getElementById('category-selected');
    
    if (!categoryOptions || !categorySelected) return;
    
    if (typeof grantauraFilterOptions === 'undefined' || !grantauraFilterOptions.categories) {
      // Fallback for missing data
      categoryOptions.innerHTML = `
        <div class="grants-filter-no-results">
          <p>Could not load category data. Please select other filter criteria or try again later.</p>
        </div>`;
      return;
    }
    
    const categories = grantauraFilterOptions.categories;
    categoryOptions.innerHTML = '';
    
    // Sort categories by name
    const sortedCategories = Object.entries(categories)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([category, data]) => ({ 
        category, 
        count: data.count, 
        slug: data.slug 
      }));
    
    // Create option for each category
    sortedCategories.forEach(function(item) {
      const option = document.createElement('label');
      option.className = 'grants-filter-checkbox';
      option.htmlFor = `category-${item.slug}`;
      option.innerHTML = `
        <input type="checkbox" id="category-${item.slug}" name="categories" value="${item.category}" data-filter-group="categories">
        <div class="grants-filter-option-content">
          <span class="grants-filter-option-label">${item.category}</span>
          <span class="grants-filter-option-count">${item.count}</span>
        </div>
      `;
      
      categoryOptions.appendChild(option);
      
      // Add event listener
      const checkbox = option.querySelector('input[type="checkbox"]');
      
      // Check if this category is already selected
      if (activeFilterState.categories.includes(item.category)) {
        checkbox.checked = true;
        option.classList.add('selected');
      }
      
      checkbox.addEventListener('change', function() {
        option.classList.toggle('selected', this.checked);
        
        if (this.checked) {
          // Add to filter state
          if (!activeFilterState.categories.includes(item.category)) {
            activeFilterState.categories.push(item.category);
          }
          
          // Add chip to selected section
          addFilterChip(item.category, 'categories', categorySelected);
        } else {
          // Remove from filter state
          const index = activeFilterState.categories.indexOf(item.category);
          if (index !== -1) {
            activeFilterState.categories.splice(index, 1);
          }
          
          // Remove chip from selected section
          removeFilterChip(item.category, categorySelected);
        }
        
        // Update matching grants count
        updateMatchingGrantsCount();
      });
    });
    
    // Add search functionality
    const categorySearch = document.getElementById('category-search');
    if (categorySearch) {
      categorySearch.addEventListener('input', debounce(function() {
        filterOptions(categoryOptions, this.value);
      }, 200));
    }
    
    // If there are already selected items, show them
    if (activeFilterState.categories.length > 0) {
      updateSelectedChips(activeFilterState.categories, 'categories', categorySelected);
    }
  }
  
  // Populate location options
  function populateLocationOptions() {
    const locationOptions = document.getElementById('location-options');
    const locationSelected = document.getElementById('location-selected');
    
    if (!locationOptions || !locationSelected) return;
    
    if (typeof grantauraFilterOptions === 'undefined' || !grantauraFilterOptions.locations) {
      // Fallback for missing data
      locationOptions.innerHTML = `
        <div class="grants-filter-no-results">
          <p>Could not load location data. Please select other filter criteria or try again later.</p>
        </div>`;
      return;
    }
    
    const locations = grantauraFilterOptions.locations;
    locationOptions.innerHTML = '';
    
    // Organize locations into groups
    const locationGroups = {
      'Global': [],
      'Regions': [],
      'Countries': [],
      'US States': [],
      'US Cities/Counties': [],
      'Other': []
    };
    
    // Helper to determine location type
    function getLocationType(location) {
      if (location.toLowerCase() === 'global' || location.toLowerCase() === 'worldwide') {
        return 'Global';
      }
      
      const regions = ['africa', 'asia', 'europe', 'north america', 'south america', 'latin america', 'caribbean', 'middle east', 'oceania'];
      if (regions.includes(location.toLowerCase())) {
        return 'Regions';
      }
      
      const countries = ['united states', 'usa', 'u.s.', 'canada', 'uk', 'united kingdom', 'mexico', 'brazil', 'colombia', 'peru', 'chile'];
      if (countries.includes(location.toLowerCase())) {
        return 'Countries';
      }
      
      const usStates = [
        'alabama', 'alaska', 'arizona', 'arkansas', 'california', 'colorado', 'connecticut', 'delaware', 
        'florida', 'georgia', 'hawaii', 'idaho', 'illinois', 'indiana', 'iowa', 'kansas', 'kentucky', 
        'louisiana', 'maine', 'maryland', 'massachusetts', 'michigan', 'minnesota', 'mississippi', 
        'missouri', 'montana', 'nebraska', 'nevada', 'new hampshire', 'new jersey', 'new mexico', 
        'new york', 'north carolina', 'north dakota', 'ohio', 'oklahoma', 'oregon', 'pennsylvania', 
        'rhode island', 'south carolina', 'south dakota', 'tennessee', 'texas', 'utah', 'vermont', 
        'virginia', 'washington', 'west virginia', 'wisconsin', 'wyoming'
      ];
      
      if (usStates.includes(location.toLowerCase())) {
        return 'US States';
      }
      
      // Check if it contains "county" or is a known city
      if (location.toLowerCase().includes('county') || 
          location.toLowerCase().includes('city') || 
          ['atlanta', 'austin', 'boston', 'chicago', 'cincinnati', 'dallas', 'denver', 'detroit', 
           'los angeles', 'miami', 'new york city', 'philadelphia', 'phoenix', 'portland', 
           'san francisco', 'seattle', 'washington dc'].includes(location.toLowerCase())) {
        return 'US Cities/Counties';
      }
      
      return 'Other';
    }
    
    // Sort locations and group them
    Object.entries(locations).forEach(([location, data]) => {
      const type = getLocationType(location);
      locationGroups[type].push({
        location,
        count: data.count,
        slug: data.slug
      });
    });
    
    // Sort locations within groups
    Object.keys(locationGroups).forEach(group => {
      locationGroups[group].sort((a, b) => a.location.localeCompare(b.location));
    });
    
    // Create a container for each group
    Object.keys(locationGroups).forEach(group => {
      if (locationGroups[group].length === 0) return;
      
      // Add group header
      const groupHeader = document.createElement('div');
      groupHeader.className = 'grants-filter-group-header';
      groupHeader.innerHTML = `<h5>${group}</h5>`;
      locationOptions.appendChild(groupHeader);
      
      // Add locations in this group
      locationGroups[group].forEach(item => {
        const option = document.createElement('label');
        option.className = 'grants-filter-checkbox';
        option.htmlFor = `location-${item.slug}`;
        option.innerHTML = `
          <input type="checkbox" id="location-${item.slug}" name="locations" value="${item.location}" data-filter-group="locations">
          <div class="grants-filter-option-content">
            <span class="grants-filter-option-label">${item.location}</span>
            <span class="grants-filter-option-count">${item.count}</span>
          </div>
        `;
        
        locationOptions.appendChild(option);
        
        // Add event listener
        const checkbox = option.querySelector('input[type="checkbox"]');
        
        // Check if this location is already selected
        if (activeFilterState.locations.includes(item.location)) {
          checkbox.checked = true;
          option.classList.add('selected');
        }
        
        checkbox.addEventListener('change', function() {
          option.classList.toggle('selected', this.checked);
          
          if (this.checked) {
            // Add to filter state
            if (!activeFilterState.locations.includes(item.location)) {
              activeFilterState.locations.push(item.location);
            }
            
            // Add chip to selected section
            addFilterChip(item.location, 'locations', locationSelected);
          } else {
            // Remove from filter state
            const index = activeFilterState.locations.indexOf(item.location);
            if (index !== -1) {
              activeFilterState.locations.splice(index, 1);
            }
            
            // Remove chip from selected section
            removeFilterChip(item.location, locationSelected);
          }
          
          // Update matching grants count
          updateMatchingGrantsCount();
        });
      });
    });
    
    // Add search functionality
    const locationSearch = document.getElementById('location-search');
    if (locationSearch) {
      locationSearch.addEventListener('input', debounce(function() {
        filterOptions(locationOptions, this.value, true);
      }, 200));
    }
    
    // Add styles for group headers
    const style = document.createElement('style');
    style.textContent = `
      .grants-filter-group-header {
        padding: 0.75rem 0.5rem 0.25rem;
        background-color: var(--grantaura-gray-50);
        border-bottom: 1px solid var(--grantaura-gray-200);
        margin-bottom: 0.5rem;
      }
      
      .grants-filter-group-header h5 {
        margin: 0;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
    `;
    document.head.appendChild(style);
    
    // If there are already selected items, show them
    if (activeFilterState.locations.length > 0) {
      updateSelectedChips(activeFilterState.locations, 'locations', locationSelected);
    }
  }
  
  // Add a filter chip to the selected section
  function addFilterChip(value, group, container) {
    if (!container) return;
    
    // Check if chip already exists
    const existingChip = container.querySelector(`[data-value="${value}"]`);
    if (existingChip) return;
    
    // Create chip
    const chip = document.createElement('div');
    chip.className = 'grants-filter-chip';
    chip.dataset.value = value;
    chip.innerHTML = `
      ${value}
      <button type="button" class="grants-filter-chip-remove" aria-label="Remove ${value}">×</button>
    `;
    
    // Add event listener to remove button
    const removeBtn = chip.querySelector('.grants-filter-chip-remove');
    removeBtn.addEventListener('click', function() {
      // Remove from filter state
      const index = activeFilterState[group].indexOf(value);
      if (index !== -1) {
        activeFilterState[group].splice(index, 1);
      }
      
      // Remove chip
      chip.remove();
      
      // Uncheck corresponding checkbox
      const checkbox = document.querySelector(`input[type="checkbox"][name="${group}"][value="${value}"]`);
      if (checkbox) {
        checkbox.checked = false;
        const optionEl = checkbox.closest('.grants-filter-checkbox');
        if (optionEl) {
          optionEl.classList.remove('selected');
        }
      }
      
      // Update matching grants count
      updateMatchingGrantsCount();
    });
    
    container.appendChild(chip);
  }
  
  // Remove a filter chip from the selected section
function removeFilterChip(value, container) {
  if (!container) return;
  
  const chip = container.querySelector(`[data-value="${value}"]`);
    if (chip) chip.remove();
  }
  
  // Update selected chips section based on current filter state
  function updateSelectedChips(values, group, container) {
    if (!container) return;
    
    // Clear existing chips
    container.innerHTML = '';
    
    // Add a chip for each value
    values.forEach(function(value) {
      addFilterChip(value, group, container);
    });
  }
  
  // Filter options based on search input
  function filterOptions(container, searchTerm, includeHeaders = false) {
    if (!container) return;
    
    const lowerSearchTerm = searchTerm.toLowerCase().trim();
    let optionsVisible = 0;
    
    // Get all checkbox options (not group headers)
    const options = container.querySelectorAll('.grants-filter-checkbox');
    
    options.forEach(function(option) {
      const label = option.querySelector('.grants-filter-option-label');
      if (!label) return;
      
      const text = label.textContent.toLowerCase();
      const matches = text.includes(lowerSearchTerm);
      
      option.style.display = matches ? '' : 'none';
      
      if (matches) {
        optionsVisible++;
        
        // Highlight matching text if there's a search term
        if (lowerSearchTerm && label.innerHTML === label.textContent) {
          const regex = new RegExp(`(${lowerSearchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
          label.innerHTML = label.textContent.replace(regex, '<span style="background-color:rgba(90,59,140,0.1);font-weight:bold;">$1</span>');
        }
      } else if (lowerSearchTerm && label.innerHTML !== label.textContent) {
        // Reset highlighting if no match
        label.innerHTML = label.textContent;
      }
    });
    
    // Handle group headers visibility if included
    if (includeHeaders) {
      const headers = container.querySelectorAll('.grants-filter-group-header');
      
      // First hide all headers
      headers.forEach(header => {
        header.style.display = 'none';
      });
      
      // Then show headers that have visible options
      options.forEach(option => {
        if (option.style.display !== 'none') {
          let prevEl = option.previousElementSibling;
          while (prevEl) {
            if (prevEl.classList.contains('grants-filter-group-header')) {
              prevEl.style.display = '';
              break;
            }
            prevEl = prevEl.previousElementSibling;
          }
        }
      });
    }
    
    // Show no results message if needed
    let noResults = container.querySelector('.grants-filter-no-results');
    
    if (optionsVisible === 0) {
      if (!noResults) {
        noResults = document.createElement('div');
        noResults.className = 'grants-filter-no-results';
        noResults.innerHTML = `
          <p>No matches found for "${searchTerm}". Try a different search term.</p>
        `;
        container.appendChild(noResults);
      } else {
        noResults.innerHTML = `
          <p>No matches found for "${searchTerm}". Try a different search term.</p>
        `;
        noResults.style.display = '';
      }
    } else if (noResults) {
      noResults.style.display = 'none';
    }
  }
  
  // Handle amount range inputs
  const amountMin = document.getElementById('amount-min');
  const amountMax = document.getElementById('amount-max');
  const amountVaries = document.getElementById('amount-varies');
  
  if (amountMin) {
    amountMin.addEventListener('input', function() {
      activeFilterState.amount.min = this.value !== '' ? parseInt(this.value, 10) : null;
      updateMatchingGrantsCount();
    });
  }
  
  if (amountMax) {
    amountMax.addEventListener('input', function() {
      activeFilterState.amount.max = this.value !== '' ? parseInt(this.value, 10) : null;
      updateMatchingGrantsCount();
    });
  }
  
  if (amountVaries) {
    amountVaries.addEventListener('change', function() {
      activeFilterState.amount.includeVaries = this.checked;
      const amountVariesLabel = document.querySelector(`label[for="${amountVaries.id}"]`);
      if (amountVariesLabel) {
        amountVariesLabel.classList.toggle('selected', this.checked);
      }
      updateMatchingGrantsCount();
    });
  }
  
  // Handle timeframe filters
  document.querySelectorAll('input[type="checkbox"][data-filter-group="timeframe"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const value = this.value;
      const isChecked = this.checked;
      const label = this.closest('.grants-filter-checkbox');
      
      if (label) {
        label.classList.toggle('selected', isChecked);
      }
      
      if (isChecked) {
        // Add to active filters
        if (!activeFilterState.timeframe.includes(value)) {
          activeFilterState.timeframe.push(value);
        }
      } else {
        // Remove from active filters
        const index = activeFilterState.timeframe.indexOf(value);
        if (index !== -1) {
          activeFilterState.timeframe.splice(index, 1);
        }
      }
      
      updateMatchingGrantsCount();
    });
  });
  
  // Reset filters
  if (filterReset) {
    filterReset.addEventListener('click', function() {
      resetFilters();
      updateMatchingGrantsCount();
    });
  }
  
  // Reset filters from no results message
  if (resetFiltersBtn) {
    resetFiltersBtn.addEventListener('click', function() {
      resetFilters();
      applyFilters();
    });
  }
  
  // Debounce function to limit how often a function is called
  function debounce(func, wait) {
    let timeout;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(function() {
        func.apply(context, args);
      }, wait);
    };
  }
  
  // Reset all filters
  function resetFilters() {
    // Reset filter state
    activeFilterState = {
      status: [],
      featured: [],
      amount: {
        min: null,
        max: null,
        includeVaries: false
      },
      timeframe: [],
      eligibleEntities: [],
      categories: [],
      locations: []
    };
    
    // Reset form inputs
    if (amountMin) amountMin.value = '';
    if (amountMax) amountMax.value = '';
    if (amountVaries) amountVaries.checked = false;
    
    // Reset checkboxes
    document.querySelectorAll('input[type="checkbox"][data-filter-group]').forEach(function(checkbox) {
      checkbox.checked = false;
      const option = checkbox.closest('.grants-filter-checkbox, .grants-filter-radio');
      if (option) option.classList.remove('selected');
    });
    
    // Clear selected chips
    document.querySelectorAll('.grants-filter-selected').forEach(function(container) {
      container.innerHTML = '';
    });
    
    // Reset filter count
    if (filterCount) {
      filterCount.textContent = '';
      filterCount.classList.remove('active');
    }
    
    // Reset filter button
    if (filterToggle) {
      filterToggle.classList.remove('active');
    }
    
    // Clear active filters display
    if (activeFilters) {
      activeFilters.innerHTML = '';
      activeFilters.classList.remove('active');
    }
    
    // Update summary view
    updateSummaryView();
  }
  
  // Apply filters
  function applyFilters() {
    showLoading();
    
    // Small delay to allow loading state to render
    setTimeout(function() {
      // Get all grant cards
      const grantCards = document.querySelectorAll('.g-card');
      
      // Count visible grants
      let visibleCount = 0;
      
      // Check if any filters are active
      const hasActiveFilters = 
        activeFilterState.status.length > 0 ||
        activeFilterState.featured.length > 0 ||
        activeFilterState.amount.min !== null ||
        activeFilterState.amount.max !== null ||
        activeFilterState.amount.includeVaries ||
        activeFilterState.timeframe.length > 0 ||
        activeFilterState.eligibleEntities.length > 0 ||
        activeFilterState.categories.length > 0 ||
        activeFilterState.locations.length > 0;
      
      // Update filter count badge
      const totalActiveFilters = 
        activeFilterState.status.length +
        activeFilterState.featured.length +
        (activeFilterState.amount.min !== null ? 1 : 0) +
        (activeFilterState.amount.max !== null ? 1 : 0) +
        (activeFilterState.amount.includeVaries ? 1 : 0) +
        activeFilterState.timeframe.length +
        activeFilterState.eligibleEntities.length +
        activeFilterState.categories.length +
        activeFilterState.locations.length;
      
      if (filterCount) {
        if (totalActiveFilters > 0) {
          filterCount.textContent = totalActiveFilters;
          filterCount.classList.add('active');
          filterToggle.classList.add('active');
        } else {
          filterCount.textContent = '';
          filterCount.classList.remove('active');
          filterToggle.classList.remove('active');
        }
      }
      
      // Generate active filters display
      generateActiveFiltersDisplay();
      
      // If no filters active, show all grants
      if (!hasActiveFilters) {
        grantCards.forEach(function(card) {
          card.style.display = '';
          visibleCount++;
        });
      } else {
        // Apply filters to each grant card
        grantCards.forEach(function(card) {
          // Get data from card attributes
          const status = card.dataset.status;
          const isFeatured = card.dataset.featured === 'true';
          const amount = card.dataset.amount;
          const deadlineTimestamp = card.dataset.deadline ? parseInt(card.dataset.deadline, 10) : 0;
          const locations = card.dataset.locations ? card.dataset.locations.split('|') : [];
          const categories = card.dataset.categories ? card.dataset.categories.split('|') : [];
          const eligibleEntities = card.dataset.eligibleEntities ? card.dataset.eligibleEntities.split('|') : [];
          
          // Check each filter category
          const passesStatusFilter = activeFilterState.status.length === 0 || activeFilterState.status.includes(status);
          
          const passesFeaturedFilter = activeFilterState.featured.length === 0 || 
            (activeFilterState.featured.includes('true') && isFeatured) || 
            (activeFilterState.featured.includes('false') && !isFeatured);
          
          // Amount filter logic
          let passesAmountFilter = true;
          if (amount !== 'varies') {
            const amountValue = parseInt(amount, 10);
            if (activeFilterState.amount.min !== null) {
              passesAmountFilter = passesAmountFilter && amountValue >= activeFilterState.amount.min;
            }
            if (activeFilterState.amount.max !== null) {
              passesAmountFilter = passesAmountFilter && amountValue <= activeFilterState.amount.max;
            }
          } else {
            // If "varies" and includeVaries is false, and we have min/max filters, this should not pass
            if ((activeFilterState.amount.min !== null || activeFilterState.amount.max !== null) && !activeFilterState.amount.includeVaries) {
              passesAmountFilter = false;
            }
          }
          
          // Time frame filter
          let passesTimeframeFilter = true;
          if (activeFilterState.timeframe.length > 0 && deadlineTimestamp > 0) {
            const now = Math.floor(Date.now() / 1000);
            const hasToday = activeFilterState.timeframe.includes('today');
            const hasWeek = activeFilterState.timeframe.includes('week');
            const hasMonth = activeFilterState.timeframe.includes('month');
            const hasQuarter = activeFilterState.timeframe.includes('quarter');
            
            const dayEnd = now + (24 * 60 * 60);
            const weekEnd = now + (7 * 24 * 60 * 60);
            const monthEnd = now + (30 * 24 * 60 * 60);
            const quarterEnd = now + (90 * 24 * 60 * 60);
            
            passesTimeframeFilter = false;
            
            if (hasToday && deadlineTimestamp <= dayEnd) {
              passesTimeframeFilter = true;
            } else if (hasWeek && deadlineTimestamp <= weekEnd) {
              passesTimeframeFilter = true;
            } else if (hasMonth && deadlineTimestamp <= monthEnd) {
              passesTimeframeFilter = true;
            } else if (hasQuarter && deadlineTimestamp <= quarterEnd) {
              passesTimeframeFilter = true;
            }
          }
          
          // Eligible entities filter
          const passesEligibleFilter = activeFilterState.eligibleEntities.length === 0 || 
            activeFilterState.eligibleEntities.some(entity => eligibleEntities.includes(entity));
          
          // Categories filter
          const passesCategoryFilter = activeFilterState.categories.length === 0 || 
            activeFilterState.categories.some(category => categories.includes(category));
          
          // Locations filter
          const passesLocationFilter = activeFilterState.locations.length === 0 || 
            activeFilterState.locations.some(location => locations.includes(location));
          
          // Combined filter result
          const isVisible = checkConditions([
            passesStatusFilter,
            passesFeaturedFilter,
            passesAmountFilter,
            passesTimeframeFilter,
            passesEligibleFilter,
            passesCategoryFilter,
            passesLocationFilter
          ]);
          
          // Update card visibility
          card.style.display = isVisible ? '' : 'none';
          
          if (isVisible) {
            visibleCount++;
          }
        });
      }
      
      // Update result count
      if (filterResultCount) {
        if (hasActiveFilters) {
          filterResultCount.innerHTML = `Showing <strong>${visibleCount}</strong> matching grant${visibleCount !== 1 ? 's' : ''}`;
        } else {
          filterResultCount.innerHTML = 'Showing all grants';
        }
      }
      
      // Show/hide no results message
      if (noFilteredGrants) {
        if (visibleCount === 0 && hasActiveFilters) {
          noFilteredGrants.classList.add('active');
        } else {
          noFilteredGrants.classList.remove('active');
        }
      }
      
      hideLoading();
    }, 300);
  }
  
  // Generate active filters display for main page
  function generateActiveFiltersDisplay() {
    if (!activeFilters) return;
    
    // Clear current active filters
    activeFilters.innerHTML = '';
    
    // Track if we have any active filters
    let hasActiveFilters = false;
    
    // Amount filters
    if (activeFilterState.amount.min !== null) {
      hasActiveFilters = true;
      addActiveFilterTag('Min Amount', '$' + activeFilterState.amount.min.toLocaleString(), 'amount', 'min');
    }
    
    if (activeFilterState.amount.max !== null) {
      hasActiveFilters = true;
      addActiveFilterTag('Max Amount', '$' + activeFilterState.amount.max.toLocaleString(), 'amount', 'max');
    }
    
    if (activeFilterState.amount.includeVaries) {
      hasActiveFilters = true;
      addActiveFilterTag('Amount', 'Include Various Benefits', 'amount', 'varies');
    }
    
    // Timeframe filters
    activeFilterState.timeframe.forEach(function(timeframe) {
      hasActiveFilters = true;
      let timeframeLabel = '';
      
      switch(timeframe) {
        case 'today':
          timeframeLabel = 'Ending Today';
          break;
        case 'week':
          timeframeLabel = 'Ending This Week';
          break;
        case 'month':
          timeframeLabel = 'Ending This Month';
          break;
        case 'quarter':
          timeframeLabel = 'Ending This Quarter';
          break;
      }
      
      addActiveFilterTag('Timeframe', timeframeLabel, 'timeframe', timeframe);
    });
    
    // Eligible entities filters
    activeFilterState.eligibleEntities.forEach(function(entity) {
      hasActiveFilters = true;
      addActiveFilterTag('Eligible', entity, 'eligibleEntities', entity);
    });
    
    // Categories filters
    activeFilterState.categories.forEach(function(category) {
      hasActiveFilters = true;
      addActiveFilterTag('Category', category, 'categories', category);
    });
    
    // Locations filters
    activeFilterState.locations.forEach(function(location) {
      hasActiveFilters = true;
      addActiveFilterTag('Location', location, 'locations', location);
    });
    
    // Show/hide active filters container
    if (hasActiveFilters) {
      activeFilters.classList.add('active');
    } else {
      activeFilters.classList.remove('active');
    }
  }
  
  // Add active filter tag to main display
  function addActiveFilterTag(type, value, filterGroup, filterValue) {
    const tag = document.createElement('div');
    tag.className = 'grants-active-filter';
    tag.innerHTML = `
      <strong>${type}:</strong> ${value}
      <button type="button" class="grants-active-filter-remove" data-filter-group="${filterGroup}" data-filter-value="${filterValue}" aria-label="Remove ${type} filter: ${value}">×</button>
    `;
    activeFilters.appendChild(tag);
    
    // Add event listener to remove button
    const removeBtn = tag.querySelector('.grants-active-filter-remove');
    removeBtn.addEventListener('click', function() {
      removeActiveFilter(this.dataset.filterGroup, this.dataset.filterValue);
    });
  }
  
  // Remove active filter
  function removeActiveFilter(filterGroup, filterValue) {
    if (filterGroup === 'amount') {
      if (filterValue === 'min') {
        activeFilterState.amount.min = null;
        if (amountMin) amountMin.value = '';
      } else if (filterValue === 'max') {
        activeFilterState.amount.max = null;
        if (amountMax) amountMax.value = '';
      } else if (filterValue === 'varies') {
        activeFilterState.amount.includeVaries = false;
        if (amountVaries) amountVaries.checked = false;
        const amountVariesLabel = document.querySelector(`label[for="${amountVaries.id}"]`);
        if (amountVariesLabel) {
          amountVariesLabel.classList.remove('selected');
        }
      }
    } else {
      const index = activeFilterState[filterGroup].indexOf(filterValue);
      if (index !== -1) {
        activeFilterState[filterGroup].splice(index, 1);
        
        // Uncheck corresponding checkbox
        const checkbox = document.querySelector(`input[type="checkbox"][data-filter-group="${filterGroup}"][value="${filterValue}"]`);
        if (checkbox) {
          checkbox.checked = false;
          const option = checkbox.closest('.grants-filter-checkbox');
          if (option) option.classList.remove('selected');
        }
        
        // Remove filter chip from step view
        let chipContainer;
        switch(filterGroup) {
          case 'eligibleEntities':
            chipContainer = document.getElementById('eligibility-selected');
            break;
          case 'categories':
            chipContainer = document.getElementById('category-selected');
            break;
          case 'locations':
            chipContainer = document.getElementById('location-selected');
            break;
        }
        
        if (chipContainer) {
          removeFilterChip(filterValue, chipContainer);
        }
      }
    }
    
    // Reapply filters
    applyFilters();
  }
  
  // Improve performance by loading only currently visible cards
  function handleIntersection(entries, observer) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const card = entry.target;
        const images = card.querySelectorAll('img[loading="lazy"]');
        
        images.forEach(function(img) {
          // Replace lazy loading with eager for visible cards
          img.loading = 'eager';
          
          // Prefetch next image if available
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
          }
        });
        
        // Stop observing this card
        observer.unobserve(card);
      }
    });
  }
  
  // Function to handle intersection for currently visible cards
  function handleIntersectionForVisible() {
    const visibleCards = document.querySelectorAll('.g-card[style=""]');
    visibleCards.forEach(function(card) {
      const images = card.querySelectorAll('img[loading="lazy"]');
      
      images.forEach(function(img) {
        img.loading = 'eager';
        
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
        }
      });
    });
  }
  
  // Set up intersection observer for lazy loading
  if ('IntersectionObserver' in window) {
    const cardObserver = new IntersectionObserver(handleIntersection, {
      rootMargin: '200px', // Load images when they're 200px from entering viewport
      threshold: 0.1
    });
    
    // Observe all cards
    document.querySelectorAll('.g-card').forEach(function(card) {
      cardObserver.observe(card);
    });
  } else {
    // Fallback for browsers without IntersectionObserver support
    document.querySelectorAll('.g-card img[loading="lazy"]').forEach(function(img) {
      img.loading = 'eager';
    });
  }
  
  // Add accessibility improvements
  function improveAccessibility() {
    // Make clickable tags accessible via keyboard
    document.querySelectorAll('.g-card__tag, .g-card__location-link').forEach(function(element) {
      element.setAttribute('role', 'link');
      if (!element.getAttribute('tabindex')) {
        element.setAttribute('tabindex', '0');
      }
    });
    
    // Make filter steps accessible
    document.querySelectorAll('.grants-filter-step').forEach(function(step) {
      step.setAttribute('tabindex', '0');
      step.setAttribute('role', 'button');
      
      step.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          navigateToStep(parseInt(this.dataset.step, 10));
        }
      });
    });
  }
  
  // Initialize countdowns
  initCountdowns();
  
  // Run accessibility improvements
  improveAccessibility();
});
// ]]>
</script>
