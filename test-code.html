<section class="grants-listing-section" data-section-id="grants-main-listing">
  <style>
    .grants-listing-section {
      max-width: 98%; /* Increased from var(--grantaura-max-width) to take more width */
      margin: 0 auto;
      padding: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
      background-color: var(--grantaura-gray-50);
      position: relative;
    }
    
    @media (min-width: 640px) {
      .grants-listing-section {
        padding: 1rem;
      }
    }
    
    @media (min-width: 768px) {
      .grants-listing-section {
        padding: 1.5rem;
        max-width: 96%; /* Further adjusted for medium screens */
      }
    }
    
    @media (min-width: 1280px) {
      .grants-listing-section {
        max-width: 95%; /* Adjusted for large screens */
      }
    }
    
    @media (min-width: 1600px) {
      .grants-listing-section {
        max-width: 90%; /* For very large screens, allow some margin but use more space */
      }
    }
  </style>
  
  <!-- Progressive Filter System -->
  <div class="grants-filter-container">
    <style>
      .grants-filter-container {
        width: 100%;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 100;
      }
      
      /* Primary Filter Button */
      .grants-filter-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
        color: white !important;
        border: none;
        padding: 0.75rem 1.25rem;
        border-radius: var(--grantaura-border-radius);
        font-weight: 600;
        font-size: clamp(0.85rem, 3vw, 0.95rem);
        cursor: pointer;
        transition: var(--grantaura-transition);
        box-shadow: var(--grantaura-box-shadow);
        position: relative;
        overflow: hidden;
      }
      
      .grants-filter-button:hover {
        box-shadow: var(--grantaura-box-shadow-lg);
        transform: translateY(-2px);
      }
      
      .grants-filter-button::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
      
      .grants-filter-button:hover::after {
        opacity: 1;
      }
      
      .grants-filter-button.active {
        background: var(--grantaura-secondary);
      }
      
      .grants-filter-button .filter-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--grantaura-secondary-light);
        color: var(--grantaura-primary-dark);
        font-size: 0.7rem;
        font-weight: 700;
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        margin-left: 0.25rem;
        transform: scale(0);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      
      .grants-filter-button .filter-count.active {
        transform: scale(1);
      }

      /* Filter Panel - Progressive Design */
      .grants-filter-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 200;
        display: none;
        flex-direction: column;
        overflow: hidden;
      }
      
      .grants-filter-panel.active {
        display: flex;
      }
      
      .grants-filter-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--grantaura-gray-200);
        background: linear-gradient(to right, var(--grantaura-gray-50), white);
        position: sticky;
        top: 0;
        z-index: 5;
      }
      
      .grants-filter-panel-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .grants-filter-panel-title svg {
        width: 18px;
        height: 18px;
        color: var(--grantaura-primary);
      }
      
      .grants-filter-close {
        background: transparent;
        border: none;
        color: var(--grantaura-gray-700);
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-close:hover {
        background-color: var(--grantaura-gray-200);
        color: var(--grantaura-primary);
      }
      
      /* Progress indicator */
      .grants-filter-progress {
        display: flex;
        padding: 0.75rem 1rem;
        overflow-x: auto;
        background-color: var(--grantaura-gray-50);
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
        position: relative;
      }
      
      .grants-filter-progress::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }
      
      .grants-filter-progress::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--grantaura-gray-200);
        z-index: 1;
      }
      
      .grants-filter-progress-steps {
        display: flex;
        gap: 0.5rem;
        position: relative;
        z-index: 2;
      }
      
      .grants-filter-step {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 0.85rem;
        border-radius: var(--grantaura-border-radius);
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
        position: relative;
        cursor: pointer;
        color: var(--grantaura-gray-600);
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-step::after {
        content: "";
        position: absolute;
        bottom: -0.75rem;
        left: 0;
        right: 0;
        height: 3px;
        background: transparent;
        border-radius: 3px 3px 0 0;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-step svg {
        width: 16px;
        height: 16px;
      }
      
      .grants-filter-step.active {
        color: var(--grantaura-primary);
        font-weight: 600;
      }
      
      .grants-filter-step.active::after {
        background: var(--grantaura-primary);
      }
      
      .grants-filter-step.completed {
        color: var(--grantaura-success);
      }
      
      .grants-filter-step.completed::after {
        background: var(--grantaura-success);
      }
      
      .grants-filter-step-separator {
        display: flex;
        align-items: center;
        color: var(--grantaura-gray-400);
        padding: 0 0.3rem;
      }
      
      /* Step content area */
      .grants-filter-step-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }
      
      .grants-filter-step-container {
        display: none;
        flex-direction: column;
        gap: 1.25rem;
      }
      
      .grants-filter-step-container.active {
        display: flex;
      }
      
      .grants-filter-step-heading {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        margin: 0 0 0.5rem;
      }
      
      .grants-filter-step-description {
        font-size: 0.85rem;
        color: var(--grantaura-gray-600);
        margin: 0 0 1.25rem;
        line-height: 1.5;
      }
      
      /* Filter options styling */
      .grants-filter-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      /* Radio/Checkbox style options */
      .grants-filter-checkbox, 
      .grants-filter-radio {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: var(--grantaura-border-radius);
        transition: var(--grantaura-transition);
        border: 1px solid var(--grantaura-gray-200);
        background-color: white;
      }
      
      .grants-filter-checkbox:hover,
      .grants-filter-radio:hover {
        border-color: var(--grantaura-primary-light);
        background-color: rgba(90, 59, 140, 0.02);
      }
      
      .grants-filter-checkbox.selected,
      .grants-filter-radio.selected {
        border-color: var(--grantaura-primary);
        background-color: rgba(90, 59, 140, 0.05);
      }
      
      .grants-filter-checkbox input[type="checkbox"],
      .grants-filter-radio input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid var(--grantaura-gray-400);
        outline: none;
        cursor: pointer;
        position: relative;
        transition: var(--grantaura-transition);
        background-color: white;
        flex-shrink: 0;
        margin-top: 0.25rem;
      }
      
      .grants-filter-checkbox input[type="checkbox"] {
        border-radius: 4px;
      }
      
      .grants-filter-radio input[type="radio"] {
        border-radius: 50%;
      }
      
      .grants-filter-checkbox input[type="checkbox"]:checked,
      .grants-filter-radio input[type="radio"]:checked {
        background-color: var(--grantaura-primary);
        border-color: var(--grantaura-primary);
      }
      
      .grants-filter-checkbox input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 5px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }
      
      .grants-filter-radio input[type="radio"]:checked::after {
        content: "";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: white;
      }
      
      .grants-filter-option-content {
        flex: 1;
      }
      
      .grants-filter-option-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--grantaura-gray-800);
        margin-bottom: 0.25rem;
      }
      
      .grants-filter-option-description {
        font-size: 0.8rem;
        color: var(--grantaura-gray-600);
        line-height: 1.5;
      }
      
      .grants-filter-option-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        background-color: var(--grantaura-gray-100);
        color: var(--grantaura-gray-600);
        padding: 0.2rem 0.4rem;
        border-radius: 12px;
        margin-left: 0.5rem;
      }
      
      /* Range filter */
      .grants-filter-range-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid var(--grantaura-gray-200);
        border-radius: var(--grantaura-border-radius);
        background-color: white;
      }
      
      .grants-filter-range-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--grantaura-gray-800);
        margin: 0 0 0.5rem;
      }
      
      .grants-filter-range-inputs {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      
      .grants-filter-range-group {
        flex: 1;
      }
      
      .grants-filter-range-label {
        display: block;
        font-size: 0.8rem;
        color: var(--grantaura-gray-600);
        margin-bottom: 0.35rem;
      }
      
      .grants-filter-range-inputs input {
        width: 100%;
        padding: 0.6rem 0.75rem !important;
        border: 1px solid var(--grantaura-gray-300);
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.9rem;
        outline: none;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-range-inputs input:focus {
        border-color: var(--grantaura-primary);
        box-shadow: 0 0 0 2px rgba(90, 59, 140, 0.1);
      }
      
      .grants-filter-range-inputs span {
        color: var(--grantaura-gray-500);
        font-size: 0.9rem;
      }
      
      /* Search options */
      .grants-filter-search {
        position: relative;
        margin-bottom: 1rem;
      }
      
      .grants-filter-search input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem !important;
        border: 1px solid var(--grantaura-gray-300);
        border-radius: var(--grantaura-border-radius);
        font-size: 0.9rem;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-search input:focus {
        border-color: var(--grantaura-primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(90, 59, 140, 0.1);
      }
      
      .grants-filter-search svg {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: var(--grantaura-gray-400);
        pointer-events: none;
      }
      
      /* Filter chips for selected options */
      .grants-filter-selected {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      
      .grants-filter-chip {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        background-color: rgba(90, 59, 140, 0.08);
        border: 1px solid rgba(90, 59, 140, 0.15);
        border-radius: 20px;
        padding: 0.35rem 0.65rem 0.35rem 0.75rem;
        font-size: 0.75rem;
        color: var(--grantaura-primary-dark);
        font-weight: 500;
      }
      
      .grants-filter-chip-remove {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background-color: rgba(90, 59, 140, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 0.7rem;
        cursor: pointer;
        border: none;
        padding: 0;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-chip-remove:hover {
        background-color: var(--grantaura-primary);
      }
      
      .grants-filter-no-results {
        padding: 1.5rem;
        text-align: center;
        color: var(--grantaura-gray-600);
        font-size: 0.9rem;
        background-color: var(--grantaura-gray-50);
        border-radius: var(--grantaura-border-radius);
        margin-top: 1rem;
      }
      
      /* Filter Panel Footer */
      .grants-filter-panel-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--grantaura-gray-200);
        background-color: white;
        position: sticky;
        bottom: 0;
        z-index: 5;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
      
      .grants-filter-panel-actions {
        display: flex;
        gap: 0.75rem;
      }
      
      .grants-filter-secondary-btn {
        background: transparent;
        border: 1px solid var(--grantaura-gray-300);
        color: var(--grantaura-gray-700);
        padding: 0.65rem 1rem;
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-secondary-btn:hover {
        background-color: var(--grantaura-gray-100);
        color: var(--grantaura-gray-900);
      }
      
      .grants-filter-primary-btn {
        background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
        border: none;
        color: white;
        padding: 0.65rem 1.25rem;
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--grantaura-transition);
        position: relative;
        overflow: hidden;
      }
      
      .grants-filter-primary-btn:hover {
        box-shadow: 0 2px 8px rgba(90, 59, 140, 0.3);
      }
      
      .grants-filter-primary-btn::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
      
      .grants-filter-primary-btn:hover::after {
        opacity: 1;
      }
      
      .grants-filter-primary-btn:disabled,
      .grants-filter-secondary-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      
      .grants-filter-result-count {
        font-size: 0.85rem;
        color: var(--grantaura-gray-700);
      }
      
      .grants-filter-result-count strong {
        color: var(--grantaura-primary);
      }

      /* Group headers for locations and categories */
      .grants-filter-group-header {
        padding: 0.75rem 0.5rem 0.25rem;
        background-color: var(--grantaura-gray-50);
        border-bottom: 1px solid var(--grantaura-gray-200);
        margin-bottom: 0.5rem;
      }
      
      .grants-filter-group-header h5 {
        margin: 0;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .grants-filter-subitem {
        padding-left: 1.5rem;
        position: relative;
      }
      
      .grants-filter-subitem::before {
        content: "â””";
        position: absolute;
        left: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--grantaura-gray-400);
        font-size: 0.75rem;
      }
      
      /* Active filters display */
      .grants-active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
        transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        max-height: 0;
        opacity: 0;
        margin: 0;
        overflow: hidden;
      }
      
      .grants-active-filters.active {
        max-height: 300px;
        opacity: 1;
        margin-top: 1rem;
        margin-bottom: 1rem;
      }
      
      .grants-active-filter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--grantaura-gray-100);
        border: 1px solid var(--grantaura-gray-200);
        padding: 0.25rem 0.75rem;
        border-radius: var(--grantaura-border-radius-sm);
        font-size: 0.8rem;
        color: var(--grantaura-gray-800);
        transition: var(--grantaura-transition);
      }
      
      .grants-active-filter strong {
        color: var(--grantaura-primary);
        margin-right: 0.25rem;
      }
      
      .grants-active-filter-remove {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--grantaura-gray-300);
        border-radius: 50%;
        cursor: pointer;
        color: white;
        font-size: 0.7rem;
        transition: var(--grantaura-transition);
        border: none;
        padding: 0;
        margin-left: 0.25rem;
      }
      
      .grants-active-filter-remove:hover {
        background-color: var(--grantaura-danger);
      }
      
      .grants-active-filter:hover {
        background-color: var(--grantaura-gray-200);
      }

      /* Loading state */
      .grants-filter-loading {
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 50;
        backdrop-filter: blur(3px);
      }
      
      .grants-filter-loading.active {
        display: flex;
      }
      
      .grants-filter-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--grantaura-gray-200);
        border-top-color: var(--grantaura-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      /* Summary view in the last step */
      .grants-filter-summary {
        padding: 1rem;
        border: 1px solid var(--grantaura-gray-200);
        border-radius: var(--grantaura-border-radius);
        background-color: white;
      }
      
      .grants-filter-summary-section {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--grantaura-gray-100);
      }
      
      .grants-filter-summary-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      
      .grants-filter-summary-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark);
        margin: 0 0 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
      }
      
      .grants-filter-summary-title svg {
        width: 16px;
        height: 16px;
        color: var(--grantaura-primary);
      }
      
      .grants-filter-summary-content {
        font-size: 0.85rem;
        color: var(--grantaura-gray-700);
      }
      
      .grants-filter-summary-empty {
        font-style: italic;
        color: var(--grantaura-gray-500);
      }
      
      .grants-filter-match-count {
        margin-top: 1.25rem;
        padding: 1rem;
        background-color: rgba(90, 59, 140, 0.05);
        border-radius: var(--grantaura-border-radius);
        text-align: center;
      }
      
      .grants-filter-match-count strong {
        font-size: 1.1rem;
        color: var(--grantaura-primary-dark);
        font-weight: 700;
      }
      
      .grants-filter-match-label {
        font-size: 0.85rem;
        color: var(--grantaura-gray-600);
        margin-top: 0.25rem;
      }
      
      /* See more/less button for grouped options */
      .grants-filter-toggle-more {
        display: inline-block;
        margin-top: 0.75rem;
        font-size: 0.8rem;
        color: var(--grantaura-primary);
        cursor: pointer;
        font-weight: 500;
        text-decoration: none !important;
        border-bottom: 1px dashed var(--grantaura-primary-light);
        transition: var(--grantaura-transition);
      }
      
      .grants-filter-toggle-more:hover {
        color: var(--grantaura-primary-dark);
        border-bottom-color: var(--grantaura-primary-dark);
      }
      
      .grants-filter-toggle-more-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        vertical-align: middle;
        margin-right: 0.25rem;
      }
      
      /* Responsive adjustments */
      @media (min-width: 768px) {
        .grants-filter-step-content {
          padding: 1.5rem;
        }
        
        .grants-filter-options {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
        }
        
        .grants-filter-range-container {
          grid-column: 1 / -1;
        }
        
        .grants-filter-summary {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }
        
        .grants-filter-summary-section {
          margin-bottom: 0;
          padding-bottom: 0;
          border-bottom: none;
        }
        
        .grants-filter-match-count {
          grid-column: 1 / -1;
        }
      }
      
      @media (min-width: 1024px) {
        .grants-filter-options {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .grants-filter-summary {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      
      /* Animations */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      
      /* Reduce motion based on user preference */
      @media (prefers-reduced-motion: reduce) {
        .grants-filter-button,
        .grants-filter-panel,
        .grants-filter-checkbox input[type="checkbox"],
        .grants-filter-radio input[type="radio"],
        .grants-filter-loading-spinner {
          transition: none;
          animation: none;
        }
      }
    </style>
    
    <!-- Filter Button -->
    <button type="button" class="grants-filter-button" id="grants-filter-toggle" aria-label="Toggle grant filters">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
      Filter Grants
      <span class="filter-count" id="filter-count"></span>
    </button>
    
    <!-- Active Filters Display -->
    <div class="grants-active-filters" id="grants-active-filters"></div>
    
    <!-- Progressive Filter Panel -->
    <div class="grants-filter-panel" id="grants-filter-panel">
      <div class="grants-filter-panel-header">
        <h3 class="grants-filter-panel-title">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          Find Your Perfect Grant
        </h3>
        <button type="button" class="grants-filter-close" id="grants-filter-close" aria-label="Close filters panel">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <!-- Progress Steps -->
      <div class="grants-filter-progress">
        <div class="grants-filter-progress-steps">
          <div class="grants-filter-step active" data-step="1">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Amount
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="2">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Timeframe
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="3">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Eligibility
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="4">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
              <polyline points="2 17 12 22 22 17"></polyline>
              <polyline points="2 12 12 17 22 12"></polyline>
            </svg>
            Categories
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="5">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            Locations
          </div>
          
          <div class="grants-filter-step-separator">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          
          <div class="grants-filter-step" data-step="6">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Summary
          </div>
        </div>
      </div>
      
      <!-- Step Content Area -->
      <div class="grants-filter-step-content">
        <!-- Step 1: Amount -->
        <div class="grants-filter-step-container active" data-step-container="1">
          <h4 class="grants-filter-step-heading">Grant Amount</h4>
          <p class="grants-filter-step-description">Filter grants based on your funding needs. You can specify a minimum and maximum amount, or include grants with non-monetary or variable benefits.</p>
          
          <div class="grants-filter-range-container">
            <div class="grants-filter-range-title">Funding Range</div>
            <div class="grants-filter-range-inputs">
              <div class="grants-filter-range-group">
                <label class="grants-filter-range-label" for="amount-min">Minimum Amount</label>
                <input type="number" id="amount-min" placeholder="$0" min="0" data-filter-group="amount">
              </div>
              <span>to</span>
              <div class="grants-filter-range-group">
                <label class="grants-filter-range-label" for="amount-max">Maximum Amount</label>
                <input type="number" id="amount-max" placeholder="No limit" min="0" data-filter-group="amount">
              </div>
            </div>
          </div>
          
          <div class="grants-filter-options">
            <label class="grants-filter-checkbox" for="amount-varies">
              <input type="checkbox" id="amount-varies" name="amount" value="varies" data-filter-group="amount">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Include "Various Benefits" Grants</span>
                <p class="grants-filter-option-description">Include grants that offer non-monetary benefits or have variable funding amounts</p>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Step 2: Timeframe -->
        <div class="grants-filter-step-container" data-step-container="2">
          <h4 class="grants-filter-step-heading">Grant Timeframe</h4>
          <p class="grants-filter-step-description">Filter grants by their deadline. Select one or more options to see grants ending within those time periods.</p>
          
          <div class="grants-filter-options">
            <label class="grants-filter-checkbox" for="timeframe-today">
              <input type="checkbox" id="timeframe-today" name="timeframe" value="today" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending Today</span>
                <p class="grants-filter-option-description">Grants with deadlines within the next 24 hours</p>
                <span class="grants-filter-option-count" data-dynamic-count="timeframe-today">0</span>
              </div>
            </label>
            
            <label class="grants-filter-checkbox" for="timeframe-week">
              <input type="checkbox" id="timeframe-week" name="timeframe" value="week" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending This Week</span>
                <p class="grants-filter-option-description">Grants with deadlines in the next 7 days</p>
                <span class="grants-filter-option-count" data-dynamic-count="timeframe-week">0</span>
              </div>
            </label>
            
            <label class="grants-filter-checkbox" for="timeframe-month">
              <input type="checkbox" id="timeframe-month" name="timeframe" value="month" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending This Month</span>
                <p class="grants-filter-option-description">Grants with deadlines in the next 30 days</p>
                <span class="grants-filter-option-count" data-dynamic-count="timeframe-month">0</span>
              </div>
            </label>
            
            <label class="grants-filter-checkbox" for="timeframe-quarter">
              <input type="checkbox" id="timeframe-quarter" name="timeframe" value="quarter" data-filter-group="timeframe">
              <div class="grants-filter-option-content">
                <span class="grants-filter-option-label">Ending This Quarter</span>
                <p class="grants-filter-option-description">Grants with deadlines in the next 90 days</p>
                <span class="grants-filter-option-count" data-dynamic-count="timeframe-quarter">0</span>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Step 3: Eligibility -->
        <div class="grants-filter-step-container" data-step-container="3">
          <h4 class="grants-filter-step-heading">Eligibility Requirements</h4>
          <p class="grants-filter-step-description">Filter by who can apply. Select the entities that match your profile to find grants you're eligible for.</p>
          
          <div class="grants-filter-search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="eligibility-search" placeholder="Search eligible entities..." aria-label="Search eligible entities">
          </div>
          
          <div id="eligibility-loading" class="grants-filter-loading">
            <div class="grants-filter-loading-spinner"></div>
          </div>
          
          <div class="grants-filter-options" id="eligibility-options">
            <!-- Dynamically populated via JavaScript -->
          </div>
          
          <div class="grants-filter-selected" id="eligibility-selected"></div>
        </div>
        
        <!-- Step 4: Categories -->
        <div class="grants-filter-step-container" data-step-container="4">
          <h4 class="grants-filter-step-heading">Grant Categories</h4>
          <p class="grants-filter-step-description">Filter by grant type or industry. Select categories to find grants in your area of interest.</p>
          
          <div class="grants-filter-search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="category-search" placeholder="Search categories..." aria-label="Search categories">
          </div>
          
          <div id="category-loading" class="grants-filter-loading">
            <div class="grants-filter-loading-spinner"></div>
          </div>
          
          <div class="grants-filter-options" id="category-options">
            <!-- Dynamically populated via JavaScript -->
          </div>
          
          <div class="grants-filter-selected" id="category-selected"></div>
        </div>
        
        <!-- Step 5: Locations -->
        <div class="grants-filter-step-container" data-step-container="5">
          <h4 class="grants-filter-step-heading">Grant Locations</h4>
          <p class="grants-filter-step-description">Filter by geographic availability. Select locations to find grants available in your area.</p>
          
          <div class="grants-filter-search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="location-search" placeholder="Search locations..." aria-label="Search locations">
          </div>
          
          <div id="location-loading" class="grants-filter-loading">
            <div class="grants-filter-loading-spinner"></div>
          </div>
          
          <div class="grants-filter-options" id="location-options">
            <!-- Dynamically populated via JavaScript -->
          </div>
          
          <div class="grants-filter-selected" id="location-selected"></div>
        </div>
        
        <!-- Step 6: Summary -->
        <div class="grants-filter-step-container" data-step-container="6">
          <h4 class="grants-filter-step-heading">Filter Summary</h4>
          <p class="grants-filter-step-description">Review your selected filters before applying them to find grants that match your criteria.</p>
          
          <div class="grants-filter-summary">
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                Amount Range
              </h5>
              <div class="grants-filter-summary-content" id="summary-amount">
                <span class="grants-filter-summary-empty">No amount filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Timeframe
              </h5>
              <div class="grants-filter-summary-content" id="summary-timeframe">
                <span class="grants-filter-summary-empty">No timeframe filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Eligibility
              </h5>
              <div class="grants-filter-summary-content" id="summary-eligibility">
                <span class="grants-filter-summary-empty">No eligibility filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                  <polyline points="2 17 12 22 22 17"></polyline>
                  <polyline points="2 12 12 17 22 12"></polyline>
                </svg>
                Categories
              </h5>
              <div class="grants-filter-summary-content" id="summary-categories">
                <span class="grants-filter-summary-empty">No category filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-summary-section">
              <h5 class="grants-filter-summary-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                Locations
              </h5>
              <div class="grants-filter-summary-content" id="summary-locations">
                <span class="grants-filter-summary-empty">No location filters selected</span>
              </div>
            </div>
            
            <div class="grants-filter-match-count">
              <strong id="matching-grants-count">0</strong>
              <div class="grants-filter-match-label">Matching Grants</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer Actions -->
      <div class="grants-filter-panel-footer">
        <div class="grants-filter-result-count" id="grants-filter-result-count">
          Ready to filter grants
        </div>
        <div class="grants-filter-panel-actions">
          <button type="button" class="grants-filter-secondary-btn" id="grants-filter-back" disabled>
            Back
          </button>
          <button type="button" class="grants-filter-secondary-btn" id="grants-filter-reset">
            Reset All
          </button>
          <button type="button" class="grants-filter-primary-btn" id="grants-filter-next">
            Next
          </button>
        </div>
      </div>
      
      <!-- Loading Overlay -->
      <div class="grants-filter-loading" id="grants-filter-loading">
        <div class="grants-filter-loading-spinner"></div>
      </div>
    </div>
  </div>
  
  <div class="grants-container" id="grants-container">
    <style>
      .grants-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
        width: 100%;
        min-height: 300px;
        position: relative;
      }
      
      @media (min-width: 640px) {
        .grants-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }
      }
      
      @media (min-width: 1024px) {
        .grants-container {
          grid-template-columns: repeat(3, 1fr);
          gap: 1.75rem; /* Reduced gap slightly */
        }
      }
      
      @media (min-width: 1440px) {
        .grants-container {
          grid-template-columns: repeat(4, 1fr);
          gap: 1.5rem; /* Further reduced gap for 4 columns */
        }
      }
      /* No grants message */
      .no-filtered-grants {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 1.5rem;
        background-color: var(--grantaura-gray-50);
        border-radius: var(--grantaura-border-radius);
        border: 1px solid var(--grantaura-gray-200);
        display: none;
      }
      
      .no-filtered-grants.active {
        display: block;
      }
      
      .no-filtered-grants h3 {
        font-size: clamp(1.5rem, 5vw, 1.75rem);
        margin-bottom: 1.25rem;
        color: var(--grantaura-gray-800);
        position: relative;
        display: inline-block;
      }
      
      .no-filtered-grants h3::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: -10px;
        transform: translateX(-50%);
        width: 70px;
        height: 3px;
        background-color: var(--grantaura-primary-light);
      }
      
      .no-filtered-grants p {
        font-size: clamp(0.95rem, 4vw, 1.1rem);
        color: var(--grantaura-gray-600);
        max-width: 600px;
        margin: 0 auto 1.5rem;
        line-height: 1.6;
      }
      
      .no-filtered-grants button {
        background: var(--grantaura-primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--grantaura-border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--grantaura-transition);
      }
      
      .no-filtered-grants button:hover {
        background: var(--grantaura-primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--grantaura-box-shadow);
      }
      
      /* Loading overlay for grants container */
      .grants-container-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      .grants-container-loading.active {
        opacity: 1;
        pointer-events: auto;
      }
      
      .grants-container-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--grantaura-gray-200);
        border-top-color: var(--grantaura-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      /* Card styles from existing design */
      .g-card {
        display: flex;
        flex-direction: column;
        border-radius: var(--grantaura-border-radius-lg);
        overflow: hidden;
        background-color: var(--grantaura-white);
        box-shadow: var(--grantaura-box-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid var(--grantaura-gray-300);
        transform: translateY(0);
        height: 100%;
        max-height: none;
        will-change: transform, box-shadow;
        position: relative;
      }
      
      .g-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--grantaura-box-shadow-xl);
      }
      
      /* Featured card styling - UPDATED VERSION */
      .g-card--featured {
        position: relative;
        z-index: 2;
        border: none !important;
        overflow: visible !important; /* This is critical to show the border */
      }
      
      .g-card--featured::before {
        content: "";
        position: absolute;
        top: -3px;
        left: -3px;
        right: -3px;
        bottom: -8px;
        background: linear-gradient(90deg, 
          #5A3B8C 0%, 
          #FFA366 25%, 
          #FFB888 50%, 
          #FFA366 75%, 
          #5A3B8C 100%);
        border-radius: 1px 1px 15px 15px;
        z-index: -1;
        background-size: 300% 300%;
        box-shadow: 0 0 15px rgba(90, 59, 140, 0.4);
        animation: border-animation 6s ease infinite;
      }
      
      @keyframes border-animation {
        0% { background-position: 0% 0%; }
        25% { background-position: 100% 0%; }
        50% { background-position: 100% 100%; }
        75% { background-position: 0% 100%; }
        100% { background-position: 0% 0%; }
      }
      
      .g-card--featured::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--grantaura-white);
        border-radius: var(--grantaura-border-radius-lg);
        z-index: -1;
      }
      
      /* Add this keyframes definition for the border animation */
      @keyframes border-shine {
        0% {
          background-position: 100% 0;
        }
        100% {
          background-position: -100% 0;
        }
      }
      
      .g-card__img-container {
        position: relative;
        width: 100%;
        padding-bottom: 90%; /* Maintain exact 1:1 aspect ratio */
        overflow: hidden;
      }
      
      /* Crisp image loading effect */
      .g-card__img-loaded {
        opacity: 1;
        transform: scale(1);
        filter: contrast(1.05);
        transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.4s ease;
      }
      
      .g-card__img-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 1;
      }
      
      .g-card__img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transform: scale(1);
        transition: transform 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
        will-change: transform;
      }
      
      .g-card__gradient-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 55%;
        background: linear-gradient(to top, 
          rgba(17, 24, 39, 0.98) 30%, 
          rgba(90, 59, 140, 0.90) 45%,
          rgba(90, 59, 140, 0.65) 65%, 
          rgba(90, 59, 140, 0.2) 85%,
          rgba(90, 59, 140, 0) 100%);
        z-index: 3;
        pointer-events: none;
        border-radius: 0 0 12px 12px;
        mix-blend-mode: multiply;
      }
      
      .g-pagination {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        margin-top: 2.5rem;
        margin-bottom: 4.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--grantaura-gray-200);
        position: relative;
      }
      
      .g-pagination::before {
        content: "";
        position: absolute;
        top: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--grantaura-primary), var(--grantaura-secondary));
      }
      
      .g-pagination__list {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        gap: clamp(0.2rem, 1vw, 0.35rem);
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .g-pagination__item a,
      .g-pagination__item span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: clamp(2rem, 6vw, 2.25rem);
        height: clamp(2rem, 6vw, 2.25rem);
        padding: 0 clamp(0.5rem, 2vw, 0.75rem);
        border-radius: var(--grantaura-border-radius-sm);
        font-size: clamp(0.8rem, 3vw, 0.9rem);
        font-weight: 500;
        text-decoration: none !important;
        transition: var(--grantaura-transition);
      }
      
      .g-pagination__item a {
        background-color: var(--grantaura-gray-100);
        color: var(--grantaura-gray-700) !important;
        border: 1px solid var(--grantaura-gray-200);
      }
      
      .g-pagination__item a:hover {
        background-color: var(--grantaura-primary-light);
        color: white !important;
        border-color: var(--grantaura-primary-light);
      }
      
      .g-pagination__item--current span {
        background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
        color: white;
        box-shadow: 0 3px 6px rgba(90, 59, 140, 0.2);
      }
      
      .g-pagination__item--prev a,
      .g-pagination__item--next a {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      @media (prefers-reduced-motion: reduce) {
        .g-card {
          transition: none;
        }
        .g-card:hover {
          transform: none;
        }
        .g-card--featured::before {
          animation: none;
        }
      }
      
      @media (max-width: 640px) {
        .g-pagination__list {
          padding: 0 0.5rem;
        }
        
        .g-pagination__item--prev a,
        .g-pagination__item--next a {
          padding: 0 0.5rem;
        }
        
        .g-pagination__item--prev svg,
        .g-pagination__item--next svg {
          width: 14px;
          height: 14px;
        }
      }
    </style>
    <!-- No Filtered Grants Message -->
    <div class="no-filtered-grants" id="no-filtered-grants">
      <h3>No Matching Grants Found</h3>
      <p>We couldn't find any grants matching your filter criteria. Try adjusting your filters or reset them to see all available grants.</p>
      <button type="button" id="reset-filters-btn">Reset All Filters</button>
    </div>
    
    <div class="grants-container-loading" id="grants-container-loading">
      <div class="grants-container-loading-spinner"></div>
    </div>
    
    [php]
    // Custom function to extract predefined eligibility options
    function get_predefined_eligibility_options() {
        // Predefined set of eligibility options as requested
        return array(
            'Businesses' => 0,
            'Startups' => 0,
            'Nonprofits' => 0,
            'Individuals' => 0,
            'Artists' => 0,
            'Group' => 0,
            'LGBTQ+' => 0,
            'Black People' => 0,
            'Asian Americans' => 0,
            'Women' => 0,
            'Military Veterans' => 0,
            'Disabled/Special Persons' => 0,
            'Students' => 0,
            'Family' => 0,
            'Project' => 0,
            'Scientists' => 0,
            'Minority' => 0,
            'Youth' => 0,
            'Educational Institutions' => 0,
            'Community Development Financial Institutions (CDFIs)' => 0
        );
    }

    // Function to extract location hierarchy from the HTML DIV
    function extract_location_hierarchy() {
        // This function will extract the location hierarchy from the WordPress location taxonomy
        global $wpdb;
        
        // Get all terms from the at_biz_dir-location taxonomy
        $query = "
            SELECT t.term_id, t.name, t.slug, tt.parent
            FROM {$wpdb->terms} AS t
            INNER JOIN {$wpdb->term_taxonomy} AS tt ON t.term_id = tt.term_id
            WHERE tt.taxonomy = 'at_biz_dir-location'
            ORDER BY tt.parent ASC, t.name ASC
        ";
        
        $locations = $wpdb->get_results($query);
        
        $location_hierarchy = array();
        $location_parents = array();
        
        // First pass - build a map of parent-child relationships
        foreach ($locations as $location) {
            if (!isset($location_hierarchy[$location->term_id])) {
                $location_hierarchy[$location->term_id] = array(
                    'id' => $location->term_id,
                    'name' => $location->name,
                    'slug' => $location->slug,
                    'parent' => $location->parent,
                    'children' => array(),
                    'count' => 0
                );
            }
            
            if ($location->parent > 0) {
                $location_parents[$location->term_id] = $location->parent;
            }
        }
        
        // Second pass - build the hierarchy
        foreach ($location_parents as $child_id => $parent_id) {
            if (isset($location_hierarchy[$parent_id]) && isset($location_hierarchy[$child_id])) {
                $location_hierarchy[$parent_id]['children'][] = $child_id;
            }
        }
        
        return $location_hierarchy;
    }

    // Set up pagination variables
    $paged = get_query_var('paged') ? get_query_var('paged') : 1;
    $posts_per_page = 12; // Number of posts to show per page
    
    // First, get featured grants
    $featured_args = array(
      'post_type' => 'at_biz_dir',
      'posts_per_page' => -1, // Get all featured posts
      'meta_query' => array(
        'relation' => 'OR',
        // Check for featured meta with value 1
        array(
          'key' => 'featured',
          'value' => array('1', 'yes', 'true', 'on'),
          'compare' => 'IN',
        ),
        // Check for _featured meta with value 1
        array(
          'key' => '_featured',
          'value' => array('1', 'yes', 'true', 'on'),
          'compare' => 'IN',
        ),
      ),
      'orderby' => 'date',
      'order' => 'DESC'
    );
    
    // Run query for featured grants
    $featured_query = new WP_Query($featured_args);
    $has_featured_posts = $featured_query->have_posts();
    $featured_post_ids = array();
    
    // Store featured post IDs
    if ($has_featured_posts) {
      while ($featured_query->have_posts()) {
        $featured_query->the_post();
        $featured_post_ids[] = get_the_ID();
      }
      wp_reset_postdata();
    }
    
    // Fallback: If no featured posts found with direct meta keys, 
    // search for any meta key containing 'featured'
    if (empty($featured_post_ids)) {
      global $wpdb;
      $query = "
        SELECT DISTINCT post_id 
        FROM $wpdb->postmeta 
        WHERE meta_key LIKE '%featured%' 
        AND meta_value IN ('1', 'yes', 'true', 'on')
        AND post_id IN (
          SELECT ID FROM $wpdb->posts 
          WHERE post_type = 'at_biz_dir' 
          AND post_status = 'publish'
        )
      ";
      $fallback_results = $wpdb->get_results($query);
      
      $has_fallback_results = !empty($fallback_results);
      if ($has_fallback_results) {
        foreach ($fallback_results as $result) {
          $featured_post_ids[] = $result->post_id;
        }
      }
    }
    
    // Get all regular (non-featured) posts to determine statuses
    $regular_args = array(
      'post_type' => 'at_biz_dir',
      'posts_per_page' => -1, // Get all posts to sort them
      'post__not_in' => $featured_post_ids,
      'orderby' => 'date',
      'order' => 'DESC'
    );
    
    $regular_query = new WP_Query($regular_args);
    $has_regular_posts = $regular_query->have_posts();
    
    // Arrays to hold active/ongoing and expired grants
    $active_ongoing_posts = array();
    $expired_posts = array();
    
    // Get predefined eligibility options
    $predefined_eligibility = get_predefined_eligibility_options();
    
    // Extract location hierarchy
    $location_hierarchy = extract_location_hierarchy();
    
    // Initialize count arrays for categories, locations, and eligibility
    $all_categories = array();
    $all_locations = array();
    $all_eligible_entities = $predefined_eligibility;
    
    // Store data for filter relationships
    $filter_relationships = array(
        'grants' => array(),
        'amount_ranges' => array(
            'ranges' => array(),
            'varies' => array()
        ),
        'timeframes' => array(
            'today' => array(),
            'week' => array(),
            'month' => array(),
            'quarter' => array()
        ),
        'eligibility' => array(),
        'categories' => array(),
        'locations' => array()
    );
    
    // Store deadline timeframes
    $current_time = time();
    $today_end = $current_time + (24 * 60 * 60);
    $week_end = $current_time + (7 * 24 * 60 * 60);
    $month_end = $current_time + (30 * 24 * 60 * 60);
    $quarter_end = $current_time + (90 * 24 * 60 * 60);
    
    // Process regular posts to determine status and sort them
    if ($has_regular_posts) {
      while ($regular_query->have_posts()) {
        $regular_query->the_post();
        $post_id = get_the_ID();
        $post = get_post($post_id);
        
        // Get deadline date
        $deadline = get_post_meta($post_id, '_custom-date', true);
        $has_deadline = !empty($deadline);
        
        // Determine grant status
        $status = 'ongoing'; // Default status if no deadline
        
        if ($has_deadline) {
          $deadline_time = strtotime($deadline);
          $is_future_deadline = $deadline_time > $current_time;
          
          if ($is_future_deadline) {
            $status = 'active';
            
            // Add to timeframe tracking
            if ($deadline_time <= $today_end) {
                $filter_relationships['timeframes']['today'][] = $post_id;
            }
            if ($deadline_time <= $week_end) {
                $filter_relationships['timeframes']['week'][] = $post_id;
            }
            if ($deadline_time <= $month_end) {
                $filter_relationships['timeframes']['month'][] = $post_id;
            }
            if ($deadline_time <= $quarter_end) {
                $filter_relationships['timeframes']['quarter'][] = $post_id;
            }
          } else {
            // Get expiration date
            $expiry_date = get_post_meta($post_id, '_expiry_date', true);
            $has_expiry_date = !empty($expiry_date);
            
            if ($has_expiry_date) {
              $status = 'expired_with_notice';
            } else {
              $status = 'expired_no_notice';
            }
          }
        }
        
        // Group posts by status
        $is_expired = $status == 'expired_with_notice' || $status == 'expired_no_notice';
        
        if ($is_expired) {
          $expired_posts[] = array(
            'post' => $post,
            'is_featured' => false,
            'status' => $status
          );
        } else {
          $active_ongoing_posts[] = array(
            'post' => $post,
            'is_featured' => false,
            'status' => $status
          );
        }
        
        // Process filter relationships
        $filter_relationships['grants'][$post_id] = array(
            'status' => $status,
            'is_featured' => false,
            'eligibility' => array(),
            'categories' => array(),
            'locations' => array(),
            'amount' => '',
            'deadline' => $has_deadline ? $deadline_time : null
        );
        
        // Get amount and track it
        $amount = get_post_meta($post_id, '_price', true);
        $is_amount_empty = empty($amount);
        if ($is_amount_empty) {
            $filter_relationships['amount_ranges']['varies'][] = $post_id;
            $filter_relationships['grants'][$post_id]['amount'] = 'varies';
        } else {
            $amount_value = intval($amount);
            $filter_relationships['grants'][$post_id]['amount'] = $amount_value;
            
            // Determine amount range
            $range_key = 'range_' . floor($amount_value / 10000) * 10000;
            if (!isset($filter_relationships['amount_ranges']['ranges'][$range_key])) {
                $filter_relationships['amount_ranges']['ranges'][$range_key] = array();
            }
            $filter_relationships['amount_ranges']['ranges'][$range_key][] = $post_id;
        }
        
        // Process eligibility
        $eligibility = get_post_meta($post_id, 'custom-checkbox', true);
        $valid_eligibility = array();
        
        if (is_array($eligibility) && !empty($eligibility)) {
            foreach ($eligibility as $entity) {
                $entity = trim($entity);
                
                // Map old labels to new ones if needed
                if ($entity == 'Females') $entity = 'Women';
                if ($entity == 'Veterans') $entity = 'Military Veterans';
                if ($entity == 'African Americans') $entity = 'Black People';
                if ($entity == 'Disabled') $entity = 'Disabled/Special Persons';
                
                if (isset($all_eligible_entities[$entity])) {
                    $all_eligible_entities[$entity]++;
                    $valid_eligibility[] = $entity;
                    
                    // Add to filter relationships
                    if (!isset($filter_relationships['eligibility'][$entity])) {
                        $filter_relationships['eligibility'][$entity] = array();
                    }
                    $filter_relationships['eligibility'][$entity][] = $post_id;
                }
            }
        }
        
        $filter_relationships['grants'][$post_id]['eligibility'] = $valid_eligibility;
        
        // Process categories
        $categories = get_the_terms($post_id, 'at_biz_dir-category');
        if (is_array($categories) && !empty($categories)) {
            foreach ($categories as $category) {
                if (!isset($all_categories[$category->name])) {
                    $all_categories[$category->name] = array(
                        'count' => 1,
                        'slug' => $category->slug
                    );
                } else {
                    $all_categories[$category->name]['count']++;
                }
                
                $filter_relationships['grants'][$post_id]['categories'][] = $category->name;
                
                // Add to filter relationships
                if (!isset($filter_relationships['categories'][$category->name])) {
                    $filter_relationships['categories'][$category->name] = array();
                }
                $filter_relationships['categories'][$category->name][] = $post_id;
            }
        }
        
        // Process locations
        $locations = get_the_terms($post_id, 'at_biz_dir-location');
        if (is_array($locations) && !empty($locations)) {
            foreach ($locations as $location) {
                if (!isset($all_locations[$location->name])) {
                    $all_locations[$location->name] = array(
                        'count' => 1,
                        'slug' => $location->slug,
                        'term_id' => $location->term_id
                    );
                } else {
                    $all_locations[$location->name]['count']++;
                }
                
                // Update location hierarchy counts
                if (isset($location_hierarchy[$location->term_id])) {
                    $location_hierarchy[$location->term_id]['count']++;
                }
                
                $filter_relationships['grants'][$post_id]['locations'][] = $location->name;
                
                // Add to filter relationships
                if (!isset($filter_relationships['locations'][$location->name])) {
                    $filter_relationships['locations'][$location->name] = array();
                }
                $filter_relationships['locations'][$location->name][] = $post_id;
            }
        }
      }
      wp_reset_postdata();
    }
    
    // Process featured posts to determine their status
    $featured_active_ongoing = array();
    $featured_expired = array();
    
    foreach ($featured_post_ids as $post_id) {
      $post = get_post($post_id);
      $is_valid_post = !empty($post) && $post->post_type === 'at_biz_dir';
      
      if ($is_valid_post) {
        // Get deadline date
        $deadline = get_post_meta($post_id, '_custom-date', true);
        $has_deadline = !empty($deadline);
    // Determine grant status
        $status = 'ongoing'; // Default status if no deadline
        
        if ($has_deadline) {
          $deadline_time = strtotime($deadline);
          $is_future_deadline = $deadline_time > $current_time;
          
          if ($is_future_deadline) {
            $status = 'active';
            
            // Add to timeframe tracking
            if ($deadline_time <= $today_end) {
                $filter_relationships['timeframes']['today'][] = $post_id;
            }
            if ($deadline_time <= $week_end) {
                $filter_relationships['timeframes']['week'][] = $post_id;
            }
            if ($deadline_time <= $month_end) {
                $filter_relationships['timeframes']['month'][] = $post_id;
            }
            if ($deadline_time <= $quarter_end) {
                $filter_relationships['timeframes']['quarter'][] = $post_id;
            }
          } else {
            // Get expiration date
            $expiry_date = get_post_meta($post_id, '_expiry_date', true);
            $has_expiry_date = !empty($expiry_date);
            
            if ($has_expiry_date) {
              $status = 'expired_with_notice';
            } else {
              $status = 'expired_no_notice';
            }
          }
        }
        
        // Group posts by status
        $is_expired = $status == 'expired_with_notice' || $status == 'expired_no_notice';
        
        if ($is_expired) {
          $featured_expired[] = array(
            'post' => $post,
            'is_featured' => true,
            'status' => $status
          );
        } else {
          $featured_active_ongoing[] = array(
            'post' => $post,
            'is_featured' => true,
            'status' => $status
          );
        }
        
        // Process filter relationships for featured posts
        $filter_relationships['grants'][$post_id] = array(
            'status' => $status,
            'is_featured' => true,
            'eligibility' => array(),
            'categories' => array(),
            'locations' => array(),
            'amount' => '',
            'deadline' => $has_deadline ? $deadline_time : null
        );
        
        // Get amount and track it
        $amount = get_post_meta($post_id, '_price', true);
        $is_amount_empty = empty($amount);
        if ($is_amount_empty) {
            $filter_relationships['amount_ranges']['varies'][] = $post_id;
            $filter_relationships['grants'][$post_id]['amount'] = 'varies';
        } else {
            $amount_value = intval($amount);
            $filter_relationships['grants'][$post_id]['amount'] = $amount_value;
            
            // Determine amount range
            $range_key = 'range_' . floor($amount_value / 10000) * 10000;
            if (!isset($filter_relationships['amount_ranges']['ranges'][$range_key])) {
                $filter_relationships['amount_ranges']['ranges'][$range_key] = array();
            }
            $filter_relationships['amount_ranges']['ranges'][$range_key][] = $post_id;
        }
        
        // Process eligibility
        $eligibility = get_post_meta($post_id, 'custom-checkbox', true);
        $valid_eligibility = array();
        
        if (is_array($eligibility) && !empty($eligibility)) {
            foreach ($eligibility as $entity) {
                $entity = trim($entity);
                
                // Map old labels to new ones if needed
                if ($entity == 'Females') $entity = 'Women';
                if ($entity == 'Veterans') $entity = 'Military Veterans';
                if ($entity == 'African Americans') $entity = 'Black People';
                if ($entity == 'Disabled') $entity = 'Disabled/Special Persons';
                
                if (isset($all_eligible_entities[$entity])) {
                    $all_eligible_entities[$entity]++;
                    $valid_eligibility[] = $entity;
                    
                    // Add to filter relationships
                    if (!isset($filter_relationships['eligibility'][$entity])) {
                        $filter_relationships['eligibility'][$entity] = array();
                    }
                    $filter_relationships['eligibility'][$entity][] = $post_id;
                }
            }
        }
        
        $filter_relationships['grants'][$post_id]['eligibility'] = $valid_eligibility;
        
        // Process categories
        $categories = get_the_terms($post_id, 'at_biz_dir-category');
        if (is_array($categories) && !empty($categories)) {
            foreach ($categories as $category) {
                if (!isset($all_categories[$category->name])) {
                    $all_categories[$category->name] = array(
                        'count' => 1,
                        'slug' => $category->slug
                    );
                } else {
                    $all_categories[$category->name]['count']++;
                }
                
                $filter_relationships['grants'][$post_id]['categories'][] = $category->name;
                
                // Add to filter relationships
                if (!isset($filter_relationships['categories'][$category->name])) {
                    $filter_relationships['categories'][$category->name] = array();
                }
                $filter_relationships['categories'][$category->name][] = $post_id;
            }
        }
        
        // Process locations
        $locations = get_the_terms($post_id, 'at_biz_dir-location');
        if (is_array($locations) && !empty($locations)) {
            foreach ($locations as $location) {
                if (!isset($all_locations[$location->name])) {
                    $all_locations[$location->name] = array(
                        'count' => 1,
                        'slug' => $location->slug,
                        'term_id' => $location->term_id
                    );
                } else {
                    $all_locations[$location->name]['count']++;
                }
                
                // Update location hierarchy counts
                if (isset($location_hierarchy[$location->term_id])) {
                    $location_hierarchy[$location->term_id]['count']++;
                }
                
                $filter_relationships['grants'][$post_id]['locations'][] = $location->name;
                
                // Add to filter relationships
                if (!isset($filter_relationships['locations'][$location->name])) {
                    $filter_relationships['locations'][$location->name] = array();
                }
                $filter_relationships['locations'][$location->name][] = $post_id;
            }
        }
      }
    }
    
    // Combine all posts in the desired order
    $combined_posts = array_merge(
      $featured_active_ongoing,   // Featured active/ongoing first
      $featured_expired,          // Featured expired second
      $active_ongoing_posts,      // Regular active/ongoing third
      $expired_posts              // Regular expired last
    );
    
    // Apply pagination to combined posts
    $total_posts = count($combined_posts);
    $total_pages = ceil($total_posts / $posts_per_page);
    
    // Calculate offset for the current page
    $offset = ($paged - 1) * $posts_per_page;
    
    // Get the posts for the current page
    $current_page_posts = array_slice($combined_posts, $offset, $posts_per_page);
    
    // Now we have all posts combined and paginated, display them
    $has_any_posts = !empty($current_page_posts);
    
    // Create arrays to store unique filter values
    $grant_data_json = array();
    
    // Store timeframe counts
    $timeframe_counts = array(
        'today' => count($filter_relationships['timeframes']['today']),
        'week' => count($filter_relationships['timeframes']['week']),
        'month' => count($filter_relationships['timeframes']['month']),
        'quarter' => count($filter_relationships['timeframes']['quarter'])
    );
    
    // Process location hierarchy to properly assign parent-child relationships
    $processed_location_hierarchy = array();
    
    foreach ($location_hierarchy as $term_id => $location_data) {
        if ($location_data['parent'] == 0) {
            // This is a top-level location
            $processed_location_hierarchy[$term_id] = $location_data;
        }
    }
    
    if ($has_any_posts) {
      foreach ($current_page_posts as $post_data) {
        $post = $post_data['post'];
        $is_featured = $post_data['is_featured'];
        $status = isset($post_data['status']) ? $post_data['status'] : 'ongoing';
        $post_id = $post->ID;
        
        // Get basic grant information
        $title = get_the_title($post_id);
        $permalink = get_permalink($post_id);
        
        // Get excerpt/tagline
        $tagline = get_post_meta($post_id, 'tagline', true);
        $is_tagline_empty = empty($tagline);
        if ($is_tagline_empty) {
          $tagline = get_the_excerpt($post_id);
        }
        
        // Get amount - use "Varies" or "Various Benefits" instead of N/A
        $amount = get_post_meta($post_id, '_price', true);
        $is_amount_empty = empty($amount);
        if ($is_amount_empty) {
          $amount_display = 'Various Benefits';
          $amount_value = 'varies';
        } else {
          $amount_display = '$' . number_format($amount);
          $amount_value = $amount;
        }
        
        // Get deadline date
        $deadline = get_post_meta($post_id, '_custom-date', true);
        $has_deadline = !empty($deadline);
        $deadline_display = $has_deadline ? date('F j, Y', strtotime($deadline)) : 'Ongoing';
        $deadline_timestamp = $has_deadline ? strtotime($deadline) : '';
        
        // Get expiration date
        $expiry_date = get_post_meta($post_id, '_expiry_date', true);
        $has_expiry_date = !empty($expiry_date);
        
        // Recalculate time remaining for active grants
        $time_remaining = array(
          'days' => 0,
          'hours' => 0,
          'minutes' => 0,
          'seconds' => 0,
          'total_seconds' => 0,
          'display_type' => 'days' // Default to days
        );
        
        $status_is_active = $status == 'active';
        $status_is_ongoing = $status == 'ongoing';
        
        if ($status_is_active && $has_deadline) {
          $current_time = time();
          $deadline_time = strtotime($deadline);
          $time_diff = $deadline_time - $current_time;
          
          // Calculate time components
          $time_remaining['days'] = floor($time_diff / (60 * 60 * 24));
          $time_remaining['hours'] = floor(($time_diff % (60 * 60 * 24)) / (60 * 60));
          $time_remaining['minutes'] = floor(($time_diff % (60 * 60)) / 60);
          $time_remaining['seconds'] = $time_diff % 60;
          $time_remaining['total_seconds'] = $time_diff;
          
          // Determine display type based on time remaining
          if ($time_remaining['days'] < 1) {
            $time_remaining['display_type'] = 'countdown';
          } else {
            $time_remaining['display_type'] = 'days';
          }
        }
        
        // Get status display text and color
        $status_text = '';
        $status_color = '';
        
        if ($status_is_active) {
          $status_text = 'Active';
          $status_color = 'var(--grantaura-success)';
        } else if ($status_is_ongoing) {
          $status_text = 'Ongoing';
          $status_color = 'var(--grantaura-secondary)';
        } else {
          $status_text = 'Expired';
          $status_color = 'var(--grantaura-danger)';
        }
        
        // Get eligibility data from the predefined structure 
        $eligible_entities = array();
        $raw_eligibility = get_post_meta($post_id, 'custom-checkbox', true);
        
        if (is_array($raw_eligibility) && !empty($raw_eligibility)) {
            $eligible_entities = $raw_eligibility;
        } else {
            // Default if nothing is specified
            $eligible_entities = array('All Applicants');
        }
        
        // Get featured image - First check for preview image
        $listing_preview_id = get_post_meta($post_id, 'listing_prv_img', true);
        $has_preview_image = !empty($listing_preview_id);
        $featured_image = '';
        
        if ($has_preview_image) {
          $featured_image = wp_get_attachment_image_url($listing_preview_id, 'large');
        }
        
        // If no preview image, check for featured image
        $has_featured_image = !empty($featured_image);
        if (!$has_featured_image) {
          $featured_image = get_the_post_thumbnail_url($post_id, 'large');
          $has_featured_image = !empty($featured_image);
        }
        
        // If still no image, check gallery/slider images
        if (!$has_featured_image) {
          $gallery_ids = get_post_meta($post_id, '_listing_img', true);
          $is_gallery_ids_array = is_array($gallery_ids);
          
          if ($is_gallery_ids_array && !empty($gallery_ids)) {
            $first_gallery_image = wp_get_attachment_image_url($gallery_ids[0], 'large');
            if (!empty($first_gallery_image)) {
              $featured_image = $first_gallery_image;
              $has_featured_image = true;
            }
          } else if (!empty($gallery_ids) && !$is_gallery_ids_array) {
            // Try to parse if it's a comma-separated string
            $gallery_ids_array = explode(',', $gallery_ids);
            if (!empty($gallery_ids_array[0])) {
              $first_gallery_image = wp_get_attachment_image_url(trim($gallery_ids_array[0]), 'large');
              if (!empty($first_gallery_image)) {
                $featured_image = $first_gallery_image;
                $has_featured_image = true;
              }
            }
          }
        }
        
        // Fallback image if no images found
        if (!$has_featured_image) {
          $featured_image = 'https://grantaura.com/wp-content/uploads/2024/11/Transparent-bg-deep-Purple-AURA-and-dark-Gold-ff914d-GRANT-1-e1731246494496.png';
        }
        
        // Get locations data from taxonomy
        $locations = get_the_terms($post_id, 'at_biz_dir-location');
        $is_locations_valid = is_array($locations) && !empty($locations);
        $location_data = array();
        $location_names = array(); // For JSON data
        
        if ($is_locations_valid) {
          // Process locations from taxonomy
          foreach ($locations as $location) {
            $location_link = get_term_link($location, 'at_biz_dir-location');
            $is_error = is_wp_error($location_link);
            if (!$is_error) {
              $location_data[] = array(
                'name' => $location->name,
                'url' => $location_link,
                'slug' => $location->slug
              );
              $location_names[] = $location->name;
            }
          }
        } else {
          // Fallback if no locations found
          $location_data[] = array(
            'name' => 'Global',
            'url' => get_term_link('global', 'at_biz_dir-location'),
            'slug' => 'global'
          );
          $location_names[] = 'Global';
        }
        
        // Get categories data from taxonomy
        $categories = get_the_terms($post_id, 'at_biz_dir-category');
        $is_categories_valid = is_array($categories) && !empty($categories);
        $category_data = array();
        $category_names = array(); // For JSON data
        
        if ($is_categories_valid) {
          // Process categories from taxonomy
          foreach ($categories as $category) {
            $category_link = get_term_link($category, 'at_biz_dir-category');
            $is_error = is_wp_error($category_link);
            if (!$is_error) {
              $category_data[] = array(
                'name' => $category->name,
                'url' => $category_link,
                'slug' => $category->slug
              );
              $category_names[] = $category->name;
            }
          }
        } else {
          // Fallback if no categories found
          $category_data[] = array(
            'name' => 'General Grants',
            'url' => '#',
            'slug' => 'general-grants'
          );
          $category_names[] = 'General Grants';
        }
        
        // Store data for JavaScript filtering
        $grant_data = array(
          'id' => $post_id,
          'title' => $title,
          'status' => $status,
          'status_display' => $status_text,
          'is_featured' => $is_featured,
          'amount' => $amount_value,
          'amount_display' => $amount_display,
          'deadline' => $deadline_timestamp,
          'deadline_display' => $deadline_display,
          'locations' => $location_names,
          'categories' => $category_names,
          'eligible_entities' => is_array($eligible_entities) ? $eligible_entities : array(),
          'time_remaining' => $time_remaining,
          'permalink' => $permalink
        );
        
        $grant_data_json[] = $grant_data;
        
        // Generate a unique ID for countdown timer
        $countdown_id = 'g-countdown-' . $post_id;
        
        // Add featured class if post is featured
        $featured_class = $is_featured ? 'g-card--featured' : '';
        
        // Determine expired status for data attribute
        $is_expired_status = strpos($status, 'expired') !== false ? 'true' : 'false';
        
        // Output HTML for each grant listing with filter data attributes
        ?>
        <div class="g-card <?php echo esc_attr($featured_class); ?>" 
             data-grant-id="<?php echo esc_attr($post_id); ?>" 
             data-status="<?php echo esc_attr($status); ?>"
             data-featured="<?php echo $is_featured ? 'true' : 'false'; ?>"
             data-amount="<?php echo esc_attr($amount_value); ?>"
             data-deadline="<?php echo esc_attr($deadline_timestamp); ?>"
             data-expired="<?php echo esc_attr($is_expired_status); ?>"
             data-locations="<?php echo esc_attr(implode('|', $location_names)); ?>"
             data-categories="<?php echo esc_attr(implode('|', $category_names)); ?>"
             data-eligible-entities="<?php echo esc_attr(is_array($eligible_entities) ? implode('|', $eligible_entities) : ''); ?>"
             <?php if ($status_is_active && $time_remaining['display_type'] == 'countdown') echo 'data-countdown-time="' . esc_attr($deadline_time) . '"'; ?>>
          <style>
            .g-card__status-badge {
              position: absolute;
              top: 12px;
              left: 12px;
              padding: 6px 14px;
              border-radius: 100px;
              font-size: clamp(0.65rem, 2.5vw, 0.75rem);
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              color: white !important;
              z-index: 5;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
              display: flex;
              align-items: center;
              gap: 5px;
              transition: transform 0.3s ease;
            }
            
            .g-card__status-badge::before {
              content: "";
              display: inline-block;
              width: 6px;
              height: 6px;
              border-radius: 50%;
              background-color: rgba(255, 255, 255, 0.8);
              box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
              animation: pulse 2s infinite;
            }
            
            .g-card__status-badge[style*="var(--grantaura-success)"]::before {
              animation: pulse-success 2s infinite;
            }
            
            .g-card__status-badge[style*="var(--grantaura-secondary)"]::before {
              animation: none;
            }
            
            .g-card__status-badge[style*="var(--grantaura-danger)"]::before {
              animation: none;
              background-color: rgba(255, 255, 255, 0.6);
              box-shadow: none;
            }
            
            @keyframes pulse {
              0% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.5);
              }
              70% {
                box-shadow: 0 0 0 4px rgba(255, 255, 255, 0);
              }
              100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
              }
            }
            
            @keyframes pulse-success {
              0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5);
              }
              70% {
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
              }
              100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
              }
            }
            
            .g-card__featured-badge {
              position: absolute;
              right: -8px;
              top: 18vw;
              z-index: 20;
              transform-origin: top right;
            }
            
            .g-card__featured-badge-inner {
              background: linear-gradient(135deg, #FFD700, #FFA500);
              color: #000;
              font-weight: 700;
              font-size: 0.75rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              padding: 6px 8px 6px 12px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
              position: relative;
              clip-path: polygon(0 0, 100% 0, 100% 100%, 8px 100%);
              display: flex;
              align-items: center;
              gap: 4px;
            }
            
            .g-card__featured-badge-inner::before {
              content: "";
              position: absolute;
              bottom: -8px;
              right: 0;
              width: 8px;
              height: 8px;
              background: #A67C00;
              clip-path: polygon(0 0, 100% 0, 100% 100%);
            }
            
            .g-card__featured-badge-inner svg {
              width: 14px;
              height: 14px;
              color: #000;
              filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
            }
            
            .g-card__featured-badge-shine {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0) 100%
              );
              background-size: 200% 200%;
              animation: shine 2s ease-in-out infinite;
            }
            
            @keyframes shine {
              0% {
                background-position: -100% -100%;
              }
              100% {
                background-position: 100% 100%;
              }
            }
            
            .g-card__countdown-wrapper {
              position: absolute;
              top: 12px;
              right: 12px;
              z-index: 5;
            }
            
            .g-card__countdown {
              background: rgba(90, 59, 140, 0.95);
              backdrop-filter: blur(5px);
              -webkit-backdrop-filter: blur(5px);
              border-radius: 3px;
              padding: 8px 10px;
              color: white;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 5px;
              box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
              border: 1px solid rgba(255, 255, 255, 0.15);
              transition: transform 0.3s ease;
            }
            
            .g-card:hover .g-card__countdown {
              transform: translateY(-2px);
            }
            
            .g-card__countdown-label {
              font-size: 0.55rem;
              text-transform: uppercase;
              opacity: 0.85;
              margin-right: 0.25rem;
              letter-spacing: 0.5px;
            }
            
            .g-card__countdown-unit {
              display: flex;
              flex-direction: column;
              align-items: center;
              position: relative;
            }
            
            .g-card__countdown-unit:not(:last-child)::after {
              content: ":";
              position: absolute;
              right: -4px;
              top: 2px;
              color: rgba(255, 255, 255, 0.7);
              font-weight: 700;
            }
            
            .g-card__countdown-number {
              font-size: clamp(0.80rem, 2vw, 0.75rem);
              font-weight: 700;
              background: rgba(255, 255, 255, 0.15);
              border-radius: 6px;
              min-width: clamp(1.8rem, 6vw, 2rem);
              text-align: center;
              padding: 2px 4px;
              position: relative;
              overflow: hidden;
            }
            
            .g-card__countdown-unit:last-child .g-card__countdown-number {
              position: relative;
            }
            
            .g-card__countdown-unit:last-child .g-card__countdown-number::after {
              content: "";
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(255, 163, 102, 0.85);
              opacity: 0;
              animation: pulse-countdown 1s infinite;
            }
            
            @keyframes pulse-countdown {
              0% {
                opacity: 0;
              }
              50% {
                opacity: 1;
              }
              100% {
                opacity: 0;
              }
            }
            
            .g-card__countdown-label-unit {
              font-size: 0.6rem;
              text-transform: uppercase;
              margin-top: 2px;
              color: rgba(255, 255, 255, 0.8);
              letter-spacing: 0.5px;
            }
            
            .g-card__deadline-days {
              background: rgba(90, 59, 140, 0.95);
              backdrop-filter: blur(5px);
              -webkit-backdrop-filter: blur(5px);
              border-radius: 3px;
              padding: 6px 10px;
              color: white;
              display: flex;
              align-items: center;
              font-weight: 600;
              box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
              border: 1px solid rgba(255, 255, 255, 0.15);
              transition: transform 0.3s ease;
              gap: 5px;
            }
            
            .g-card:hover .g-card__deadline-days {
              transform: translateY(-2px);
            }
            
            .g-card__deadline-days-num {
              font-size: clamp(0.75rem, 2vw, 1rem);
              font-weight: 800;
              background: rgba(255, 255, 255, 0.15);
              border-radius: 6px;
              min-width: 1.8rem;
              text-align: center;
              padding: 2px 6px;
              color: var(--grantaura-secondary-light);
            }
            
            .g-card__title {
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              z-index: 4;
              padding: 1.25rem 1.25rem 1.5rem;
              margin: 0;
              font-size: clamp(1.1rem, 5vw, 1.35rem);
              font-weight: 700;
              line-height: 1.3;
              color: white !important;
              text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
              transition: transform 0.3s ease;
            }
            
            .g-card:hover .g-card__title {
              transform: translateY(-5px);
            }
            
            .g-card__title a {
              color: white !important;
              text-decoration: none !important;
              transition: var(--grantaura-transition);
              display: block;
              width: 100%;
              position: relative;
              padding-left: 0;
              overflow: hidden;
            }
            
            .g-card__title a:hover {
              color: var(--grantaura-secondary-light) !important;
            }
            
            .g-card__title a::after {
              content: "";
              position: absolute;
              bottom: -5px;
              left: 0;
              width: 0;
              height: 2px;
              background: var(--grantaura-secondary);
              transition: width 0.3s ease;
            }
            
            .g-card:hover .g-card__title a::after {
              width: 40px;
            }
            
            .g-card__title a::first-letter {
              font-size: 110%;
              color: var(--grantaura-secondary-light);
            }
            
            .g-card--featured .g-card__title a::first-letter {
              color: #FFD700;
            }
            
            .g-card__img-accessibility {
              position: absolute;
              width: 1px;
              height: 1px;
              padding: 0;
              margin: -1px;
              overflow: hidden;
              clip: rect(0, 0, 0, 0);
              white-space: nowrap;
              border-width: 0;
            }
            
            .g-card__content {
              display: flex;
              flex-direction: column;
              flex: 1;
              padding: clamp(0.75rem, 3vw, 1.25rem);
              height: auto;
              overflow: visible;
            }
            
            .g-card__amount {
              font-size: clamp(1.1rem, 4vw, 1.3rem);
              font-weight: 700;
              position: relative;
              padding: 0.25rem 0;
              margin-bottom: 0.75rem;
              color: var(--grantaura-primary);
            }
            
            .g-card__amount::before {
              content: "";
              position: absolute;
              bottom: 0;
              left: 0;
              width: 100%;
              height: 2px;
              background: linear-gradient(90deg, var(--grantaura-primary), var(--grantaura-secondary-dark));
              opacity: 0.2;
            }
            
            .g-card--featured .g-card__amount {
              color: var(--grantaura-primary-dark);
            }
            
            .g-card--featured .g-card__amount::before {
              background: linear-gradient(90deg, var(--grantaura-primary-dark), #FFD700);
              opacity: 0.3;
              height: 3px;
            }
            
            .g-card__deadline-info {
              display: flex;
              align-items: center;
              font-size: clamp(0.8rem, 3vw, 0.85rem);
              color: var(--grantaura-gray-700);
              margin-bottom: 0.75rem;
              gap: 0.5rem;
            }
            
            .g-card__deadline-info svg {
              color: var(--grantaura-primary);
              flex-shrink: 0;
              width: clamp(14px, 4vw, 16px);
              height: clamp(14px, 4vw, 16px);
            }
            
            .g-card__deadline-info strong {
              font-weight: 600;
              margin-right: 0.25rem;
              color: var(--grantaura-gray-800);
            }
            
            .g-card__deadline-value {
              font-weight: 500;
            }
            
            .g-card__deadline-value--ongoing {
              color: var(--grantaura-secondary-dark);
              font-weight: 600;
            }
            
            .g-card__deadline-value--expired {
              color: var(--grantaura-danger);
              font-weight: 500;
            }
            
            .g-card--featured .g-card__deadline-info svg {
              color: var(--grantaura-primary-dark);
            }
            
            .g-card__excerpt {
              margin-bottom: 1rem;
              font-size: clamp(0.8rem, 3vw, 0.9rem);
              color: var(--grantaura-gray-600);
              line-height: 1.6;
              overflow: hidden;
              position: relative;
              display: -webkit-box;
              -webkit-line-clamp: 3;
              -webkit-box-orient: vertical;
              max-height: 4.8em; /* Approximately 3 lines */
            }
            
            .g-card__excerpt::first-letter {
              font-size: 1.1em;
              font-weight: 500;
              color: var(--grantaura-primary);
            }
            
            .g-card--featured .g-card__excerpt {
              color: var(--grantaura-gray-700);
            }
            
            .g-card--featured .g-card__excerpt::first-letter {
              color: var(--grantaura-primary-dark);
              font-weight: 600;
            }
            
            .g-card__meta {
              display: grid;
              grid-template-columns: 1fr;
              gap: 0.75rem;
              margin-top: auto;
              position: relative;
            }
            
            .g-card__meta::before {
              content: "";
              position: absolute;
              top: -10px;
              left: 0;
              right: 0;
              height: 1px;
              background: linear-gradient(90deg, var(--grantaura-gray-300), transparent);
            }
            
            .g-card__meta-item {
              display: flex;
              align-items: center;
              font-size: clamp(0.75rem, 3vw, 0.85rem);
              color: var(--grantaura-gray-700);
              gap: 0.35rem;
              flex-wrap: wrap;
            }
            
            .g-card__meta-item svg {
              color: var(--grantaura-primary);
              flex-shrink: 0;
              width: clamp(14px, 4vw, 16px);
              height: clamp(14px, 4vw, 16px);
            }
            
            .g-card__meta-item strong {
              font-weight: 600;
              margin-right: 0.25rem;
              color: var(--grantaura-gray-800);
            }
            
            .g-card__location-link {
              color: var(--grantaura-gray-700) !important;
              text-decoration: none !important;
              transition: color 0.2s ease;
              display: inline-block;
            }
            
            .g-card__location-link:hover {
              color: var(--grantaura-primary) !important;
              text-decoration: underline !important;
            }
            
            .g-card__location-list {
              display: flex;
              flex-wrap: wrap;
              gap: 0.25rem;
            }
            
            .g-card__location-more {
              display: inline-flex;
              color: var(--grantaura-secondary-dark);
              font-weight: 500;
              font-size: 0.75rem;
              margin-left: 0.25rem;
            }
            
            .g-card__location-item--extra {
              display: none;
            }
            
            @media (min-width: 768px) {
              .g-card__location-item--extra-md {
                display: inline;
              }
              
              .g-card__location-more--mobile {
                display: none;
              }
              
              .g-card__location-more--tablet {
                display: inline-flex;
              }
            }
            
            @media (min-width: 1024px) {
              .g-card__location-item--extra-lg {
                display: inline;
              }
              
              .g-card__location-more--tablet {
                display: none;
              }
              
              .g-card__location-more--desktop {
                display: inline-flex;
              }
            }
            
            .g-card__tags {
              display: flex;
              flex-wrap: wrap;
              gap: 0.5rem;
              margin-top: 0.75rem;
            }
            
            .g-card__tag {
              font-size: 0.75rem;
              padding: 3px 10px;
              background-color: var(--grantaura-gray-100);
              border-radius: 20px;
              color: var(--grantaura-gray-700) !important;
              border: 1px solid var(--grantaura-gray-200);
              transition: var(--grantaura-transition);
              text-decoration: none !important;
              display: inline-block;
            }
            
            .g-card__tag:hover {
              background-color: var(--grantaura-primary-light);
              color: white !important;
              border-color: var(--grantaura-primary-light);
            }
            
            .g-card__tag--more {
              background: var(--grantaura-gray-200);
              color: var(--grantaura-gray-800) !important;
              cursor: default;
            }
            
            .g-card__tag--more:hover {
              background: var(--grantaura-gray-200);
              color: var(--grantaura-gray-800) !important;
              border-color: var(--grantaura-gray-200);
            }
            
            .g-card__tag--extra {
              display: none;
            }
            
            @media (min-width: 768px) {
              .g-card__tag--extra-md {
                display: inline-block;
              }
              
              .g-card__tag--more-mobile {
                display: none;
              }
              
              .g-card__tag--more-tablet {
                display: inline-block;
              }
            }
            
            @media (min-width: 1024px) {
              .g-card__tag--extra-lg {
                display: inline-block;
              }
              
              .g-card__tag--more-tablet {
                display: none;
              }
              
              .g-card__tag--more-desktop {
                display: inline-block;
              }
            }
            
            .g-card--featured .g-card__meta::before {
              background: linear-gradient(90deg, var(--grantaura-primary-light), transparent);
              opacity: 0.3;
            }
            
            .g-card--featured .g-card__meta-item svg {
              color: var(--grantaura-primary-dark);
            }
            
            .g-card--featured .g-card__tag {
              border-color: var(--grantaura-primary-light);
              background-color: rgba(90, 59, 140, 0.05);
            }
            .g-card--featured .g-card__tag:hover {
              color: white !important;
              background-color: var(--grantaura-primary-light);
            }
            
            @media (max-width: 640px) {
              .g-card__status-badge {
                top: 10px;
                left: 10px;
                padding: 5px 12px;
              }
              
              .g-card__countdown-wrapper {
                top: 10px;
                right: 10px;
              }
              
              .g-card__countdown, 
              .g-card__deadline-days {
                padding: 4px 6px;
              }
            }
            
            @media (prefers-reduced-motion: reduce) {
              .g-card__status-badge::before {
                animation: none !important;
              }
              
              .g-card:hover .g-card__status-badge {
                transform: none;
              }
              
              .g-card__countdown-unit:last-child .g-card__countdown-number::after {
                animation: none;
              }
              
              .g-card:hover .g-card__countdown,
              .g-card:hover .g-card__deadline-days {
                transform: none;
              }
              
              .g-card:hover .g-card__title {
                transform: none;
              }
              
              .g-card:hover .g-card__title a::after {
                transition: none;
              }
              
              .g-card__featured-badge-shine {
                animation: none;
              }
            }
          </style>
          
          <div class="g-card__img-container">
            <div class="g-card__img-wrapper">
              <a href="<?php echo esc_url($permalink); ?>" title="<?php echo esc_attr($title); ?>" aria-label="View details of <?php echo esc_attr($title); ?>">
                <img 
                  src="<?php echo esc_url($featured_image); ?>" 
                  alt="<?php echo esc_attr($title); ?>" 
                  loading="lazy"
                  class="g-card__image"
                  onload="this.classList.add('g-card__img-loaded')"
                  width="500"
                  height="500"
                >
              </a>
            </div>
            
            <div class="g-card__status-badge" style="background-color: <?php echo esc_attr($status_color); ?>;">
              <?php echo esc_html($status_text); ?>
            </div>
            
            <?php if ($is_featured): ?>
            <div class="g-card__featured-badge">
              <div class="g-card__featured-badge-inner">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2l2.2 6.6h7.1l-5.7 4.2 2.2 6.6-5.8-4.2-5.7 4.2 2.2-6.6-5.8-4.2h7.1z"/>
                </svg>
                Featured
                <div class="g-card__featured-badge-shine"></div>
              </div>
            </div>
            <?php endif; ?>
            
            <?php if ($status_is_active): ?>
            <div class="g-card__countdown-wrapper">
              <?php if ($time_remaining['display_type'] == 'countdown'): ?>
              <div class="g-card__countdown" id="<?php echo esc_attr($countdown_id); ?>" data-deadline="<?php echo esc_attr($deadline_time); ?>">
                <div class="g-card__countdown-unit">
                  <div class="g-card__countdown-number" data-hours><?php echo sprintf('%02d', $time_remaining['hours']); ?></div>
                  <div class="g-card__countdown-label-unit">Hrs</div>
                </div>
                
                <div class="g-card__countdown-unit">
                  <div class="g-card__countdown-number" data-minutes><?php echo sprintf('%02d', $time_remaining['minutes']); ?></div>
                  <div class="g-card__countdown-label-unit">Min</div>
                </div>
                
                <div class="g-card__countdown-unit">
                  <div class="g-card__countdown-number" data-seconds><?php echo sprintf('%02d', $time_remaining['seconds']); ?></div>
                  <div class="g-card__countdown-label-unit">Sec</div>
                </div>
              </div>
              <?php else: ?>
              <div class="g-card__deadline-days">
                <span class="g-card__deadline-days-num"><?php echo $time_remaining['days']; ?></span>
                <span>Days Left</span>
              </div>
              <?php endif; ?>
            </div>
            <?php endif; ?>
            
            <div class="g-card__gradient-overlay"></div>
            
            <h2 class="g-card__title">
              <a href="<?php echo esc_url($permalink); ?>" title="<?php echo esc_attr($title); ?>" aria-label="View details of <?php echo esc_attr($title); ?>">
                <?php echo esc_html($title); ?>
              </a>
            </h2>
            
            <!-- Accessibility features -->
            <div class="g-card__img-accessibility" aria-hidden="true">
              <div class="g-card__screen-reader-info">
                <p>Grant: <?php echo esc_html($title); ?></p>
                <p>Status: <?php echo esc_html($status_text); ?></p>
                <?php if ($is_featured): ?>
                  <p>Featured Grant</p>
                <?php endif; ?>
                <?php if ($status_is_active && $has_deadline): ?>
                  <p>Deadline: <?php echo esc_html($deadline_display); ?></p>
                <?php endif; ?>
                <p>Amount: <?php echo esc_html($amount_display); ?></p>
              </div>
            </div>
          </div>
          <div class="g-card__content">
            <div class="g-card__amount">
              <?php echo esc_html($amount_display); ?>
            </div>
            
            <div class="g-card__deadline-info">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              
              <div>
                <strong>Deadline:</strong>
                <span class="g-card__deadline-value <?php echo $status_is_ongoing ? 'g-card__deadline-value--ongoing' : ($status_is_active ? '' : 'g-card__deadline-value--expired'); ?>">
                  <?php echo esc_html($deadline_display); ?>
                </span>
              </div>
            </div>
            
            <div class="g-card__excerpt">
              <?php echo esc_html($tagline); ?>
            </div>
            
            <div class="g-card__meta">
              <?php if (!empty($location_data)): ?>
              <div class="g-card__meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <strong>Location:</strong> 
                <div class="g-card__location-list">
                  <?php 
                  $location_count = count($location_data);
                  $mobile_limit = 2;
                  $tablet_limit = 4;
                  $desktop_limit = 6;
                  
                  foreach ($location_data as $index => $location):
                    // Determine which responsive class to use
                    $extra_class = '';
                    if ($index >= $mobile_limit) {
                      $extra_class = 'g-card__location-item--extra';
                      if ($index < $tablet_limit) {
                        $extra_class .= ' g-card__location-item--extra-md';
                      } else if ($index < $desktop_limit) {
                        $extra_class .= ' g-card__location-item--extra-md g-card__location-item--extra-lg';
                      }
                    }
                    
                    // Output comma for items after the first
                    if ($index > 0) {
                      echo ($index < $mobile_limit || $extra_class) ? '<span class="' . $extra_class . '">, </span>' : '';
                    }
                    
                    // Output the location link with appropriate class
                    echo '<a href="' . esc_url($location['url']) . '" class="g-card__location-link ' . $extra_class . '">' . esc_html($location['name']) . '</a>';
                  endforeach;
                  
                  // Show "+X more" indicators for different screen sizes
                  if ($location_count > $mobile_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--mobile">+' . ($location_count - $mobile_limit) . ' more</span>';
                  }
                  
                  if ($location_count > $tablet_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--tablet g-card__location-item--extra g-card__location-item--extra-md">+' . ($location_count - $tablet_limit) . ' more</span>';
                  }
                  
                  if ($location_count > $desktop_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--desktop g-card__location-item--extra g-card__location-item--extra-md g-card__location-item--extra-lg">+' . ($location_count - $desktop_limit) . ' more</span>';
                  }
                  ?>
                </div>
              </div>
              <?php endif; ?>
              
              <?php if (!empty($eligible_entities) && is_array($eligible_entities)): ?>
              <div class="g-card__meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <strong>Eligible:</strong> 
                <div class="g-card__location-list">
                  <?php 
                  $entity_count = count($eligible_entities);
                  $mobile_limit = 2;
                  $tablet_limit = 4;
                  $desktop_limit = 6;
                  
                  foreach ($eligible_entities as $index => $entity):
                    // Determine which responsive class to use
                    $extra_class = '';
                    if ($index >= $mobile_limit) {
                      $extra_class = 'g-card__location-item--extra';
                      if ($index < $tablet_limit) {
                        $extra_class .= ' g-card__location-item--extra-md';
                      } else if ($index < $desktop_limit) {
                        $extra_class .= ' g-card__location-item--extra-md g-card__location-item--extra-lg';
                      }
                    }
                    
                    // Output comma for items after the first
                    if ($index > 0) {
                      echo ($index < $mobile_limit || $extra_class) ? '<span class="' . $extra_class . '">, </span>' : '';
                    }
                    
                    // Output the entity with appropriate class - not linking as we don't have entity archive pages
                    echo '<span class="' . $extra_class . '">' . esc_html($entity) . '</span>';
                  endforeach;
                  
                  // Show "+X more" indicators for different screen sizes
                  if ($entity_count > $mobile_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--mobile">+' . ($entity_count - $mobile_limit) . ' more</span>';
                  }
                  
                  if ($entity_count > $tablet_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--tablet g-card__location-item--extra g-card__location-item--extra-md">+' . ($entity_count - $tablet_limit) . ' more</span>';
                  }
                  
                  if ($entity_count > $desktop_limit) {
                    echo '<span class="g-card__location-more g-card__location-more--desktop g-card__location-item--extra g-card__location-item--extra-md g-card__location-item--extra-lg">+' . ($entity_count - $desktop_limit) . ' more</span>';
                  }
                  ?>
                </div>
              </div>
              <?php endif; ?>
              
              <?php if (!empty($category_data)): ?>
              <div class="g-card__tags">
                <?php 
                $category_count = count($category_data);
                $mobile_limit = 2;
                $tablet_limit = 4;
                $desktop_limit = 6;
                
                foreach ($category_data as $index => $category):
                  // Determine which responsive class to use
                  $extra_class = '';
                  if ($index >= $mobile_limit) {
                    $extra_class = 'g-card__tag--extra';
                    if ($index < $tablet_limit) {
                      $extra_class .= ' g-card__tag--extra-md';
                    } else if ($index < $desktop_limit) {
                      $extra_class .= ' g-card__tag--extra-md g-card__tag--extra-lg';
                    }
                  }
                  
                  // Output category link
                  echo '<a href="' . esc_url($category['url']) . '" class="g-card__tag ' . $extra_class . '">' . esc_html($category['name']) . '</a>';
                endforeach;
                
                // Show "+X more" indicators for different screen sizes
                if ($category_count > $mobile_limit) {
                  echo '<span class="g-card__tag g-card__tag--more g-card__tag--more-mobile">+' . ($category_count - $mobile_limit) . ' more</span>';
                }
                
                if ($category_count > $tablet_limit) {
                  echo '<span class="g-card__tag g-card__tag--more g-card__tag--more-tablet g-card__tag--extra g-card__tag--extra-md">+' . ($category_count - $tablet_limit) . ' more</span>';
                }
                
                if ($category_count > $desktop_limit) {
                  echo '<span class="g-card__tag g-card__tag--more g-card__tag--more-desktop g-card__tag--extra g-card__tag--extra-md g-card__tag--extra-lg">+' . ($category_count - $desktop_limit) . ' more</span>';
                }
                ?>
              </div>
              <?php endif; ?>
            </div>
          </div>
        </div>
        <?php
      }
      
      // Store all filter data in JavaScript
      ?>
      <script type="text/javascript">
      // <![CDATA[
        // Store grant data for client-side filtering
        var grantauraGrantsData = <?php echo json_encode($grant_data_json); ?>;
        
        // Store available filter options with counts
        var grantauraFilterOptions = {
          categories: <?php echo json_encode($all_categories); ?>,
          locations: <?php echo json_encode($all_locations); ?>,
          eligibleEntities: <?php echo json_encode($all_eligible_entities); ?>,
          timeframes: <?php echo json_encode($timeframe_counts); ?>,
          locationHierarchy: <?php echo json_encode($location_hierarchy); ?>,
          filterRelationships: <?php echo json_encode($filter_relationships); ?>
        };
      // ]]>
      </script>
      <?php
      
      // Calculate the total number of posts and pages for pagination
      $has_multiple_pages = $total_pages > 1;
      
      if ($has_multiple_pages) {
        ?>
        <div class="g-pagination" id="g-pagination">
          <ul class="g-pagination__list">
            <?php
            $current_page = max(1, get_query_var('paged'));
            $is_not_first_page = $current_page > 1;
            
            // Previous page
            if ($is_not_first_page) {
              echo '<li class="g-pagination__item g-pagination__item--prev">
                      <a href="' . esc_url(get_pagenum_link($current_page - 1)) . '">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Prev
                      </a>
                    </li>';
            }
            
            // Page numbers
            $start_page = max(1, $current_page - 2);
            $end_page = min($start_page + 4, $total_pages);
            $is_start_page_after_first = $start_page > 1;
            
            if ($is_start_page_after_first) {
              echo '<li class="g-pagination__item">
                      <a href="' . esc_url(get_pagenum_link(1)) . '">1</a>
                    </li>';
                    
              $is_gap_needed = $start_page > 2;
              if ($is_gap_needed) {
                echo '<li class="g-pagination__item g-pagination__item--dots">
                        <span>...</span>
                      </li>';
              }
            }
            
            for ($i = $start_page; $i <= $end_page; $i++) {
              $is_current = $i == $current_page;
              if ($is_current) {
                echo '<li class="g-pagination__item g-pagination__item--current">
                        <span>' . $i . '</span>
                      </li>';
              } else {
                echo '<li class="g-pagination__item">
                        <a href="' . esc_url(get_pagenum_link($i)) . '">' . $i . '</a>
                      </li>';
              }
            }
            
            $is_end_before_last = $end_page < $total_pages;
            if ($is_end_before_last) {
              $is_gap_needed = $end_page < $total_pages - 1;
              if ($is_gap_needed) {
                echo '<li class="g-pagination__item g-pagination__item--dots">
                        <span>...</span>
                      </li>';
              }
              
              echo '<li class="g-pagination__item">
                      <a href="' . esc_url(get_pagenum_link($total_pages)) . '">' . $total_pages . '</a>
                    </li>';
            }
            
            // Next page
            $is_not_last_page = $current_page < $total_pages;
            if ($is_not_last_page) {
              echo '<li class="g-pagination__item g-pagination__item--next">
                      <a href="' . esc_url(get_pagenum_link($current_page + 1)) . '">
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                      </a>
                    </li>';
            }
            ?>
          </ul>
        </div>
        <?php
      }
    } else {
      // No grants found
      ?>
      <div class="no-grants-message">
        <style>
          .no-grants-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 1.5rem;
            background-color: var(--grantaura-gray-50);
            border-radius: var(--grantaura-border-radius);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--grantaura-gray-200);
          }
          
          .no-grants-message::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--grantaura-primary), var(--grantaura-secondary));
          }
          
          .no-grants-message h3 {
            font-size: clamp(1.5rem, 5vw, 1.75rem);
            margin-bottom: 1.25rem;
            color: var(--grantaura-gray-800);
            position: relative;
            display: inline-block;
          }
          
          .no-grants-message h3::after {
            content: "";
            position: absolute;
            left: 50%;
            bottom: -10px;
            transform: translateX(-50%);
            width: 70px;
            height: 3px;
            background-color: var(--grantaura-primary-light);
          }
          
          .no-grants-message p {
            font-size: clamp(0.95rem, 4vw, 1.1rem);
            color: var(--grantaura-gray-600);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
          }
        </style>
        
        <h3>No Grants Available</h3>
        <p>We're currently updating our grants database. Please check back soon for new grant opportunities, or contact us to learn about our custom grant research services.</p>
      </div>
      <?php
    }
    [/php]
  </div>
</section>
<!-- Progressive filtering JavaScript -->
<script>
// <![CDATA[
document.addEventListener('DOMContentLoaded', function() {
  // Function to check if values in an array are all true - safer alternative to && operator
  function checkConditions(conditions) {
    for (var i = 0; i < conditions.length; i++) {
      if (!conditions[i]) {
        return false;
      }
    }
    return true;
  }
  
  // Initialize countdown timers
  function initCountdowns() {
    const countdownElements = document.querySelectorAll('[data-countdown-time]');
    
    countdownElements.forEach(function(element) {
      const deadline = parseInt(element.dataset.countdownTime, 10) * 1000;
      const countdownEl = element.querySelector('.g-card__countdown');
      
      if (!countdownEl) return;
      
      const hoursElement = countdownEl.querySelector('[data-hours]');
      const minutesElement = countdownEl.querySelector('[data-minutes]');
      const secondsElement = countdownEl.querySelector('[data-seconds]');
      
      function updateCountdown() {
        const now = new Date().getTime();
        const distance = deadline - now;
        
        if (distance <= 0) {
          // Handle expired timer
          if (hoursElement) hoursElement.textContent = '00';
          if (minutesElement) minutesElement.textContent = '00';
          if (secondsElement) secondsElement.textContent = '00';
          return;
        }
        
        // Calculate time units
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Update the elements
        if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
        if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
        if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
      }
      
      // Initial update
      updateCountdown();
      
      // Update every second
      setInterval(updateCountdown, 1000);
    });
  }
  
  // Filter Setup
  const filterToggle = document.getElementById('grants-filter-toggle');
  const filterPanel = document.getElementById('grants-filter-panel');
  const filterClose = document.getElementById('grants-filter-close');
  const filterReset = document.getElementById('grants-filter-reset');
  const filterNext = document.getElementById('grants-filter-next');
  const filterBack = document.getElementById('grants-filter-back');
  const resetFiltersBtn = document.getElementById('reset-filters-btn');
  const filterCount = document.getElementById('filter-count');
  const activeFilters = document.getElementById('grants-active-filters');
  const filterResultCount = document.getElementById('grants-filter-result-count');
  const noFilteredGrants = document.getElementById('no-filtered-grants');
  const grantsContainer = document.getElementById('grants-container');
  const grantsContainerLoading = document.getElementById('grants-container-loading');
  const paginationContainer = document.getElementById('g-pagination');
  
  // Step navigation elements
  const filterSteps = document.querySelectorAll('.grants-filter-step');
  const filterStepContainers = document.querySelectorAll('.grants-filter-step-container');
  
  // Current active step
  let currentStep = 1;
  
  // Track active filters
  let activeFilterState = {
    status: [],
    featured: [],
    amount: {
      min: null,
      max: null,
      includeVaries: false
    },
    timeframe: [],
    eligibleEntities: [],
    categories: [],
    locations: []
  };
  
  // Helper function to show loading state
  function showLoading() {
    grantsContainerLoading.classList.add('active');
  }
  
  // Helper function to hide loading state
  function hideLoading() {
    grantsContainerLoading.classList.remove('active');
    
    // Re-initialize countdowns after filtering
    initCountdowns();
    
    // Re-initialize lazy loading for images
    handleIntersectionForVisible();
  }
  
  // Toggle filter panel
  if (filterToggle) {
    filterToggle.addEventListener('click', function() {
      filterPanel.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Initialize data for first step
      initFilterData();
      
      // Reset to first step when opening
      navigateToStep(1);
    });
  }
  
  // Close filter panel
  if (filterClose) {
    filterClose.addEventListener('click', function() {
      filterPanel.classList.remove('active');
      document.body.style.overflow = '';
    });
  }
  
  // Initialize filter data
  function initFilterData() {
    // Show loading states
    document.getElementById('eligibility-loading').classList.add('active');
    document.getElementById('category-loading').classList.add('active');
    document.getElementById('location-loading').classList.add('active');
    
    // Fetch and populate filter options
    setTimeout(function() {
      populateEligibilityOptions();
      populateCategoryOptions();
      populateLocationOptions();
      updateTimeframeCounts();
      
      // Hide loading states
      document.getElementById('eligibility-loading').classList.remove('active');
      document.getElementById('category-loading').classList.remove('active');
      document.getElementById('location-loading').classList.remove('active');
    }, 300);
  }
  
  // Update timeframe count indicators
  function updateTimeframeCounts() {
    if (!window.grantauraFilterOptions || !window.grantauraFilterOptions.timeframes) return;
    
    const timeframes = window.grantauraFilterOptions.timeframes;
    const filterRelationships = window.grantauraFilterOptions.filterRelationships;
    
    // Get counts for each timeframe option
    let countToday = timeframes.today;
    let countWeek = timeframes.week;
    let countMonth = timeframes.month;
    let countQuarter = timeframes.quarter;
    
    // Apply filtering based on other selected filters
    if (activeFilterState.eligibleEntities.length > 0 || 
        activeFilterState.categories.length > 0 || 
        activeFilterState.locations.length > 0 ||
        activeFilterState.amount.min !== null ||
        activeFilterState.amount.max !== null ||
        activeFilterState.amount.includeVaries) {
      
      // Get eligible grants based on current filter state
      const eligibleGrants = getEligibleGrantIds();
      
      // Update counts
      if (filterRelationships) {
        countToday = filterRelationships.timeframes.today.filter(id => eligibleGrants.includes(id)).length;
        countWeek = filterRelationships.timeframes.week.filter(id => eligibleGrants.includes(id)).length;
        countMonth = filterRelationships.timeframes.month.filter(id => eligibleGrants.includes(id)).length;
        countQuarter = filterRelationships.timeframes.quarter.filter(id => eligibleGrants.includes(id)).length;
      }
    }
    
    // Update count displays
    document.querySelector('[data-dynamic-count="timeframe-today"]').textContent = countToday;
    document.querySelector('[data-dynamic-count="timeframe-week"]').textContent = countWeek;
    document.querySelector('[data-dynamic-count="timeframe-month"]').textContent = countMonth;
    document.querySelector('[data-dynamic-count="timeframe-quarter"]').textContent = countQuarter;
  }
  
  // Helper function to get eligible grant ids based on current filter state
  function getEligibleGrantIds() {
    if (!window.grantauraFilterOptions || !window.grantauraFilterOptions.filterRelationships) return [];
    
    const relationships = window.grantauraFilterOptions.filterRelationships;
    const grants = relationships.grants;
    let eligibleIds = Object.keys(grants).map(Number);
    
    // Apply amount filtering
    if (activeFilterState.amount.min !== null || activeFilterState.amount.max !== null) {
      eligibleIds = eligibleIds.filter(id => {
        const grant = grants[id];
        if (grant.amount === 'varies') {
          return activeFilterState.amount.includeVaries;
        }
        
        const amount = parseInt(grant.amount, 10);
        let passes = true;
        
        if (activeFilterState.amount.min !== null) {
          passes = passes && amount >= activeFilterState.amount.min;
        }
        
        if (activeFilterState.amount.max !== null) {
          passes = passes && amount <= activeFilterState.amount.max;
        }
        
        return passes;
      });
    } else if (activeFilterState.amount.includeVaries) {
      // If only "includeVaries" is selected without min/max, we need to do nothing special
      // as we want to include all grants
    }
    
    // Apply eligibility filtering
    if (activeFilterState.eligibleEntities.length > 0) {
      eligibleIds = eligibleIds.filter(id => {
        const grant = grants[id];
        return activeFilterState.eligibleEntities.some(entity => grant.eligibility.includes(entity));
      });
    }
    
    // Apply category filtering
    if (activeFilterState.categories.length > 0) {
      eligibleIds = eligibleIds.filter(id => {
        const grant = grants[id];
        return activeFilterState.categories.some(category => grant.categories.includes(category));
      });
    }
    
    // Apply location filtering
    if (activeFilterState.locations.length > 0) {
      eligibleIds = eligibleIds.filter(id => {
        const grant = grants[id];
        return activeFilterState.locations.some(location => grant.locations.includes(location));
      });
    }
    
    return eligibleIds;
  }
  
  // Navigate between steps
  function navigateToStep(step) {
    // Validate step
    if (step < 1 || step > filterSteps.length) return;
    
    // Update relevant counts as we navigate between steps
    if (step === 3) { // Going to eligibility step
      updateEligibilityCounts();
    } else if (step === 4) { // Going to categories step
      updateCategoryCounts();
    } else if (step === 5) { // Going to locations step
      updateLocationCounts();
    } else if (step === 2) { // Going to timeframe step
      updateTimeframeCounts();
    }
    
    // Update current step
    currentStep = step;
    
    // Update step indicators
    filterSteps.forEach(function(stepEl) {
      const stepNum = parseInt(stepEl.dataset.step, 10);
      stepEl.classList.remove('active', 'completed');
      
      if (stepNum === currentStep) {
        stepEl.classList.add('active');
      } else if (stepNum < currentStep) {
        stepEl.classList.add('completed');
      }
    });
    
    // Show current step content
    filterStepContainers.forEach(function(container) {
      container.classList.remove('active');
      if (parseInt(container.dataset.stepContainer, 10) === currentStep) {
        container.classList.add('active');
      }
    });
    
    // Update navigation buttons
    filterBack.disabled = currentStep === 1;
    
    if (currentStep === filterSteps.length) {
      filterNext.textContent = 'Apply Filters';
      // Update summary view
      updateSummaryView();
      // Update matching grants count
      updateMatchingGrantsCount();
    } else {
      filterNext.textContent = 'Next';
    }
  }
  
  // Update eligibility counts based on other selected filters
  function updateEligibilityCounts() {
    if (!window.grantauraFilterOptions || !window.grantauraFilterOptions.filterRelationships) return;
    
    const eligibilityOptions = document.querySelectorAll('input[name="eligibleEntities"]');
    const relationships = window.grantauraFilterOptions.filterRelationships;
    
    // Get eligible grants based on current filter state (excluding eligibility)
    const currentEligibility = [...activeFilterState.eligibleEntities];
    activeFilterState.eligibleEntities = [];
    const eligibleGrants = getEligibleGrantIds();
    activeFilterState.eligibleEntities = currentEligibility;
    
    // Update eligibility counts
    eligibilityOptions.forEach(option => {
      const entity = option.value;
      const entityOption = option.closest('.grants-filter-checkbox');
      const countElement = entityOption.querySelector('.grants-filter-option-count');
      
      if (countElement && relationships.eligibility[entity]) {
        const filteredCount = relationships.eligibility[entity].filter(id => eligibleGrants.includes(Number(id))).length;
        countElement.textContent = filteredCount;
        
        // If count is zero, disable the option
        if (filteredCount === 0 && !option.checked) {
          entityOption.classList.add('disabled');
          option.disabled = true;
        } else {
          entityOption.classList.remove('disabled');
          option.disabled = false;
        }
      }
    });
  }
  
  // Update category counts based on other selected filters
  function updateCategoryCounts() {
    if (!window.grantauraFilterOptions || !window.grantauraFilterOptions.filterRelationships) return;
    
    const categoryOptions = document.querySelectorAll('input[name="categories"]');
    const relationships = window.grantauraFilterOptions.filterRelationships;
    
    // Get eligible grants based on current filter state (excluding categories)
    const currentCategories = [...activeFilterState.categories];
    activeFilterState.categories = [];
    const eligibleGrants = getEligibleGrantIds();
    activeFilterState.categories = currentCategories;
    
    // Update category counts
    categoryOptions.forEach(option => {
      const category = option.value;
      const categoryOption = option.closest('.grants-filter-checkbox');
      const countElement = categoryOption.querySelector('.grants-filter-option-count');
      
      if (countElement && relationships.categories[category]) {
        const filteredCount = relationships.categories[category].filter(id => eligibleGrants.includes(Number(id))).length;
        countElement.textContent = filteredCount;
        
        // If count is zero, disable the option
        if (filteredCount === 0 && !option.checked) {
          categoryOption.classList.add('disabled');
          option.disabled = true;
        } else {
          categoryOption.classList.remove('disabled');
          option.disabled = false;
        }
      }
    });
  }
  
  // Update location counts based on other selected filters
  function updateLocationCounts() {
    if (!window.grantauraFilterOptions || !window.grantauraFilterOptions.filterRelationships) return;
    
    const locationOptions = document.querySelectorAll('input[name="locations"]');
    const relationships = window.grantauraFilterOptions.filterRelationships;
    
    // Get eligible grants based on current filter state (excluding locations)
    const currentLocations = [...activeFilterState.locations];
    activeFilterState.locations = [];
    const eligibleGrants = getEligibleGrantIds();
    activeFilterState.locations = currentLocations;
    
    // Update location counts
    locationOptions.forEach(option => {
      const location = option.value;
      const locationOption = option.closest('.grants-filter-checkbox');
      const countElement = locationOption.querySelector('.grants-filter-option-count');
      
      if (countElement && relationships.locations[location]) {
        const filteredCount = relationships.locations[location].filter(id => eligibleGrants.includes(Number(id))).length;
        countElement.textContent = filteredCount;
        
        // If count is zero, disable the option
        if (filteredCount === 0 && !option.checked) {
          locationOption.classList.add('disabled');
          option.disabled = true;
        } else {
          locationOption.classList.remove('disabled');
          option.disabled = false;
        }
      }
    });
  }
  
  // Step navigation - next button
  if (filterNext) {
    filterNext.addEventListener('click', function() {
      if (currentStep === filterSteps.length) {
        // Last step - apply filters
        applyFilters();
        filterPanel.classList.remove('active');
        document.body.style.overflow = '';
      } else {
        // Go to next step
        navigateToStep(currentStep + 1);
      }
    });
  }
  
  // Step navigation - back button
  if (filterBack) {
    filterBack.addEventListener('click', function() {
      navigateToStep(currentStep - 1);
    });
  }
  
  // Step navigation - click on step indicators
  filterSteps.forEach(function(step) {
    step.addEventListener('click', function() {
      navigateToStep(parseInt(this.dataset.step, 10));
    });
  });
  
  // Update summary view in the last step
  function updateSummaryView() {
    // Amount summary
    const summaryAmount = document.getElementById('summary-amount');
    let amountSummary = '<span class="grants-filter-summary-empty">No amount filters selected</span>';
    
    if (activeFilterState.amount.min !== null || activeFilterState.amount.max !== null || activeFilterState.amount.includeVaries) {
      const parts = [];
      
      if (activeFilterState.amount.min !== null) {
        parts.push(`Minimum: $${activeFilterState.amount.min.toLocaleString()}`);
      }
      
      if (activeFilterState.amount.max !== null) {
        parts.push(`Maximum: $${activeFilterState.amount.max.toLocaleString()}`);
      }
      
      if (activeFilterState.amount.includeVaries) {
        parts.push("Including various benefits grants");
      }
      
      amountSummary = parts.join('<br>');
    }
    
    summaryAmount.innerHTML = amountSummary;
    
    // Timeframe summary
    const summaryTimeframe = document.getElementById('summary-timeframe');
    let timeframeSummary = '<span class="grants-filter-summary-empty">No timeframe filters selected</span>';
    
    if (activeFilterState.timeframe.length > 0) {
      const timeframeLabels = {
        'today': 'Ending Today',
        'week': 'Ending This Week',
        'month': 'Ending This Month',
        'quarter': 'Ending This Quarter'
      };
      
      const parts = activeFilterState.timeframe.map(function(tf) {
        return timeframeLabels[tf] || tf;
      });
      
      timeframeSummary = parts.join('<br>');
    }
    
    summaryTimeframe.innerHTML = timeframeSummary;
    
    // Eligibility summary
    const summaryEligibility = document.getElementById('summary-eligibility');
    let eligibilitySummary = '<span class="grants-filter-summary-empty">No eligibility filters selected</span>';
    
    if (activeFilterState.eligibleEntities.length > 0) {
      eligibilitySummary = activeFilterState.eligibleEntities.join('<br>');
    }
    
    summaryEligibility.innerHTML = eligibilitySummary;
    
    // Categories summary
    const summaryCategories = document.getElementById('summary-categories');
    let categoriesSummary = '<span class="grants-filter-summary-empty">No category filters selected</span>';
    
    if (activeFilterState.categories.length > 0) {
      categoriesSummary = activeFilterState.categories.join('<br>');
    }
    
    summaryCategories.innerHTML = categoriesSummary;
    
    // Locations summary
    const summaryLocations = document.getElementById('summary-locations');
    let locationsSummary = '<span class="grants-filter-summary-empty">No location filters selected</span>';
    
    if (activeFilterState.locations.length > 0) {
      locationsSummary = activeFilterState.locations.join('<br>');
    }
    
    summaryLocations.innerHTML = locationsSummary;
  }
  
  // Update matching grants count based on current filters
  function updateMatchingGrantsCount() {
    const matchingCountEl = document.getElementById('matching-grants-count');
    if (!matchingCountEl) return;
    
    // Get all grant cards
    const grantCards = document.querySelectorAll('.g-card');
    
    // Check if any filters are active
    const hasActiveFilters = 
      activeFilterState.status.length > 0 ||
      activeFilterState.featured.length > 0 ||
      activeFilterState.amount.min !== null ||
      activeFilterState.amount.max !== null ||
      activeFilterState.amount.includeVaries ||
      activeFilterState.timeframe.length > 0 ||
      activeFilterState.eligibleEntities.length > 0 ||
      activeFilterState.categories.length > 0 ||
      activeFilterState.locations.length > 0;
    
    // If no filters, show all grants count
    if (!hasActiveFilters) {
      matchingCountEl.textContent = grantCards.length;
      return;
    }
    
    // Count matches
    let matchCount = 0;
    
    grantCards.forEach(function(card) {
      // Get data from card attributes
      const status = card.dataset.status;
      const isFeatured = card.dataset.featured === 'true';
      const amount = card.dataset.amount;
      const deadlineTimestamp = card.dataset.deadline ? parseInt(card.dataset.deadline, 10) : 0;
      const locations = card.dataset.locations ? card.dataset.locations.split('|') : [];
      const categories = card.dataset.categories ? card.dataset.categories.split('|') : [];
      const eligibleEntities = card.dataset.eligibleEntities ? card.dataset.eligibleEntities.split('|') : [];
      
      // Check each filter category
      const passesStatusFilter = activeFilterState.status.length === 0 || activeFilterState.status.includes(status);
      
      const passesFeaturedFilter = activeFilterState.featured.length === 0 || 
        (activeFilterState.featured.includes('true') && isFeatured) || 
        (activeFilterState.featured.includes('false') && !isFeatured);
      
      // Amount filter logic
      let passesAmountFilter = true;
      if (amount !== 'varies') {
        const amountValue = parseInt(amount, 10);
        if (activeFilterState.amount.min !== null) {
          passesAmountFilter = passesAmountFilter && amountValue >= activeFilterState.amount.min;
        }
        if (activeFilterState.amount.max !== null) {
          passesAmountFilter = passesAmountFilter && amountValue <= activeFilterState.amount.max;
        }
      } else {
        // If "varies" and includeVaries is false, and we have min/max filters, this should not pass
        if ((activeFilterState.amount.min !== null || activeFilterState.amount.max !== null) && !activeFilterState.amount.includeVaries) {
          passesAmountFilter = false;
        }
      }
      
      // Time frame filter
      let passesTimeframeFilter = true;
      if (activeFilterState.timeframe.length > 0 && deadlineTimestamp > 0) {
        const now = Math.floor(Date.now() / 1000);
        const hasToday = activeFilterState.timeframe.includes('today');
        const hasWeek = activeFilterState.timeframe.includes('week');
        const hasMonth = activeFilterState.timeframe.includes('month');
        const hasQuarter = activeFilterState.timeframe.includes('quarter');
        
        const dayEnd = now + (24 * 60 * 60);
        const weekEnd = now + (7 * 24 * 60 * 60);
        const monthEnd = now + (30 * 24 * 60 * 60);
        const quarterEnd = now + (90 * 24 * 60 * 60);
        
        passesTimeframeFilter = false;
        
        if (hasToday && deadlineTimestamp <= dayEnd) {
          passesTimeframeFilter = true;
        } else if (hasWeek && deadlineTimestamp <= weekEnd) {
          passesTimeframeFilter = true;
        } else if (hasMonth && deadlineTimestamp <= monthEnd) {
          passesTimeframeFilter = true;
        } else if (hasQuarter && deadlineTimestamp <= quarterEnd) {
          passesTimeframeFilter = true;
        }
      }
      
      // Eligible entities filter
      const passesEligibleFilter = activeFilterState.eligibleEntities.length === 0 || 
        activeFilterState.eligibleEntities.some(entity => eligibleEntities.includes(entity));
      
      // Categories filter
      const passesCategoryFilter = activeFilterState.categories.length === 0 || 
        activeFilterState.categories.some(category => categories.includes(category));
      
      // Locations filter
      const passesLocationFilter = activeFilterState.locations.length === 0 || 
        activeFilterState.locations.some(location => locations.includes(location));
      
      // Combined filter result
      const isVisible = checkConditions([
        passesStatusFilter,
        passesFeaturedFilter,
        passesAmountFilter,
        passesTimeframeFilter,
        passesEligibleFilter,
        passesCategoryFilter,
        passesLocationFilter
      ]);
      
      if (isVisible) {
        matchCount++;
      }
    });
    
    matchingCountEl.textContent = matchCount;
  }
  
  // Populate eligibility options
  function populateEligibilityOptions() {
    const eligibilityOptions = document.getElementById('eligibility-options');
    const eligibilitySelected = document.getElementById('eligibility-selected');
    
    if (!eligibilityOptions || !eligibilitySelected) return;
    
    if (typeof grantauraFilterOptions === 'undefined' || !grantauraFilterOptions.eligibleEntities) {
      // Fallback for missing data
      eligibilityOptions.innerHTML = `
        <div class="grants-filter-no-results">
          <p>Could not load eligibility data. Please select other filter criteria or try again later.</p>
        </div>`;
      return;
    }
    
    const entities = grantauraFilterOptions.eligibleEntities;
    eligibilityOptions.innerHTML = '';
    
    // Sort entities alphabetically
    const sortedEntities = Object.entries(entities)
      .sort((a, b) => a[0].localeCompare(b[0]))
      .map(([entity, count]) => ({ entity, count }));
    
    // Create option for each entity
    sortedEntities.forEach(function(item) {
      const option = document.createElement('label');
      option.className = 'grants-filter-checkbox';
      option.htmlFor = `entity-${item.entity.replace(/\s+/g, '-').toLowerCase()}`;
      option.innerHTML = `
        <input type="checkbox" id="entity-${item.entity.replace(/\s+/g, '-').toLowerCase()}" name="eligibleEntities" value="${item.entity}" data-filter-group="eligibleEntities">
        <div class="grants-filter-option-content">
          <span class="grants-filter-option-label">${item.entity}</span>
          <span class="grants-filter-option-count">${item.count}</span>
        </div>
      `;
      
      eligibilityOptions.appendChild(option);
      
      // Add event listener
      const checkbox = option.querySelector('input[type="checkbox"]');
      
      // Check if this entity is already selected
      if (activeFilterState.eligibleEntities.includes(item.entity)) {
        checkbox.checked = true;
        option.classList.add('selected');
      }
      
      checkbox.addEventListener('change', function() {
        option.classList.toggle('selected', this.checked);
        
        if (this.checked) {
          // Add to filter state
          if (!activeFilterState.eligibleEntities.includes(item.entity)) {
            activeFilterState.eligibleEntities.push(item.entity);
          }
          
          // Add chip to selected section
          addFilterChip(item.entity, 'eligibleEntities', eligibilitySelected);
        } else {
          // Remove from filter state
          const index = activeFilterState.eligibleEntities.indexOf(item.entity);
          if (index !== -1) {
            activeFilterState.eligibleEntities.splice(index, 1);
          }
          
          // Remove chip from selected section
          removeFilterChip(item.entity, eligibilitySelected);
        }
        
        // Update subsequent filter options based on this selection
        updateCategoryCounts();
        updateLocationCounts();
        updateTimeframeCounts();
        
        // Update matching grants count
        updateMatchingGrantsCount();
      });
    });
    
    // Add search functionality
    const eligibilitySearch = document.getElementById('eligibility-search');
    if (eligibilitySearch) {
      eligibilitySearch.addEventListener('input', debounce(function() {
        filterOptions(eligibilityOptions, this.value);
      }, 200));
    }
    
    // If there are already selected items, show them
    if (activeFilterState.eligibleEntities.length > 0) {
      updateSelectedChips(activeFilterState.eligibleEntities, 'eligibleEntities', eligibilitySelected);
    }
    
    // Show active filter counts
    updateEligibilityCounts();
  }
  
  // Populate category options
  function populateCategoryOptions() {
    const categoryOptions = document.getElementById('category-options');
    const categorySelected = document.getElementById('category-selected');
    
    if (!categoryOptions || !categorySelected) return;
    
    if (typeof grantauraFilterOptions === 'undefined' || !grantauraFilterOptions.categories) {
      // Fallback for missing data
      categoryOptions.innerHTML = `
        <div class="grants-filter-no-results">
          <p>Could not load category data. Please select other filter criteria or try again later.</p>
        </div>`;
      return;
    }
    
    const categories = grantauraFilterOptions.categories;
    categoryOptions.innerHTML = '';
    
    // Sort categories alphabetically
    const sortedCategories = Object.entries(categories)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([category, data]) => ({ 
        category, 
        count: data.count, 
        slug: data.slug 
      }));
    
    // Create option for each category
    sortedCategories.forEach(function(item) {
      const option = document.createElement('label');
      option.className = 'grants-filter-checkbox';
      option.htmlFor = `category-${item.slug}`;
      option.innerHTML = `
        <input type="checkbox" id="category-${item.slug}" name="categories" value="${item.category}" data-filter-group="categories">
        <div class="grants-filter-option-content">
          <span class="grants-filter-option-label">${item.category}</span>
          <span class="grants-filter-option-count">${item.count}</span>
        </div>
      `;
      
      categoryOptions.appendChild(option);
      
      // Add event listener
      const checkbox = option.querySelector('input[type="checkbox"]');
      
      // Check if this category is already selected
      if (activeFilterState.categories.includes(item.category)) {
        checkbox.checked = true;
        option.classList.add('selected');
      }
      
      checkbox.addEventListener('change', function() {
        option.classList.toggle('selected', this.checked);
        
        if (this.checked) {
          // Add to filter state
          if (!activeFilterState.categories.includes(item.category)) {
            activeFilterState.categories.push(item.category);
          }
          
          // Add chip to selected section
          addFilterChip(item.category, 'categories', categorySelected);
        } else {
          // Remove from filter state
          const index = activeFilterState.categories.indexOf(item.category);
          if (index !== -1) {
            activeFilterState.categories.splice(index, 1);
          }
          
          // Remove chip from selected section
          removeFilterChip(item.category, categorySelected);
        }
        
        // Update other filter options counts
        updateEligibilityCounts();
        updateLocationCounts();
        updateTimeframeCounts();
        
        // Update matching grants count
        updateMatchingGrantsCount();
      });
    });
    
    // Add search functionality
    const categorySearch = document.getElementById('category-search');
    if (categorySearch) {
      categorySearch.addEventListener('input', debounce(function() {
        filterOptions(categoryOptions, this.value);
      }, 200));
    }
    
    // If there are already selected items, show them
    if (activeFilterState.categories.length > 0) {
      updateSelectedChips(activeFilterState.categories, 'categories', categorySelected);
    }
    
    // Show active filter counts
    updateCategoryCounts();
  }
  
  // Populate location options
  function populateLocationOptions() {
    const locationOptions = document.getElementById('location-options');
    const locationSelected = document.getElementById('location-selected');
    
    if (!locationOptions || !locationSelected) return;
    
    if (typeof grantauraFilterOptions === 'undefined' || !grantauraFilterOptions.locations) {
      // Fallback for missing data
      locationOptions.innerHTML = `
        <div class="grants-filter-no-results">
          <p>Could not load location data. Please select other filter criteria or try again later.</p>
        </div>`;
      return;
    }
    
    const locations = grantauraFilterOptions.locations;
    const locationHierarchy = grantauraFilterOptions.locationHierarchy || {};
    locationOptions.innerHTML = '';
    
    // Group locations by parent-child relationship
    const parentToChildren = {};
    const topLevelLocations = [];
    
    // First identify the top-level locations and create parent-child mapping
    Object.entries(locationHierarchy).forEach(([id, data]) => {
      const termId = parseInt(id, 10);
      if (data.parent === 0) {
        topLevelLocations.push({
          id: termId,
          name: data.name,
          slug: data.slug,
          count: data.count
        });
      }
      
      if (data.children && data.children.length > 0) {
        parentToChildren[termId] = data.children.map(childId => parseInt(childId, 10));
      }
    });
    
    // Sort top level locations alphabetically with Global first
    topLevelLocations.sort((a, b) => {
      if (a.name === 'Global') return -1;
      if (b.name === 'Global') return 1;
      return a.name.localeCompare(b.name);
    });
    
    // Function to create location option element
    function createLocationOption(location, isChild = false) {
      const option = document.createElement('label');
      option.className = isChild ? 'grants-filter-checkbox grants-filter-subitem' : 'grants-filter-checkbox';
      option.htmlFor = `location-${location.slug}`;
      option.innerHTML = `
        <input type="checkbox" id="location-${location.slug}" name="locations" value="${location.name}" data-filter-group="locations" data-location-id="${location.id}">
        <div class="grants-filter-option-content">
          <span class="grants-filter-option-label">${location.name}</span>
          <span class="grants-filter-option-count">${location.count}</span>
        </div>
      `;
      
      // Check if this location is already selected
      const checkbox = option.querySelector('input[type="checkbox"]');
      if (activeFilterState.locations.includes(location.name)) {
        checkbox.checked = true;
        option.classList.add('selected');
      }
      
      // Add event listener
      checkbox.addEventListener('change', function() {
        option.classList.toggle('selected', this.checked);
        
        if (this.checked) {
          // Add to filter state
          if (!activeFilterState.locations.includes(location.name)) {
            activeFilterState.locations.push(location.name);
          }
          
          // Add chip to selected section
          addFilterChip(location.name, 'locations', locationSelected);
        } else {
          // Remove from filter state
          const index = activeFilterState.locations.indexOf(location.name);
          if (index !== -1) {
            activeFilterState.locations.splice(index, 1);
          }
          
          // Remove chip from selected section
          removeFilterChip(location.name, locationSelected);
        }
        
        // Update other filter options counts
        updateEligibilityCounts();
        updateCategoryCounts();
        updateTimeframeCounts();
        
        // Update matching grants count
        updateMatchingGrantsCount();
      });
      
      return option;
    }
    
    // Process each top-level location and its children
    topLevelLocations.forEach(location => {
      // Create group header for top-level location
      const groupHeader = document.createElement('div');
      groupHeader.className = 'grants-filter-group-header';
      groupHeader.innerHTML = `<h5>${location.name}</h5>`;
      locationOptions.appendChild(groupHeader);
      
      // Add the top-level location itself
      const locationOption = createLocationOption(location);
      locationOptions.appendChild(locationOption);
      
      // Process children if any
      if (parentToChildren[location.id]) {
        const childIds = parentToChildren[location.id];
        
        // Sort children alphabetically
        const childLocations = childIds
          .map(id => locationHierarchy[id])
          .filter(data => data) // Ensure we have valid data
          .sort((a, b) => a.name.localeCompare(b.name))
          .map(data => ({
            id: data.id,
            name: data.name,
            slug: data.slug,
            count: data.count
          }));
        
        // Add child locations
        childLocations.forEach(childLocation => {
          const childOption = createLocationOption(childLocation, true);
          locationOptions.appendChild(childOption);
          
          // Process grandchildren if any
          if (parentToChildren[childLocation.id]) {
            const grandchildIds = parentToChildren[childLocation.id];
            
            // Sort grandchildren alphabetically
            const grandchildLocations = grandchildIds
              .map(id => locationHierarchy[id])
              .filter(data => data) // Ensure we have valid data
              .sort((a, b) => a.name.localeCompare(b.name))
              .map(data => ({
                id: data.id,
                name: data.name,
                slug: data.slug,
                count: data.count
              }));
            
            // Add grandchild locations with double indentation
            grandchildLocations.forEach(grandchildLocation => {
              const grandchildOption = document.createElement('label');
              grandchildOption.className = 'grants-filter-checkbox grants-filter-subitem grants-filter-subitem-level2';
              grandchildOption.style.paddingLeft = '3rem'; // Additional indentation
              grandchildOption.htmlFor = `location-${grandchildLocation.slug}`;
              grandchildOption.innerHTML = `
                <input type="checkbox" id="location-${grandchildLocation.slug}" name="locations" value="${grandchildLocation.name}" data-filter-group="locations" data-location-id="${grandchildLocation.id}">
                <div class="grants-filter-option-content">
                  <span class="grants-filter-option-label">${grandchildLocation.name}</span>
                  <span class="grants-filter-option-count">${grandchildLocation.count}</span>
                </div>
              `;
              
              // Check if this location is already selected
              const checkbox = grandchildOption.querySelector('input[type="checkbox"]');
              if (activeFilterState.locations.includes(grandchildLocation.name)) {
                checkbox.checked = true;
                grandchildOption.classList.add('selected');
              }
              
              // Add same event listener as other locations
              checkbox.addEventListener('change', function() {
                grandchildOption.classList.toggle('selected', this.checked);
                
                if (this.checked) {
                  if (!activeFilterState.locations.includes(grandchildLocation.name)) {
                    activeFilterState.locations.push(grandchildLocation.name);
                  }
                  addFilterChip(grandchildLocation.name, 'locations', locationSelected);
                } else {
                  const index = activeFilterState.locations.indexOf(grandchildLocation.name);
                  if (index !== -1) {
                    activeFilterState.locations.splice(index, 1);
                  }
                  removeFilterChip(grandchildLocation.name, locationSelected);
                }
                
                updateEligibilityCounts();
                updateCategoryCounts();
                updateTimeframeCounts();
                updateMatchingGrantsCount();
              });
              
              locationOptions.appendChild(grandchildOption);
            });
          }
        });
      }
    });
    
    // Add search functionality
    const locationSearch = document.getElementById('location-search');
    if (locationSearch) {
      locationSearch.addEventListener('input', debounce(function() {
        filterOptionsHierarchy(locationOptions, this.value);
      }, 200));
    }
    
    // If there are already selected items, show them
    if (activeFilterState.locations.length > 0) {
      updateSelectedChips(activeFilterState.locations, 'locations', locationSelected);
    }
    
    // Show active filter counts
    updateLocationCounts();
  }
  
  // Filter hierarchical options (like locations) based on search term
  function filterOptionsHierarchy(container, searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    
    // First, hide all group headers and show them only if they have visible children
    const groupHeaders = container.querySelectorAll('.grants-filter-group-header');
    groupHeaders.forEach(header => {
      header.style.display = 'none';
    });
    
    // Process all option elements
    const options = container.querySelectorAll('.grants-filter-checkbox');
    let lastVisibleHeader = null;
    
    options.forEach(option => {
      const label = option.querySelector('.grants-filter-option-label').textContent.toLowerCase();
      const matches = label.includes(term);
      
      if (matches || term === '') {
        option.style.display = '';
        
        // Find the preceding header and make it visible
        let currentElement = option.previousElementSibling;
        while (currentElement && !currentElement.classList.contains('grants-filter-group-header')) {
          currentElement = currentElement.previousElementSibling;
        }
        
        if (currentElement && currentElement.classList.contains('grants-filter-group-header')) {
          currentElement.style.display = '';
          lastVisibleHeader = currentElement;
        }
      } else {
        option.style.display = 'none';
      }
    });
    
    // If no options match, show a message
    const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
    if (visibleOptions.length === 0 && term !== '') {
      // Create or update "no results" message
      let noResults = container.querySelector('.grants-filter-no-results');
      if (!noResults) {
        noResults = document.createElement('div');
        noResults.className = 'grants-filter-no-results';
        noResults.innerHTML = `<p>No locations match "${searchTerm}". Try a different search term.</p>`;
        container.appendChild(noResults);
      } else {
        noResults.innerHTML = `<p>No locations match "${searchTerm}". Try a different search term.</p>`;
        noResults.style.display = 'block';
      }
    } else {
      // Hide "no results" message if it exists
      const noResults = container.querySelector('.grants-filter-no-results');
      if (noResults) {
        noResults.style.display = 'none';
      }
    }
  }
  
  // Filter options based on search term
  function filterOptions(container, searchTerm) {
    const options = container.querySelectorAll('.grants-filter-checkbox');
    const term = searchTerm.toLowerCase().trim();
    let hasVisibleOptions = false;
    
    options.forEach(function(option) {
      const label = option.querySelector('.grants-filter-option-label').textContent.toLowerCase();
      const matches = label.includes(term);
      option.style.display = matches ? '' : 'none';
      if (matches) hasVisibleOptions = true;
    });
    
    // If no options match, show a message
    if (!hasVisibleOptions && term !== '') {
      // Create or update "no results" message
      let noResults = container.querySelector('.grants-filter-no-results');
      if (!noResults) {
        noResults = document.createElement('div');
        noResults.className = 'grants-filter-no-results';
        noResults.innerHTML = `<p>No matches found for "${searchTerm}". Try a different search term.</p>`;
        container.appendChild(noResults);
      } else {
        noResults.innerHTML = `<p>No matches found for "${searchTerm}". Try a different search term.</p>`;
        noResults.style.display = 'block';
      }
    } else {
      // Hide "no results" message if it exists
      const noResults = container.querySelector('.grants-filter-no-results');
      if (noResults) {
        noResults.style.display = 'none';
      }
    }
  }
  
  // Add a filter chip to the selected section
  function addFilterChip(value, group, container) {
    if (!container) return;
    
    // Check if chip already exists
    const existingChip = container.querySelector(`[data-value="${value}"]`);
    if (existingChip) return;
    
    // Create chip
    const chip = document.createElement('div');
    chip.className = 'grants-filter-chip';
    chip.dataset.value = value;
    chip.innerHTML = `
      ${value}
      <button type="button" class="grants-filter-chip-remove" aria-label="Remove ${value}">Ã—</button>
    `;
    
    // Add event listener to remove button
    const removeBtn = chip.querySelector('.grants-filter-chip-remove');
    removeBtn.addEventListener('click', function() {
      // Remove from filter state
      const index = activeFilterState[group].indexOf(value);
      if (index !== -1) {
        activeFilterState[group].splice(index, 1);
      }
      
      // Remove chip
      chip.remove();
      
      // Uncheck corresponding checkbox
      const checkbox = document.querySelector(`input[type="checkbox"][name="${group}"][value="${value}"]`);
      if (checkbox) {
        checkbox.checked = false;
        const optionEl = checkbox.closest('.grants-filter-checkbox');
        if (optionEl) {
          optionEl.classList.remove('selected');
        }
      }
      
      // Update filter option counts
      updateEligibilityCounts();
      updateCategoryCounts();
      updateLocationCounts();
      updateTimeframeCounts();
      
      // Update matching grants count
      updateMatchingGrantsCount();
    });
    
    container.appendChild(chip);
  }
  
  // Remove a filter chip from the selected section
  function removeFilterChip(value, container) {
    if (!container) return;
    
    const chip = container.querySelector(`[data-value="${value}"]`);
    if (chip) {
      chip.remove();
    }
  }
  
  // Update selected chips based on active filter state
  function updateSelectedChips(values, group, container) {
    if (!container) return;
    container.innerHTML = '';
    values.forEach(value => addFilterChip(value, group, container));
  }
  
  // Debounce utility function to limit search input events
  function debounce(func, wait) {
    let timeout;
    return function() {
      const context = this, args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), wait);
    };
  }
  
  // Apply filters to the grants list and update pagination
  function applyFilters() {
    showLoading();
    
    // Get all grant cards
    const grantCards = document.querySelectorAll('.g-card');
    let visibleCards = [];
    
    grantCards.forEach(function(card) {
      // Get data from card attributes
      const status = card.dataset.status;
      const isFeatured = card.dataset.featured === 'true';
      const amount = card.dataset.amount;
      const deadlineTimestamp = card.dataset.deadline ? parseInt(card.dataset.deadline, 10) : 0;
      const locations = card.dataset.locations ? card.dataset.locations.split('|') : [];
      const categories = card.dataset.categories ? card.dataset.categories.split('|') : [];
      const eligibleEntities = card.dataset.eligibleEntities ? card.dataset.eligibleEntities.split('|') : [];
      
      // Check each filter category
      const passesStatusFilter = activeFilterState.status.length === 0 || activeFilterState.status.includes(status);
      
      const passesFeaturedFilter = activeFilterState.featured.length === 0 || 
        (activeFilterState.featured.includes('true') && isFeatured) || 
        (activeFilterState.featured.includes('false') && !isFeatured);
      
      // Amount filter logic
      let passesAmountFilter = true;
      if (amount !== 'varies') {
        const amountValue = parseInt(amount, 10);
        if (activeFilterState.amount.min !== null) {
          passesAmountFilter = passesAmountFilter && amountValue >= activeFilterState.amount.min;
        }
        if (activeFilterState.amount.max !== null) {
          passesAmountFilter = passesAmountFilter && amountValue <= activeFilterState.amount.max;
        }
      } else {
        // If "varies" and includeVaries is false, and we have min/max filters, this should not pass
        if ((activeFilterState.amount.min !== null || activeFilterState.amount.max !== null) && !activeFilterState.amount.includeVaries) {
          passesAmountFilter = false;
        }
      }
      
      // Time frame filter
      let passesTimeframeFilter = true;
      if (activeFilterState.timeframe.length > 0 && deadlineTimestamp > 0) {
        const now = Math.floor(Date.now() / 1000);
        const hasToday = activeFilterState.timeframe.includes('today');
        const hasWeek = activeFilterState.timeframe.includes('week');
        const hasMonth = activeFilterState.timeframe.includes('month');
        const hasQuarter = activeFilterState.timeframe.includes('quarter');
        
        const dayEnd = now + (24 * 60 * 60);
        const weekEnd = now + (7 * 24 * 60 * 60);
        const monthEnd = now + (30 * 24 * 60 * 60);
        const quarterEnd = now + (90 * 24 * 60 * 60);
        
        passesTimeframeFilter = false;
        
        if (hasToday && deadlineTimestamp <= dayEnd) {
          passesTimeframeFilter = true;
        } else if (hasWeek && deadlineTimestamp <= weekEnd) {
          passesTimeframeFilter = true;
        } else if (hasMonth && deadlineTimestamp <= monthEnd) {
          passesTimeframeFilter = true;
        } else if (hasQuarter && deadlineTimestamp <= quarterEnd) {
          passesTimeframeFilter = true;
        }
      }
      
      // Eligible entities filter
      const passesEligibleFilter = activeFilterState.eligibleEntities.length === 0 || 
        activeFilterState.eligibleEntities.some(entity => eligibleEntities.includes(entity));
      
      // Categories filter
      const passesCategoryFilter = activeFilterState.categories.length === 0 || 
        activeFilterState.categories.some(category => categories.includes(category));
      
      // Locations filter
      const passesLocationFilter = activeFilterState.locations.length === 0 || 
        activeFilterState.locations.some(location => locations.includes(location));
      
      // Combined filter result
      const isVisible = checkConditions([
        passesStatusFilter,
        passesFeaturedFilter,
        passesAmountFilter,
        passesTimeframeFilter,
        passesEligibleFilter,
        passesCategoryFilter,
        passesLocationFilter
      ]);
      
      // Update card visibility
      card.style.display = isVisible ? '' : 'none';
      
      if (isVisible) {
        visibleCards.push(card);
      }
    });
    
    // Update no grants message
    noFilteredGrants.classList.toggle('active', visibleCards.length === 0);
    
    // Update pagination if needed
    updatePagination(visibleCards.length);
    
    // Update active filters display
    updateActiveFiltersDisplay();
    
    hideLoading();
  }
  
  // Update pagination based on filtered grants
  function updatePagination(visibleCount) {
    if (!paginationContainer) return;
    
    // If there are active filters and we need pagination
    if (visibleCount > 0 && visibleCount < grantauraGrantsData.length) {
      // For client-side filtering, we'll hide the server-side pagination
      // as we're now showing a different set of results
      paginationContainer.style.display = 'none';
    } else {
      // Show server-side pagination when no filters are active
      paginationContainer.style.display = '';
    }
  }
  
  // Update the display of active filters
  function updateActiveFiltersDisplay() {
    activeFilters.innerHTML = '';
    
    function addActiveFilterChip(label, group, displayValue, filterKey) {
      const chip = document.createElement('div');
      chip.className = 'grants-active-filter';
      chip.innerHTML = `<strong>${label}:</strong> ${displayValue} <button type="button" class="grants-active-filter-remove" aria-label="Remove ${displayValue} from ${label}">Ã—</button>`;
      
      chip.querySelector('.grants-active-filter-remove').addEventListener('click', function() {
        if (group === 'amount') {
          if (filterKey === 'min') activeFilterState.amount.min = null;
          else if (filterKey === 'max') activeFilterState.amount.max = null;
          else if (filterKey === 'includeVaries') activeFilterState.amount.includeVaries = false;
        } else {
          const index = activeFilterState[group].indexOf(filterKey);
          if (index !== -1) activeFilterState[group].splice(index, 1);
        }
        applyFilters();
        updateActiveFiltersDisplay();
        
        // Update the checkboxes in the filter panel
        if (group !== 'amount') {
          const checkbox = document.querySelector(`input[type="checkbox"][name="${group}"][value="${filterKey}"]`);
          if (checkbox) {
            checkbox.checked = false;
            const optionEl = checkbox.closest('.grants-filter-checkbox');
            if (optionEl) {
              optionEl.classList.remove('selected');
            }
          }
        } else if (group === 'amount' && filterKey === 'includeVaries') {
          const checkbox = document.getElementById('amount-varies');
          if (checkbox) checkbox.checked = false;
        } else if (group === 'amount' && filterKey === 'min') {
          const input = document.getElementById('amount-min');
          if (input) input.value = '';
        } else if (group === 'amount' && filterKey === 'max') {
          const input = document.getElementById('amount-max');
          if (input) input.value = '';
        }
        
        // Update the related items in the filter panel
        const selected = document.getElementById(`${group}-selected`);
        if (selected) {
          if (group === 'amount') {
            // For amount, rebuild the entire selected section
            selected.innerHTML = '';
            if (activeFilterState.amount.min !== null) {
              addFilterChip(`Min: $${activeFilterState.amount.min.toLocaleString()}`, 'amount', selected);
            }
            if (activeFilterState.amount.max !== null) {
              addFilterChip(`Max: $${activeFilterState.amount.max.toLocaleString()}`, 'amount', selected);
            }
            if (activeFilterState.amount.includeVaries) {
              addFilterChip('Include Various Benefits', 'amount', selected);
            }
          } else {
            // For other groups, remove the specific chip
            removeFilterChip(filterKey, selected);
          }
        }
        
        // Update counts for other filter options
        updateEligibilityCounts();
        updateCategoryCounts();
        updateLocationCounts();
        updateTimeframeCounts();
      });
      
      activeFilters.appendChild(chip);
    }
    
    if (activeFilterState.amount.min !== null) addActiveFilterChip('Amount', 'amount', `Min: $${activeFilterState.amount.min.toLocaleString()}`, 'min');
    if (activeFilterState.amount.max !== null) addActiveFilterChip('Amount', 'amount', `Max: $${activeFilterState.amount.max.toLocaleString()}`, 'max');
    if (activeFilterState.amount.includeVaries) addActiveFilterChip('Amount', 'amount', 'Include Various Benefits', 'includeVaries');
    
    const timeframeLabels = { 'today': 'Ending Today', 'week': 'Ending This Week', 'month': 'Ending This Month', 'quarter': 'Ending This Quarter' };
    activeFilterState.timeframe.forEach(tf => addActiveFilterChip('Timeframe', 'timeframe', timeframeLabels[tf] || tf, tf));
    activeFilterState.eligibleEntities.forEach(entity => addActiveFilterChip('Eligibility', 'eligibleEntities', entity, entity));
    activeFilterState.categories.forEach(category => addActiveFilterChip('Category', 'categories', category, category));
    activeFilterState.locations.forEach(location => addActiveFilterChip('Location', 'locations', location, location));
    
    const totalFilters = 
      (activeFilterState.amount.min !== null ? 1 : 0) +
      (activeFilterState.amount.max !== null ? 1 : 0) +
      (activeFilterState.amount.includeVaries ? 1 : 0) +
      activeFilterState.timeframe.length +
      activeFilterState.eligibleEntities.length +
      activeFilterState.categories.length +
      activeFilterState.locations.length;
    
    filterCount.textContent = totalFilters || '';
    filterCount.classList.toggle('active', totalFilters > 0);
    activeFilters.classList.toggle('active', totalFilters > 0);
  }
  
  // Reset all filters
  if (filterReset) {
    filterReset.addEventListener('click', function() {
      resetAllFilters();
    });
  }
  
  // Reset filters from "no filtered grants" message
  if (resetFiltersBtn) {
    resetFiltersBtn.addEventListener('click', function() {
      resetAllFilters();
      noFilteredGrants.classList.remove('active');
    });
  }
  
  function resetAllFilters() {
    activeFilterState = { 
      status: [], 
      featured: [], 
      amount: { min: null, max: null, includeVaries: false }, 
      timeframe: [], 
      eligibleEntities: [], 
      categories: [], 
      locations: [] 
    };
    
    // Reset all form inputs
    document.querySelectorAll('.grants-filter-selected').forEach(container => container.innerHTML = '');
    document.querySelectorAll('.grants-filter-checkbox input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
      checkbox.closest('.grants-filter-checkbox')?.classList.remove('selected');
    });
    document.getElementById('amount-min').value = '';
    document.getElementById('amount-max').value = '';
    
    // Show all grants
    document.querySelectorAll('.g-card').forEach(card => card.style.display = '');
    
    // Update UI
    filterCount.textContent = '';
    filterCount.classList.remove('active');
    activeFilters.innerHTML = '';
    activeFilters.classList.remove('active');
    
    // Make sure pagination is visible
    if (paginationContainer) {
      paginationContainer.style.display = '';
    }
    
    // Navigate back to first step
    navigateToStep(1);
    
    // Update summary and counts
    updateSummaryView();
    updateMatchingGrantsCount();
    updateActiveFiltersDisplay();
    
    // Refresh filter counts
    updateEligibilityCounts();
    updateCategoryCounts();
    updateLocationCounts();
    updateTimeframeCounts();
  }
  
  // Event listeners for amount filters
  const amountMinInput = document.getElementById('amount-min');
  const amountMaxInput = document.getElementById('amount-max');
  const includeVariesCheckbox = document.getElementById('amount-varies');
  
  if (amountMinInput) {
    amountMinInput.addEventListener('input', function() {
      activeFilterState.amount.min = this.value ? parseInt(this.value, 10) : null;
      updateEligibilityCounts();
      updateCategoryCounts();
      updateLocationCounts();
      updateTimeframeCounts();
      updateMatchingGrantsCount();
    });
  }
  
  if (amountMaxInput) {
    amountMaxInput.addEventListener('input', function() {
      activeFilterState.amount.max = this.value ? parseInt(this.value, 10) : null;
      updateEligibilityCounts();
      updateCategoryCounts();
      updateLocationCounts();
      updateTimeframeCounts();
      updateMatchingGrantsCount();
    });
  }
  
  if (includeVariesCheckbox) {
    includeVariesCheckbox.addEventListener('change', function() {
      activeFilterState.amount.includeVaries = this.checked;
      updateEligibilityCounts();
      updateCategoryCounts();
      updateLocationCounts();
      updateTimeframeCounts();
      updateMatchingGrantsCount();
    });
  }
  
  // Event listeners for timeframe checkboxes
  const timeframeCheckboxes = document.querySelectorAll('input[name="timeframe"]');
  timeframeCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const value = this.value;
      if (this.checked) {
        if (!activeFilterState.timeframe.includes(value)) activeFilterState.timeframe.push(value);
      } else {
        const index = activeFilterState.timeframe.indexOf(value);
        if (index !== -1) activeFilterState.timeframe.splice(index, 1);
      }
      
      updateEligibilityCounts();
      updateCategoryCounts();
      updateLocationCounts();
      updateMatchingGrantsCount();
    });
  });
  
  // Utility function to handle lazy loading for visible images
  function handleIntersectionForVisible() {
    const images = document.querySelectorAll('.g-card__image');
    
    images.forEach(img => {
      if (img.closest('.g-card').style.display !== 'none') {
        if (!img.complete) {
          img.addEventListener('load', function() {
            this.classList.add('g-card__img-loaded');
          });
        } else {
          img.classList.add('g-card__img-loaded');
        }
      }
    });
  }
  
  // Initial setup
  initCountdowns();
});
// ]]>
</script>
