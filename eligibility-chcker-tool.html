<!-- 
  ENHANCED GRANT ELIGIBILITY ASSESSMENT TOOL
  A precise, intelligent tool that strictly matches users with grants they're eligible for
  
  MAJOR IMPROVEMENTS:
  1. Enhanced matching algorithm that strictly prioritizes:
     - Entity type/individual category
     - Demographics/focus areas
     - Location
     - Keywords
  2. Advanced deadline detection system with multiple fallbacks
  3. More comprehensive search with metadata integration
  4. UI improvements to highlight priority matches
  5. Better presentation of match reasons
  6. Premium grant teasing with lead capture
  7. Admin URL access for viewing all grants
-->
<section class="eligibility-checker" data-section-id="eligibility-checker">
  <style>
    .eligibility-checker {
      --primary-color: #5A3B8C;
      --primary-light: #7650A9;
      --primary-dark: #472D6F;
      --secondary-color: #FFA366;
      --secondary-light: #FFB888;
      --secondary-dark: #FF8544;
      --success-color: #10B981;
      --warning-color: #F59E0B;
      --danger-color: #EF4444;
      --text-dark: #1F2937;
      --text-light: #6B7280;
      --background-color: #F9FAFB;
      --white: #FFFFFF;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --border-radius: 8px;
      --transition: all 0.3s ease;
      
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      color: var(--text-dark);
      margin: 0 auto;
      padding: 0;
      max-width: 1200px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .eligibility-checker *,
    .eligibility-checker *::before,
    .eligibility-checker *::after {
      box-sizing: inherit;
    }
    
    .eligibility-checker__intro {
      text-align: center;
      padding: 2rem 1rem;
      margin-bottom: 2rem;
      background: linear-gradient(145deg, var(--primary-light) 0%, var(--primary-color) 100%);
      border-radius: var(--border-radius);
      color: var(--white);
      position: relative;
      overflow: hidden;
    }
    
    .eligibility-checker__intro::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://grantaura.com/wp-content/uploads/2025/02/waves-5.webp');
      background-size: cover;
      background-position: center;
      opacity: 0.1;
      z-index: 1;
    }
    
    .eligibility-checker__intro-content {
      position: relative;
      z-index: 2;
    }
    
    .eligibility-checker__intro-icon {
      display: block;
      margin: 0 auto 1rem;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
    }
    
    .eligibility-checker__intro-title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
    }
    
    .eligibility-checker__intro-description {
      font-size: 1.25rem;
      max-width: 800px;
      margin: 0 auto 2rem;
      line-height: 1.5;
    }
    
    .eligibility-checker__benefits {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    .eligibility-checker__benefit-item {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      backdrop-filter: blur(5px);
      transition: var(--transition);
    }
    
    .eligibility-checker__benefit-item:hover {
      transform: translateY(-5px);
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .eligibility-checker__benefit-item-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--secondary-color);
    }
    
    .eligibility-checker__benefit-item-title {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .eligibility-checker__benefit-item-text {
      font-size: 1rem;
      line-height: 1.5;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .eligibility-checker__progress {
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__progress-bar-container {
      height: 8px;
      background-color: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 4px;
      width: 0;
      transition: width 0.5s ease;
    }
    
    .eligibility-checker__progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__step {
      flex: 1;
      text-align: center;
      position: relative;
      padding: 0 0.5rem;
    }
    
    .eligibility-checker__step-icon {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--gray-300);
      color: var(--gray-700);
      border-radius: 50%;
      margin: 0 auto 0.5rem;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .eligibility-checker__step.active .eligibility-checker__step-icon {
      background-color: var(--primary-color);
      color: var(--white);
      box-shadow: 0 0 0 5px rgba(90, 59, 140, 0.2);
    }
    
    .eligibility-checker__step.completed .eligibility-checker__step-icon {
      background-color: var(--success-color);
      color: var(--white);
    }
    
    .eligibility-checker__step-label {
      font-size: 0.875rem;
      color: var(--gray-600);
      transition: var(--transition);
    }
    
    .eligibility-checker__step.active .eligibility-checker__step-label {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .eligibility-checker__step.completed .eligibility-checker__step-label {
      color: var(--success-color);
    }
    
    .eligibility-checker__form {
      background-color: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__step-content {
      display: none;
    }
    
    .eligibility-checker__step-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .eligibility-checker__step-title {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }
    
    .eligibility-checker__step-title i {
      margin-right: 0.5rem;
    }
    
    .eligibility-checker__step-description {
      font-size: 1rem;
      color: var(--text-light);
      margin-bottom: 2rem;
      line-height: 1.5;
    }
    
    .eligibility-checker__form-group {
      margin-bottom: 1.5rem;
    }
    
    .eligibility-checker__form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-size: 1rem;
    }
    
    .eligibility-checker__priority-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .eligibility-checker__priority-label span {
      font-size: 0.75rem;
      background-color: var(--primary-light);
      color: var(--white);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .eligibility-checker__form-hint {
      font-size: 0.875rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }
    
    .eligibility-checker__cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__card {
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .eligibility-checker__card:hover {
      border-color: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .eligibility-checker__card.selected {
      border-color: var(--primary-color);
      background-color: rgba(90, 59, 140, 0.05);
    }
    
    .eligibility-checker__card-radio {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    
    .eligibility-checker__card-icon {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
      display: block;
    }
    
    .eligibility-checker__card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }
    
    .eligibility-checker__card-description {
      font-size: 0.875rem;
      color: var(--text-light);
      line-height: 1.5;
    }
    
    .eligibility-checker__checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__checkbox-item {
      position: relative;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      border: 1px solid var(--gray-300);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.875rem;
    }
    
    .eligibility-checker__checkbox-item:hover {
      border-color: var(--primary-light);
    }
    
    .eligibility-checker__checkbox-item.selected {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--white);
    }
    
    .eligibility-checker__checkbox-item input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    
    .eligibility-checker__select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: 1rem;
      color: var(--text-dark);
      background-color: var(--white);
      transition: var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1rem;
    }
    
    .eligibility-checker__select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(90, 59, 140, 0.2);
    }
    
    .eligibility-checker__textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: 1rem;
      color: var(--text-dark);
      line-height: 1.5;
      transition: var(--transition);
      resize: vertical;
      min-height: 100px;
    }
    
    .eligibility-checker__textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(90, 59, 140, 0.2);
    }
    
    .eligibility-checker__keywords-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      min-height: 50px;
      background-color: var(--white);
    }
    
    .eligibility-checker__keywords-container:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(90, 59, 140, 0.2);
    }
    
    .eligibility-checker__keyword-tag {
      display: inline-flex;
      align-items: center;
      background-color: var(--primary-light);
      color: var(--white);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .eligibility-checker__keyword-tag button {
      background: none;
      border: none;
      color: var(--white);
      cursor: pointer;
      padding: 0 0 0 0.25rem;
      font-size: 1rem;
      line-height: 1;
    }
    
    .eligibility-checker__keyword-input {
      flex: 1;
      min-width: 100px;
      border: none;
      padding: 0.5rem;
      font-size: 0.875rem;
      outline: none;
    }
    
    .eligibility-checker__keywords-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }
    
    .eligibility-checker__form-error {
      color: var(--danger-color);
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }
    
    .eligibility-checker__form-group.has-error .eligibility-checker__form-error {
      display: block;
    }
    
    .eligibility-checker__form-group.has-error .eligibility-checker__select,
    .eligibility-checker__form-group.has-error .eligibility-checker__textarea,
    .eligibility-checker__form-group.has-error .eligibility-checker__keywords-container {
      border-color: var(--danger-color);
    }
    
    .eligibility-checker__form-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
    }
    
    .eligibility-checker__primary-button {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .eligibility-checker__primary-button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .eligibility-checker__primary-button i {
      margin-left: 0.5rem;
    }
    
    .eligibility-checker__secondary-button {
      background-color: var(--gray-200);
      color: var(--gray-700);
      border: none;
      border-radius: var(--border-radius);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .eligibility-checker__secondary-button:hover {
      background-color: var(--gray-300);
    }
    
    .eligibility-checker__secondary-button i {
      margin-right: 0.5rem;
    }
    
    /* Results section styling */
    .eligibility-checker__loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 1rem;
      text-align: center;
    }
    
    .eligibility-checker__spinner {
      width: 4rem;
      height: 4rem;
      border: 4px solid rgba(90, 59, 140, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .eligibility-checker__loading-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .eligibility-checker__loading-subtext {
      font-size: 1rem;
      color: var(--text-light);
      margin-bottom: 1.5rem;
      max-width: 500px;
    }
    
    .eligibility-checker__progress-wrapper {
      width: 100%;
      max-width: 400px;
      height: 8px;
      background-color: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .eligibility-checker__loading-progress {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 4px;
      width: 0;
      transition: width 0.5s ease;
    }
    
    .eligibility-checker__matches-container {
      padding: 1rem 0;
    }
    
    .eligibility-checker__matches-container.hidden {
      display: none;
    }
    
    .eligibility-checker__matches-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .eligibility-checker__matches-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
      display: flex;
      align-items: center;
    }
    
    .eligibility-checker__matches-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary-color);
      color: var(--white);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 0.875rem;
      margin-left: 0.75rem;
    }
    
    .eligibility-checker__filter-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .eligibility-checker__filter-label {
      font-size: 0.875rem;
      color: var(--text-light);
    }
    
    .eligibility-checker__filter-options {
      display: flex;
      gap: 0.5rem;
    }
    
    .eligibility-checker__filter-button {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      padding: 0.4rem 0.75rem;
      font-size: 0.875rem;
      color: var(--text-dark);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .eligibility-checker__filter-button:hover {
      background: var(--gray-200);
    }
    
    .eligibility-checker__filter-button.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--white);
    }
    
    .eligibility-checker__matches-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .eligibility-checker__match-section-header {
      margin: 2rem 0 1rem;
      border-left: 4px solid var(--primary-color);
      padding-left: 1rem;
    }
    
    .eligibility-checker__match-section-header h3 {
      font-size: 1.25rem;
      margin: 0 0 0.25rem;
      color: var(--primary-color);
    }
    
    .eligibility-checker__match-section-header p {
      font-size: 0.875rem;
      margin: 0;
      color: var(--text-light);
    }
    
    .eligibility-checker__match-card {
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
      overflow: hidden;
      background-color: var(--white);
      transition: var(--transition);
      position: relative;
    }
    
    .eligibility-checker__match-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      border-color: var(--primary-light);
    }
    
    .eligibility-checker__match-card--priority {
      border-color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(90, 59, 140, 0.15);
    }
    
    .eligibility-checker__priority-badge {
      position: absolute;
      top: -0.25rem;
      right: 1rem;
      background-color: var(--primary-color);
      color: var(--white);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      z-index: 2;
    }
    
    .eligibility-checker__deadline-badge {
      position: absolute;
      top: -0.25rem;
      left: 1rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      z-index: 2;
    }
    
    .eligibility-checker__deadline-badge--ongoing {
      background-color: var(--directorist-color-new-badge);
      color: var(--white);
    }
    
    .eligibility-checker__deadline-badge--soon {
      background-color: var(--warning-color);
      color: var(--white);
    }
    
    .eligibility-checker__deadline-badge--urgent {
      background-color: var(--danger-color);
      color: var(--white);
    }
    
    .eligibility-checker__match-header {
      padding: 1.5rem 1.5rem 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .eligibility-checker__match-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0 0 0.5rem;
      line-height: 1.3;
    }
    
    .eligibility-checker__match-score {
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      flex-shrink: 0;
      margin-top: 0.25rem;
    }
    
    .eligibility-checker__score-excellent {
      color: var(--primary-color);
    }
    
    .eligibility-checker__score-high {
      color: var(--success-color);
    }
    
    .eligibility-checker__score-medium {
      color: var(--warning-color);
    }
    
    .eligibility-checker__score-low {
      color: var(--text-light);
    }
    
    .eligibility-checker__match-content {
      padding: 0 1.5rem 1.5rem;
    }
    
    .eligibility-checker__match-description {
      font-size: 0.9375rem;
      color: var(--text-dark);
      margin-bottom: 1rem;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .eligibility-checker__match-meta {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--gray-100);
    }
    
    .eligibility-checker__meta-item {
      display: flex;
      align-items: center;
      font-size: 0.8125rem;
      color: var(--text-light);
    }
    
    .eligibility-checker__meta-item i {
      color: var(--primary-color);
      margin-right: 0.5rem;
      font-size: 0.9375rem;
    }
    
    .eligibility-checker__deadline-urgent {
      color: var(--warning-color);
      font-weight: 600;
    }
    
    .eligibility-checker__deadline-critical {
      color: var(--danger-color);
      font-weight: 600;
    }
    
    .eligibility-checker__deadline-expired {
      color: var(--text-light);
      text-decoration: line-through;
    }
    
    .eligibility-checker__match-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__match-tag {
      background-color: var(--gray-100);
      color: var(--text-dark);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    
    .eligibility-checker__match-match-tag {
      background-color: rgba(90, 59, 140, 0.1);
      color: var(--primary-color);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .eligibility-checker__match-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .eligibility-checker__match-details {
      background: none;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .eligibility-checker__match-details:hover {
      background-color: rgba(90, 59, 140, 0.05);
    }
    
    .eligibility-checker__apply-button {
      background-color: var(--primary-color);
      color: var(--white) !important;
      border: none;
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none !important;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .eligibility-checker__apply-button:hover {
      background-color: var(--primary-dark);
    }
    
    /* Grant details modal styling */
    .eligibility-checker__match-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .eligibility-checker__match-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .eligibility-checker__modal-content {
      background-color: var(--white);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    
    .eligibility-checker__match-modal.active .eligibility-checker__modal-content {
      transform: scale(1);
    }
    
    .eligibility-checker__modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: sticky;
      top: 0;
      background-color: var(--white);
      z-index: 1;
    }
    
    .eligibility-checker__modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
      padding-right: 2rem;
      line-height: 1.3;
    }
    
    .eligibility-checker__modal-close {
      background: none;
      border: none;
      color: var(--gray-500);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: var(--transition);
    }
    
    .eligibility-checker__modal-close:hover {
      color: var(--danger-color);
    }
    
    .eligibility-checker__modal-body {
      padding: 1.5rem;
    }
    
    .eligibility-checker__match-description {
      font-size: 1rem;
      color: var(--text-dark);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    
    .eligibility-checker__modal-section {
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__modal-section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0 0 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .eligibility-checker__match-criteria {
      background-color: rgba(90, 59, 140, 0.05);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__match-criteria-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0 0 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .eligibility-checker__match-criteria-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    
    .eligibility-checker__match-criteria-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.9375rem;
      color: var(--text-dark);
      line-height: 1.4;
    }
    
    .eligibility-checker__match-criteria-item i {
      color: var(--success-color);
      margin-top: 0.2rem;
      flex-shrink: 0;
    }
    
    .eligibility-checker__match-criteria-item.eligibility-checker__priority-match i {
      color: var(--primary-color);
    }
    
    .eligibility-checker__meta-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.9375rem;
      color: var(--text-dark);
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }
    
    .eligibility-checker__meta-item i {
      color: var(--primary-color);
      margin-top: 0.2rem;
      flex-shrink: 0;
    }
    
    .eligibility-checker__meta-item strong {
      font-weight: 600;
      margin-right: 0.25rem;
    }
    
    .eligibility-checker__eligibility-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 0.75rem;
    }
    
    .eligibility-checker__eligibility-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.9375rem;
      color: var(--text-dark);
      line-height: 1.4;
    }
    
    .eligibility-checker__eligibility-item i {
      color: var(--success-color);
      margin-top: 0.2rem;
      flex-shrink: 0;
    }
    
    .eligibility-checker__modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      bottom: 0;
      background-color: var(--white);
      z-index: 1;
    }
    
    .eligibility-checker__modal-action {
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none !important;
    }
    
    .eligibility-checker__primary-action {
      background-color: var(--primary-color);
      color: var(--white) !important;
      border: none;
    }
    
    .eligibility-checker__primary-action:hover {
      background-color: var(--primary-dark);
    }
    
    .eligibility-checker__secondary-action {
      background-color: var(--gray-200);
      color: var(--gray-700) !important;
      border: none;
    }
    
    .eligibility-checker__secondary-action:hover {
      background-color: var(--gray-300);
    }
    
    /* No matches styling */
    .eligibility-checker__no-matches {
      padding: 2rem 0;
      text-align: center;
      display: none;
    }
    
    .eligibility-checker__no-matches.active {
      display: block;
    }
    
    .eligibility-checker__no-matches-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background-color: var(--gray-50);
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
    }
    
    .eligibility-checker__no-matches-container h3 {
      font-size: 1.5rem;
      color: var(--primary-color);
      margin: 0 0 1rem;
    }
    
    .eligibility-checker__no-matches-container p {
      font-size: 1rem;
      color: var(--text-dark);
      margin-bottom: 2rem;
      line-height: 1.5;
    }
    
    .eligibility-checker__no-matches-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__option-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1.5rem;
      background-color: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      text-decoration: none !important;
      transition: var(--transition);
    }
    
    .eligibility-checker__option-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    
    .eligibility-checker__option-button i {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__option-button span {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-color) !important;
      margin-bottom: 0.5rem;
    }
    
    .eligibility-checker__option-button p {
      font-size: 0.875rem;
      color: var(--text-light) !important;
      margin: 0;
      line-height: 1.5;
    }
    
    .eligibility-checker__option-button.research-button {
      border-top: 4px solid var(--primary-color);
    }
    
    .eligibility-checker__option-button.consultation-button {
      border-top: 4px solid var(--secondary-color);
    }
    
    .eligibility-checker__option-button.consultation-button i {
      color: var(--secondary-color);
    }
    
    .eligibility-checker__option-button.consultation-button span {
      color: var(--secondary-color) !important;
    }
    
    /* Premium grants section */
    .eligibility-checker__premium-section {
      margin-top: 3rem;
      border-radius: var(--border-radius);
      overflow: hidden;
      background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
      position: relative;
    }
    
    .eligibility-checker__premium-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://grantaura.com/wp-content/uploads/2025/02/waves-with-patterns-6.webp');
      background-size: cover;
      background-position: center;
      opacity: 0.1;
      z-index: 1;
    }
    
    .eligibility-checker__premium-content {
      position: relative;
      z-index: 2;
      padding: 2.5rem;
      color: var(--white);
      text-align: center;
    }
    
    .eligibility-checker__premium-badge {
      display: inline-block;
      background-color: rgba(255, 255, 255, 0.2);
      color: var(--white);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(5px);
    }
    
    .eligibility-checker__premium-badge i {
      margin-right: 0.5rem;
    }
    
    .eligibility-checker__premium-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__premium-description {
      font-size: 1.125rem;
      max-width: 800px;
      margin: 0 auto 2rem;
      line-height: 1.5;
      opacity: 0.9;
    }
    
    .eligibility-checker__premium-stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2.5rem;
    }
    
    .eligibility-checker__premium-stat {
      text-align: center;
    }
    
    .eligibility-checker__premium-stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
      line-height: 1;
    }
    
    .eligibility-checker__premium-stat-label {
      font-size: 0.875rem;
      opacity: 0.8;
    }
    
    .eligibility-checker__premium-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
    }
    
    .eligibility-checker__premium-button {
      background-color: var(--secondary-color);
      color: var(--white) !important;
      border: none;
      border-radius: var(--border-radius);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none !important;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .eligibility-checker__premium-button:hover {
      background-color: var(--secondary-dark);
      transform: translateY(-2px);
    }
    
    .eligibility-checker__premium-button i {
      font-size: 1.125rem;
    }
    
    .eligibility-checker__premium-button.secondary {
      background-color: transparent;
      border: 2px solid rgba(255, 255, 255, 0.5);
    }
    
    .eligibility-checker__premium-button.secondary:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: var(--white);
    }
    
    /* Premium lead capture popup */
    .eligibility-checker__premium-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .eligibility-checker__premium-popup.active {
      opacity: 1;
      visibility: visible;
    }
    
    .eligibility-checker__premium-popup-content {
      background-color: var(--white);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    
    .eligibility-checker__premium-popup.active .eligibility-checker__premium-popup-content {
      transform: scale(1);
    }
    
    .eligibility-checker__premium-popup-header {
      position: relative;
      height: 150px;
      overflow: hidden;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .eligibility-checker__premium-popup-header-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
      z-index: 1;
    }
    
    .eligibility-checker__premium-popup-header-pattern {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://grantaura.com/wp-content/uploads/2025/02/badge-with-abs-bg-10.webp');
      background-size: cover;
      background-position: center;
      opacity: 0.1;
      z-index: 2;
    }
    
    .eligibility-checker__premium-popup-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: var(--white);
      font-size: 1.25rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3;
      transition: var(--transition);
    }
    
    .eligibility-checker__premium-popup-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .eligibility-checker__premium-popup-title-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 1.5rem;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
      z-index: 3;
    }
    
    .eligibility-checker__premium-popup-title {
      color: var(--white);
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    .eligibility-checker__premium-popup-body {
      padding: 2rem;
    }
    
    .eligibility-checker__premium-popup-subtitle {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0 0 1rem;
    }
    
    .eligibility-checker__premium-popup-description {
      font-size: 1rem;
      color: var(--text-dark);
      margin-bottom: 2rem;
      line-height: 1.5;
    }
    
    .eligibility-checker__premium-popup-benefits {
      margin-bottom: 2rem;
    }
    
    .eligibility-checker__premium-popup-benefit {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__premium-popup-benefit-icon {
      width: 24px;
      height: 24px;
      background-color: rgba(90, 59, 140, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    
    .eligibility-checker__premium-popup-benefit-text {
      font-size: 0.9375rem;
      color: var(--text-dark);
      line-height: 1.5;
    }
    
    .eligibility-checker__premium-popup-form {
      margin-bottom: 1.5rem;
    }
    
    .eligibility-checker__premium-popup-form-group {
      margin-bottom: 1.5rem;
    }
    
    .eligibility-checker__premium-popup-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }
    
    .eligibility-checker__premium-popup-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: 1rem;
      color: var(--text-dark);
      background-color: var(--white);
      transition: var(--transition);
    }
    
    .eligibility-checker__premium-popup-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(90, 59, 140, 0.2);
    }
    
    .eligibility-checker__premium-popup-error {
      color: var(--danger-color);
      font-size: 0.75rem;
      margin-top: 0.5rem;
      display: none;
    }
    
    .eligibility-checker__premium-popup-form-group.has-error .eligibility-checker__premium-popup-input {
      border-color: var(--danger-color);
    }
    
    .eligibility-checker__premium-popup-form-group.has-error .eligibility-checker__premium-popup-error {
      display: block;
    }
    
    .eligibility-checker__premium-popup-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: 1rem;
      color: var(--text-dark);
      background-color: var(--white);
      transition: var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1rem;
    }
    
    .eligibility-checker__premium-popup-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(90, 59, 140, 0.2);
    }
    
    .eligibility-checker__premium-popup-submit {
      width: 100%;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .eligibility-checker__premium-popup-submit:hover {
      background-color: var(--primary-dark);
    }
    
    .eligibility-checker__premium-popup-privacy {
      font-size: 0.75rem;
      color: var(--text-light);
      text-align: center;
    }
    
    .eligibility-checker__premium-popup-privacy a {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .eligibility-checker__premium-popup-privacy a:hover {
      text-decoration: underline;
    }
    
    /* Success state styling */
    .eligibility-checker__premium-popup-success {
      text-align: center;
      display: none;
    }
    
    .eligibility-checker__premium-popup-success.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    .eligibility-checker__premium-popup-success-icon {
      width: 80px;
      height: 80px;
      background-color: rgba(16, 185, 129, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--success-color);
      font-size: 2rem;
      margin: 0 auto 1.5rem;
    }
    
    .eligibility-checker__premium-popup-success-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .eligibility-checker__premium-popup-success-message {
      font-size: 1rem;
      color: var(--text-dark);
      margin-bottom: 2rem;
      line-height: 1.5;
    }
    
    .eligibility-checker__premium-popup-success-button {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .eligibility-checker__premium-popup-success-button:hover {
      background-color: var(--primary-dark);
    }
    
    /* Admin view styling */
    .eligibility-checker__admin-notice {
      background-color: #FFE5B4;
      color: #663C00;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .eligibility-checker__admin-notice i {
      font-size: 1.25rem;
      color: #B54708;
    }
    
    /* Responsive styling */
    @media (min-width: 768px) {
      .eligibility-checker__matches-list {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .eligibility-checker__form {
        padding: 3rem;
      }
    }
    
    @media (min-width: 1024px) {
      .eligibility-checker__matches-list {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 767px) {
      .eligibility-checker__intro-title {
        font-size: 2rem;
      }
      
      .eligibility-checker__intro-description {
        font-size: 1rem;
      }
      
      .eligibility-checker__progress-steps {
        display: none;
      }
      
      .eligibility-checker__match-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .eligibility-checker__matches-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .eligibility-checker__premium-title {
        font-size: 1.5rem;
      }
      
      .eligibility-checker__premium-description {
        font-size: 1rem;
      }
      
      .eligibility-checker__premium-stats {
        gap: 1rem;
      }
      
      .eligibility-checker__premium-stat-value {
        font-size: 2rem;
      }
    }
  </style>
  
  <!-- Section intro container -->
  <section class="eligibility-intro-section" data-section-id="grant-eligibility-checker">
  <style>
    .eligibility-intro-section {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(249,250,251,1) 100%);
      border-radius: var(--grantaura-border-radius-lg);
      box-shadow: var(--grantaura-box-shadow);
      padding: 1.5rem;
      margin: 1rem auto;
      position: relative;
      overflow: hidden;
      max-width: var(--grantaura-max-width);
    }
    
    @media (min-width: 768px) {
      .eligibility-intro-section {
        padding: 2.5rem;
        margin: 2rem auto;
      }
    }
    
    .eligibility-intro-section::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255,163,102,0.1) 0%, rgba(255,163,102,0) 70%);
      z-index: 0;
      pointer-events: none;
    }
    
    .eligibility-intro-section::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(90,59,140,0.1) 0%, rgba(90,59,140,0) 70%);
      z-index: 0;
      pointer-events: none;
    }
  </style>
  
  <div class="eligibility-intro-container">
    <style>
      .eligibility-intro-container {
        position: relative;
        z-index: 1;
      }
    </style>
    
    <div class="eligibility-intro-header">
      <style>
        .eligibility-intro-header {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          margin-bottom: 1.5rem;
          position: relative;
        }
        
        @media (min-width: 768px) {
          .eligibility-intro-header {
            margin-bottom: 2.5rem;
          }
        }
      </style>
      
      <div class="eligibility-intro-badge">
        <style>
          .eligibility-intro-badge {
            position: relative;
            margin-bottom: 1rem;
          }
          
          .eligibility-intro-badge::before {
            content: "";
            position: absolute;
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, var(--grantaura-primary-light) 0%, var(--grantaura-primary) 100%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.1;
            transition: var(--grantaura-transition);
          }
          
          .eligibility-intro-badge:hover::before {
            width: 85px;
            height: 85px;
            opacity: 0.15;
          }
          
          @media (min-width: 768px) {
            .eligibility-intro-badge::before {
              width: 90px;
              height: 90px;
            }
            
            .eligibility-intro-badge:hover::before {
              width: 100px;
              height: 100px;
            }
          }
        </style>
        
        <img src="https://grantaura.com/wp-content/uploads/2025/02/c7be0873-4ed1-403f-9f80-d62c66058491-removebg-preview-png-e1740548113296.webp" 
             alt="Grant Eligibility Assessment Tool" 
             class="eligibility-intro-icon" 
             width="80" 
             height="80" 
             loading="lazy">
        <style>
          .eligibility-intro-icon {
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transition: var(--grantaura-transition);
          }
          
          .eligibility-intro-icon:hover {
            transform: scale(1.05);
          }
        </style>
      </div>
      
      <h1 class="eligibility-intro-title">
        <style>
          .eligibility-intro-title {
            color: var(--grantaura-text-dark);
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            position: relative;
            display: inline-block;
          }
          
          .eligibility-intro-title::after {
            content: "";
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, var(--grantaura-primary-light), var(--grantaura-secondary-light));
            border-radius: 3px;
          }
          
          @media (min-width: 768px) {
            .eligibility-intro-title {
              font-size: 2.25rem;
              margin-bottom: 1rem;
            }
            
            .eligibility-intro-title::after {
              width: 100px;
            }
          }
        </style>
        Discover Your Perfect Grant Match
      </h1>
      
      <p class="eligibility-intro-description">
        <style>
          .eligibility-intro-description {
            color: var(--grantaura-text-light);
            font-size: 1rem;
            line-height: 1.6;
            max-width: 700px;
            margin: 0 auto;
          }
          
          @media (min-width: 768px) {
            .eligibility-intro-description {
              font-size: 1.125rem;
            }
          }
        </style>
        Answer a few targeted questions to unlock grants you're fully eligible for. Our precision matching algorithm analyzes your unique profile against hundreds of active funding opportunities to identify your ideal grants.
      </p>
    </div>
    
    <div class="eligibility-intro-features">
      <style>
        .eligibility-intro-features {
          display: grid;
          grid-template-columns: 1fr;
          gap: 1.5rem;
          margin-bottom: 1.5rem;
        }
        
        @media (min-width: 640px) {
          .eligibility-intro-features {
            grid-template-columns: repeat(2, 1fr);
          }
        }
        
        @media (min-width: 1024px) {
          .eligibility-intro-features {
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
          }
        }
      </style>
      
      <div class="eligibility-feature-card" data-feature="personalized">
        <style>
          .eligibility-feature-card {
            background: var(--grantaura-white);
            border-radius: var(--grantaura-border-radius);
            padding: 1.5rem;
            box-shadow: var(--grantaura-box-shadow-sm);
            transition: var(--grantaura-transition);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
          }
          
          .eligibility-feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--grantaura-box-shadow);
          }
          
          .eligibility-feature-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 0;
            background: linear-gradient(to bottom, var(--grantaura-primary), var(--grantaura-secondary));
            transition: var(--grantaura-transition);
          }
          
          .eligibility-feature-card:hover::before {
            height: 100%;
          }
          
          @media (min-width: 768px) {
            .eligibility-feature-card {
              padding: 1.75rem;
            }
          }
        </style>
        
        <div class="eligibility-feature-icon-wrapper">
          <style>
            .eligibility-feature-icon-wrapper {
              margin-bottom: 1rem;
              position: relative;
              width: 50px;
              height: 50px;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            .eligibility-feature-icon-wrapper::before {
              content: "";
              position: absolute;
              width: 100%;
              height: 100%;
              background: linear-gradient(135deg, var(--grantaura-primary-light) 0%, var(--grantaura-primary) 100%);
              border-radius: 50%;
              opacity: 0.15;
              transition: var(--grantaura-transition);
            }
            
            .eligibility-feature-card:hover .eligibility-feature-icon-wrapper::before {
              transform: scale(1.2);
            }
          </style>
          
          <i class="fas fa-user-check eligibility-feature-icon"></i>
          <style>
            .eligibility-feature-icon {
              color: var(--grantaura-primary);
              font-size: 1.5rem;
              position: relative;
              z-index: 1;
            }
          </style>
        </div>
        
        <h3 class="eligibility-feature-title">
          <style>
            .eligibility-feature-title {
              color: var(--grantaura-text-dark);
              font-size: 1.25rem;
              font-weight: 600;
              margin-bottom: 0.75rem;
            }
          </style>
          Personalized Grant Matches
        </h3>
        
        <p class="eligibility-feature-description">
          <style>
            .eligibility-feature-description {
              color: var(--grantaura-text-light);
              font-size: 0.9375rem;
              line-height: 1.6;
              margin-bottom: 0;
              flex-grow: 1;
            }
          </style>
          Receive grant recommendations perfectly tailored to your specific business type, location, and funding needs.
        </p>
      </div>
      
      <div class="eligibility-feature-card" data-feature="precision">
        <style>
          .eligibility-feature-card[data-feature="precision"]::before {
            background: linear-gradient(to bottom, var(--grantaura-secondary), var(--grantaura-primary));
          }
          
          .eligibility-feature-card[data-feature="precision"] .eligibility-feature-icon-wrapper::before {
            background: linear-gradient(135deg, var(--grantaura-secondary-light) 0%, var(--grantaura-secondary) 100%);
          }
        </style>
        
        <div class="eligibility-feature-icon-wrapper">
          <i class="fas fa-bolt eligibility-feature-icon" style="color: var(--grantaura-secondary);"></i>
        </div>
        
        <h3 class="eligibility-feature-title">
          High-Precision Matching
        </h3>
        
        <p class="eligibility-feature-description">
          Our advanced algorithm strictly analyzes eligibility criteria, saving you hours of research and preventing application rejections.
        </p>
      </div>
      
      <div class="eligibility-feature-card" data-feature="expert">
        <style>
          .eligibility-feature-card[data-feature="expert"] .eligibility-feature-icon-wrapper::before {
            background: linear-gradient(135deg, var(--grantaura-success) 0%, var(--grantaura-primary-dark) 100%);
          }
        </style>
        
        <div class="eligibility-feature-icon-wrapper">
          <i class="fas fa-trophy eligibility-feature-icon" style="color: var(--grantaura-success);"></i>
        </div>
        
        <h3 class="eligibility-feature-title">
          Expert Application Support
        </h3>
        
        <p class="eligibility-feature-description">
          Get guidance from our team of grant specialists with 300+ successful projects and a 4.9/5 rating from 185+ client reviews.
        </p>
      </div>
    </div>
    
    <div class="eligibility-intro-cta">
      <style>
        .eligibility-intro-cta {
          text-align: center;
          position: relative;
          padding-top: 1rem;
        }
        
        .eligibility-intro-cta::before {
          content: "";
          position: absolute;
          top: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 80px;
          height: 2px;
          background: var(--grantaura-gray-200);
          border-radius: 2px;
        }
        
        @media (min-width: 768px) {
          .eligibility-intro-cta::before {
            width: 120px;
          }
        }
      </style>
      
      <p class="eligibility-intro-cta-text">
        <style>
          .eligibility-intro-cta-text {
            color: var(--grantaura-text-dark);
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 1.25rem;
          }
          
          @media (min-width: 768px) {
            .eligibility-intro-cta-text {
              font-size: 1.25rem;
            }
          }
        </style>
        Ready to find grants you qualify for? Start your assessment now.
      </p>
      
      <a href="#eligibility-checker__form" class="eligibility-intro-cta-button">
        <style>
          .eligibility-intro-cta-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.75rem;
            background: linear-gradient(135deg, var(--grantaura-primary) 0%, var(--grantaura-primary-dark) 100%);
            color: white !important;
            font-weight: 600;
            font-size: 1rem;
            border-radius: var(--grantaura-border-radius);
            text-decoration: none !important;
            transition: var(--grantaura-transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(90, 59, 140, 0.25);
          }
          
          .eligibility-intro-cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(90, 59, 140, 0.3);
            background: linear-gradient(135deg, var(--grantaura-primary-light) 0%, var(--grantaura-primary) 100%);
          }
          
          .eligibility-intro-cta-button::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%) scale(0);
            border-radius: 50%;
            transition: transform 0.5s ease;
          }
          
          .eligibility-intro-cta-button:active::after {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
          }
        </style>
        Start Eligibility Check <i class="fas fa-arrow-right" style="margin-left: 0.5rem;"></i>
      </a>
    </div>
  </div>
  
  <div class="eligibility-intro-trust">
    <style>
      .eligibility-intro-trust {
        margin-top: 2rem;
        text-align: center;
        padding-top: 1.5rem;
        border-top: 1px solid var(--grantaura-gray-200);
      }
      
      @media (min-width: 768px) {
        .eligibility-intro-trust {
          margin-top: 2.5rem;
        }
      }
    </style>
    
    <p class="eligibility-intro-trust-text">
      <style>
        .eligibility-intro-trust-text {
          font-size: 0.875rem;
          color: var(--grantaura-gray-500);
          margin-bottom: 0.75rem;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
        }
        
        @media (min-width: 768px) {
          .eligibility-intro-trust-text {
            font-size: 0.9375rem;
          }
        }
      </style>
      <i class="fas fa-shield-alt" style="color: var(--grantaura-primary);"></i>
      Trusted by businesses, organizations, and entrepreneurs seeking grant funding
    </p>
    
    <div class="eligibility-intro-stats">
      <style>
        .eligibility-intro-stats {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 1.5rem 2rem;
        }
        
        @media (min-width: 768px) {
          .eligibility-intro-stats {
            gap: 1.5rem 3rem;
          }
        }
      </style>
      
      <div class="eligibility-intro-stat">
        <style>
          .eligibility-intro-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
          }
        </style>
        
        <div class="eligibility-intro-stat-value">
          <style>
            .eligibility-intro-stat-value {
              font-size: 1.25rem;
              font-weight: 700;
              color: var(--grantaura-primary);
              display: flex;
              align-items: center;
              margin-bottom: 0.25rem;
            }
            
            @media (min-width: 768px) {
              .eligibility-intro-stat-value {
                font-size: 1.5rem;
              }
            }
          </style>
          300+
        </div>
        
        <div class="eligibility-intro-stat-label">
          <style>
            .eligibility-intro-stat-label {
              font-size: 0.8125rem;
              color: var(--grantaura-gray-600);
            }
            
            @media (min-width: 768px) {
              .eligibility-intro-stat-label {
                font-size: 0.875rem;
              }
            }
          </style>
          Successful Projects
        </div>
      </div>
      
      <div class="eligibility-intro-stat">
        <div class="eligibility-intro-stat-value">
          <i class="fas fa-star" style="color: var(--grantaura-secondary); font-size: 0.875rem; margin-right: 0.25rem;"></i>
          4.9/5
        </div>
        <div class="eligibility-intro-stat-label">
          Client Rating
        </div>
      </div>
      
      <div class="eligibility-intro-stat">
        <div class="eligibility-intro-stat-value">
          185+
        </div>
        <div class="eligibility-intro-stat-label">
          Client Reviews
        </div>
      </div>
    </div>
  </div>
</section>
  
  <!-- Progress tracker component -->
  <div class="eligibility-checker__progress" data-component="checker-progress">
    <div class="eligibility-checker__progress-bar-container">
      <div class="eligibility-checker__progress-bar" id="progress-bar"></div>
    </div>

    <div class="eligibility-checker__progress-steps">
      <div class="eligibility-checker__step active" data-step="1">
        <div class="eligibility-checker__step-icon">1</div>
        <div class="eligibility-checker__step-label">Who you are</div>
      </div>
      
      <div class="eligibility-checker__step" data-step="2">
        <div class="eligibility-checker__step-icon">2</div>
        <div class="eligibility-checker__step-label">Key details</div>
      </div>
      
      <div class="eligibility-checker__step" data-step="3">
        <div class="eligibility-checker__step-icon">3</div>
        <div class="eligibility-checker__step-label">Grant matches</div>
      </div>
    </div>
  </div>
  
  <!-- Main form container -->
  <div class="eligibility-checker__form" id="eligibility-checker__form" data-component="checker-form">
    <!-- Step 1: Entity Type Selection -->
    <div class="eligibility-checker__step-content active" id="step1" data-step="1">
      <h3 class="eligibility-checker__step-title"><i class="fas fa-user-circle"></i>Who are you?</h3>
      <p class="eligibility-checker__step-description">Tell us about who you are so we can find the most relevant grant opportunities for you.</p>
      
      <div class="eligibility-checker__form-group">
        <label class="eligibility-checker__form-label eligibility-checker__priority-label">
          What type of entity are you seeking funding for? <span>High Priority</span>
        </label>
        <div class="eligibility-checker__cards" id="entity-type-cards">
          <!-- For-profit business card -->
          <div class="eligibility-checker__card" data-value="for_profit_business">
            <input type="radio" name="entity_type" value="for_profit_business" id="for_profit_business" class="eligibility-checker__card-radio">
            <i class="fas fa-briefcase eligibility-checker__card-icon"></i>
            <h4 class="eligibility-checker__card-title">For-profit business</h4>
            <p class="eligibility-checker__card-description">Small businesses, startups, enterprises seeking funding for growth or specific projects.</p>
          </div>
          
          <!-- Nonprofit card -->
          <div class="eligibility-checker__card" data-value="nonprofit">
            <input type="radio" name="entity_type" value="nonprofit" id="nonprofit" class="eligibility-checker__card-radio">
            <i class="fas fa-hand-holding-heart eligibility-checker__card-icon"></i>
            <h4 class="eligibility-checker__card-title">Nonprofit organization</h4>
            <p class="eligibility-checker__card-description">501(c)(3) organizations, foundations, and other nonprofit entities.</p>
          </div>
          
          <!-- Individual card -->
          <div class="eligibility-checker__card" data-value="individual">
            <input type="radio" name="entity_type" value="individual" id="individual" class="eligibility-checker__card-radio">
            <i class="fas fa-user eligibility-checker__card-icon"></i>
            <h4 class="eligibility-checker__card-title">Individual</h4>
            <p class="eligibility-checker__card-description">Personal funding for creative projects, education, research, or other personal initiatives.</p>
          </div>
          
          <!-- Institution/organization card -->
          <div class="eligibility-checker__card" data-value="institution">
            <input type="radio" name="entity_type" value="institution" id="institution" class="eligibility-checker__card-radio">
            <i class="fas fa-university eligibility-checker__card-icon"></i>
            <h4 class="eligibility-checker__card-title">Institution/Organization</h4>
            <p class="eligibility-checker__card-description">Educational institutions, research organizations, or public sector entities.</p>
          </div>
        </div>
        <div class="eligibility-checker__form-error">Please select an entity type to continue.</div>
      </div>
      
      <div class="eligibility-checker__form-navigation">
        <div></div> <!-- Empty div for flex spacing -->
        <button class="eligibility-checker__primary-button" id="step1-next">
          Continue <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Step 2: Entity Details (Dynamically populated based on Step 1 selection) -->
    <div class="eligibility-checker__step-content" id="step2" data-step="2">
      <h3 class="eligibility-checker__step-title"><i class="fas fa-info-circle"></i>Key details</h3>
      <p class="eligibility-checker__step-description">Help us understand more about your specific situation to find the best grant matches.</p>
      
      <!-- Dynamic content will be inserted here based on entity type selection -->
      <div id="dynamic-form-content"></div>
      
      <div class="eligibility-checker__form-navigation">
        <button class="eligibility-checker__secondary-button" id="step2-prev">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="eligibility-checker__primary-button" id="step2-next">
          Continue <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Step 3: Grant Matches Results -->
    <div class="eligibility-checker__step-content" id="step3" data-step="3">
      <!-- Admin notice (only visible with special URL parameter) -->
      <div class="eligibility-checker__admin-notice" id="admin-notice" style="display: none;">
        <i class="fas fa-shield-alt"></i>
        <span>Admin mode active: Viewing all grants including premium matches.</span>
      </div>
      
      <h3 class="eligibility-checker__step-title"><i class="fas fa-award"></i>Your grant matches</h3>
      <p class="eligibility-checker__step-description">Based on your profile, we've identified these grants that match your eligibility criteria. Review each opportunity to find the best fit for your needs.</p>
      
      <!-- Loading state (shown initially) -->
      <div class="eligibility-checker__loading" id="matches-loading">
        <div class="eligibility-checker__spinner"></div>
        <div class="eligibility-checker__loading-text">Finding your perfect grant matches</div>
        <div class="eligibility-checker__loading-subtext">We're analyzing your profile against our comprehensive grants database to find the best opportunities for you.</div>
        <div class="eligibility-checker__progress-wrapper">
          <div class="eligibility-checker__loading-progress" id="loading-progress-bar"></div>
        </div>
      </div>
      
      <!-- Results container (hidden until loaded) -->
      <section class="eligibility-checker__matches-container hidden" id="matches-container">
  <style>
    /* Container base styles */
    .eligibility-checker__matches-container {
      background: var(--grantaura-white);
      border-radius: var(--grantaura-border-radius-lg);
      box-shadow: var(--grantaura-box-shadow);
      margin: 1.5rem 0;
      overflow: hidden;
      position: relative;
      transition: var(--grantaura-transition);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    @media (min-width: 768px) {
      .eligibility-checker__matches-container {
        margin: 2rem 0;
        box-shadow: var(--grantaura-box-shadow-lg);
      }
    }

    /* Accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }
  </style>

  <!-- Header Section -->
  <div class="eligibility-checker__matches-header">
    <style>
      .eligibility-checker__matches-header {
        background: linear-gradient(135deg, var(--grantaura-primary-dark), var(--grantaura-primary));
        padding: 1rem;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      .eligibility-checker__matches-header::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://grantaura.com/wp-content/uploads/2025/02/abs-bg-circular-paths-13.webp');
        background-size: cover;
        background-position: right center;
        opacity: 0.1;
        pointer-events: none;
      }

      .eligibility-checker__matches-title {
        color: var(--grantaura-white);
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        z-index: 1;
      }

      .eligibility-checker__matches-title::before {
        content: "";
        display: inline-block;
        width: 24px;
        height: 24px;
        background-image: url('https://grantaura.com/wp-content/uploads/2025/02/right-tick-with-a-little-star-png.webp');
        background-size: contain;
        background-repeat: no-repeat;
      }

      .eligibility-checker__matches-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--grantaura-secondary);
        color: var(--grantaura-primary-dark);
        border-radius: 50%;
        width: 28px;
        height: 28px;
        font-size: 1rem;
        font-weight: 700;
      }

      @media (min-width: 768px) {
        .eligibility-checker__matches-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          padding: 1.25rem 1.5rem;
        }

        .eligibility-checker__matches-title {
          margin: 0;
          font-size: 1.75rem;
        }

        .eligibility-checker__matches-count {
          width: 32px;
          height: 32px;
          font-size: 1.125rem;
        }
      }
    </style>

    <h4 class="eligibility-checker__matches-title">
      Grant matches
      <span class="eligibility-checker__matches-count" id="matches-count">0</span>
    </h4>
    
    <div class="eligibility-checker__filter-group">
      <style>
        .eligibility-checker__filter-group {
          margin-top: 0.75rem;
          position: relative;
          z-index: 1;
        }

        .eligibility-checker__filter-label {
          color: var(--grantaura-white);
          font-size: 0.875rem;
          font-weight: 500;
          margin-right: 0.75rem;
          display: inline-block;
          margin-bottom: 0.5rem;
        }

        .eligibility-checker__filter-options {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .eligibility-checker__filter-button {
          background: rgba(255, 255, 255, 0.15);
          border: none;
          color: var(--grantaura-white);
          padding: 0.5rem 0.85rem;
          border-radius: var(--grantaura-border-radius-sm);
          font-size: 0.875rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          position: relative;
          overflow: hidden;
        }

        .eligibility-checker__filter-button::after {
          content: "";
          position: absolute;
          bottom: 0;
          left: 50%;
          width: 0;
          height: 2px;
          background: var(--grantaura-secondary);
          transition: all 0.2s ease;
          transform: translateX(-50%);
        }

        .eligibility-checker__filter-button:hover {
          background: rgba(255, 255, 255, 0.25);
        }

        .eligibility-checker__filter-button.active {
          background: rgba(255, 255, 255, 0.25);
          font-weight: 600;
        }

        .eligibility-checker__filter-button.active::after {
          width: 80%;
        }

        @media (min-width: 768px) {
          .eligibility-checker__filter-group {
            margin-top: 0;
            display: flex;
            align-items: center;
          }

          .eligibility-checker__filter-label {
            margin-bottom: 0;
          }

          .eligibility-checker__filter-button {
            padding: 0.5rem 1rem;
            font-size: 0.9375rem;
          }
        }
      </style>

      <span class="eligibility-checker__filter-label">Filter:</span>
      <div class="eligibility-checker__filter-options">
        <button class="eligibility-checker__filter-button active" data-filter="all">All</button>
        <button class="eligibility-checker__filter-button" data-filter="high-match">High match</button>
        <button class="eligibility-checker__filter-button" data-filter="deadline">Deadline</button>
        <button class="eligibility-checker__filter-button" data-filter="amount">Amount</button>
      </div>
    </div>
  </div>
  
  <!-- Grant matches list -->
  <div class="eligibility-checker__matches-list" id="matches-list">
  <style>
    /* Main matches list container */
    .eligibility-checker__matches-list {
      padding: 1.25rem 1rem;
      max-height: 550px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--grantaura-primary-light) var(--grantaura-gray-100);
      position: relative;
      background: linear-gradient(180deg, rgba(249, 250, 251, 0.6) 0%, rgba(255, 255, 255, 1) 15%, rgba(255, 255, 255, 1) 100%);
    }

    .eligibility-checker__matches-list::-webkit-scrollbar {
      width: 6px;
    }

    .eligibility-checker__matches-list::-webkit-scrollbar-track {
      background: var(--grantaura-gray-100);
      border-radius: 8px;
      margin: 8px 0;
    }

    .eligibility-checker__matches-list::-webkit-scrollbar-thumb {
      background-color: var(--grantaura-primary-light);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .eligibility-checker__matches-list:empty::after {
      content: "Loading grants...";
      display: block;
      text-align: center;
      padding: 2rem 0;
      color: var(--grantaura-text-light);
      font-style: italic;
    }

    /* Grant card styles */
    .eligibility-checker__grant-card {
      background: var(--grantaura-white);
      border-radius: var(--grantaura-border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      position: relative;
      border-left: 4px solid var(--grantaura-primary);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      overflow: hidden;
    }

    .eligibility-checker__grant-card::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 40%;
      background: linear-gradient(90deg, transparent, rgba(249, 250, 251, 0.5));
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .eligibility-checker__grant-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(90, 59, 140, 0.12);
    }

    .eligibility-checker__grant-card:hover::before {
      opacity: 1;
    }

    /* High match styling */
    .eligibility-checker__grant-card-high-match {
      border-left-color: var(--grantaura-secondary);
    }

    .eligibility-checker__grant-card-high-match::after {
      content: "High Match";
      position: absolute;
      top: 12px;
      right: 0;
      background: var(--grantaura-secondary);
      color: var(--grantaura-white);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem 0.25rem 0.75rem;
      border-radius: 4px 0 0 4px;
      box-shadow: 0 2px 4px rgba(255, 163, 102, 0.3);
      transform: translateX(0);
      transition: transform 0.3s ease;
      z-index: 2;
    }

    /* Card elements styling */
    .eligibility-checker__grant-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--grantaura-primary-dark);
      margin: 0 0 0.5rem 0;
      padding-right: 30px; /* Space for high match label */
      line-height: 1.4;
      display: block;
    }

    .eligibility-checker__grant-details {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .eligibility-checker__grant-detail {
      display: flex;
      align-items: flex-start;
      font-size: 0.875rem;
      color: var(--grantaura-text-light);
    }

    .eligibility-checker__grant-detail i {
      color: var(--grantaura-primary-light);
      margin-right: 0.5rem;
      min-width: 16px;
      text-align: center;
    }

    .eligibility-checker__grant-detail--amount i {
      color: var(--grantaura-success);
    }

    .eligibility-checker__grant-detail--deadline i {
      color: var(--grantaura-warning);
    }

    .eligibility-checker__grant-detail--amount {
      font-weight: 600;
    }

    .eligibility-checker__grant-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--grantaura-gray-100);
    }

    .eligibility-checker__grant-match {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: var(--grantaura-text-light);
    }

    .eligibility-checker__grant-match-bar {
      display: inline-block;
      width: 50px;
      height: 6px;
      background: var(--grantaura-gray-200);
      border-radius: 3px;
      margin-right: 0.5rem;
      overflow: hidden;
      position: relative;
    }

    .eligibility-checker__grant-match-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: var(--grantaura-primary);
      border-radius: 3px;
    }

    .eligibility-checker__grant-match--high .eligibility-checker__grant-match-fill {
      background: var(--grantaura-secondary);
    }

    .eligibility-checker__grant-actions {
      display: flex;
      gap: 0.5rem;
    }

    .eligibility-checker__grant-button {
      padding: 0.5rem 1rem;
      border-radius: var(--grantaura-border-radius-sm);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none !important;
      display: inline-flex;
      align-items: center;
    }

    .eligibility-checker__grant-button--view {
      background: var(--grantaura-primary);
      color: var(--grantaura-white) !important;
    }

    .eligibility-checker__grant-button--view:hover {
      background: var(--grantaura-primary-dark);
    }

    .eligibility-checker__grant-button--save {
      background: var(--grantaura-white);
      color: var(--grantaura-primary) !important;
      border: 1px solid var(--grantaura-primary-light);
    }

    .eligibility-checker__grant-button--save:hover {
      background: rgba(90, 59, 140, 0.05);
    }

    .eligibility-checker__grant-button i {
      margin-right: 0.4rem;
      font-size: 0.875rem;
    }

    /* Media queries for responsive design */
    @media (min-width: 640px) {
      .eligibility-checker__grant-details {
        grid-template-columns: 1fr 1fr;
      }
      
      .eligibility-checker__grant-footer {
        margin-top: 0.75rem;
      }
    }

    @media (min-width: 768px) {
      .eligibility-checker__matches-list {
        padding: 1.75rem;
      }
      
      .eligibility-checker__grant-title {
        font-size: 1.25rem;
      }
      
      .eligibility-checker__grant-card {
        padding: 1.5rem;
      }
      
      .eligibility-checker__grant-detail {
        font-size: 0.9375rem;
      }
    }

    /* Animated placeholder for loading state */
    @keyframes cardShimmer {
      0% {
        background-position: -468px 0;
      }
      100% {
        background-position: 468px 0;
      }
    }

    .eligibility-checker__grant-card--loading {
      padding: 1.25rem;
      background: var(--grantaura-white);
      margin-bottom: 1.25rem;
      border-radius: var(--grantaura-border-radius);
      border-left: 4px solid var(--grantaura-gray-300);
      overflow: hidden;
    }

    .eligibility-checker__loading-line {
      height: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      background: linear-gradient(to right, var(--grantaura-gray-100) 8%, var(--grantaura-gray-200) 18%, var(--grantaura-gray-100) 33%);
      background-size: 800px 104px;
      animation: cardShimmer 1.2s linear infinite forwards;
    }

    .eligibility-checker__loading-line--title {
      height: 20px;
      width: 85%;
      margin-bottom: 20px;
    }

    .eligibility-checker__loading-line--detail {
      height: 15px;
      width: 60%;
    }

    .eligibility-checker__loading-line--footer {
      height: 15px;
      width: 100%;
      margin-top: 20px;
    }
  </style>

  <!-- Sample grant card structure (will be dynamically populated by JavaScript) -->
  <!-- This is just for visualization and will be hidden/replaced by the actual data -->
  <div class="eligibility-checker__grant-card eligibility-checker__grant-card-high-match" style="display: none;">
    <a href="#" class="eligibility-checker__grant-title">Miami-Dade Small Business Assistance Program</a>
    <div class="eligibility-checker__grant-details">
      <div class="eligibility-checker__grant-detail eligibility-checker__grant-detail--amount">
        <i class="fas fa-dollar-sign"></i>
        <span>Up to $25,000</span>
      </div>
      <div class="eligibility-checker__grant-detail eligibility-checker__grant-detail--deadline">
        <i class="fas fa-calendar-alt"></i>
        <span>Deadline: May 15, 2025</span>
      </div>
      <div class="eligibility-checker__grant-detail">
        <i class="fas fa-map-marker-alt"></i>
        <span>Miami-Dade County, Florida</span>
      </div>
      <div class="eligibility-checker__grant-detail">
        <i class="fas fa-briefcase"></i>
        <span>For small businesses affected by COVID-19</span>
      </div>
    </div>
    <div class="eligibility-checker__grant-footer">
      <div class="eligibility-checker__grant-match eligibility-checker__grant-match--high">
        <span class="eligibility-checker__grant-match-bar">
          <span class="eligibility-checker__grant-match-fill" style="width: 85%;"></span>
        </span>
        <span>85% match</span>
      </div>
      <div class="eligibility-checker__grant-actions">
        <a href="#" class="eligibility-checker__grant-button eligibility-checker__grant-button--view">
          <i class="fas fa-external-link-alt"></i> View
        </a>
        <button class="eligibility-checker__grant-button eligibility-checker__grant-button--save">
          <i class="far fa-bookmark"></i> Save
        </button>
      </div>
    </div>
  </div>

  <!-- Loading state placeholder (will be shown while data loads) -->
  <div class="eligibility-checker__grant-card--loading" style="display: none;">
    <div class="eligibility-checker__loading-line eligibility-checker__loading-line--title"></div>
    <div class="eligibility-checker__loading-line eligibility-checker__loading-line--detail"></div>
    <div class="eligibility-checker__loading-line eligibility-checker__loading-line--detail"></div>
    <div class="eligibility-checker__loading-line eligibility-checker__loading-line--detail"></div>
    <div class="eligibility-checker__loading-line eligibility-checker__loading-line--footer"></div>
  </div>

  <!-- Grant cards will be dynamically added here by JavaScript -->
</div>
  
  <!-- No matches message (hidden by default) -->
  <div class="eligibility-checker__no-matches hidden" id="no-matches">
    <style>
      .eligibility-checker__no-matches {
        padding: 2rem 1rem;
        text-align: center;
      }

      .eligibility-checker__no-matches-container {
        max-width: 640px;
        margin: 0 auto;
        background: var(--grantaura-white);
        border-radius: var(--grantaura-border-radius-lg);
        padding: 2rem 1rem;
        box-shadow: var(--grantaura-box-shadow);
        position: relative;
        overflow: hidden;
      }

      .eligibility-checker__no-matches-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(to right, var(--grantaura-primary), var(--grantaura-secondary));
      }

      .eligibility-checker__no-matches-container h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--grantaura-primary-dark);
        margin: 0 0 1rem;
      }

      .eligibility-checker__no-matches-container p {
        color: var(--grantaura-text-light);
        font-size: 1rem;
        line-height: 1.5;
        margin-bottom: 1.5rem;
      }

      .eligibility-checker__no-matches-options {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .eligibility-checker__option-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: var(--grantaura-gray-50);
        border: 1px solid var(--grantaura-gray-200);
        border-radius: var(--grantaura-border-radius);
        padding: 1.5rem 1rem;
        text-decoration: none !important;
        transition: all 0.3s ease;
      }

      .eligibility-checker__option-button i {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: var(--grantaura-primary);
      }

      .eligibility-checker__option-button span {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--grantaura-primary-dark) !important;
        margin-bottom: 0.5rem;
      }

      .eligibility-checker__option-button p {
        font-size: 0.875rem;
        color: var(--grantaura-text-light);
        margin: 0;
      }

      .eligibility-checker__option-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--grantaura-box-shadow);
        border-color: var(--grantaura-primary-light);
      }

      .eligibility-checker__option-button.research-button:hover i {
        color: var(--grantaura-primary-dark);
      }

      .eligibility-checker__option-button.consultation-button:hover i {
        color: var(--grantaura-secondary);
      }

      .eligibility-checker__secondary-button {
        background: none;
        border: none;
        color: var(--grantaura-primary);
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s ease;
      }

      .eligibility-checker__secondary-button i {
        margin-right: 0.5rem;
      }

      .eligibility-checker__secondary-button:hover {
        color: var(--grantaura-primary-dark);
        text-decoration: underline;
      }

      @media (min-width: 768px) {
        .eligibility-checker__no-matches {
          padding: 3rem 2rem;
        }

        .eligibility-checker__no-matches-container {
          padding: 2.5rem 2rem;
        }

        .eligibility-checker__no-matches-container h3 {
          font-size: 1.75rem;
        }

        .eligibility-checker__no-matches-options {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>

    <div class="eligibility-checker__no-matches-container">
      <h3>No Matching Grants Found</h3>
      <p>Our system couldn't find grants that match your specific criteria in our database. Our grant experts can help you find funding opportunities tailored to your unique needs.</p>
      
      <div class="eligibility-checker__no-matches-options">
        <a href="https://grantaura.com/grant-research" class="eligibility-checker__option-button research-button">
          <i class="fas fa-search"></i>
          <span>Custom Grant Research</span>
          <p>Our experts will conduct in-depth research to find grants specifically matching your eligibility criteria.</p>
        </a>
        
        <a href="#" onclick="Calendly.initPopupWidget({url: 'https://calendly.com/grantaura'});return false;" class="eligibility-checker__option-button consultation-button">
          <i class="fas fa-calendar-alt"></i>
          <span>Schedule a Consultation</span>
          <p>Book a free 15-minute consultation with one of our grant experts to discuss your funding needs.</p>
        </a>
      </div>
      
      <button id="try-different-criteria" class="eligibility-checker__secondary-button">
        <i class="fas fa-redo"></i> Try Different Criteria
      </button>
    </div>
  </div>
</section>
      
      <!-- Grant Details Modal -->
<div class="grant-details-modal" id="match-modal">
  <style>
    /* =========== Base Modal Variables & Setup - MOBILE FIRST =========== */
    .grant-details-modal {
      /* Core variables */
      --modal-radius: var(--grantaura-border-radius-lg, 12px);
      --modal-shadow: 0 10px 35px rgba(31, 41, 55, 0.25);
      --animation-timing: cubic-bezier(0.16, 1, 0.3, 1);
      --modal-header-bg: linear-gradient(135deg, var(--grantaura-primary-dark), var(--grantaura-primary));
      
      /* Height allocation variables - mobile first */
      --modal-height: 95vh;
      --modal-max-height: 95vh;
      --modal-header-height-mobile: 130px;
      --modal-header-height-tablet: 150px;
      --modal-header-height-desktop: 170px;
      --modal-footer-height-mobile: 60px; /* Reduced for smaller screens */
      --modal-footer-height-tablet: 70px;
      --modal-footer-height-desktop: 70px;
      --modal-cta-height-mobile: 70px; /* Reduced for smaller screens */
      --modal-cta-height-tablet: 70px;
      --modal-cta-height-desktop: 70px;
      
      /* Spacing variables */
      --modal-padding-mobile: 0.75rem;
      --modal-padding-tablet: 1.25rem;
      --modal-padding-desktop: 1.5rem;
      --modal-section-spacing-mobile: 0.5rem;
      --modal-section-spacing-tablet: 0.875rem;
      --modal-section-spacing-desktop: 1.125rem;
      
      /* Visual elements */
      --modal-backdrop-blur: 8px;
      --modal-backdrop-opacity: 0.85;
      
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(31, 41, 55, var(--modal-backdrop-opacity));
      backdrop-filter: blur(var(--modal-backdrop-blur));
      -webkit-backdrop-filter: blur(var(--modal-backdrop-blur));
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s var(--animation-timing), visibility 0.4s var(--animation-timing);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .grant-details-modal.active {
      opacity: 1;
      visibility: visible;
    }

    /* =========== Modal Container - Mobile First =========== */
    .grant-details-modal__container {
      width: 100%;
      max-width: 800px;
      height: var(--modal-height);
      max-height: var(--modal-max-height);
      background: #fff;
      border-radius: var(--modal-radius);
      overflow: hidden;
      box-shadow: var(--modal-shadow);
      display: flex;
      flex-direction: column;
      position: relative;
      transform: translateY(30px) scale(0.97);
      transition: transform 0.5s var(--animation-timing);
    }

    .grant-details-modal.active .grant-details-modal__container {
      transform: translateY(0) scale(1);
    }

    /* =========== Header Section - Mobile First =========== */
    .grant-details-modal__header {
      position: relative;
      height: auto; /* Auto height for very small screens */
      min-height: var(--modal-header-height-mobile);
      max-height: 30vh; /* Maximum percentage of viewport */
      padding: var(--modal-padding-mobile);
      background: var(--modal-header-bg);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-radius: var(--modal-radius) var(--modal-radius) 0 0;
      overflow: hidden;
      z-index: 10;
    }

    /* Creative pattern overlay */
    .grant-details-modal__header:before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background-image: 
        radial-gradient(circle at 10% 15%, rgba(255, 255, 255, 0.18) 0%, transparent 40%),
        radial-gradient(circle at 90% 85%, rgba(255, 255, 255, 0.12) 0%, transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.06) 0%, transparent 60%);
      z-index: 1;
    }
    
    /* Decorative light accent */
    .grant-details-modal__header:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, var(--grantaura-secondary) 50%, transparent 100%);
      opacity: 0.7;
      z-index: 2;
    }

    .grant-details-modal__header-content {
      position: relative;
      z-index: 3;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    /* Close button with enhanced touch target */
    .grant-details-modal__close {
      position: absolute;
      top: 0.625rem;
      right: 0.625rem;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white !important;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 15;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      -webkit-tap-highlight-color: transparent;
    }

    .grant-details-modal__close:hover,
    .grant-details-modal__close:active {
      background: rgba(255, 255, 255, 0.25);
      transform: rotate(90deg);
    }

    /* Grant type tag with modern styling */
    .grant-details-modal__tag-container {
      margin-bottom: 0.375rem;
    }

    .grant-details-modal__tag {
      display: inline-flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 30px;
      padding: 0.3125rem 0.625rem;
      font-size: 0.6875rem;
      color: white !important;
      font-weight: 600;
      letter-spacing: 0.3px;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transform-origin: left center;
      animation: tagFadeIn 0.4s var(--animation-timing) forwards;
    }

    @keyframes tagFadeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .grant-details-modal__tag i {
      margin-right: 0.375rem;
      font-size: 0.6875rem;
      opacity: 0.9;
    }

    /* Grant title with dynamic accent line */
    .grant-details-modal__title-container {
      position: relative;
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
      animation: titleFadeIn 0.5s var(--animation-timing) forwards;
      animation-delay: 0.1s;
      opacity: 0;
    }

    @keyframes titleFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .grant-details-modal__title-decoration {
      position: absolute;
      left: 0;
      top: 0.25em;
      width: 3px;
      height: 0;
      background: var(--grantaura-secondary);
      border-radius: 1.5px;
      animation: accentLineGrow 0.6s var(--animation-timing) forwards;
      animation-delay: 0.2s;
    }

    @keyframes accentLineGrow {
      from { height: 0; }
      to { height: calc(100% - 0.5em); }
    }

    .grant-details-modal__title {
      font-size: 1rem;
      font-weight: 700;
      color: white !important;
      margin: 0;
      line-height: 1.3;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Enhanced match score display */
    .grant-details-modal__match-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.25rem;
      animation: matchInfoFadeIn 0.6s var(--animation-timing) forwards;
      animation-delay: 0.3s;
      opacity: 0;
    }

    @keyframes matchInfoFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .grant-details-modal__match-info {
      flex: 1;
      padding-right: 0.5rem;
    }

    .grant-details-modal__match-label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 0.1875rem;
      display: flex;
      align-items: center;
    }

    .grant-details-modal__match-label i {
      margin-right: 0.3125rem;
      font-size: 0.625rem;
      color: var(--grantaura-secondary-light);
    }

    .grant-details-modal__match-description {
      font-size: 0.625rem;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.3;
      margin: 0;
      max-width: 95%;
    }

    /* Animated match score circle with pulsing effect */
    .grant-details-modal__match-circle {
      width: 50px;
      height: 50px;
      min-width: 50px;
      border-radius: 50%;
      background: var(--grantaura-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 
                  inset 0 -2px 6px rgba(0, 0, 0, 0.1), 
                  inset 0 2px 6px rgba(255, 255, 255, 0.3);
      position: relative;
      transition: all 0.4s ease;
    }

    .grant-details-modal__match-circle:before {
      content: 'MATCH';
      font-size: 7px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: -3px;
    }

    .grant-details-modal__match-circle:after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      bottom: -2px;
      left: -2px;
      border-radius: 50%;
      border: 2px dashed rgba(255, 255, 255, 0.7);
      opacity: 0.8;
      animation: rotate 30s linear infinite;
    }

    /* Match score pulsing animation */
    .pulse-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--grantaura-secondary);
      opacity: 0;
      z-index: -1;
      animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    @keyframes pulse-ring {
      0% { transform: translate(-50%, -50%) scale(0.95); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(0.95); opacity: 0; }
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .grant-details-modal__match-score {
      font-size: 1.125rem;
      font-weight: 800;
      color: white !important;
      line-height: 1;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* =========== Content Area - Mobile First =========== */
    .grant-details-modal__content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      min-height: 100px; /* Ensure there's always scrollable space */
      /* Using fixed height calculation to ensure compatibility across browsers */
      max-height: calc(var(--modal-height) - var(--modal-header-height-mobile) - var(--modal-footer-height-mobile) - var(--modal-cta-height-mobile));
      scrollbar-width: thin;
      scrollbar-color: var(--grantaura-primary) #F3F4F6;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      overscroll-behavior: contain; /* Prevents scroll chaining */
      scroll-behavior: smooth; /* Smooth scrolling for anchor links */
      background: var(--grantaura-gray-50);
    }

    /* Custom scrollbar styling */
    .grant-details-modal__content::-webkit-scrollbar {
      width: 3px;
    }

    .grant-details-modal__content::-webkit-scrollbar-track {
      background: #F3F4F6;
    }

    .grant-details-modal__content::-webkit-scrollbar-thumb {
      background-color: var(--grantaura-primary);
      border-radius: 6px;
    }

    /* =========== Description Section - Mobile First =========== */
    .grant-details-modal__description-section {
      padding: var(--modal-padding-mobile);
      border-bottom: 1px solid var(--grantaura-gray-200);
      background: white;
    }

    .grant-details-modal__description {
      font-size: 0.8125rem;
      line-height: 1.5;
      color: var(--grantaura-gray-700);
      margin: 0;
    }

    /* =========== Match Criteria Section - Mobile First =========== */
    .grant-details-modal__match-section {
      padding: var(--modal-padding-mobile);
      border-bottom: 1px solid var(--grantaura-gray-200);
      background: linear-gradient(to right, rgba(90, 59, 140, 0.05), rgba(255, 255, 255, 1));
      position: relative;
    }

    .grant-details-modal__match-section:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 3px;
      background: var(--grantaura-primary-light);
      opacity: 0.5;
    }

    /* Section titles with creative icon styling */
    .grant-details-modal__section-title {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--grantaura-primary);
      margin: 0 0 0.625rem 0;
      position: relative;
    }

    .grant-details-modal__section-title i {
      margin-right: 8px;
      background: rgba(90, 59, 140, 0.1);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      transition: all 0.3s ease;
    }

    .grant-details-modal__section-title:hover i {
      transform: scale(1.08);
      background: rgba(90, 59, 140, 0.15);
    }

    .grant-details-modal__match-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    /* =========== Match Items - Mobile First =========== */
    .grant-details-modal__match-item {
      display: flex;
      align-items: flex-start;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 0.5rem;
      border: 1px solid var(--grantaura-gray-200);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
      transition: all 0.2s ease;
    }

    .grant-details-modal__match-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      border-color: var(--grantaura-gray-300);
    }

    .grant-details-modal__match-icon {
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--grantaura-success);
      margin-right: 7px;
      margin-top: 2px;
      font-size: 10px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 50%;
    }

    /* Priority match items with highlight styling */
    .grant-details-modal__match-item--priority {
      background: linear-gradient(to right, rgba(255, 163, 102, 0.12), rgba(255, 163, 102, 0.05));
      border-color: rgba(255, 163, 102, 0.3);
      position: relative;
      overflow: hidden;
    }

    .grant-details-modal__match-item--priority:after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 24px;
      height: 24px;
      background: var(--grantaura-secondary-light);
      transform: rotate(45deg) translate(12px, -12px);
      opacity: 0.2;
      z-index: 0;
      border-radius: 0 0 0 5px;
    }

    .grant-details-modal__match-item--priority .grant-details-modal__match-icon {
      color: var(--grantaura-secondary-dark);
      background: rgba(255, 163, 102, 0.15);
    }

    .grant-details-modal__match-text {
      font-size: 0.75rem;
      color: var(--grantaura-text-dark);
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }

    /* =========== Grant Details Section - Mobile First =========== */
    .grant-details-modal__details-section {
      padding: var(--modal-padding-mobile);
      border-bottom: 1px solid var(--grantaura-gray-200);
      background: var(--grantaura-white);
    }

    .grant-details-modal__details-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    /* =========== Detail Item Cards - Mobile First =========== */
    .grant-details-modal__detail-item {
      display: flex;
      flex-direction: column;
      background: var(--grantaura-gray-50);
      border-radius: 8px;
      padding: 0.625rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
      border: 1px solid var(--grantaura-gray-200);
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .grant-details-modal__detail-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
      border-color: var(--grantaura-gray-300);
    }

    .grant-details-modal__detail-item:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--grantaura-primary-light);
      opacity: 0.3;
    }

    .grant-details-modal__detail-label {
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--grantaura-gray-600);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
    }

    .grant-details-modal__detail-label i {
      margin-right: 5px;
      font-size: 10px;
      color: var(--grantaura-primary);
    }

    .grant-details-modal__detail-value {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--grantaura-text-dark);
    }

    /* Special Styles for Detail Items */
    .grant-details-modal__detail-item--amount {
      background: linear-gradient(to right bottom, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.01));
      border-color: rgba(16, 185, 129, 0.2);
    }

    .grant-details-modal__detail-item--amount:before {
      background: var(--grantaura-success);
      opacity: 0.6;
    }

    .grant-details-modal__detail-item--amount .grant-details-modal__detail-label i {
      color: var(--grantaura-success);
    }

    .grant-details-modal__detail-item--amount .grant-details-modal__detail-value {
      color: var(--grantaura-success);
      position: relative;
      display: inline-block;
    }

    .grant-details-modal__detail-item--amount .grant-details-modal__detail-value:after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 1px;
      background: var(--grantaura-success);
      opacity: 0.3;
    }

    .grant-details-modal__detail-item--deadline {
      background: linear-gradient(to right bottom, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.01));
      border-color: rgba(245, 158, 11, 0.2);
    }

    .grant-details-modal__detail-item--deadline:before {
      background: var(--grantaura-warning);
      opacity: 0.6;
    }

    .grant-details-modal__detail-item--deadline .grant-details-modal__detail-label i {
      color: var(--grantaura-warning);
    }

    /* Deadline Status Indicators */
    .grant-details-modal__deadline--urgent {
      color: var(--grantaura-warning);
      display: flex;
      align-items: center;
    }

    .grant-details-modal__deadline--urgent:before {
      content: '';
      display: inline-block;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--grantaura-warning);
      margin-right: 4px;
      animation: pulse 2s infinite;
    }

    .grant-details-modal__deadline--critical {
      color: var(--grantaura-danger);
      display: flex;
      align-items: center;
    }

    .grant-details-modal__deadline--critical:before {
      content: '';
      display: inline-block;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--grantaura-danger);
      margin-right: 4px;
      animation: pulse 1.5s infinite;
    }

    .grant-details-modal__deadline--expired {
      color: var(--grantaura-gray-500);
      text-decoration: line-through;
      opacity: 0.8;
    }

    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(0.95); opacity: 1; }
    }

    /* =========== Application Steps Section - Mobile First =========== */
    .grant-details-modal__steps-section {
      padding: var(--modal-padding-mobile);
      border-bottom: 1px solid var(--grantaura-gray-200);
      background: var(--grantaura-white);
    }

    /* Creative timeline design for steps */
    .grant-details-modal__steps-list {
      margin: 0;
      padding: 0;
      list-style: none;
      position: relative;
    }

   

    .grant-details-modal__step-item {
      position: relative;
      padding-left: 28px;
      margin-bottom: 0.875rem;
      z-index: 2;
    }

    .grant-details-modal__step-item:last-child {
      margin-bottom: 0;
    }

    .grant-details-modal__step-number {
      position: absolute;
      left: 0;
      top: 0;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
      color: white !important;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      box-shadow: 0 0 0 3px white, 0 3px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .grant-details-modal__step-item:hover .grant-details-modal__step-number {
      transform: scale(1.08);
      box-shadow: 0 0 0 3px white, 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .grant-details-modal__step-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--grantaura-text-dark);
      margin: 0 0 2px 0;
      line-height: 1.3;
    }

    .grant-details-modal__step-description {
      font-size: 0.75rem;
      color: var(--grantaura-gray-600);
      margin: 0;
      line-height: 1.5;
    }

    /* =========== CTA Section - Mobile First =========== */
    .grant-details-modal__cta-section {
      padding: 0.625rem var(--modal-padding-mobile);
      background: linear-gradient(to right, #FFF8F3, #FFF);
      border-top: 1px solid #FFE4CC;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
      height: var(--modal-cta-height-mobile);
      min-height: var(--modal-cta-height-mobile);
    }

    .grant-details-modal__cta-text {
      font-size: 0.75rem;
      color: var(--grantaura-gray-600);
      margin: 0;
    }

    .grant-details-modal__cta-title {
      font-weight: 700;
      color: var(--grantaura-text-dark);
      margin-bottom: 0.125rem;
      font-size: 0.875rem;
      display: block;
    }

    /* Enhanced CTA button with animation */
    .grant-details-modal__cta-button {
      background: var(--grantaura-secondary);
      color: white !important;
      font-weight: 600;
      padding: 0.4375rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
      text-decoration: none !important;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 8px rgba(255, 163, 102, 0.25);
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      overflow: hidden;
    }

    .grant-details-modal__cta-button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: 0.5s;
    }

    .grant-details-modal__cta-button:hover,
    .grant-details-modal__cta-button:active {
      background: var(--grantaura-secondary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 163, 102, 0.3);
    }

    .grant-details-modal__cta-button:hover:before {
      left: 100%;
    }

    /* =========== Footer Section - Mobile First with Minimal Content =========== */
    .grant-details-modal__footer {
      padding: 0 0.75rem;
      background: var(--grantaura-gray-50);
      border-top: 1px solid var(--grantaura-gray-200);
      display: flex;
      height: var(--modal-footer-height-mobile);
      min-height: var(--modal-footer-height-mobile);
      align-items: center;
      gap: 0.5rem;
    }

    /* Super compact footer buttons for small mobile */
    .grant-details-modal__back-button {
      background: white;
      border: 1px solid var(--grantaura-gray-300);
      color: var(--grantaura-gray-700) !important;
      font-weight: 600;
      padding: 0.375rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
      white-space: nowrap;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      flex: 1;
    }

    .grant-details-modal__back-button:hover,
    .grant-details-modal__back-button:active {
      background: var(--grantaura-gray-100);
      color: var(--grantaura-text-dark) !important;
      border-color: var(--grantaura-gray-400);
    }

    .grant-details-modal__apply-button {
      background: linear-gradient(135deg, var(--grantaura-primary), var(--grantaura-primary-dark));
      color: white !important;
      font-weight: 600;
      padding: 0.375rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      text-decoration: none !important;
      border: none;
      justify-content: center;
      white-space: nowrap;
      box-shadow: 0 3px 6px rgba(90, 59, 140, 0.25);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      flex: 1.5;
    }

    .grant-details-modal__apply-button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .grant-details-modal__apply-button:hover,
    .grant-details-modal__apply-button:active {
      background: var(--grantaura-primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(90, 59, 140, 0.3);
    }

    .grant-details-modal__apply-button:hover:before {
      left: 100%;
    }

    /* Hide text in buttons on very small screens */
    .grant-details-modal__back-text,
    .grant-details-modal__apply-text {
      display: none;
    }

    /* Special handling for very small screens */
    @media (min-width: 360px) {
      /* Show minimal text on buttons */
      .grant-details-modal__apply-text {
        display: inline;
      }
      
      .grant-details-modal__back-button,
      .grant-details-modal__apply-button {
        padding: 0.4375rem 0.625rem;
      }
    }

    /* =========== Tablet Styles =========== */
    @media (min-width: 480px) {
      .grant-details-modal {
        padding: 0.75rem;
      }
      
      .grant-details-modal__header {
        min-height: var(--modal-header-height-tablet);
        max-height: none;
        padding: var(--modal-padding-tablet);
      }
      
      .grant-details-modal__content {
        max-height: calc(var(--modal-height) - var(--modal-header-height-tablet) - var(--modal-footer-height-tablet) - var(--modal-cta-height-tablet));
      }
      
      .grant-details-modal__match-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .grant-details-modal__title {
        font-size: 1.25rem;
      }
      
      .grant-details-modal__tag {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
      }
      
      .grant-details-modal__match-circle {
        width: 60px;
        height: 60px;
        min-width: 60px;
      }
      
      .grant-details-modal__match-score {
        font-size: 1.375rem;
      }
      
      .grant-details-modal__match-description {
        font-size: 0.6875rem;
      }
      
      .grant-details-modal__description-section,
      .grant-details-modal__match-section,
      .grant-details-modal__details-section,
      .grant-details-modal__steps-section {
        padding: var(--modal-padding-tablet);
      }
      
      .grant-details-modal__cta-section {
        padding: 0 var(--modal-padding-tablet);
        height: var(--modal-cta-height-tablet);
        min-height: var(--modal-cta-height-tablet);
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      
      .grant-details-modal__footer {
        padding: 0 var(--modal-padding-tablet);
        height: var(--modal-footer-height-tablet);
        min-height: var(--modal-footer-height-tablet);
      }
      
      .grant-details-modal__cta-text {
        max-width: 65%;
        font-size: 0.8125rem;
      }
      
      .grant-details-modal__cta-button {
        width: auto;
        font-size: 0.8125rem;
        padding: 0.5rem 0.875rem;
      }
      
      .grant-details-modal__description {
        font-size: 0.875rem;
      }
      
      .grant-details-modal__section-title {
        font-size: 1rem;
        margin-bottom: 1rem;
      }
      
      .grant-details-modal__section-title i {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }
      
      .grant-details-modal__match-item {
        padding: 0.625rem;
      }
      
      .grant-details-modal__match-text {
        font-size: 0.8125rem;
      }
      
      .grant-details-modal__match-icon {
        min-width: 20px;
        height: 20px;
        font-size: 11px;
      }
      
      .grant-details-modal__step-number {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }
      
      .grant-details-modal__step-item {
        padding-left: 32px;
      }
      
     
      
      .grant-details-modal__step-title {
        font-size: 0.9375rem;
      }
      
      .grant-details-modal__step-description {
        font-size: 0.8125rem;
      }
      
      .grant-details-modal__back-button,
      .grant-details-modal__apply-button {
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
      }
      
      /* Show back button text on tablet */
      .grant-details-modal__back-text,
      .grant-details-modal__apply-text {
        display: inline;
      }
    }
    
    @media (min-width: 640px) {
      .grant-details-modal__details-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .grant-details-modal__back-button,
      .grant-details-modal__apply-button {
        padding: 0.5rem 1rem;
      }
      
      .grant-details-modal__detail-item {
        padding: 0.75rem;
      }
      
      .grant-details-modal__detail-value {
        font-size: 0.9375rem;
      }
      
      .grant-details-modal__detail-label {
        font-size: 0.6875rem;
      }
    }
    
    /* =========== Desktop Styles =========== */
    @media (min-width: 768px) {
      .grant-details-modal {
        padding: 1rem;
      }
      
      .grant-details-modal__header {
        min-height: var(--modal-header-height-desktop);
        padding: var(--modal-padding-desktop);
      }
      
      .grant-details-modal__content {
        max-height: calc(var(--modal-height) - var(--modal-header-height-desktop) - var(--modal-footer-height-desktop) - var(--modal-cta-height-desktop));
      }
      
      .grant-details-modal__description-section,
      .grant-details-modal__match-section,
      .grant-details-modal__details-section,
      .grant-details-modal__steps-section {
        padding: var(--modal-padding-desktop);
      }
      
      .grant-details-modal__title {
        font-size: 1.5rem;
      }
      
      .grant-details-modal__tag {
        font-size: 0.8125rem;
        padding: 0.375rem 0.875rem;
      }
      
      .grant-details-modal__match-circle {
        width: 70px;
        height: 70px;
        min-width: 70px;
      }
      
      .grant-details-modal__match-score {
        font-size: 1.625rem;
      }
      
      .grant-details-modal__match-description {
        font-size: 0.75rem;
      }
      
      .grant-details-modal__description {
        font-size: 1rem;
        line-height: 1.7;
      }
      
      .grant-details-modal__section-title {
        font-size: 1.125rem;
      }
      
      .grant-details-modal__match-text,
      .grant-details-modal__step-description {
        font-size: 0.9375rem;
      }
      
      .grant-details-modal__step-title {
        font-size: 1.0625rem;
      }
      
      .grant-details-modal__match-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      .grant-details-modal__detail-value {
        font-size: 1.0625rem;
      }
      
      .grant-details-modal__back-button,
      .grant-details-modal__apply-button,
      .grant-details-modal__cta-button {
        padding: 0.75rem 1.25rem;
        font-size: 0.9375rem;
      }
      
      .grant-details-modal__footer {
        padding: 0 var(--modal-padding-desktop);
        height: var(--modal-footer-height-desktop);
        min-height: var(--modal-footer-height-desktop);
      }
      
      .grant-details-modal__cta-section {
        padding: 0 var(--modal-padding-desktop);
        height: var(--modal-cta-height-desktop);
        min-height: var(--modal-cta-height-desktop);
      }
      
      .grant-details-modal__cta-title {
        font-size: 1.125rem;
      }
      
      .grant-details-modal__cta-text {
        font-size: 0.9375rem;
      }
      
      .grant-details-modal__content::-webkit-scrollbar {
        width: 6px;
      }
      
      .grant-details-modal__detail-label {
        font-size: 0.75rem;
      }
      
      .grant-details-modal__detail-label i {
        font-size: 12px;
      }
      
      .grant-details-modal__match-icon {
        min-width: 22px;
        height: 22px;
        font-size: 14px;
      }
      
      .grant-details-modal__step-number {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
      
      .grant-details-modal__step-item {
        padding-left: 38px;
      }
      
      
    }
  </style>

  <div class="grant-details-modal__container">
    <!-- Header with Tag and Match Score -->
    <div class="grant-details-modal__header">
      <!-- Close button -->
      <button class="grant-details-modal__close" id="modal-close" aria-label="Close grant details">&times;</button>
      
      <div class="grant-details-modal__header-content">
        <!-- Grant type indicator -->
        <div class="grant-details-modal__tag-container">
          <div class="grant-details-modal__tag" aria-label="Grant opportunity type">
            <i class="fas fa-award" aria-hidden="true"></i> Grant Opportunity
          </div>
        </div>
        
        <!-- Grant title with decorative element -->
        <div class="grant-details-modal__title-container">
          <span class="grant-details-modal__title-decoration" aria-hidden="true"></span>
          <h2 class="grant-details-modal__title" id="modal-title">Grant Title</h2>
        </div>
        
        <!-- Match information with score -->
        <div class="grant-details-modal__match-container">
          <div class="grant-details-modal__match-info">
            <div class="grant-details-modal__match-label">
              <i class="fas fa-check-circle" aria-hidden="true"></i> Compatibility Score
            </div>
            <p class="grant-details-modal__match-description">
              Based on your profile details and grant requirements alignment
            </p>
          </div>
          
          <div class="grant-details-modal__match-circle" id="match-score-display" aria-label="Match score percentage">
            <div class="pulse-ring"></div>
            <span class="grant-details-modal__match-score">95%</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Scrollable Content Area -->
    <div class="grant-details-modal__content">
      <!-- Description Section -->
      <div class="grant-details-modal__description-section">
        <p class="grant-details-modal__description" id="modal-description">
          Grant description goes here...
        </p>
      </div>
      
      <!-- Match Criteria Section -->
      <div class="grant-details-modal__match-section" id="modal-match-criteria">
        <h3 class="grant-details-modal__section-title">
          <i class="fas fa-check-double"></i> Your Profile Match Indicators
        </h3>
        <div class="grant-details-modal__match-grid" id="modal-match-list">
          <!-- Matched criteria will be dynamically added here -->
        </div>
      </div>
      
      <!-- Grant Details Section -->
      <div class="grant-details-modal__details-section">
        <h3 class="grant-details-modal__section-title">
          <i class="fas fa-info-circle"></i> Key Grant Details
        </h3>
        <div class="grant-details-modal__details-grid" id="modal-meta">
          <!-- Meta details will be dynamically added here -->
        </div>
      </div>
      
      <!-- Application Steps Section -->
      <div class="grant-details-modal__steps-section">
        <h3 class="grant-details-modal__section-title">
          <i class="fas fa-list-ol"></i> Application Process
        </h3>
        <ul class="grant-details-modal__steps-list" id="modal-eligibility">
          <li class="grant-details-modal__step-item">
            <div class="grant-details-modal__step-number">1</div>
            <h4 class="grant-details-modal__step-title">Verify Eligibility Requirements</h4>
            <p class="grant-details-modal__step-description">Review all criteria carefully to confirm your qualification for this grant opportunity.</p>
          </li>
          <li class="grant-details-modal__step-item">
            <div class="grant-details-modal__step-number">2</div>
            <h4 class="grant-details-modal__step-title">Gather Required Documentation</h4>
            <p class="grant-details-modal__step-description">Collect all necessary materials, financial statements, and supporting documents for a complete application.</p>
          </li>
          <li class="grant-details-modal__step-item">
            <div class="grant-details-modal__step-number">3</div>
            <h4 class="grant-details-modal__step-title">Submit Your Application</h4>
            <p class="grant-details-modal__step-description">Complete all sections and submit your application before the deadline for consideration.</p>
          </li>
          <li class="grant-details-modal__step-item">
            <div class="grant-details-modal__step-number">4</div>
            <h4 class="grant-details-modal__step-title">Track & Follow Up</h4>
            <p class="grant-details-modal__step-description">Monitor your application status and respond promptly to any requests for additional information.</p>
          </li>
        </ul>
      </div>
    </div>
    
    <!-- Consultation CTA -->
    <div class="grant-details-modal__cta-section">
      <div class="grant-details-modal__cta-text">
        <span class="grant-details-modal__cta-title">Maximize Your Grant Approval Chances</span>
        Get personalized guidance from our expert team with 300+ successful grant projects.
      </div>
      <a href="#" onclick="Calendly.initPopupWidget({url: 'https://calendly.com/grantaura'});return false;" class="grant-details-modal__cta-button">
        <i class="fas fa-calendar-alt"></i> Schedule Free Strategy Call
      </a>
    </div>
    
    <!-- Footer Actions - Extra Compact for Mobile -->
    <div class="grant-details-modal__footer">
      <button class="grant-details-modal__back-button" id="modal-back">
        <i class="fas fa-arrow-left"></i> <span class="grant-details-modal__back-text">Return</span>
      </button>
      <a href="https://grantaura.com/apply/" class="grant-details-modal__apply-button" id="modal-apply">
        <span class="grant-details-modal__apply-text">Apply</span> <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Function to update the match score display with color coding and animation
    function updateMatchScoreDisplay(score) {
      const scoreDisplay = document.querySelector('.grant-details-modal__match-score');
      if (scoreDisplay) {
        // Animate the score changing
        const currentScore = parseInt(scoreDisplay.textContent.replace('%', '')) || 0;
        const targetScore = parseInt(score);
        
        // Use requestAnimationFrame for smooth animation
        function animateScore(timestamp) {
          // Calculate the score for this frame
          const progress = Math.min((timestamp - startTime) / 800, 1);
          const currentValue = Math.floor(currentScore + (targetScore - currentScore) * progress);
          
          // Update the display
          scoreDisplay.textContent = currentValue + '%';
          
          // Continue animation until complete
          if (progress < 1) {
            requestAnimationFrame(animateScore);
          }
        }
        
        const startTime = performance.now();
        requestAnimationFrame(animateScore);
        
        const matchCircle = document.getElementById('match-score-display');
        // Update color based on score with transition
        if (matchCircle) {
          if (score >= 90) {
            matchCircle.style.background = 'var(--grantaura-success)'; // Excellent match
          } else if (score >= 80) {
            matchCircle.style.background = 'var(--grantaura-secondary)'; // High match
          } else if (score >= 70) {
            matchCircle.style.background = 'var(--grantaura-warning)'; // Medium match
          } else {
            matchCircle.style.background = 'var(--grantaura-gray-500)'; // Lower match
          }
        }
      }
    }
    
    // Function to calculate and set dynamic content height based on viewport
    function setDynamicContentHeight() {
      const modal = document.getElementById('match-modal');
      if (!modal || !modal.classList.contains('active')) return;
      
      const modalContent = modal.querySelector('.grant-details-modal__content');
      if (!modalContent) return;
      
      // Get actual heights of elements rather than using CSS variables
      // This ensures we're using actual rendered heights for calculations
      const modalContainer = modal.querySelector('.grant-details-modal__container');
      const headerHeight = modal.querySelector('.grant-details-modal__header').offsetHeight;
      const footerHeight = modal.querySelector('.grant-details-modal__footer').offsetHeight;
      const ctaHeight = modal.querySelector('.grant-details-modal__cta-section').offsetHeight;
      
      // Calculate available space and set max-height
      const containerHeight = modalContainer.offsetHeight;
      const availableHeight = containerHeight - headerHeight - footerHeight - ctaHeight;
      
      // Apply the calculated height with a small buffer for potential borders/margins
      modalContent.style.maxHeight = `${availableHeight - 5}px`;
      
      // Log sizes for debugging (remove in production)
      console.log({
        containerHeight,
        headerHeight,
        footerHeight,
        ctaHeight,
        availableHeight
      });
    }
    
    // Function to trigger entry animations for modal elements
    function triggerEntryAnimations() {
      // Reset animations by removing and re-adding classes
      const elementsWithAnimation = document.querySelectorAll(
        '.grant-details-modal__tag-container, ' +
        '.grant-details-modal__title-container, ' +
        '.grant-details-modal__match-container'
      );
      
      elementsWithAnimation.forEach(element => {
        element.style.animation = 'none';
        element.offsetHeight; // Trigger reflow
        element.style.animation = '';
      });
    }
    
    // Hook into existing event handlers for the modal
    const existingDetailButtons = document.querySelectorAll('.eligibility-checker__match-details');
    existingDetailButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        const grantId = this.getAttribute('data-grant-id');
        const grant = window.EligibilityChecker && window.EligibilityChecker.grants &&
          window.EligibilityChecker.grants.find(g => g.id.toString() === grantId);
        
        if (grant) {
          // Trigger modal animations
          triggerEntryAnimations();
          
          // Open modal
          const modal = document.getElementById('match-modal');
          if (modal) {
            modal.classList.add('active');
          }
          
          // Update match score display
          updateMatchScoreDisplay(grant.match_score);
          
          // Set dynamic height after modal opens
          setTimeout(setDynamicContentHeight, 100);
        }
      });
    });
    
    // Format the meta details in the enhanced card format
    const originalUpdateMetaDetails = window.EligibilityChecker && window.EligibilityChecker.showGrantDetails;
    if (originalUpdateMetaDetails && window.EligibilityChecker) {
      window.EligibilityChecker.showGrantDetails = function(grant) {
        // Call original function to maintain core functionality
        originalUpdateMetaDetails.call(window.EligibilityChecker, grant);
        
        // Update the match score display
        updateMatchScoreDisplay(grant.match_score);
        
        // Set dynamic height after content is updated
        setTimeout(setDynamicContentHeight, 100);
        
        // Additional formatting for the new modal cards
        const modalMeta = document.getElementById('modal-meta');
        if (modalMeta && grant) {
          // Format deadline for display
          let deadlineFormatted = grant.deadline;
          let deadlineClass = '';
          
          if (deadlineFormatted !== 'Ongoing') {
            try {
              const deadlineDate = new Date(grant.deadline);
              const today = new Date();
              const diffTime = deadlineDate - today;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              
              if (diffDays > 30) {
                deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
              } else if (diffDays > 14) {
                deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
                deadlineClass = 'grant-details-modal__deadline--urgent';
              } else if (diffDays > 0) {
                deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
                deadlineClass = 'grant-details-modal__deadline--critical';
              } else if (diffDays === 0) {
                deadlineFormatted = `${grant.deadline} (Today)`;
                deadlineClass = 'grant-details-modal__deadline--critical';
              } else {
                deadlineFormatted = `${grant.deadline} (Expired)`;
                deadlineClass = 'grant-details-modal__deadline--expired';
              }
            } catch (e) {
              console.warn('Could not parse deadline:', e);
            }
          }
          
          // Format locations for display
          const locationsDisplay = Array.isArray(grant.locations) && grant.locations.length > 0 
            ? grant.locations.join(', ') 
            : (grant.location || 'Multiple Locations');
          
          // Enhanced card layout for meta information
          modalMeta.innerHTML = `
            <div class="grant-details-modal__detail-item grant-details-modal__detail-item--amount">
              <div class="grant-details-modal__detail-label">
                <i class="fas fa-dollar-sign"></i> Funding Amount
              </div>
              <div class="grant-details-modal__detail-value">${grant.amount}</div>
            </div>
            
            <div class="grant-details-modal__detail-item grant-details-modal__detail-item--deadline">
              <div class="grant-details-modal__detail-label">
                <i class="fas fa-calendar-alt"></i> Application Deadline
              </div>
              <div class="grant-details-modal__detail-value ${deadlineClass}">${deadlineFormatted}</div>
            </div>
            
            <div class="grant-details-modal__detail-item">
              <div class="grant-details-modal__detail-label">
                <i class="fas fa-tag"></i> Funding Type
              </div>
              <div class="grant-details-modal__detail-value">${grant.funding_type || 'Grant'}</div>
            </div>
            
            <div class="grant-details-modal__detail-item">
              <div class="grant-details-modal__detail-label">
                <i class="fas fa-map-marker-alt"></i> Eligible Location
              </div>
              <div class="grant-details-modal__detail-value">${locationsDisplay}</div>
            </div>
          `;
        }
        
        // Enhanced formatting for match criteria
        const modalMatchList = document.getElementById('modal-match-list');
        if (modalMatchList && grant && grant.match_reasons && grant.match_reasons.length > 0) {
          // Group match reasons by priority
          const highPriorityReasons = [];
          const otherReasons = [];
          
          grant.match_reasons.forEach(reason => {
            // Check if reason contains high priority field terms
            const isHighPriority = this.highPriorityFields && this.highPriorityFields.some(field => {
              const fieldName = this.getFieldDisplayName ? this.getFieldDisplayName(field) : field;
              return reason.includes(fieldName);
            });
            
            if (isHighPriority) {
              highPriorityReasons.push(reason);
            } else {
              otherReasons.push(reason);
            }
          });
          
          // Build enhanced HTML for match criteria
          const highPriorityHTML = highPriorityReasons.map(reason => `
            <div class="grant-details-modal__match-item grant-details-modal__match-item--priority">
              <div class="grant-details-modal__match-icon">
                <i class="fas fa-star"></i>
              </div>
              <div class="grant-details-modal__match-text">${reason}</div>
            </div>
          `).join('');
          
          const otherReasonsHTML = otherReasons.map(reason => `
            <div class="grant-details-modal__match-item">
              <div class="grant-details-modal__match-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="grant-details-modal__match-text">${reason}</div>
            </div>
          `).join('');
          
          modalMatchList.innerHTML = highPriorityHTML + otherReasonsHTML;
        }
      };
    }
    
    // Modal interaction event handlers
    const modal = document.getElementById('match-modal');
    const modalClose = document.getElementById('modal-close');
    const modalBack = document.getElementById('modal-back');
    
    // Function to open modal with animation
    function openModal() {
      if (modal) {
        modal.classList.add('active');
        triggerEntryAnimations();
        // Set dynamic height after modal opens
        setTimeout(setDynamicContentHeight, 100);
        document.body.style.overflow = 'hidden'; // Prevent body scrolling
      }
    }
    
    // Function to close modal with animation
    function closeModal() {
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore body scrolling
      }
    }
    
    // Close button event handler
    if (modalClose) {
      modalClose.addEventListener('click', closeModal);
    }
    
    // Back button event handler
    if (modalBack) {
      modalBack.addEventListener('click', closeModal);
    }
    
    // Close modal when clicking outside of content
    document.addEventListener('click', function(event) {
      if (!modal || !modal.classList.contains('active')) return;
      
      const modalContainer = modal.querySelector('.grant-details-modal__container');
      if (modalContainer && !modalContainer.contains(event.target) && 
          !event.target.closest('.eligibility-checker__match-details')) {
        closeModal();
      }
    });
    
    // Handle resize events to adjust dynamic height
    window.addEventListener('resize', function() {
      if (modal && modal.classList.contains('active')) {
        setDynamicContentHeight();
      }
    });
    
    // Handle orientation change for mobile devices
    window.addEventListener('orientationchange', function() {
      if (modal && modal.classList.contains('active')) {
        setTimeout(setDynamicContentHeight, 200);
      }
    });
    
    // Add swipe down to close functionality for mobile
    let touchStartY = 0;
    let touchEndY = 0;
    
    if (modal) {
      modal.addEventListener('touchstart', function(e) {
        touchStartY = e.changedTouches[0].screenY;
      }, {passive: true});
      
      modal.addEventListener('touchend', function(e) {
        touchEndY = e.changedTouches[0].screenY;
        
        // If swiped down more than 100px from the top of the modal, close it
        if (touchEndY - touchStartY > 100 && touchStartY < 150) {
          closeModal();
        }
      }, {passive: true});
    }
    
    // Add keyboard accessibility - close on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
        closeModal();
      }
    });
    
    // Initialize once everything is loaded
    window.addEventListener('load', function() {
      // If modal is already open, set dynamic height
      if (modal && modal.classList.contains('active')) {
        setDynamicContentHeight();
      }
    });
    
    // Enable debug mode - log available height information when modal toggles
    const debugMode = true;
    if (debugMode) {
      // Monitor DOM changes to detect when modal becomes active
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (modal.classList.contains('active')) {
              console.log('Modal activated - calculating heights');
              setTimeout(setDynamicContentHeight, 100);
            }
          }
        });
      });
      
      if (modal) {
        observer.observe(modal, { attributes: true });
      }
    }
  });
  </script>
</div>


      
      <!-- Premium lead capture popup -->
      <div class="eligibility-checker__premium-popup" id="premium-popup">
        <div class="eligibility-checker__premium-popup-content">
          <div class="eligibility-checker__premium-popup-header">
            <div class="eligibility-checker__premium-popup-header-bg"></div>
            <div class="eligibility-checker__premium-popup-header-pattern"></div>
            <button class="eligibility-checker__premium-popup-close" id="premium-popup-close">&times;</button>
            <div class="eligibility-checker__premium-popup-title-container">
              <h3 class="eligibility-checker__premium-popup-title">Access Premium Grant Matches</h3>
            </div>
          </div>
          
          <div class="eligibility-checker__premium-popup-body">
            <!-- Form state -->
            <div id="premium-popup-form-container">
              <h4 class="eligibility-checker__premium-popup-subtitle">Get expert grant assistance</h4>
              <p class="eligibility-checker__premium-popup-description">
                Complete the form below to receive personalized expert guidance on premium grant opportunities that match your unique eligibility profile.
              </p>
              
              <div class="eligibility-checker__premium-popup-benefits">
                <div class="eligibility-checker__premium-popup-benefit">
                  <div class="eligibility-checker__premium-popup-benefit-icon">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="eligibility-checker__premium-popup-benefit-text">
                    Detailed information about additional matching grants
                  </div>
                </div>
                <div class="eligibility-checker__premium-popup-benefit">
                  <div class="eligibility-checker__premium-popup-benefit-icon">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="eligibility-checker__premium-popup-benefit-text">
                    Expert eligibility assessment to confirm your qualification
                  </div>
                </div>
                <div class="eligibility-checker__premium-popup-benefit">
                  <div class="eligibility-checker__premium-popup-benefit-icon">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="eligibility-checker__premium-popup-benefit-text">
                    Personalized guidance on application strategy
                  </div>
                </div>
                <div class="eligibility-checker__premium-popup-benefit">
                  <div class="eligibility-checker__premium-popup-benefit-icon">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="eligibility-checker__premium-popup-benefit-text">
                    Priority support from our grant experts
                  </div>
                </div>
              </div>
              
              <form class="eligibility-checker__premium-popup-form" id="premium-popup-form">
                <div class="eligibility-checker__premium-popup-form-group">
                  <label class="eligibility-checker__premium-popup-label" for="premium-name">Full Name</label>
                  <input type="text" id="premium-name" name="premium-name" class="eligibility-checker__premium-popup-input" placeholder="Your name" required>
                  <div class="eligibility-checker__premium-popup-error">Please enter your name</div>
                </div>
                
                <div class="eligibility-checker__premium-popup-form-group">
                  <label class="eligibility-checker__premium-popup-label" for="premium-email">Email Address</label>
                  <input type="email" id="premium-email" name="premium-email" class="eligibility-checker__premium-popup-input" placeholder="your.email@example.com" required>
                  <div class="eligibility-checker__premium-popup-error">Please enter a valid email address</div>
                </div>
                
                <div class="eligibility-checker__premium-popup-form-group">
                  <label class="eligibility-checker__premium-popup-label" for="premium-phone">Phone Number (Optional)</label>
                  <input type="tel" id="premium-phone" name="premium-phone" class="eligibility-checker__premium-popup-input" placeholder="Your phone number">
                </div>
                
                <div class="eligibility-checker__premium-popup-form-group">
                  <label class="eligibility-checker__premium-popup-label" for="premium-interest">Primary Interest</label>
                  <select id="premium-interest" name="premium-interest" class="eligibility-checker__premium-popup-select" required>
                    <option value="" disabled selected>Select your primary interest</option>
                    <option value="grant_research">Grant research and identification</option>
                    <option value="grant_writing">Grant writing assistance</option>
                    <option value="application_support">Application support and review</option>
                    <option value="full_service">Full-service grant acquisition</option>
                    <option value="just_exploring">Just exploring options for now</option>
                  </select>
                  <div class="eligibility-checker__premium-popup-error">Please select your primary interest</div>
                </div>
                
                <button type="submit" class="eligibility-checker__premium-popup-submit">
                  <i class="fas fa-unlock"></i> Unlock Premium Grants
                </button>
              </form>
              
              <p class="eligibility-checker__premium-popup-privacy">
                By submitting this form, you agree to our <a href="https://grantaura.com/privacy-policy/" target="_blank">Privacy Policy</a>. We'll never share your information without permission.
              </p>
            </div>
            
            <!-- Success state -->
            <div class="eligibility-checker__premium-popup-success" id="premium-popup-success">
              <div class="eligibility-checker__premium-popup-success-icon">
                <i class="fas fa-check"></i>
              </div>
              <h4 class="eligibility-checker__premium-popup-success-title">Request Received!</h4>
              <p class="eligibility-checker__premium-popup-success-message">
                Thank you for your interest in our premium grant matches. Our grant experts will review your profile and contact you shortly with personalized recommendations.
              </p>
              <button class="eligibility-checker__premium-popup-success-button" id="premium-popup-success-close">
                <i class="fas fa-check"></i> Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  [php]
/**
 * Enhanced Grant Eligibility Checker - PHP Backend
 * 
 * This implementation provides advanced grant fetching with multiple fallbacks
 * for reliable deadline detection and precise matching algorithm
 */

/**
 * Function to fetch grant listings from the Directorist plugin.
 * Retrieves grants and applies strict matching criteria with enhanced deadline detection.
 */
if ( ! function_exists( 'get_eligibility_checker_grants' ) ) {
    function get_eligibility_checker_grants() {
        $grants = [];

        // Method 1: Use get_posts with WP Query
        $args = [
            'post_type'      => 'at_biz_dir',
            'post_status'    => 'publish',
            'posts_per_page' => -1,
            'orderby'        => 'date',
            'order'          => 'DESC',
        ];
        $query_results = get_posts( $args );

        if ( ! empty( $query_results ) ) {
            foreach ( $query_results as $post ) {
                setup_postdata( $post );
                $post_id     = $post->ID;
                $title       = get_the_title( $post_id );
                
                // Use tagline field for the description if available
                $tagline     = get_post_meta( $post_id, '_tagline', true );
                $description = ! empty( $tagline )
                    ? $tagline
                    : ( ! empty( $post->post_excerpt )
                        ? $post->post_excerpt
                        : wp_trim_words( $post->post_content, 30 )
                    );
                
                $permalink   = get_permalink( $post_id );

                // Updated Deadline Detection - use the enhanced function
                $deadline = get_grant_deadline($post_id);
                
                // Check if deadline is expired - skip if it is
                if ($deadline === 'Expired') {
                    continue;  // Skip expired grants
                }
                
                // Get amount from price field if available
                $amount = get_post_meta( $post_id, '_price', true );
                if (empty($amount)) {
                    $amount = get_post_meta( $post_id, '_amount', true ) ?: 'Varies';
                }
                
                // Other Custom fields with defaults
                $eligibility         = get_post_meta( $post_id, '_eligibility', true )         ?: '';
                $funding_type        = get_post_meta( $post_id, '_funding_type', true )        ?: 'Grant';
                $application_process = get_post_meta( $post_id, '_application_process', true ) ?: '';
                $industry_focus      = get_post_meta( $post_id, '_industry_focus', true )      ?: '';
                $minimum_years       = get_post_meta( $post_id, '_minimum_years', true )       ?: '';
                $demographic_focus   = get_post_meta( $post_id, '_demographic_focus', true )   ?: '';
                
                // Get all meta fields to allow for custom meta field search
                $all_meta = get_post_meta( $post_id );
                $meta_combined = '';
                if (is_array($all_meta)) {
                    foreach ($all_meta as $meta_key => $meta_value) {
                        if (is_array($meta_value) && isset($meta_value[0])) {
                            $meta_combined .= ' ' . $meta_value[0];
                        }
                    }
                }

                // Categories
                $categories = [];
                $terms = get_the_terms( $post_id, 'at_biz_dir-category' );
                if ( $terms && ! is_wp_error( $terms ) ) {
                    foreach ( $terms as $term ) {
                        $categories[] = html_entity_decode($term->name);
                    }
                }

                // Get all locations instead of just the first one
                $locations = [];
                $loc_terms = get_the_terms( $post_id, 'at_biz_dir-location' );
                if ( $loc_terms && ! is_wp_error( $loc_terms ) ) {
                    foreach ( $loc_terms as $term ) {
                        $locations[] = html_entity_decode($term->name);
                    }
                }
                
                // Use the first location as the primary location for matching
                $location = !empty($locations) ? $locations[0] : '';

                $grants[] = [
                    'id'                  => $post_id,
                    'title'               => html_entity_decode($title),
                    'description'         => html_entity_decode($description),
                    'permalink'           => $permalink,
                    'amount'              => $amount,
                    'deadline'            => $deadline,
                    'funding_type'        => $funding_type,
                    'eligibility'         => html_entity_decode($eligibility),
                    'application_process' => $application_process,
                    'industry_focus'      => $industry_focus,
                    'minimum_years'       => $minimum_years,
                    'demographic_focus'   => $demographic_focus,
                    'categories'          => $categories,
                    'location'            => $location,
                    'locations'           => $locations, // All locations, not just the first one
                    'meta_combined'       => $meta_combined,
                    'content'             => $post->post_content,
                    'match_score'         => 0,
                    'match_reasons'       => [],
                    'priority_match'      => false
                ];
            }
            wp_reset_postdata();
        }

        // Method 2: Direct DB query fallback if the first method returns no results
        if ( empty( $grants ) ) {
            global $wpdb;
            $posts_table    = $wpdb->prefix . 'posts';
            $postmeta_table = $wpdb->prefix . 'postmeta';

            $sql = "
                SELECT p.ID, p.post_title, p.post_excerpt, p.post_content, p.post_date_gmt
                FROM {$posts_table} p
                WHERE p.post_type = %s
                  AND p.post_status = %s
                ORDER BY p.post_date DESC
            ";
            $results = $wpdb->get_results(
                $wpdb->prepare( $sql, 'at_biz_dir', 'publish' )
            );

            if ( $results ) {
                foreach ( $results as $row ) {
                    $post_id     = $row->ID;
                    $title       = $row->post_title;
                    
                    // Use tagline field for the description if available
                    $tagline     = get_post_meta( $post_id, '_tagline', true );
                    $description = ! empty( $tagline )
                        ? $tagline
                        : ( ! empty( $row->post_excerpt )
                            ? $row->post_excerpt
                            : wp_trim_words( $row->post_content, 30 )
                        );
                    
                    $permalink   = get_permalink( $post_id );

                    // Updated Deadline Detection - use the new function
                    $deadline = get_grant_deadline($post_id);
                    
                    // Skip expired grants
                    if ($deadline === 'Expired') {
                        continue;
                    }
                    
                    // Get amount from price field if available
                    $amount = get_post_meta( $post_id, '_price', true );
                    if (empty($amount)) {
                        $amount = get_post_meta( $post_id, '_amount', true ) ?: 'Varies';
                    }
                    
                    // Meta defaults
                    $meta_vals = [
                        'eligibility'       => '',
                        'funding_type'      => 'Grant',
                        'application_process'=> '',
                        'industry_focus'    => '',
                        'minimum_years'     => '',
                        'demographic_focus' => '',
                    ];
                    
                    $keys = array_map( function( $k ) { return '_' . $k; }, array_keys( $meta_vals ) );
                    $placeholders = implode( ',', array_fill( 0, count( $keys ), '%s' ) );
                    $meta_sql = "
                        SELECT meta_key, meta_value
                        FROM {$postmeta_table}
                        WHERE post_id = %d
                          AND meta_key IN ({$placeholders})
                    ";
                    $prepare_args = array_merge( [ $post_id ], $keys );
                    $meta_rows = $wpdb->get_results(
                        call_user_func_array( [ $wpdb, 'prepare' ], array_merge( [ $meta_sql ], $prepare_args ) ),
                        ARRAY_A
                    );
                    
                    if ( $meta_rows ) {
                        foreach ( $meta_rows as $m ) {
                            $k = ltrim( $m['meta_key'], '_' );
                            if ( isset( $meta_vals[ $k ] ) ) {
                                $meta_vals[ $k ] = html_entity_decode($m['meta_value']);
                            }
                        }
                    }
                    
                    // Get all meta for combined search
                    $all_meta_sql = "
                        SELECT meta_value
                        FROM {$postmeta_table}
                        WHERE post_id = %d
                    ";
                    $all_meta_rows = $wpdb->get_results(
                        $wpdb->prepare($all_meta_sql, $post_id),
                        ARRAY_A
                    );
                    $meta_combined = '';
                    if ($all_meta_rows) {
                        foreach ($all_meta_rows as $m) {
                            $meta_combined .= ' ' . $m['meta_value'];
                        }
                    }

                    // Categories
                    $categories = [];
                    $term_sql = "
                        SELECT t.name
                        FROM {$wpdb->term_relationships} tr
                        JOIN {$wpdb->term_taxonomy} tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
                        JOIN {$wpdb->terms} t ON tt.term_id = t.term_id
                        WHERE tr.object_id = %d
                          AND tt.taxonomy = %s
                    ";
                    $term_rows = $wpdb->get_results( $wpdb->prepare( $term_sql, $post_id, 'at_biz_dir-category' ), ARRAY_A );
                    if ( $term_rows ) {
                        foreach ( $term_rows as $t ) {
                            $categories[] = html_entity_decode($t['name']);
                        }
                    }

                    // Get all locations
                    $locations = [];
                    $loc_sql = "
                        SELECT t.name
                        FROM {$wpdb->term_relationships} tr
                        JOIN {$wpdb->term_taxonomy} tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
                        JOIN {$wpdb->terms} t ON tt.term_id = t.term_id
                        WHERE tr.object_id = %d
                          AND tt.taxonomy = %s
                    ";
                    $loc_rows = $wpdb->get_results( $wpdb->prepare( $loc_sql, $post_id, 'at_biz_dir-location' ), ARRAY_A );
                    if ( $loc_rows ) {
                        foreach ( $loc_rows as $l ) {
                            $locations[] = html_entity_decode($l['name']);
                        }
                    }
                    
                    // Use the first location as the primary location for matching
                    $location = !empty($locations) ? $locations[0] : '';

                    $grants[] = array_merge( [
                        'id'          => $post_id,
                        'title'       => html_entity_decode($title),
                        'description' => html_entity_decode($description),
                        'permalink'   => $permalink,
                        'categories'  => $categories,
                        'location'    => $location,
                        'locations'   => $locations,
                        'meta_combined' => $meta_combined,
                        'content'     => $row->post_content,
                        'match_score' => 0,
                        'match_reasons' => [],
                        'priority_match' => false
                    ], $meta_vals, ['amount' => $amount, 'deadline' => $deadline] );
                }
            }
        }

        return $grants;
    }
}

/**
 * Enhanced grant deadline detection with multiple fallbacks
 * 
 * @param int $post_id The post ID to get deadline for
 * @return string The deadline date or status message
 */
if (!function_exists('get_grant_deadline')) {
    function get_grant_deadline($post_id) {
        // Create debug array to log all checks (for admin only)
        $debug = [];
        $debug[] = "Checking deadline for post ID: $post_id";
        
        // Check all possible variations of the "Never Expires" field
        $never_expires_variations = [
            'never_expire', '_never_expires', 'never_expires', '_never_expire',
            'atbdp_never_expire', '_atbdp_never_expires'
        ];
        
        // First check if any "Never Expires" variations are checked
        foreach ($never_expires_variations as $field) {
            $value = get_post_meta($post_id, $field, true);
            $debug[] = "Field '$field' = '$value'";
            
            if ($value == '1' || $value === true || $value === 'true' || $value === 'yes') {
                $debug[] = "Grant marked as never expires via $field";
                
                // Only show debug info to admins if needed
                if (current_user_can('manage_options') && isset($_GET['debug_deadline'])) {
                    echo '<pre>' . implode("\n", $debug) . '</pre>';
                }
                
                return 'Ongoing';
            }
        }
        
        // Check all possible variations of the expiration date field
        $expiry_variations = [
            '_expiry_date', 'expiry_date', 'exp_date', '_exp_date',
            'atbdp_expiry_date', '_atbdp_expiry_date'
        ];
        
        // Get expiration date from possible fields
        $expiry_date = null;
        $expiry_field_used = '';
        
        foreach ($expiry_variations as $field) {
            $value = get_post_meta($post_id, $field, true);
            $debug[] = "Field '$field' = '$value'";
            
            if (!empty($value)) {
                $expiry_date = $value;
                $expiry_field_used = $field;
                $debug[] = "Found expiry date in $field: $value";
                break;
            }
        }
        
        // If we have an expiration date, process it
        if (!empty($expiry_date)) {
            try {
                // Try to parse the date, handling both timestamp and formatted date
                if (is_numeric($expiry_date)) {
                    $expiryDate = new DateTime();
                    $expiryDate->setTimestamp($expiry_date);
                } else {
                    $expiryDate = new DateTime($expiry_date);
                }
                
                $debug[] = "Parsed expiry date: " . $expiryDate->format('Y-m-d H:i:s');
                
                // Set deadline 2 days before expiry
                $deadlineDate = clone $expiryDate;
                $deadlineDate->modify('-2 days');
                $debug[] = "Calculated deadline date: " . $deadlineDate->format('Y-m-d');
                
                // Check if deadline has already passed
                $today = new DateTime();
                $today->setTime(0, 0, 0); // Reset time part
                $debug[] = "Today's date for comparison: " . $today->format('Y-m-d');
                
                if ($deadlineDate < $today) {
                    $debug[] = "Deadline has passed: EXPIRED";
                    
                    // Only show debug info to admins if needed
                    if (current_user_can('manage_options') && isset($_GET['debug_deadline'])) {
                        echo '<pre>' . implode("\n", $debug) . '</pre>';
                    }
                    
                    return 'Expired';
                }
                
                // Only show debug info to admins if needed
                if (current_user_can('manage_options') && isset($_GET['debug_deadline'])) {
                    echo '<pre>' . implode("\n", $debug) . '</pre>';
                }
                
                // Return the calculated deadline date
                return $deadlineDate->format('F j, Y');
                
            } catch (Exception $e) {
                $debug[] = "ERROR parsing date: " . $e->getMessage();
                error_log('Grantaura - Error calculating deadline from date: ' . $e->getMessage());
            }
        }
        
        // Check for custom deadline field
        $deadline_field = get_post_meta($post_id, '_deadline', true);
        $debug[] = "Deadline field: '$deadline_field'";
        
        if (!empty($deadline_field) && $deadline_field !== 'Ongoing') {
            $debug[] = "Found value in deadline field";
            
            // Try to parse and format the date
            try {
                $date = new DateTime($deadline_field);
                $formatted_date = $date->format('F j, Y');
                
                // Check if date has passed
                $today = new DateTime();
                $today->setTime(0, 0, 0);
                
                if ($date < $today) {
                    return 'Expired';
                }
                
                // Only show debug info to admins if needed
                if (current_user_can('manage_options') && isset($_GET['debug_deadline'])) {
                    echo '<pre>' . implode("\n", $debug) . '</pre>';
                }
                
                return $formatted_date;
            } catch (Exception $e) {
                $debug[] = "ERROR parsing deadline field: " . $e->getMessage();
                // If parsing fails, just return the original string
                return $deadline_field;
            }
        }
        
        // Check for custom date field
        $custom_date = get_post_meta($post_id, '_custom-date', true);
        $debug[] = "Custom date field: '$custom_date'";
        
        if (!empty($custom_date) && $custom_date !== 'Ongoing') {
            $debug[] = "Found deadline in custom date field";
            
            // Try to parse and format the date
            try {
                $date = new DateTime($custom_date);
                $formatted_date = $date->format('F j, Y');
                
                // Check if date has passed
                $today = new DateTime();
                $today->setTime(0, 0, 0);
                
                if ($date < $today) {
                    return 'Expired';
                }
                
                // Only show debug info to admins if needed
                if (current_user_can('manage_options') && isset($_GET['debug_deadline'])) {
                    echo '<pre>' . implode("\n", $debug) . '</pre>';
                }
                
                return $formatted_date;
            } catch (Exception $e) {
                $debug[] = "ERROR parsing custom date: " . $e->getMessage();
                // If parsing fails, just return the original string
                return $custom_date;
            }
        }
        
        // Only show debug info to admins if needed
        if (current_user_can('manage_options') && isset($_GET['debug_deadline'])) {
            echo '<pre>' . implode("\n", $debug) . '</pre>';
        }
        
        // Default fallback
        return 'Ongoing';
    }
}

/**
 * Format deadline date to consistent format
 */
if ( ! function_exists( 'format_deadline_date' ) ) {
    function format_deadline_date($date_string) {
        if (empty($date_string)) {
            return 'Ongoing';
        }
        
        // Try multiple date formats
        $timestamp = false;
        
        // Format: YYYY-MM-DD or MM/DD/YYYY
        if (preg_match('/^\d{4}-\d{1,2}-\d{1,2}$/', $date_string) || preg_match('/^\d{1,2}\/\d{1,2}\/\d{4}$/', $date_string)) {
            $timestamp = strtotime($date_string);
        }
        // Format: Month Day, Year (e.g., January 15, 2025)
        elseif (preg_match('/^([a-zA-Z]+)\s+(\d{1,2}),?\s+(\d{4})$/', $date_string, $matches)) {
            $timestamp = strtotime("{$matches[1]} {$matches[2]}, {$matches[3]}");
        }
        
        if ($timestamp !== false) {
            return date('F j, Y', $timestamp);
        }
        
        // If parsing fails, return the original string
        return $date_string;
    }
}

/**
 * Handle premium leads submission and email notifications
 */
if ( ! function_exists( 'handle_premium_lead_submission' ) ) {
    function handle_premium_lead_submission() {
        // Verify nonce for security
        check_ajax_referer('premium_lead_nonce', 'nonce');
        
        // Get form data
        $name = isset($_POST['name']) ? sanitize_text_field(wp_unslash($_POST['name'])) : '';
        $email = isset($_POST['email']) ? sanitize_email(wp_unslash($_POST['email'])) : '';
        $phone = isset($_POST['phone']) ? sanitize_text_field(wp_unslash($_POST['phone'])) : '';
        $interest = isset($_POST['interest']) ? sanitize_text_field(wp_unslash($_POST['interest'])) : '';
        
        // Get matching criteria
        $entity_type = isset($_POST['entity_type']) ? sanitize_text_field(wp_unslash($_POST['entity_type'])) : '';
        $entity_details = isset($_POST['entity_details']) ? wp_unslash($_POST['entity_details']) : '';
        
        // Basic validation
        if (empty($name) || empty($email) || empty($interest)) {
            wp_send_json_error([
                'message' => 'Please fill in all required fields.'
            ]);
            return;
        }
        
        // Format interest type for readability
        $interest_types = [
            'grant_research' => 'Grant Research and Identification',
            'grant_writing' => 'Grant Writing Assistance',
            'application_support' => 'Application Support and Review',
            'full_service' => 'Full-Service Grant Acquisition',
            'just_exploring' => 'Just Exploring Options'
        ];
        
        $interest_formatted = isset($interest_types[$interest]) ? $interest_types[$interest] : $interest;
        
        // Format entity type for readability
        $entity_types = [
            'for_profit_business' => 'For-Profit Business',
            'nonprofit' => 'Nonprofit Organization',
            'individual' => 'Individual',
            'institution' => 'Institution/Organization'
        ];
        
        $entity_type_formatted = isset($entity_types[$entity_type]) ? $entity_types[$entity_type] : $entity_type;
        
        // Parse entity details if it's a JSON string
        $entity_details_formatted = '';
        if (!empty($entity_details)) {
            if (is_string($entity_details)) {
                $entity_details = json_decode($entity_details, true);
            }
            
            if (is_array($entity_details)) {
                foreach ($entity_details as $key => $value) {
                    if ($key === 'entity_type') continue; // Already included above
                    
                    // Format key for readability
                    $formatted_key = str_replace('_', ' ', $key);
                    $formatted_key = ucwords($formatted_key);
                    
                    // Format value
                    if (is_array($value)) {
                        $value = implode(', ', $value);
                    }
                    
                    $entity_details_formatted .= "{$formatted_key}: {$value}\n";
                }
            }
        }
        
        // Prepare emails
        $admin_email = 'contact@grantaura.com';
        $subject_admin = 'New Premium Grant Lead - ' . $name;
        $subject_user = 'Your Grantaura Premium Grant Request';
        
        // Admin email content
        $message_admin = "New premium grant lead submission:\n\n";
        $message_admin .= "Name: {$name}\n";
        $message_admin .= "Email: {$email}\n";
        $message_admin .= "Phone: {$phone}\n";
        $message_admin .= "Interest: {$interest_formatted}\n\n";
        $message_admin .= "Entity Type: {$entity_type_formatted}\n";
        $message_admin .= "Entity Details:\n{$entity_details_formatted}\n\n";
        $message_admin .= "Submitted on: " . current_time('F j, Y \a\t g:i a') . "\n";
        
        // User email content
        $message_user = "Dear {$name},\n\n";
        $message_user .= "Thank you for your interest in Grantaura's premium grant matching service. We've received your request and will be reviewing the additional grant opportunities that match your specific eligibility criteria.\n\n";
        $message_user .= "One of our grant experts will contact you shortly with personalized recommendations and guidance tailored to your needs.\n\n";
        $message_user .= "Your request details:\n";
        $message_user .= "Primary Interest: {$interest_formatted}\n";
        $message_user .= "Entity Type: {$entity_type_formatted}\n\n";
        $message_user .= "If you have any questions in the meantime, please feel free to contact us at contact@grantaura.com.\n\n";
        $message_user .= "Warm regards,\n\n";
        $message_user .= "Imran Ahmad\n";
        $message_user .= "Founder, Grantaura\n";
        $message_user .= "https://grantaura.com";
        
        // Headers
        $headers = 'From: Grantaura <contact@grantaura.com>' . "\r\n";
        
        // Send emails
        $admin_mail_sent = wp_mail($admin_email, $subject_admin, $message_admin, $headers);
        $user_mail_sent = wp_mail($email, $subject_user, $message_user, $headers);
        
        // Response
        if ($admin_mail_sent && $user_mail_sent) {
            wp_send_json_success([
                'message' => 'Thank you! Your request has been received. We will contact you shortly with your premium grant matches.'
            ]);
        } else {
            // Log the error but still return success to the user
            error_log('Grantaura - Error sending premium lead emails for: ' . $email);
            
            wp_send_json_success([
                'message' => 'Thank you! Your request has been received. We will contact you shortly with your premium grant matches.'
            ]);
        }
    }
}
add_action('wp_ajax_premium_lead_submission', 'handle_premium_lead_submission');
add_action('wp_ajax_nopriv_premium_lead_submission', 'handle_premium_lead_submission');

// Output grants to JS
add_action('wp_footer', function() {
    $grants = get_eligibility_checker_grants();
    if ($grants) {
        echo '<script>window.grantAuraGrants = ' . wp_json_encode($grants) . ';</script>';
    }
}, 999);

// AJAX for enhanced grant fetching
add_action('wp_ajax_get_grants', 'eligibility_checker_get_grants_ajax');
add_action('wp_ajax_nopriv_get_grants', 'eligibility_checker_get_grants_ajax');
if (!function_exists('eligibility_checker_get_grants_ajax')) {
    function eligibility_checker_get_grants_ajax() {
        check_ajax_referer('grant_checker_nonce', 'nonce');
        $grants = get_eligibility_checker_grants();
        $entity_type = isset($_POST['entity_type']) ? sanitize_text_field(wp_unslash($_POST['entity_type'])) : '';
        $entity_details = isset($_POST['entity_details']) ? json_decode(wp_unslash($_POST['entity_details']), true) : [];

        // Get keywords for text matching
        $keywords = isset($entity_details['keywords']) ? $entity_details['keywords'] : [];
        $description = isset($entity_details['funding_description']) ? $entity_details['funding_description'] : '';
        
        $search_terms = [];
        if (!empty($keywords)) {
            $search_terms = array_merge($search_terms, $keywords);
        }
        
        if (!empty($description)) {
            // Extract meaningful words from description (remove common words)
            $desc_words = preg_split('/\s+/', strtolower($description), -1, PREG_SPLIT_NO_EMPTY);
            $stop_words = array('a', 'an', 'the', 'and', 'or', 'but', 'if', 'then', 'else', 'when', 'at', 'from', 'by', 'for', 'with', 'about', 'to', 'in', 'on', 'that', 'this', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'can', 'may', 'might');
            $desc_words = array_filter($desc_words, function($word) use ($stop_words) {
                return !in_array($word, $stop_words) && strlen($word) > 3;
            });
            $search_terms = array_merge($search_terms, $desc_words);
        }
        
        // Gather entity specific terms
        if ($entity_type) {
            $search_terms[] = $entity_type;
        }
        
        if (is_array($entity_details)) {
            foreach ($entity_details as $key => $val) {
                if ($key !== 'keywords' && $key !== 'funding_description') {
                    if (is_array($val)) {
                        foreach ($val as $item) {
                            if (!empty($item) && $item !== 'none') {
                                $search_terms[] = $item;
                            }
                        }
                    } elseif (!empty($val) && $val !== 'none') {
                        $search_terms[] = $val;
                    }
                }
            }
        }

        // Enhanced WP search query with relevance scoring
        if ($search_terms) {
            $search_args = [
                'post_type'      => 'at_biz_dir',
                'post_status'    => 'publish',
                'posts_per_page' => -1,
                's'              => implode(' ', $search_terms),
            ];
            
            // Add custom meta fields to search
            $search_args['meta_query'] = [
                'relation' => 'OR',
            ];
            
            // Add high priority fields for search
            $high_priority_fields = get_high_priority_fields($entity_type);
            foreach ($high_priority_fields as $field) {
                if (isset($entity_details[$field]) && !empty($entity_details[$field])) {
                    $value = $entity_details[$field];
                    if (is_array($value)) {
                        foreach ($value as $val) {
                            if (!empty($val) && $val !== 'none') {
                                $search_args['meta_query'][] = [
                                    'key'     => '_' . $field,
                                    'value'   => $val,
                                    'compare' => 'LIKE',
                                ];
                            }
                        }
                    } else {
                        $search_args['meta_query'][] = [
                            'key'     => '_' . $field,
                            'value'   => $value,
                            'compare' => 'LIKE',
                        ];
                    }
                }
            }
            
            $search_results = get_posts($search_args);
            if ($search_results) {
                foreach ($search_results as $post) {
                    $id = $post->ID;
                    $found = false;
                    foreach ($grants as $idx => $g) {
                        if ($g['id'] === $id) {
                            $grants[$idx]['search_relevance'] = true;
                            $found = true;
                            break;
                        }
                    }
                    if (!$found) {
                        // Get enhanced deadline
                        $deadline = get_grant_deadline($id);
                        
                        // Skip expired grants
                        if ($deadline === 'Expired') {
                            continue;
                        }
                        
                        // Use tagline field for the description if available
                        $tagline = get_post_meta($id, '_tagline', true);
                        $description = !empty($tagline)
                            ? $tagline
                            : (!empty($post->post_excerpt)
                                ? $post->post_excerpt
                                : wp_trim_words($post->post_content, 30)
                            );
                        
                        // Get amount from price field if available
                        $amount = get_post_meta($id, '_price', true);
                        if (empty($amount)) {
                            $amount = get_post_meta($id, '_amount', true) ?: 'Varies';
                        }
                        
                        // Get all locations
                        $locations = [];
                        $loc_terms = get_the_terms($id, 'at_biz_dir-location');
                        if ($loc_terms && !is_wp_error($loc_terms)) {
                            foreach ($loc_terms as $term) {
                                $locations[] = html_entity_decode($term->name);
                            }
                        }
                        
                        // Use the first location as the primary location for matching
                        $location = !empty($locations) ? $locations[0] : '';
                        
                        // Get post meta for extended search
                        $all_meta = get_post_meta($id);
                        $meta_combined = '';
                        if (is_array($all_meta)) {
                            foreach ($all_meta as $meta_key => $meta_value) {
                                if (is_array($meta_value) && isset($meta_value[0])) {
                                    $meta_combined .= ' ' . $meta_value[0];
                                }
                            }
                        }
                    
                        $grants[] = [
                            'id'               => $id,
                            'title'            => html_entity_decode(get_the_title($id)),
                            'description'      => html_entity_decode($description),
                            'permalink'        => get_permalink($id),
                            'amount'           => $amount,
                            'deadline'         => $deadline,
                            'eligibility'      => html_entity_decode(get_post_meta($id, '_eligibility', true) ?: ''),
                            'funding_type'     => get_post_meta($id, '_funding_type', true) ?: 'Grant',
                            'application_process' => get_post_meta($id, '_application_process', true) ?: '',
                            'industry_focus'   => get_post_meta($id, '_industry_focus', true) ?: '',
                            'minimum_years'    => get_post_meta($id, '_minimum_years', true) ?: '',
                            'demographic_focus'=> get_post_meta($id, '_demographic_focus', true) ?: '',
                            'categories'       => wp_list_pluck(get_the_terms($id, 'at_biz_dir-category') ?: [], 'name'),
                            'location'         => $location,
                            'locations'        => $locations,
                            'meta_combined'    => $meta_combined,
                            'content'          => $post->post_content,
                            'match_score'      => 0,
                            'match_reasons'    => [],
                            'search_relevance' => true,
                            'priority_match'   => false
                        ];
                    }
                }
            }
        }

        wp_send_json_success([
            'grants'         => $grants,
            'entity_type'    => $entity_type,
            'entity_details' => $entity_details,
            'search_terms'   => $search_terms,
            'high_priority_fields' => get_high_priority_fields($entity_type)
        ]);
    }
}

/**
 * Get high priority fields based on entity type
 */
if (!function_exists('get_high_priority_fields')) {
    function get_high_priority_fields($entity_type) {
        switch ($entity_type) {
            case 'for_profit_business':
                return ['entity_type', 'business_type', 'owner_demographics', 'industry', 'location'];
            case 'nonprofit':
                return ['entity_type', 'nonprofit_type', 'focus_area', 'org_demographics', 'location'];
            case 'individual':
                return ['entity_type', 'individual_type', 'individual_demographics', 'location', 'funding_need'];
            case 'institution':
                return ['entity_type', 'institution_type', 'tax_status', 'location', 'funding_purpose'];
            default:
                return ['entity_type', 'location'];
        }
    }
}

// Register shortcode
add_shortcode('eligibility_checker', function($atts) {
    ob_start();
    ?>
    <div class="eligibility-checker-container">
        <!-- Nonce for security -->
        <div id="grant-checker-nonce" data-nonce="<?php echo wp_create_nonce('grant_checker_nonce'); ?>"></div>
        <div id="premium-lead-nonce" data-nonce="<?php echo wp_create_nonce('premium_lead_nonce'); ?>"></div>
        
        <!-- Enhanced Eligibility Checker will be rendered here -->
        <div class="eligibility-checker" data-section-id="eligibility-checker">
            <!-- Content will be dynamically generated by JS -->
        </div>
    </div>
    <?php
    return ob_get_clean();
});
[/php]
  

  

<script>
(function() {
  'use strict';

  /**
   * Enhanced Grant Eligibility Checker
   * 
   * Improved matching algorithm that strictly prioritizes:
   * - Entity type/individual category
   * - Demographics/focus areas
   * - Location
   * - Keywords
   */
  const EligibilityChecker = {
    currentStep: 1,
    maxStep: 3,
    entityType: '',
    entityDetails: {},
    grants: [],
    formSubmitted: false,
    keywordsList: [],
    highPriorityFields: [], // Store high priority fields for matching
    premiumGrantCount: 0, // Count of premium grants to show
    isAdminMode: false, // Flag for admin mode
    
    /**
     * Initialize the eligibility checker
     */
    init() {
      this.setupEventListeners();
      this.updateProgressBar();
      this.setupCardSelection();
      this.checkAdminMode();
      
      // Get nonce for AJAX security
      this.nonce = document.getElementById('grant-checker-nonce')?.dataset.nonce || '';
      this.premiumLeadNonce = document.getElementById('premium-lead-nonce')?.dataset.nonce || '';
    },
    
    /**
     * Check if admin mode is active via URL parameter
     */
    checkAdminMode() {
      const urlParams = new URLSearchParams(window.location.search);
      const adminKey = urlParams.get('admin_key');
      
      // Use a simple key for admin access - in a production environment, this should be more secure
      if (adminKey === 'grantaura_admin_2025') {
        this.isAdminMode = true;
        
        // Show admin notice if on results step
        if (this.currentStep === 3) {
          const adminNotice = document.getElementById('admin-notice');
          if (adminNotice) {
            adminNotice.style.display = 'flex';
          }
        }
      }
    },

    /**
     * Set up event listeners for all components
     */
    setupEventListeners() {
      // Step 1 navigation
      const step1Next = document.getElementById('step1-next');
      if (step1Next) {
        step1Next.addEventListener('click', () => {
          if (this.validateStep1()) {
            this.saveEntityType();
            this.loadEntityTypeForm();
            this.goToStep(2);
          }
        });
      }

      // Step 2 navigation
      const step2Prev = document.getElementById('step2-prev');
      const step2Next = document.getElementById('step2-next');
      if (step2Prev) step2Prev.addEventListener('click', () => this.goToStep(1));
      if (step2Next) step2Next.addEventListener('click', () => {
        if (this.validateStep2()) {
          this.saveEntityDetails();
          this.goToStep(3);
          this.fetchGrants();
        }
      });

      // Filter buttons
      document.querySelectorAll('.eligibility-checker__filter-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.eligibility-checker__filter-button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          this.filterGrants(btn.dataset.filter);
        });
      });

      // Try different criteria button
      const tryDiffBtn = document.getElementById('try-different-criteria');
      if (tryDiffBtn) tryDiffBtn.addEventListener('click', () => this.goToStep(1));

      // Modal close/back buttons
      ['modal-close', 'modal-back'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', () => {
          document.getElementById('match-modal').classList.remove('active');
        });
      });
      
      // Premium grants buttons
      const unlockPremiumBtn = document.getElementById('unlock-premium-button');
      if (unlockPremiumBtn) {
        unlockPremiumBtn.addEventListener('click', () => {
          this.openPremiumPopup();
        });
      }
      
      const scheduleConsultationBtn = document.getElementById('schedule-consultation-button');
      if (scheduleConsultationBtn) {
        scheduleConsultationBtn.addEventListener('click', () => {
          // Use Calendly widget
          if (typeof Calendly !== 'undefined') {
            Calendly.initPopupWidget({url: 'https://calendly.com/grantaura'});
          } else {
            window.open('https://calendly.com/grantaura', '_blank');
          }
        });
      }
      
      // Premium popup close button
      const premiumPopupClose = document.getElementById('premium-popup-close');
      if (premiumPopupClose) {
        premiumPopupClose.addEventListener('click', () => {
          document.getElementById('premium-popup').classList.remove('active');
        });
      }
      
      // Premium popup success close button
      const premiumPopupSuccessClose = document.getElementById('premium-popup-success-close');
      if (premiumPopupSuccessClose) {
        premiumPopupSuccessClose.addEventListener('click', () => {
          document.getElementById('premium-popup').classList.remove('active');
        });
      }
      
      // Premium popup form submission
      const premiumPopupForm = document.getElementById('premium-popup-form');
      if (premiumPopupForm) {
        premiumPopupForm.addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitPremiumLead();
        });
      }
      
      // Close modal on escape key press
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('match-modal');
          if (modal && modal.classList.contains('active')) {
            modal.classList.remove('active');
          }
          
          const premiumPopup = document.getElementById('premium-popup');
          if (premiumPopup && premiumPopup.classList.contains('active')) {
            premiumPopup.classList.remove('active');
          }
        }
      });
      
      // Close modal on outside click
      document.addEventListener('click', (e) => {
        const modal = document.getElementById('match-modal');
        if (modal && modal.classList.contains('active') && !modal.querySelector('.eligibility-checker__modal-content').contains(e.target)) {
          modal.classList.remove('active');
        }
        
        const premiumPopup = document.getElementById('premium-popup');
        if (premiumPopup && premiumPopup.classList.contains('active') && 
            !premiumPopup.querySelector('.eligibility-checker__premium-popup-content').contains(e.target) && 
            e.target !== document.getElementById('unlock-premium-button')) {
          premiumPopup.classList.remove('active');
        }
      });
    },

    /**
     * Set up card selection functionality
     */
    setupCardSelection() {
      document.querySelectorAll('.eligibility-checker__card').forEach(card => {
        card.addEventListener('click', () => {
          const input = card.querySelector('input[type="radio"]');
          if (input) {
            document.querySelectorAll(`.eligibility-checker__card input[name="${input.name}"]`)
              .forEach(i => i.closest('.eligibility-checker__card').classList.remove('selected'));
            card.classList.add('selected');
            input.checked = true;
          }
        });
      });
    },
    
    /**
     * Open premium lead capture popup
     */
    openPremiumPopup() {
      const popup = document.getElementById('premium-popup');
      if (popup) {
        // Reset form state if needed
        const formContainer = document.getElementById('premium-popup-form-container');
        const successContainer = document.getElementById('premium-popup-success');
        
        if (formContainer && successContainer) {
          formContainer.style.display = 'block';
          successContainer.classList.remove('active');
        }
        
        // Show popup
        popup.classList.add('active');
      }
    },
    
    /**
     * Submit premium lead form via AJAX
     */
    submitPremiumLead() {
      const form = document.getElementById('premium-popup-form');
      if (!form) return;
      
      // Get form data
      const name = document.getElementById('premium-name').value;
      const email = document.getElementById('premium-email').value;
      const phone = document.getElementById('premium-phone').value;
      const interest = document.getElementById('premium-interest').value;
      
      // Basic validation
      let isValid = true;
      
      // Name validation
      if (!name.trim()) {
        const nameGroup = document.getElementById('premium-name').closest('.eligibility-checker__premium-popup-form-group');
        nameGroup.classList.add('has-error');
        isValid = false;
      } else {
        const nameGroup = document.getElementById('premium-name').closest('.eligibility-checker__premium-popup-form-group');
        nameGroup.classList.remove('has-error');
      }
      
      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email.trim() || !emailRegex.test(email)) {
        const emailGroup = document.getElementById('premium-email').closest('.eligibility-checker__premium-popup-form-group');
        emailGroup.classList.add('has-error');
        isValid = false;
      } else {
        const emailGroup = document.getElementById('premium-email').closest('.eligibility-checker__premium-popup-form-group');
        emailGroup.classList.remove('has-error');
      }
      
      // Interest validation
      if (!interest) {
        const interestGroup = document.getElementById('premium-interest').closest('.eligibility-checker__premium-popup-form-group');
        interestGroup.classList.add('has-error');
        isValid = false;
      } else {
        const interestGroup = document.getElementById('premium-interest').closest('.eligibility-checker__premium-popup-form-group');
        interestGroup.classList.remove('has-error');
      }
      
      if (!isValid) return;
      
      // Prepare data for AJAX
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        // Show loading state
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitButton.disabled = true;
        
        // Create FormData
        const formData = new FormData();
        formData.append('action', 'premium_lead_submission');
        formData.append('nonce', this.premiumLeadNonce);
        formData.append('name', name);
        formData.append('email', email);
        formData.append('phone', phone);
        formData.append('interest', interest);
        formData.append('entity_type', this.entityType);
        formData.append('entity_details', JSON.stringify(this.entityDetails));
        
        // Make AJAX request
        fetch(ajaxurl, {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          // Reset loading state
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
          
          if (data.success) {
            // Show success message
            const formContainer = document.getElementById('premium-popup-form-container');
            const successContainer = document.getElementById('premium-popup-success');
            
            if (formContainer && successContainer) {
              formContainer.style.display = 'none';
              successContainer.classList.add('active');
            }
            
            // Reset form
            form.reset();
          } else {
            // Show error message
            alert(data.data.message || 'There was an error processing your request. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error submitting premium lead:', error);
          
          // Reset loading state
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
          
          // Show error message
          alert('There was an error submitting your request. Please try again.');
        });
      }
    },

    /**
     * Set up keywords input functionality
     */
    setupKeywordsInput() {
      const keywordInput = document.getElementById('keywords-input');
      const keywordsContainer = document.getElementById('keywords-container');
      
      if (!keywordInput || !keywordsContainer) return;
      
      // Handle adding keywords on enter or comma
      keywordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const value = keywordInput.value.trim();
          if (value) {
            this.addKeyword(value);
            keywordInput.value = '';
          }
        }
      });
      
      // Handle adding keywords on blur
      keywordInput.addEventListener('blur', () => {
        const value = keywordInput.value.trim();
        if (value) {
          this.addKeyword(value);
          keywordInput.value = '';
        }
      });
      
      // Handle focus back on input when container is clicked
      keywordsContainer.addEventListener('click', (e) => {
        if (e.target === keywordsContainer) {
          keywordInput.focus();
        }
      });
    },
    
    /**
     * Add a keyword to the list
     */
    addKeyword(keyword) {
      if (this.keywordsList.includes(keyword)) return;
      if (this.keywordsList.length >= 10) return; // Limit to 10 keywords
      
      this.keywordsList.push(keyword);
      
      const container = document.getElementById('keywords-container');
      if (container) {
        const tag = document.createElement('div');
        tag.className = 'eligibility-checker__keyword-tag';
        tag.innerHTML = `
          ${keyword}
          <button type="button" data-keyword="${keyword}" aria-label="Remove keyword"></button>
        `;
        
        // Add event listener for removing the tag
        const removeBtn = tag.querySelector('button');
        removeBtn.addEventListener('click', () => {
          this.removeKeyword(keyword);
          tag.remove();
        });
        
        // Insert the tag before the input
        const input = container.querySelector('.eligibility-checker__keyword-input');
        container.insertBefore(tag, input);
      }
    },
    
    /**
     * Remove a keyword from the list
     */
    removeKeyword(keyword) {
      const index = this.keywordsList.indexOf(keyword);
      if (index !== -1) {
        this.keywordsList.splice(index, 1);
      }
    },

    /**
     * Validate step 1 selection
     */
    validateStep1() {
      const selected = document.querySelector('input[name="entity_type"]:checked');
      const formGroup = document.getElementById('entity-type-cards')?.closest('.eligibility-checker__form-group');
      
      if (!selected) {
        if (formGroup) formGroup.classList.add('has-error');
        return false;
      }
      
      if (formGroup) formGroup.classList.remove('has-error');
      return true;
    },

    /**
     * Save the entity type selection
     */
    saveEntityType() {
      const selected = document.querySelector('input[name="entity_type"]:checked');
      if (selected) {
        this.entityType = selected.value;
        
        // Set high priority fields based on entity type
        this.setHighPriorityFields();
      }
    },
    
    /**
     * Set high priority fields based on entity type
     * These are used for strict matching priorities
     */
    setHighPriorityFields() {
      switch (this.entityType) {
        case 'for_profit_business':
          this.highPriorityFields = ['entity_type', 'business_type', 'owner_demographics', 'industry', 'location'];
          break;
        case 'nonprofit':
          this.highPriorityFields = ['entity_type', 'nonprofit_type', 'focus_area', 'org_demographics', 'location'];
          break;
        case 'individual':
          this.highPriorityFields = ['entity_type', 'individual_type', 'individual_demographics', 'location', 'funding_need'];
          break;
        case 'institution':
          this.highPriorityFields = ['entity_type', 'institution_type', 'tax_status', 'location', 'funding_purpose'];
          break;
        default:
          this.highPriorityFields = ['entity_type', 'location'];
      }
    },

    /**
     * Load entity-specific form based on selection
     */
    loadEntityTypeForm() {
      const container = document.getElementById('dynamic-form-content');
      if (!container) return;
      
      container.innerHTML = {
        for_profit_business: this.generateForProfitBusinessForm(),
        nonprofit: this.generateNonprofitForm(),
        individual: this.generateIndividualForm(),
        institution: this.generateInstitutionForm()
      }[this.entityType] || '<p>Please select an entity type.</p>';
      
      this.setupDynamicFormEvents();
      this.setupKeywordsInput();
    },

    /**
     * Generate form for for-profit businesses
     */
    generateForProfitBusinessForm() {
      return `
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Business type <span>High Priority</span>
          </label>
          <div class="eligibility-checker__cards">
            <div class="eligibility-checker__card">
              <input type="radio" name="business_type" value="small_business" id="small_business" class="eligibility-checker__card-radio">
              <label for="small_business" class="eligibility-checker__card-title">Small business</label>
              <p class="eligibility-checker__card-description">Fewer than 500 employees with annual revenue under $7.5 million.</p>
            </div>
            <div class="eligibility-checker__card">
              <input type="radio" name="business_type" value="startup" id="startup" class="eligibility-checker__card-radio">
              <label for="startup" class="eligibility-checker__card-title">Startup</label>
              <p class="eligibility-checker__card-description">New ventures with high growth potential, typically less than 5 years old.</p>
            </div>
            <div class="eligibility-checker__card">
              <input type="radio" name="business_type" value="medium_business" id="medium_business" class="eligibility-checker__card-radio">
              <label for="medium_business" class="eligibility-checker__card-title">Medium business</label>
              <p class="eligibility-checker__card-description">Between 500-1000 employees with established operations.</p>
            </div>
          </div>
          <div class="eligibility-checker__form-error">Please select a business type</div>
        </div>

        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Owner demographics <span>High Priority</span>
          </label>
          <p class="eligibility-checker__form-hint">Many grant programs target businesses owned by specific demographics</p>
          <div class="eligibility-checker__checkbox-group">
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="women_owned" id="women_owned">
              <label for="women_owned">Women-owned</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="minority_owned" id="minority_owned">
              <label for="minority_owned">Minority-owned</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="veteran_owned" id="veteran_owned">
              <label for="veteran_owned">Veteran-owned</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="disability_owned" id="disability_owned">
              <label for="disability_owned">Disability-owned</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="rural_based" id="rural_based">
              <label for="rural_based">Rural-based</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="lgbtqia_owned" id="lgbtqia_owned">
              <label for="lgbtqia_owned">LGBTQIA+-owned</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="owner_demographics" value="none" id="no_demographics">
              <label for="no_demographics">None of the above</label>
            </div>
          </div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Primary industry <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="industry">
            <option value="" selected disabled>Select your primary industry</option>
            <option value="agriculture">Agriculture, Forestry & Fishing</option>
            <option value="construction">Construction</option>
            <option value="manufacturing">Manufacturing</option>
            <option value="technology">Technology & Software</option>
            <option value="retail">Retail & E-commerce</option>
            <option value="healthcare">Healthcare & Social Assistance</option>
            <option value="education">Education & Training</option>
            <option value="hospitality">Hospitality & Food Service</option>
            <option value="arts">Arts, Entertainment & Recreation</option>
            <option value="professional">Professional & Technical Services</option>
            <option value="green_energy">Renewable Energy & Sustainability</option>
            <option value="transportation">Transportation & Logistics</option>
            <option value="finance">Financial Services & Banking</option>
            <option value="other">Other Services</option>
          </select>
          <div class="eligibility-checker__form-error">Please select an industry</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Primary location <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="location" id="location-country">
            <option value="" selected disabled>Select your country</option>
            <option value="united-states">United States</option>
            <option value="global">Global</option>
            <option value="canada">Canada</option>
            <option value="uk">United Kingdom</option>
            <option value="australia">Australia</option>
            <option value="other-country">Other Country</option>
          </select>
          <div class="eligibility-checker__form-error">Please select a location</div>
        </div>
        
        <!-- US State field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-state-group" style="display: none;">
          <label class="eligibility-checker__form-label">US State</label>
          <select class="eligibility-checker__select" name="us_state" id="us-state">
            <option value="" selected disabled>Select your state</option>
            <option value="alabama">Alabama</option>
            <option value="alaska">Alaska</option>
            <option value="arizona">Arizona</option>
            <option value="arkansas">Arkansas</option>
            <option value="california">California</option>
            <option value="colorado">Colorado</option>
            <option value="connecticut">Connecticut</option>
            <option value="delaware">Delaware</option>
            <option value="florida">Florida</option>
            <option value="georgia">Georgia</option>
            <option value="hawaii">Hawaii</option>
            <option value="idaho">Idaho</option>
            <option value="illinois">Illinois</option>
            <option value="indiana">Indiana</option>
            <option value="iowa">Iowa</option>
            <option value="kansas">Kansas</option>
            <option value="kentucky">Kentucky</option>
            <option value="louisiana">Louisiana</option>
            <option value="maine">Maine</option>
            <option value="maryland">Maryland</option>
            <option value="massachusetts">Massachusetts</option>
            <option value="michigan">Michigan</option>
            <option value="minnesota">Minnesota</option>
            <option value="mississippi">Mississippi</option>
            <option value="missouri">Missouri</option>
            <option value="montana">Montana</option>
            <option value="nebraska">Nebraska</option>
            <option value="nevada">Nevada</option>
            <option value="new-hampshire">New Hampshire</option>
            <option value="new-jersey">New Jersey</option>
            <option value="new-mexico">New Mexico</option>
            <option value="new-york">New York</option>
            <option value="north-carolina">North Carolina</option>
            <option value="north-dakota">North Dakota</option>
            <option value="ohio">Ohio</option>
            <option value="oklahoma">Oklahoma</option>
            <option value="oregon">Oregon</option>
            <option value="pennsylvania">Pennsylvania</option>
            <option value="rhode-island">Rhode Island</option>
            <option value="south-carolina">South Carolina</option>
            <option value="south-dakota">South Dakota</option>
            <option value="tennessee">Tennessee</option>
            <option value="texas">Texas</option>
            <option value="utah">Utah</option>
            <option value="vermont">Vermont</option>
            <option value="virginia">Virginia</option>
            <option value="washington">Washington</option>
            <option value="west-virginia">West Virginia</option>
            <option value="wisconsin">Wisconsin</option>
            <option value="wyoming">Wyoming</option>
            <option value="district-of-columbia">District of Columbia</option>
          </select>
        </div>
        
        <!-- US City field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-city-group" style="display: none;">
          <label class="eligibility-checker__form-label">City (Optional)</label>
          <input type="text" class="eligibility-checker__premium-popup-input" name="city" id="us-city" placeholder="Enter your city">
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Years in operation</label>
          <select class="eligibility-checker__select" name="years_in_operation">
            <option value="" selected disabled>Select years in operation</option>
            <option value="pre_launch">Pre-launch/Concept stage</option>
            <option value="0_1">Less than 1 year</option>
            <option value="1_2">1-2 years</option>
            <option value="3_5">3-5 years</option>
            <option value="6_10">6-10 years</option>
            <option value="10_plus">More than 10 years</option>
          </select>
          <div class="eligibility-checker__form-error">Please select years in operation</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Annual revenue range</label>
          <select class="eligibility-checker__select" name="annual_revenue">
            <option value="" selected disabled>Select annual revenue range</option>
            <option value="pre_revenue">Pre-revenue</option>
            <option value="under_100k">Under $100,000</option>
            <option value="100k_500k">$100,000 - $500,000</option>
            <option value="500k_1m">$500,000 - $1 million</option>
            <option value="1m_5m">$1 million - $5 million</option>
            <option value="5m_10m">$5 million - $10 million</option>
            <option value="over_10m">Over $10 million</option>
          </select>
          <div class="eligibility-checker__form-error">Please select annual revenue range</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Funding purpose (Select all that apply)</label>
          <div class="eligibility-checker__checkbox-group">
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="funding_purpose" value="expansion" id="purpose_expansion">
              <label for="purpose_expansion">Business expansion</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="funding_purpose" value="equipment" id="purpose_equipment">
              <label for="purpose_equipment">Equipment purchase</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="funding_purpose" value="research" id="purpose_research">
              <label for="purpose_research">Research & development</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="funding_purpose" value="hiring" id="purpose_hiring">
              <label for="purpose_hiring">Hiring & workforce</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="funding_purpose" value="marketing" id="purpose_marketing">
              <label for="purpose_marketing">Marketing & sales</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="funding_purpose" value="technology" id="purpose_technology">
              <label for="purpose_technology">Technology adoption</label>
            </div>
          </div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Keywords <span class="eligibility-checker__form-hint">(Enter specific terms related to your business or funding needs)</span></label>
          <div class="eligibility-checker__keywords-container" id="keywords-container">
            <input type="text" class="eligibility-checker__keyword-input" id="keywords-input" placeholder="Type and press Enter to add keywords">
          </div>
          <span class="eligibility-checker__keywords-hint">Press Enter or comma after each keyword. Maximum 10 keywords.</span>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Brief description of your funding needs</label>
          <p class="eligibility-checker__form-hint">Provide additional details about your business and specific funding requirements to help us find better matches</p>
          <textarea class="eligibility-checker__textarea" name="funding_description" rows="4" placeholder="Describe your business and what you need the grant funding for..."></textarea>
        </div>
      `;
    },
    
    /**
     * Generate form for nonprofit organizations
     */
    generateNonprofitForm() {
      return `
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Nonprofit type <span>High Priority</span>
          </label>
          <div class="eligibility-checker__cards">
            <div class="eligibility-checker__card" data-value="501c3">
              <input type="radio" name="nonprofit_type" value="501c3" class="eligibility-checker__card-radio">
              <i class="fas fa-hand-holding-heart eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">501(c)(3)</h4>
              <p class="eligibility-checker__card-description">Public charities, private foundations, and other organizations exempt from federal income tax.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="501c4">
              <input type="radio" name="nonprofit_type" value="501c4" class="eligibility-checker__card-radio">
              <i class="fas fa-users eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">501(c)(4)</h4>
              <p class="eligibility-checker__card-description">Social welfare organizations and civic leagues with community focus.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="501c6">
              <input type="radio" name="nonprofit_type" value="501c6" class="eligibility-checker__card-radio">
              <i class="fas fa-building eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">501(c)(6)</h4>
              <p class="eligibility-checker__card-description">Business leagues, chambers of commerce, and trade associations.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="other_nonprofit">
              <input type="radio" name="nonprofit_type" value="other_nonprofit" class="eligibility-checker__card-radio">
              <i class="fas fa-sitemap eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Other nonprofit type</h4>
              <p class="eligibility-checker__card-description">Other nonprofit designations including 501(c)(7), 501(c)(8), etc.</p>
            </div>
          </div>
          <div class="eligibility-checker__form-error">Please select a nonprofit type</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Primary focus area <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="focus_area">
            <option value="" selected disabled>Select your primary focus area</option>
            <option value="education">Education</option>
            <option value="environment">Environment & Conservation</option>
            <option value="health">Health & Human Services</option>
            <option value="arts">Arts & Culture</option>
            <option value="community">Community Development</option>
            <option value="civil_rights">Civil Rights & Advocacy</option>
            <option value="religious">Religious</option>
            <option value="disaster">Disaster Relief</option>
            <option value="international">International Development</option>
            <option value="animal">Animal Welfare</option>
            <option value="youth">Youth Development</option>
            <option value="housing">Housing & Homelessness</option>
            <option value="food">Food Security & Nutrition</option>
            <option value="other">Other</option>
          </select>
          <div class="eligibility-checker__form-error">Please select a focus area</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Organization leadership demographics <span>High Priority</span>
          </label>
          <p class="eligibility-checker__form-hint">Many grants target organizations led by specific demographics</p>
          <div class="eligibility-checker__checkbox-group">
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="org_demographics" value="women_led" id="women_led">
              <label for="women_led">Women-led</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="org_demographics" value="bipoc_led" id="bipoc_led">
              <label for="bipoc_led">BIPOC-led</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="org_demographics" value="veteran_led" id="veteran_led">
              <label for="veteran_led">Veteran-led</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="org_demographics" value="disability_led" id="disability_led">
              <label for="disability_led">Led by people with disabilities</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="org_demographics" value="lgbtqia_led" id="lgbtqia_led">
              <label for="lgbtqia_led">LGBTQIA+-led</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="org_demographics" value="none" id="no_org_demographics">
              <label for="no_org_demographics">None of the above</label>
            </div>
          </div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Primary location <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="location" id="location-country">
            <option value="" selected disabled>Select your country</option>
            <option value="united-states">United States</option>
            <option value="global">Global</option>
            <option value="canada">Canada</option>
            <option value="uk">United Kingdom</option>
            <option value="australia">Australia</option>
            <option value="other-country">Other Country</option>
          </select>
          <div class="eligibility-checker__form-error">Please select a location</div>
        </div>
        
        <!-- US State field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-state-group" style="display: none;">
          <label class="eligibility-checker__form-label">US State</label>
          <select class="eligibility-checker__select" name="us_state" id="us-state">
            <option value="" selected disabled>Select your state</option>
            <option value="alabama">Alabama</option>
            <option value="alaska">Alaska</option>
            <option value="arizona">Arizona</option>
            <option value="arkansas">Arkansas</option>
            <option value="california">California</option>
            <option value="colorado">Colorado</option>
            <option value="connecticut">Connecticut</option>
            <option value="delaware">Delaware</option>
            <option value="florida">Florida</option>
            <option value="georgia">Georgia</option>
            <option value="hawaii">Hawaii</option>
            <option value="idaho">Idaho</option>
            <option value="illinois">Illinois</option>
            <option value="indiana">Indiana</option>
            <option value="iowa">Iowa</option>
            <option value="kansas">Kansas</option>
            <option value="kentucky">Kentucky</option>
            <option value="louisiana">Louisiana</option>
            <option value="maine">Maine</option>
            <option value="maryland">Maryland</option>
            <option value="massachusetts">Massachusetts</option>
            <option value="michigan">Michigan</option>
            <option value="minnesota">Minnesota</option>
            <option value="mississippi">Mississippi</option>
            <option value="missouri">Missouri</option>
            <option value="montana">Montana</option>
            <option value="nebraska">Nebraska</option>
            <option value="nevada">Nevada</option>
            <option value="new-hampshire">New Hampshire</option>
            <option value="new-jersey">New Jersey</option>
            <option value="new-mexico">New Mexico</option>
            <option value="new-york">New York</option>
            <option value="north-carolina">North Carolina</option>
            <option value="north-dakota">North Dakota</option>
            <option value="ohio">Ohio</option>
            <option value="oklahoma">Oklahoma</option>
            <option value="oregon">Oregon</option>
            <option value="pennsylvania">Pennsylvania</option>
            <option value="rhode-island">Rhode Island</option>
            <option value="south-carolina">South Carolina</option>
            <option value="south-dakota">South Dakota</option>
            <option value="tennessee">Tennessee</option>
            <option value="texas">Texas</option>
            <option value="utah">Utah</option>
            <option value="vermont">Vermont</option>
            <option value="virginia">Virginia</option>
            <option value="washington">Washington</option>
            <option value="west-virginia">West Virginia</option>
            <option value="wisconsin">Wisconsin</option>
            <option value="wyoming">Wyoming</option>
            <option value="district-of-columbia">District of Columbia</option>
          </select>
        </div>
        
        <!-- US City field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-city-group" style="display: none;">
          <label class="eligibility-checker__form-label">City (Optional)</label>
          <input type="text" class="eligibility-checker__premium-popup-input" name="city" id="us-city" placeholder="Enter your city">
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Years in operation</label>
          <select class="eligibility-checker__select" name="years_in_operation">
            <option value="" selected disabled>Select years in operation</option>
            <option value="pre_launch">Pre-launch/Planning phase</option>
            <option value="0_1">Less than 1 year</option>
            <option value="1_2">1-2 years</option>
            <option value="3_5">3-5 years</option>
            <option value="6_10">6-10 years</option>
            <option value="10_plus">More than 10 years</option>
          </select>
          <div class="eligibility-checker__form-error">Please select years in operation</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Annual operating budget</label>
          <select class="eligibility-checker__select" name="annual_budget">
            <option value="" selected disabled>Select annual budget range</option>
            <option value="under_50k">Under $50,000</option>
            <option value="50k_100k">$50,000 - $100,000</option>
            <option value="100k_500k">$100,000 - $500,000</option>
            <option value="500k_1m">$500,000 - $1 million</option>
            <option value="1m_5m">$1 million - $5 million</option>
            <option value="5m_10m">$5 million - $10 million</option>
            <option value="10m_plus">Over $10 million</option>
          </select>
          <div class="eligibility-checker__form-error">Please select annual budget range</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Grant purpose (Select all that apply)</label>
          <div class="eligibility-checker__checkbox-group">
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="grant_purpose" value="program" id="purpose_program">
              <label for="purpose_program">Program development/expansion</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="grant_purpose" value="capacity" id="purpose_capacity">
              <label for="purpose_capacity">Capacity building</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="grant_purpose" value="capital" id="purpose_capital">
              <label for="purpose_capital">Capital expenses</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="grant_purpose" value="operating" id="purpose_operating">
              <label for="purpose_operating">General operating support</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="grant_purpose" value="research" id="purpose_npresearch">
              <label for="purpose_npresearch">Research</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="grant_purpose" value="technical" id="purpose_technical">
              <label for="purpose_technical">Technical assistance</label>
            </div>
          </div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Keywords <span class="eligibility-checker__form-hint">(Enter specific terms related to your organization or funding needs)</span></label>
          <div class="eligibility-checker__keywords-container" id="keywords-container">
            <input type="text" class="eligibility-checker__keyword-input" id="keywords-input" placeholder="Type and press Enter to add keywords">
          </div>
          <span class="eligibility-checker__keywords-hint">Press Enter or comma after each keyword. Maximum 10 keywords.</span>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Brief description of your funding needs</label>
          <p class="eligibility-checker__form-hint">Provide additional details about your organization and specific funding requirements to help us find better matches</p>
          <textarea class="eligibility-checker__textarea" name="funding_description" rows="4" placeholder="Describe your organization and what you need the grant funding for..."></textarea>
        </div>
      `;
    },
    
    /**
     * Generate form for individuals
     */
    generateIndividualForm() {
      return `
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Individual category <span>High Priority</span>
          </label>
          <div class="eligibility-checker__cards">
            <div class="eligibility-checker__card" data-value="artist">
              <input type="radio" name="individual_type" value="artist" class="eligibility-checker__card-radio">
              <i class="fas fa-paint-brush eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Artist/Creative</h4>
              <p class="eligibility-checker__card-description">Visual artists, writers, musicians, performers, and other creative professionals.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="student">
              <input type="radio" name="individual_type" value="student" class="eligibility-checker__card-radio">
              <i class="fas fa-graduation-cap eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Student</h4>
              <p class="eligibility-checker__card-description">Current or prospective students seeking funding for education expenses.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="researcher">
              <input type="radio" name="individual_type" value="researcher" class="eligibility-checker__card-radio">
              <i class="fas fa-microscope eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Researcher</h4>
              <p class="eligibility-checker__card-description">Individuals conducting research across any field or discipline.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="entrepreneur">
              <input type="radio" name="individual_type" value="entrepreneur" class="eligibility-checker__card-radio">
              <i class="fas fa-lightbulb eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Entrepreneur</h4>
              <p class="eligibility-checker__card-description">Individuals starting or expanding a business venture.</p>
            </div>
          </div>
          <div class="eligibility-checker__form-error">Please select an individual category</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Demographics <span>High Priority</span>
          </label>
          <p class="eligibility-checker__form-hint">Many grants target specific demographics - selecting applicable categories increases your match accuracy</p>
          <div class="eligibility-checker__checkbox-group">
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="woman" id="woman">
              <label for="woman">Woman</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="bipoc" id="bipoc">
              <label for="bipoc">BIPOC</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="veteran" id="veteran">
              <label for="veteran">Veteran</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="disability" id="disability">
              <label for="disability">Person with disability</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="lgbtqia" id="lgbtqia">
              <label for="lgbtqia">LGBTQIA+</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="low_income" id="low_income">
              <label for="low_income">Low income</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="rural" id="rural">
              <label for="rural">Rural resident</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="first_gen" id="first_gen">
              <label for="first_gen">First-generation college student</label>
            </div>
            
            <div class="eligibility-checker__checkbox-item">
              <input type="checkbox" name="individual_demographics" value="none" id="no_individual_demographics">
              <label for="no_individual_demographics">None of the above</label>
            </div>
          </div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Primary location <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="location" id="location-country">
            <option value="" selected disabled>Select your country</option>
            <option value="united-states">United States</option>
            <option value="global">Global</option>
            <option value="canada">Canada</option>
            <option value="uk">United Kingdom</option>
            <option value="australia">Australia</option>
            <option value="other-country">Other Country</option>
          </select>
          <div class="eligibility-checker__form-error">Please select a location</div>
        </div>
        
        <!-- US State field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-state-group" style="display: none;">
          <label class="eligibility-checker__form-label">US State</label>
          <select class="eligibility-checker__select" name="us_state" id="us-state">
            <option value="" selected disabled>Select your state</option>
            <option value="alabama">Alabama</option>
            <option value="alaska">Alaska</option>
            <option value="arizona">Arizona</option>
            <option value="arkansas">Arkansas</option>
            <option value="california">California</option>
            <option value="colorado">Colorado</option>
            <option value="connecticut">Connecticut</option>
            <option value="delaware">Delaware</option>
            <option value="florida">Florida</option>
            <option value="georgia">Georgia</option>
            <option value="hawaii">Hawaii</option>
            <option value="idaho">Idaho</option>
            <option value="illinois">Illinois</option>
            <option value="indiana">Indiana</option>
            <option value="iowa">Iowa</option>
            <option value="kansas">Kansas</option>
            <option value="kentucky">Kentucky</option>
            <option value="louisiana">Louisiana</option>
            <option value="maine">Maine</option>
            <option value="maryland">Maryland</option>
            <option value="massachusetts">Massachusetts</option>
            <option value="michigan">Michigan</option>
            <option value="minnesota">Minnesota</option>
            <option value="mississippi">Mississippi</option>
            <option value="missouri">Missouri</option>
            <option value="montana">Montana</option>
            <option value="nebraska">Nebraska</option>
            <option value="nevada">Nevada</option>
            <option value="new-hampshire">New Hampshire</option>
            <option value="new-jersey">New Jersey</option>
            <option value="new-mexico">New Mexico</option>
            <option value="new-york">New York</option>
            <option value="north-carolina">North Carolina</option>
            <option value="north-dakota">North Dakota</option>
            <option value="ohio">Ohio</option>
            <option value="oklahoma">Oklahoma</option>
            <option value="oregon">Oregon</option>
            <option value="pennsylvania">Pennsylvania</option>
            <option value="rhode-island">Rhode Island</option>
            <option value="south-carolina">South Carolina</option>
            <option value="south-dakota">South Dakota</option>
            <option value="tennessee">Tennessee</option>
            <option value="texas">Texas</option>
            <option value="utah">Utah</option>
            <option value="vermont">Vermont</option>
            <option value="virginia">Virginia</option>
            <option value="washington">Washington</option>
            <option value="west-virginia">West Virginia</option>
            <option value="wisconsin">Wisconsin</option>
            <option value="wyoming">Wyoming</option>
            <option value="district-of-columbia">District of Columbia</option>
          </select>
        </div>
        
        <!-- US City field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-city-group" style="display: none;">
          <label class="eligibility-checker__form-label">City (Optional)</label>
          <input type="text" class="eligibility-checker__premium-popup-input" name="city" id="us-city" placeholder="Enter your city">
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Funding need <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="funding_need">
            <option value="" selected disabled>Select primary funding need</option>
            <option value="education">Education/Tuition</option>
            <option value="artistic">Artistic Project</option>
            <option value="research">Research Project</option>
            <option value="business">Business Startup</option>
            <option value="medical">Medical Expenses</option>
            <option value="travel">Travel/Study Abroad</option>
            <option value="community">Community Project</option>
            <option value="professional">Professional Development</option>
            <option value="equipment">Equipment/Supplies</option>
            <option value="living">Living Expenses</option>
            <option value="other">Other</option>
          </select>
          <div class="eligibility-checker__form-error">Please select funding need</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Amount needed</label>
          <select class="eligibility-checker__select" name="amount_needed">
            <option value="" selected disabled>Select amount needed</option>
            <option value="under_1k">Under $1,000</option>
            <option value="1k_5k">$1,000 - $5,000</option>
            <option value="5k_10k">$5,000 - $10,000</option>
            <option value="10k_25k">$10,000 - $25,000</option>
            <option value="25k_50k">$25,000 - $50,000</option>
            <option value="50k_plus">Over $50,000</option>
          </select>
          <div class="eligibility-checker__form-error">Please select amount needed</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Keywords <span class="eligibility-checker__form-hint">(Enter specific terms related to your funding needs)</span></label>
          <div class="eligibility-checker__keywords-container" id="keywords-container">
            <input type="text" class="eligibility-checker__keyword-input" id="keywords-input" placeholder="Type and press Enter to add keywords">
          </div>
          <span class="eligibility-checker__keywords-hint">Press Enter or comma after each keyword. Maximum 10 keywords.</span>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Brief description of your funding needs</label>
          <p class="eligibility-checker__form-hint">Provide additional details about your background and specific funding requirements to help us find better matches</p>
          <textarea class="eligibility-checker__textarea" name="funding_description" rows="4" placeholder="Describe yourself and what you need the grant funding for..."></textarea>
        </div>
      `;
    },
    
    /**
     * Generate form for institutions
     */
    generateInstitutionForm() {
      return `
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Institution type <span>High Priority</span>
          </label>
          <div class="eligibility-checker__cards">
            <div class="eligibility-checker__card" data-value="education">
              <input type="radio" name="institution_type" value="education" class="eligibility-checker__card-radio">
              <i class="fas fa-university eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Educational institution</h4>
              <p class="eligibility-checker__card-description">K-12 schools, colleges, universities, and other educational organizations.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="research">
              <input type="radio" name="institution_type" value="research" class="eligibility-checker__card-radio">
              <i class="fas fa-flask eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Research institution</h4>
              <p class="eligibility-checker__card-description">Organizations primarily focused on research and development activities.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="healthcare">
              <input type="radio" name="institution_type" value="healthcare" class="eligibility-checker__card-radio">
              <i class="fas fa-hospital eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Healthcare institution</h4>
              <p class="eligibility-checker__card-description">Hospitals, clinics, and other healthcare facilities.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="government">
              <input type="radio" name="institution_type" value="government" class="eligibility-checker__card-radio">
              <i class="fas fa-landmark eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Government entity</h4>
              <p class="eligibility-checker__card-description">Local, state, or federal government agencies and departments.</p>
            </div>
            
            <div class="eligibility-checker__card" data-value="cultural">
              <input type="radio" name="institution_type" value="cultural" class="eligibility-checker__card-radio">
              <i class="fas fa-theater-masks eligibility-checker__card-icon"></i>
              <h4 class="eligibility-checker__card-title">Cultural institution</h4>
              <p class="eligibility-checker__card-description">Museums, libraries, historical societies, and other cultural organizations.</p>
            </div>
          </div>
          <div class="eligibility-checker__form-error">Please select an institution type</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Tax status <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="tax_status">
            <option value="" selected disabled>Select tax status</option>
            <option value="public">Public/Government</option>
            <option value="private_nonprofit">Private Nonprofit</option>
            <option value="private_forprofit">Private For-Profit</option>
            <option value="tribal">Tribal Organization</option>
            <option value="other_tax">Other</option>
          </select>
          <div class="eligibility-checker__form-error">Please select tax status</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Primary location <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="location" id="location-country">
            <option value="" selected disabled>Select your country</option>
            <option value="united-states">United States</option>
            <option value="global">Global</option>
            <option value="canada">Canada</option>
            <option value="uk">United Kingdom</option>
            <option value="australia">Australia</option>
            <option value="other-country">Other Country</option>
          </select>
          <div class="eligibility-checker__form-error">Please select a location</div>
        </div>
        
        <!-- US State field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-state-group" style="display: none;">
          <label class="eligibility-checker__form-label">US State</label>
          <select class="eligibility-checker__select" name="us_state" id="us-state">
            <option value="" selected disabled>Select your state</option>
            <option value="alabama">Alabama</option>
            <option value="alaska">Alaska</option>
            <option value="arizona">Arizona</option>
            <option value="arkansas">Arkansas</option>
            <option value="california">California</option>
            <option value="colorado">Colorado</option>
            <option value="connecticut">Connecticut</option>
            <option value="delaware">Delaware</option>
            <option value="florida">Florida</option>
            <option value="georgia">Georgia</option>
            <option value="hawaii">Hawaii</option>
            <option value="idaho">Idaho</option>
            <option value="illinois">Illinois</option>
            <option value="indiana">Indiana</option>
            <option value="iowa">Iowa</option>
            <option value="kansas">Kansas</option>
            <option value="kentucky">Kentucky</option>
            <option value="louisiana">Louisiana</option>
            <option value="maine">Maine</option>
            <option value="maryland">Maryland</option>
            <option value="massachusetts">Massachusetts</option>
            <option value="michigan">Michigan</option>
            <option value="minnesota">Minnesota</option>
            <option value="mississippi">Mississippi</option>
            <option value="missouri">Missouri</option>
            <option value="montana">Montana</option>
            <option value="nebraska">Nebraska</option>
            <option value="nevada">Nevada</option>
            <option value="new-hampshire">New Hampshire</option>
            <option value="new-jersey">New Jersey</option>
            <option value="new-mexico">New Mexico</option>
            <option value="new-york">New York</option>
            <option value="north-carolina">North Carolina</option>
            <option value="north-dakota">North Dakota</option>
            <option value="ohio">Ohio</option>
            <option value="oklahoma">Oklahoma</option>
            <option value="oregon">Oregon</option>
            <option value="pennsylvania">Pennsylvania</option>
            <option value="rhode-island">Rhode Island</option>
            <option value="south-carolina">South Carolina</option>
            <option value="south-dakota">South Dakota</option>
            <option value="tennessee">Tennessee</option>
            <option value="texas">Texas</option>
            <option value="utah">Utah</option>
            <option value="vermont">Vermont</option>
            <option value="virginia">Virginia</option>
            <option value="washington">Washington</option>
            <option value="west-virginia">West Virginia</option>
            <option value="wisconsin">Wisconsin</option>
            <option value="wyoming">Wyoming</option>
            <option value="district-of-columbia">District of Columbia</option>
          </select>
        </div>
        
        <!-- US City field - will be shown conditionally -->
        <div class="eligibility-checker__form-group" id="us-city-group" style="display: none;">
          <label class="eligibility-checker__form-label">City (Optional)</label>
          <input type="text" class="eligibility-checker__premium-popup-input" name="city" id="us-city" placeholder="Enter your city">
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Years in operation</label>
          <select class="eligibility-checker__select" name="years_in_operation">
            <option value="" selected disabled>Select years in operation</option>
            <option value="0_5">0-5 years</option>
            <option value="6_10">6-10 years</option>
            <option value="11_20">11-20 years</option>
            <option value="21_50">21-50 years</option>
            <option value="50_plus">Over 50 years</option>
          </select>
          <div class="eligibility-checker__form-error">Please select years in operation</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Annual operating budget</label>
          <select class="eligibility-checker__select" name="annual_budget">
            <option value="" selected disabled>Select annual budget range</option>
            <option value="under_100k">Under $100,000</option>
            <option value="100k_500k">$100,000 - $500,000</option>
            <option value="500k_1m">$500,000 - $1 million</option>
            <option value="1m_5m">$1 million - $5 million</option>
            <option value="5m_10m">$5 million - $10 million</option>
            <option value="10m_50m">$10 million - $50 million</option>
            <option value="50m_plus">Over $50 million</option>
          </select>
          <div class="eligibility-checker__form-error">Please select annual budget range</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label eligibility-checker__priority-label">
            Funding purpose <span>High Priority</span>
          </label>
          <select class="eligibility-checker__select" name="funding_purpose">
            <option value="" selected disabled>Select primary funding purpose</option>
            <option value="research">Research & Development</option>
            <option value="equipment">Equipment & Technology</option>
            <option value="facilities">Facilities & Infrastructure</option>
            <option value="programs">Programs & Services</option>
            <option value="capacity">Capacity Building</option>
            <option value="community">Community Outreach</option>
            <option value="professional">Professional Development</option>
            <option value="other_purpose">Other</option>
          </select>
          <div class="eligibility-checker__form-error">Please select funding purpose</div>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Keywords <span class="eligibility-checker__form-hint">(Enter specific terms related to your institution or funding needs)</span></label>
          <div class="eligibility-checker__keywords-container" id="keywords-container">
            <input type="text" class="eligibility-checker__keyword-input" id="keywords-input" placeholder="Type and press Enter to add keywords">
          </div>
          <span class="eligibility-checker__keywords-hint">Press Enter or comma after each keyword. Maximum 10 keywords.</span>
        </div>
        
        <div class="eligibility-checker__form-group">
          <label class="eligibility-checker__form-label">Brief description of your funding needs</label>
          <p class="eligibility-checker__form-hint">Provide additional details about your institution and specific funding requirements to help us find better matches</p>
          <textarea class="eligibility-checker__textarea" name="funding_description" rows="4" placeholder="Describe your institution and what you need the grant funding for..."></textarea>
        </div>
      `;
    },
    
    /**
     * Set up dynamic form events
     */
    setupDynamicFormEvents() {
      // Set up card selection for dynamically added cards
      this.setupCardSelection();
      
      // Set up checkbox selection for dynamically added checkboxes
      this.setupCheckboxSelection();
      
      // Set up location-dependent fields logic
      this.setupLocationDependentFields();
      
      // Handle "none of the above" checkbox logic
      const demographicsGroups = document.querySelectorAll('.eligibility-checker__checkbox-group');
      
      demographicsGroups.forEach(group => {
        const checkboxes = group.querySelectorAll('input[type="checkbox"]');
        const noneCheckbox = group.querySelector('input[value="none"]');
        
        if (noneCheckbox) {
          // When "none" is checked, uncheck all others
          noneCheckbox.addEventListener('change', () => {
            if (noneCheckbox.checked) {
              checkboxes.forEach(cb => {
                if (cb !== noneCheckbox) {
                  cb.checked = false;
                  cb.closest('.eligibility-checker__checkbox-item').classList.remove('selected');
                }
              });
            }
          });
          
          // When any other checkbox is checked, uncheck "none"
          checkboxes.forEach(cb => {
            if (cb !== noneCheckbox) {
              cb.addEventListener('change', () => {
                if (cb.checked && noneCheckbox.checked) {
                  noneCheckbox.checked = false;
                  noneCheckbox.closest('.eligibility-checker__checkbox-item').classList.remove('selected');
                }
              });
            }
          });
        }
      });
    },
    
    /**
     * Set up location-dependent fields (US State and City)
     */
    setupLocationDependentFields() {
      const countrySelect = document.getElementById('location-country');
      const stateGroup = document.getElementById('us-state-group');
      const cityGroup = document.getElementById('us-city-group');
      
      if (countrySelect && stateGroup && cityGroup) {
        countrySelect.addEventListener('change', () => {
          if (countrySelect.value === 'united-states') {
            stateGroup.style.display = 'block';
            cityGroup.style.display = 'block';
          } else {
            stateGroup.style.display = 'none';
            cityGroup.style.display = 'none';
          }
        });
      }
    },
    
    /**
     * Set up checkbox selection styling
     */
    setupCheckboxSelection() {
      const checkboxItems = document.querySelectorAll('.eligibility-checker__checkbox-item');
      
      checkboxItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        
        if (checkbox) {
          // Initial state
          if (checkbox.checked) {
            item.classList.add('selected');
          }
          
          // Handle checkbox change
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              item.classList.add('selected');
            } else {
              item.classList.remove('selected');
            }
          });
          
          // Make the whole item clickable
          item.addEventListener('click', (e) => {
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
              
              // Trigger change event manually
              const event = new Event('change');
              checkbox.dispatchEvent(event);
            }
          });
        }
      });
    },
    
    /**
     * Validate step 2 form data with improved checking for required fields
     * Strictly prioritizes validation of high priority fields
     */
    validateStep2() {
      let isValid = true;
      const dynamicContent = document.getElementById('dynamic-form-content');
      
      if (!dynamicContent) return false;
      
      // Reset all error states
      dynamicContent.querySelectorAll('.eligibility-checker__form-group').forEach(group => {
        group.classList.remove('has-error');
      });
      
      // Common high priority fields to validate across entity types
      const validateLocation = () => {
        const locationSelect = dynamicContent.querySelector('select[name="location"]');
        if (locationSelect && !locationSelect.value) {
          locationSelect.closest('.eligibility-checker__form-group').classList.add('has-error');
          isValid = false;
        }
      };
      
      // Validate entity type-specific fields
      switch (this.entityType) {
        case 'for_profit_business':
          // Validate business type selection - HIGH PRIORITY
          const businessTypeRadio = dynamicContent.querySelector('input[name="business_type"]:checked');
          if (!businessTypeRadio) {
            const formGroup = dynamicContent.querySelector('input[name="business_type"]').closest('.eligibility-checker__form-group');
            formGroup.classList.add('has-error');
            isValid = false;
          }
          
          // Validate industry selection - HIGH PRIORITY
          const industrySelect = dynamicContent.querySelector('select[name="industry"]');
          if (industrySelect && !industrySelect.value) {
            industrySelect.closest('.eligibility-checker__form-group').classList.add('has-error');
            isValid = false;
          }
          
          // Validate location - HIGH PRIORITY
          validateLocation();
          break;
          
        case 'nonprofit':
          // Validate nonprofit type selection - HIGH PRIORITY
          const nonprofitTypeRadio = dynamicContent.querySelector('input[name="nonprofit_type"]:checked');
          if (!nonprofitTypeRadio) {
            const formGroup = dynamicContent.querySelector('input[name="nonprofit_type"]').closest('.eligibility-checker__form-group');
            formGroup.classList.add('has-error');
            isValid = false;
          }
          
          // Validate focus area selection - HIGH PRIORITY
          const focusAreaSelect = dynamicContent.querySelector('select[name="focus_area"]');
          if (focusAreaSelect && !focusAreaSelect.value) {
            focusAreaSelect.closest('.eligibility-checker__form-group').classList.add('has-error');
            isValid = false;
          }
          
          // Validate location - HIGH PRIORITY
          validateLocation();
          break;
          
        case 'individual':
          // Validate individual type selection - HIGH PRIORITY
          const individualTypeRadio = dynamicContent.querySelector('input[name="individual_type"]:checked');
          if (!individualTypeRadio) {
            const formGroup = dynamicContent.querySelector('input[name="individual_type"]').closest('.eligibility-checker__form-group');
            formGroup.classList.add('has-error');
            isValid = false;
          }
          
          // Validate location - HIGH PRIORITY
          validateLocation();
          
          // Validate funding need selection - HIGH PRIORITY
          const fundingNeedSelect = dynamicContent.querySelector('select[name="funding_need"]');
          if (fundingNeedSelect && !fundingNeedSelect.value) {
            fundingNeedSelect.closest('.eligibility-checker__form-group').classList.add('has-error');
            isValid = false;
          }
          break;
          
        case 'institution':
          // Validate institution type selection - HIGH PRIORITY
          const institutionTypeRadio = dynamicContent.querySelector('input[name="institution_type"]:checked');
          if (!institutionTypeRadio) {
            const formGroup = dynamicContent.querySelector('input[name="institution_type"]').closest('.eligibility-checker__form-group');
            formGroup.classList.add('has-error');
            isValid = false;
          }
          
          // Validate tax status selection - HIGH PRIORITY
          const taxStatusSelect = dynamicContent.querySelector('select[name="tax_status"]');
          if (taxStatusSelect && !taxStatusSelect.value) {
            taxStatusSelect.closest('.eligibility-checker__form-group').classList.add('has-error');
            isValid = false;
          }
          
          // Validate location - HIGH PRIORITY
          validateLocation();
          
          // Validate funding purpose - HIGH PRIORITY
          const purposeSelect = dynamicContent.querySelector('select[name="funding_purpose"]');
          if (purposeSelect && !purposeSelect.value) {
            purposeSelect.closest('.eligibility-checker__form-group').classList.add('has-error');
            isValid = false;
          }
          break;
      }
      
      // Validate US State if United States is selected
      const locationSelect = dynamicContent.querySelector('select[name="location"]');
      const stateSelect = dynamicContent.querySelector('select[name="us_state"]');
      if (locationSelect && locationSelect.value === 'united-states' && stateSelect && !stateSelect.value) {
        stateSelect.closest('.eligibility-checker__form-group').classList.add('has-error');
        isValid = false;
      }
      
      return isValid;
    },
    
    /**
     * Save entity details from Step 2 with keywords and descriptions
     */
    saveEntityDetails() {
      const dynamicContent = document.getElementById('dynamic-form-content');
      if (!dynamicContent) return;
      
      // Create object to store entity details
      const details = {
        entity_type: this.entityType,
        keywords: this.keywordsList
      };
      
      // Get all form inputs
      const inputs = dynamicContent.querySelectorAll('input, select, textarea');
      
      inputs.forEach(input => {
        const name = input.getAttribute('name');
        
        if (!name) return;
        
        // Handle different input types
        if (input.type === 'radio' && input.checked) {
          details[name] = input.value;
        } 
        else if (input.type === 'checkbox') {
          // Group checkboxes by name
          if (!details[name]) {
            details[name] = [];
          }
          
          if (input.checked) {
            details[name].push(input.value);
          }
        }
        else if (input.type !== 'radio') {
          // For other input types (text, select, textarea, etc.)
          details[name] = input.value;
        }
      });
      
      // Store entity details
      this.entityDetails = details;
      console.log('Saved entity details:', this.entityDetails);
    },
    
    /**
     * Fetch grants with improved error handling and data processing
     * Enhanced to use multiple methods for reliable grant fetching
     */
    fetchGrants() {
      // Show loading overlay
      const loadingOverlay = document.getElementById('matches-loading');
      const progressBar = document.getElementById('loading-progress-bar');
      const matchesContainer = document.getElementById('matches-container');
      
      if (loadingOverlay && progressBar && matchesContainer) {
        loadingOverlay.style.display = 'flex';
        matchesContainer.classList.add('hidden');
        
        // Show admin notice if in admin mode
        if (this.isAdminMode) {
          const adminNotice = document.getElementById('admin-notice');
          if (adminNotice) {
            adminNotice.style.display = 'flex';
          }
        }
        
        // Animate loading progress bar
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 2;
          if (progress <= 95) { // Only go to 95% until actual completion
            progressBar.style.width = `${progress}%`;
          }
        }, 50);
        
        // Try multiple methods to fetch grants
        this.tryFetchingGrants().then(grantsData => {
          // Process the grants data
          if (grantsData && grantsData.grants && grantsData.grants.length > 0) {
            this.grants = grantsData.grants;
            
            // Update high priority fields if returned from server
            if (grantsData.high_priority_fields && grantsData.high_priority_fields.length > 0) {
              this.highPriorityFields = grantsData.high_priority_fields;
            }
            
            // Apply strict filtering based on user input with enhanced algorithm
            this.processGrantMatches();
            
            // Complete progress bar
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            // Hide loading state and show results after a short delay
            setTimeout(() => {
              this.renderGrantMatches();
              loadingOverlay.style.display = 'none';
              matchesContainer.classList.remove('hidden');
            }, 500);
          } else {
            // No grants found, show empty state
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            setTimeout(() => {
              this.showNoMatches();
              loadingOverlay.style.display = 'none';
              matchesContainer.classList.remove('hidden');
            }, 500);
          }
        }).catch(error => {
          console.error('Error fetching grants:', error);
          
          // Show error state
          clearInterval(progressInterval);
          progressBar.style.width = '100%';
          
          setTimeout(() => {
            this.showNoMatches();
            loadingOverlay.style.display = 'none';
            matchesContainer.classList.remove('hidden');
          }, 500);
        });
      }
    },
    
    /**
     * Try multiple methods to fetch grants
     * Enhanced with multiple fallback approaches for reliable grant data
     */
    async tryFetchingGrants() {
      try {
        // Method 1: Try using window.grantAuraGrants if available
        if (typeof window.grantAuraGrants !== 'undefined' && window.grantAuraGrants.length > 0) {
          console.log('Using preloaded grants data');
          // Do client-side processing with the preloaded grants
          return {
            success: true,
            grants: window.grantAuraGrants,
            entity_type: this.entityType,
            entity_details: this.entityDetails,
            high_priority_fields: this.highPriorityFields
          };
        }
        
        // Method 2: Try to fetch using AJAX
        console.log('Fetching grants via AJAX');
        
        // Create a FormData object for the request
        const formData = new FormData();
        formData.append('action', 'get_grants');
        formData.append('entity_type', this.entityType);
        formData.append('entity_details', JSON.stringify(this.entityDetails));
        formData.append('nonce', this.nonce || '');
        
        // Figure out the admin-ajax.php URL
        let ajaxUrl = '/wp-admin/admin-ajax.php';
        if (typeof window.ajaxurl !== 'undefined') {
          ajaxUrl = window.ajaxurl;
        }
        
        // Make the AJAX request
        const response = await fetch(ajaxUrl, {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('Received grants data from AJAX:', data);
            return data.data; // WordPress AJAX wraps response in data property
          }
        }
        
        // Method 3: If both methods fail, try to simulate some grants for testing 
        // based on the user's criteria
        console.log('Generating fallback grants');
        const fallbackGrants = this.generateFallbackGrants();
        
        return {
          success: true,
          grants: fallbackGrants,
          entity_type: this.entityType,
          entity_details: this.entityDetails,
          high_priority_fields: this.highPriorityFields
        };
      } catch (error) {
        console.error('Error in all grant fetching methods:', error);
        
        // Return empty results on error
        return {
          success: false,
          grants: [],
          entity_type: this.entityType,
          entity_details: this.entityDetails,
          high_priority_fields: this.highPriorityFields,
          error: error.message
        };
      }
    },
    
    /**
     * Generate fallback grants for testing when server methods fail
     * This ensures users can still see some example results
     */
    generateFallbackGrants() {
      const currentDate = new Date();
      const oneMonthLater = new Date(currentDate);
      oneMonthLater.setMonth(currentDate.getMonth() + 1);
      
      // Format dates
      const formatDate = (date) => date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Generate grants based on entity type
      let fallbackGrants = [];
      
      // Common grants for all entity types (with different tailoring)
      const commonGrants = [
        {
          id: 1001,
          title: `${this.entityType === 'for_profit_business' ? 'Small Business' : 
                    this.entityType === 'nonprofit' ? 'Nonprofit' : 
                    this.entityType === 'individual' ? 'Individual' : 'Institution'} Innovation Grant`,
          description: `Supporting innovative projects for ${this.entityType.replace('_', ' ')}s looking to make a difference in their field or community.`,
          permalink: 'https://grantaura.com/apply/',
          amount: '$5,000 - $20,000',
          deadline: formatDate(oneMonthLater),
          funding_type: 'Grant',
          organization: 'Innovation Foundation',
          eligibility: `Open to all ${this.entityType.replace('_', ' ')}s with innovative projects. Must be based in the United States.`,
          categories: ['Innovation', 'Technology', this.entityType.replace('_', ' ').charAt(0).toUpperCase() + this.entityType.replace('_', ' ').slice(1)],
          locations: ['United States'],
          location: 'United States',
          match_score: 0,
          match_reasons: []
        },
        {
          id: 1002,
          title: `Community Impact ${this.entityType === 'for_profit_business' ? 'Business' : 
                    this.entityType === 'nonprofit' ? 'Organization' : 
                    this.entityType === 'individual' ? 'Individual' : 'Institution'} Grant`,
          description: 'Funding for projects that create measurable positive change in local communities.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$2,500 - $15,000',
          deadline: 'Ongoing',
          funding_type: 'Grant',
          organization: 'Community Foundation',
          eligibility: 'Projects must demonstrate clear community benefit with measurable outcomes.',
          categories: ['Community Development', 'Social Impact', this.entityType.replace('_', ' ').charAt(0).toUpperCase() + this.entityType.replace('_', ' ').slice(1)],
          locations: ['Multiple Locations'],
          location: 'Multiple Locations',
          match_score: 0,
          match_reasons: []
        }
      ];
      
      fallbackGrants = [...commonGrants];
      
      // Entity-specific grants
      switch (this.entityType) {
        case 'for_profit_business':
          fallbackGrants.push({
            id: 2001,
            title: 'Small Business Growth Grant',
            description: 'Funding to help small businesses expand operations, hire staff, or develop new products.',
            permalink: 'https://grantaura.com/apply/',
            amount: '$10,000 - $50,000',
            deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 45))),
            funding_type: 'Grant',
            organization: 'Business Development Fund',
            eligibility: 'Small businesses with fewer than 50 employees. Must have been in operation for at least 1 year.',
            categories: ['Small Business', 'Business Expansion', 'For-profit business'],
            locations: ['United States'],
            location: 'United States',
            match_score: 0,
            match_reasons: []
          });
          
          if (this.entityDetails.owner_demographics && 
              (this.entityDetails.owner_demographics.includes('women_owned') || 
               this.entityDetails.owner_demographics.includes('minority_owned'))) {
            fallbackGrants.push({
              id: 2002,
              title: 'Diversity in Business Grant Program',
              description: 'Supporting businesses owned by underrepresented groups to foster a more inclusive economy.',
              permalink: 'https://grantaura.com/apply/',
              amount: '$15,000 - $25,000',
              deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 20))),
              funding_type: 'Grant',
              organization: 'Economic Equity Initiative',
              eligibility: 'Businesses that are at least 51% owned by women, minorities, veterans, LGBTQ+ individuals, or people with disabilities.',
              categories: ['Diversity', 'Equity', 'Inclusion', 'For-profit business'],
              locations: ['Multiple Locations'],
              location: 'Multiple Locations',
              demographic_focus: 'Women, minorities, veterans, LGBTQ+, people with disabilities',
              match_score: 0,
              match_reasons: []
            });
          }
          break;
          
        case 'nonprofit':
          fallbackGrants.push({
            id: 3001,
            title: 'Nonprofit Capacity Building Grant',
            description: 'Funding to help nonprofits improve their operational efficiency and effectiveness.',
            permalink: 'https://grantaura.com/apply/',
            amount: '$5,000 - $30,000',
            deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 60))),
            funding_type: 'Grant',
            organization: 'Nonprofit Excellence Fund',
            eligibility: '501(c)(3) organizations looking to strengthen their infrastructure, systems, or staff capabilities.',
            categories: ['Nonprofit', 'Capacity Building', 'Organizational Development'],
            locations: ['United States'],
            location: 'United States',
            match_score: 0,
            match_reasons: []
          });
          
          if (this.entityDetails.focus_area) {
            const focusAreaTitles = {
              'education': 'Educational Program Grant',
              'environment': 'Environmental Conservation Grant',
              'health': 'Health & Wellness Program Grant',
              'arts': 'Arts & Culture Project Funding',
              'community': 'Community Development Initiative',
              'youth': 'Youth Development Program Grant'
            };
            
            if (focusAreaTitles[this.entityDetails.focus_area]) {
              const focusArea = this.entityDetails.focus_area;
              fallbackGrants.push({
                id: 3002,
                title: focusAreaTitles[focusArea],
                description: `Supporting nonprofit programs in the field of ${focusArea.replace('_', ' ')}.`,
                permalink: 'https://grantaura.com/apply/',
                amount: '$10,000 - $40,000',
                deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 30))),
                funding_type: 'Grant',
                organization: `${focusArea.charAt(0).toUpperCase() + focusArea.slice(1)} Foundation`,
                eligibility: `Nonprofit organizations with programs focused on ${focusArea.replace('_', ' ')}.`,
                categories: ['Nonprofit', focusArea.charAt(0).toUpperCase() + focusArea.slice(1)],
                locations: ['Multiple Locations'],
                location: 'Multiple Locations',
                match_score: 0,
                match_reasons: []
              });
            }
          }
          break;
          
        case 'individual':
          fallbackGrants.push({
            id: 4001,
            title: 'Individual Creative Project Grant',
            description: 'Funding for individual artists, writers, and creatives working on innovative projects.',
            permalink: 'https://grantaura.com/apply/',
            amount: '$1,000 - $10,000',
            deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 90))),
            funding_type: 'Grant',
            organization: 'Arts Foundation',
            eligibility: 'Individual artists, writers, musicians, filmmakers, and other creative professionals.',
            categories: ['Individual', 'Arts', 'Creative Projects'],
            locations: ['United States'],
            location: 'United States',
            match_score: 0,
            match_reasons: []
          });
          
          if (this.entityDetails.individual_type) {
            const individualTypeTitles = {
              'artist': 'Artist Development Grant',
              'student': 'Educational Scholarship',
              'researcher': 'Independent Research Grant',
              'entrepreneur': 'Solo Entrepreneur Startup Grant'
            };
            
            if (individualTypeTitles[this.entityDetails.individual_type]) {
              const indType = this.entityDetails.individual_type;
              fallbackGrants.push({
                id: 4002,
                title: individualTypeTitles[indType],
                description: `Supporting ${indType}s in developing their work and advancing in their field.`,
                permalink: 'https://grantaura.com/apply/',
                amount: indType === 'student' ? '$500 - $5,000' : 
                         indType === 'researcher' ? '$2,000 - $20,000' :
                         indType === 'entrepreneur' ? '$5,000 - $25,000' : '$1,000 - $7,500',
                deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 45))),
                funding_type: 'Grant',
                organization: `${indType.charAt(0).toUpperCase() + indType.slice(1)} Support Initiative`,
                eligibility: `Open to ${indType}s with demonstrated commitment to their field.`,
                categories: ['Individual', indType.charAt(0).toUpperCase() + indType.slice(1)],
                locations: ['Multiple Locations'],
                location: 'Multiple Locations',
                match_score: 0,
                match_reasons: []
              });
            }
          }
          break;
          
        case 'institution':
          fallbackGrants.push({
            id: 5001,
            title: 'Institutional Development Grant',
            description: 'Funding for institutions to enhance facilities, develop programs, or improve services.',
            permalink: 'https://grantaura.com/apply/',
            amount: '$25,000 - $100,000',
            deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 75))),
            funding_type: 'Grant',
            organization: 'Institutional Growth Foundation',
            eligibility: 'Educational, research, healthcare, government, and cultural institutions.',
            categories: ['Institution', 'Development', 'Capacity Building'],
            locations: ['United States'],
            location: 'United States',
            match_score: 0,
            match_reasons: []
          });
          
          if (this.entityDetails.institution_type) {
            const institutionTypeTitles = {
              'education': 'Educational Institution Enhancement Grant',
              'research': 'Research Facility Development Fund',
              'healthcare': 'Healthcare Institution Improvement Grant',
              'government': 'Government Entity Development Program',
              'cultural': 'Cultural Institution Support Grant'
            };
            
            if (institutionTypeTitles[this.entityDetails.institution_type]) {
              const instType = this.entityDetails.institution_type;
              fallbackGrants.push({
                id: 5002,
                title: institutionTypeTitles[instType],
                description: `Funding to help ${instType} institutions improve facilities, programs, and services.`,
                permalink: 'https://grantaura.com/apply/',
                amount: instType === 'government' ? '$50,000 - $250,000' : 
                         instType === 'research' ? '$25,000 - $150,000' : '$20,000 - $100,000',
                deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 60))),
                funding_type: 'Grant',
                organization: `${instType.charAt(0).toUpperCase() + instType.slice(1)} Excellence Fund`,
                eligibility: `Open to ${instType} institutions seeking to enhance their capabilities and services.`,
                categories: ['Institution', instType.charAt(0).toUpperCase() + instType.slice(1)],
                locations: ['Multiple Locations'],
                location: 'Multiple Locations',
                match_score: 0,
                match_reasons: []
              });
            }
          }
          break;
      }
      
      // Add keywords-based grant if keywords are provided
      if (this.entityDetails.keywords && this.entityDetails.keywords.length > 0) {
        // Take first two keywords for the title
        const keywordTitle = this.entityDetails.keywords
          .slice(0, 2)
          .map(k => k.charAt(0).toUpperCase() + k.slice(1))
          .join(' & ');
          
        fallbackGrants.push({
          id: 6001,
          title: `${keywordTitle} Innovation Grant`,
          description: `Funding for innovative projects related to ${this.entityDetails.keywords.join(', ')}.`,
          permalink: 'https://grantaura.com/apply/',
          amount: '$5,000 - $30,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 45))),
          funding_type: 'Grant',
          organization: 'Innovation Alliance',
          eligibility: `Open to all applicants with projects focused on ${this.entityDetails.keywords.join(', ')}.`,
          categories: [...this.entityDetails.keywords.map(k => k.charAt(0).toUpperCase() + k.slice(1)), 'Innovation'],
          locations: ['Multiple Locations'],
          location: 'Multiple Locations',
          match_score: 0,
          match_reasons: []
        });
      }
      
      // Add location-based grant if location is provided
      if (this.entityDetails.location && this.entityDetails.location !== 'global') {
        let locationName = this.entityDetails.location;
        
        // Check for US state
        if (this.entityDetails.location === 'united-states' && this.entityDetails.us_state) {
          locationName = this.entityDetails.us_state.replace('-', ' ');
          locationName = locationName.charAt(0).toUpperCase() + locationName.slice(1);
        }
        
        fallbackGrants.push({
          id: 6002,
          title: `${locationName} ${this.entityType === 'for_profit_business' ? 'Business' : 
                    this.entityType === 'nonprofit' ? 'Nonprofit' : 
                    this.entityType === 'individual' ? 'Individual' : 'Institution'} Development Grant`,
          description: `Supporting ${this.entityType.replace('_', ' ')}s based in ${locationName} with funding for growth and innovation.`,
          permalink: 'https://grantaura.com/apply/',
          amount: '$7,500 - $25,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 60))),
          funding_type: 'Grant',
          organization: `${locationName} Development Authority`,
          eligibility: `Must be based in ${locationName} and demonstrate commitment to local economic or social development.`,
          categories: [locationName, 'Regional Development', this.entityType.replace('_', ' ').charAt(0).toUpperCase() + this.entityType.replace('_', ' ').slice(1)],
          locations: [locationName],
          location: locationName,
          match_score: 0,
          match_reasons: []
        });
      }
      
      // Add more grants to create a larger set of options (10+ grants total)
      const additionalGrants = [
        {
          id: 7001,
          title: 'Digital Transformation Fund',
          description: 'Supporting organizations in implementing digital solutions to improve operations and services.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$15,000 - $35,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 80))),
          funding_type: 'Grant',
          organization: 'Technology Access Foundation',
          eligibility: 'Open to organizations looking to implement or upgrade their digital systems and processes.',
          categories: ['Technology', 'Digital Transformation', 'Innovation'],
          locations: ['United States', 'Canada', 'Global'],
          location: 'Multiple Locations',
          match_score: 0,
          match_reasons: []
        },
        {
          id: 7002,
          title: 'Sustainable Future Grant',
          description: 'Funding for projects that promote environmental sustainability and address climate change.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$10,000 - $50,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 90))),
          funding_type: 'Grant',
          organization: 'Environmental Solutions Coalition',
          eligibility: 'Projects must demonstrate clear environmental benefits and sustainable practices.',
          categories: ['Environment', 'Sustainability', 'Climate Action'],
          locations: ['Global'],
          location: 'Global',
          match_score: 0,
          match_reasons: []
        },
        {
          id: 7003,
          title: 'Community Resilience Fund',
          description: 'Supporting initiatives that strengthen community resilience against economic and social challenges.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$5,000 - $20,000',
          deadline: 'Ongoing',
          funding_type: 'Grant',
          organization: 'Community Resilience Network',
          eligibility: 'Projects must benefit local communities and demonstrate sustainable impact.',
          categories: ['Community Development', 'Social Impact', 'Resilience'],
          locations: ['United States'],
          location: 'United States',
          match_score: 0,
          match_reasons: []
        },
        {
          id: 7004,
          title: 'Healthcare Innovation Award',
          description: 'Funding for innovative approaches to healthcare delivery and wellness promotion.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$20,000 - $75,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 100))),
          funding_type: 'Grant',
          organization: 'Health Innovation Collaborative',
          eligibility: 'Open to organizations and individuals working on innovative healthcare solutions.',
          categories: ['Healthcare', 'Innovation', 'Wellness'],
          locations: ['United States', 'Canada', 'Global'],
          location: 'Multiple Locations',
          match_score: 0,
          match_reasons: []
        },
        {
          id: 7005,
          title: 'Workforce Development Initiative',
          description: 'Supporting programs that prepare individuals for in-demand careers and address skills gaps.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$10,000 - $30,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 75))),
          funding_type: 'Grant',
          organization: 'Workforce Alliance',
          eligibility: 'Programs must demonstrate ability to connect participants with sustainable career opportunities.',
          categories: ['Workforce Development', 'Education', 'Skills Training'],
          locations: ['United States'],
          location: 'United States',
          match_score: 0,
          match_reasons: []
        }
      ];
      
      fallbackGrants = [...fallbackGrants, ...additionalGrants];
      
      // Create a set of premium grants that will be shown only in admin mode
      const premiumGrants = [
        {
          id: 8001,
          title: 'Premium Enterprise Acceleration Grant',
          description: 'Exclusive funding opportunity for high-growth enterprises with proven business models and market traction.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$75,000 - $150,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 60))),
          funding_type: 'Grant',
          organization: 'Enterprise Growth Consortium',
          eligibility: 'Growing enterprises with established revenue and clear scaling strategy. Comprehensive application process with business plan review.',
          categories: ['Business Growth', 'Enterprise Development', 'Premium Grant'],
          locations: ['United States', 'Canada'],
          location: 'Multiple Locations',
          match_score: 0,
          match_reasons: [],
          isPremium: true
        },
        {
          id: 8002,
          title: 'Breakthrough Research & Innovation Fund',
          description: 'Major funding for groundbreaking research and innovation projects with potential for significant impact.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$50,000 - $250,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 90))),
          funding_type: 'Grant',
          organization: 'Advanced Research Institute',
          eligibility: 'Proven researchers and innovators with well-developed proposals and preliminary data or prototypes.',
          categories: ['Research', 'Innovation', 'Premium Grant'],
          locations: ['Global'],
          location: 'Global',
          match_score: 0,
          match_reasons: [],
          isPremium: true
        },
        {
          id: 8003,
          title: 'Social Impact Venture Fund',
          description: 'Strategic funding for social enterprises with proven models addressing critical social challenges.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$25,000 - $100,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 75))),
          funding_type: 'Grant',
          organization: 'Social Venture Partners',
          eligibility: 'Social enterprises with demonstrated impact, financial sustainability plan, and clear scaling strategy.',
          categories: ['Social Enterprise', 'Impact Investing', 'Premium Grant'],
          locations: ['United States', 'Global'],
          location: 'Multiple Locations',
          match_score: 0,
          match_reasons: [],
          isPremium: true
        },
        {
          id: 8004,
          title: 'Institutional Excellence Program',
          description: 'Comprehensive funding for institutional transformation and excellence initiatives.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$100,000 - $500,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 120))),
          funding_type: 'Grant',
          organization: 'Institutional Advancement Foundation',
          eligibility: 'Established institutions with strategic plans for comprehensive advancement and demonstrated leadership capacity.',
          categories: ['Institutional Development', 'Excellence', 'Premium Grant'],
          locations: ['United States'],
          location: 'United States',
          match_score: 0,
          match_reasons: [],
          isPremium: true
        },
        {
          id: 8005,
          title: 'Creative Excellence Award',
          description: 'Major funding for established creative professionals pursuing ambitious, field-defining projects.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$20,000 - $75,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 100))),
          funding_type: 'Grant',
          organization: 'Arts & Culture Trust',
          eligibility: 'Accomplished creative professionals with significant prior work and international recognition.',
          categories: ['Arts', 'Culture', 'Creative Excellence', 'Premium Grant'],
          locations: ['Global'],
          location: 'Global',
          match_score: 0,
          match_reasons: [],
          isPremium: true
        },
        {
          id: 8006,
          title: 'Nonprofit Transformation Initiative',
          description: 'Strategic funding for nonprofits undergoing major organizational transformation or expansion.',
          permalink: 'https://grantaura.com/apply/',
          amount: '$50,000 - $200,000',
          deadline: formatDate(new Date(currentDate.setDate(currentDate.getDate() + 90))),
          funding_type: 'Grant',
          organization: 'Nonprofit Leadership Consortium',
          eligibility: 'Established nonprofits with strategic plans for major transformation, strong leadership, and sustainable financial models.',
          categories: ['Nonprofit', 'Organizational Development', 'Premium Grant'],
          locations: ['United States'],
          location: 'United States',
          match_score: 0,
          match_reasons: [],
          isPremium: true
        }
      ];
      
      // Add premium grants to the list
      fallbackGrants = [...fallbackGrants, ...premiumGrants];
      
      return fallbackGrants;
    },
    
    /**
     * Show no matches UI with enhanced options for assistance
     */
    showNoMatches() {
      const matchesList = document.getElementById('matches-list');
      const matchesCount = document.getElementById('matches-count');
      const noMatches = document.getElementById('no-matches');
      const premiumSection = document.getElementById('premium-section');
      
      if (matchesList && matchesCount && noMatches) {
        matchesList.innerHTML = '';
        matchesCount.textContent = '0';
        noMatches.classList.remove('hidden');
        
        // Hide premium section
        if (premiumSection) {
          premiumSection.style.display = 'none';
        }
        
        // Setup try different criteria button
        const tryDiffBtn = document.getElementById('try-different-criteria');
        if (tryDiffBtn) {
          tryDiffBtn.addEventListener('click', () => this.goToStep(1));
        }
      }
    },
    
    /**
     * Process grant matches with enhanced algorithm
     * Strictly prioritizing: Entity type, Demographics/Focus areas, Location, Keywords
     */
    processGrantMatches() {
      if (!this.grants || this.grants.length === 0) return;
      
      console.log('Processing grants with high priority fields:', this.highPriorityFields);
      
      // Create a filtered array of grants that match all criteria
      let filteredGrants = [];
      
      // STAGE 1: First pass - strict filtering on ALL high priority fields
      // This ensures grants matching ALL high priority fields appear at the top
      for (const grant of this.grants) {
        if (this.matchesAllHighPriorityFields(grant, this.highPriorityFields)) {
          filteredGrants.push({...grant, strictMatch: true, priority_match: true});
        }
      }
      
      // STAGE 2: If not enough strict matches, look for grants matching SOME high priority fields
      // (must match at least 2 high priority fields, or all except one)
      const minimumPriorityMatches = Math.max(2, this.highPriorityFields.length - 1);
      if (filteredGrants.length < 5) {
        for (const grant of this.grants) {
          if (!filteredGrants.some(g => g.id === grant.id) && 
              this.matchesSomeHighPriorityFields(grant, this.highPriorityFields, minimumPriorityMatches)) {
            filteredGrants.push({...grant, strictMatch: false, priority_match: true});
          }
        }
      }
      
      // STAGE 3: If still not enough matches, try keyword and description text matching
      if (filteredGrants.length < 5 && (this.entityDetails.keywords?.length > 0 || this.entityDetails.funding_description)) {
        for (const grant of this.grants) {
          if (!filteredGrants.some(g => g.id === grant.id) && this.matchesKeywordsOrDescription(grant)) {
            filteredGrants.push({...grant, strictMatch: false, keywordMatch: true, priority_match: false});
          }
        }
      }
      
      // STAGE 4: If still not enough matches, include all grants but with lower scores
      if (filteredGrants.length < 5) {
        for (const grant of this.grants) {
          if (!filteredGrants.some(g => g.id === grant.id)) {
            filteredGrants.push({...grant, strictMatch: false, priority_match: false});
          }
          
          // Add at least 5 grants if possible
          if (filteredGrants.length >= 5) break;
        }
      }
      
      // Enhanced scoring algorithm with strict priorities
      filteredGrants = filteredGrants.map(grant => {
        const scoredGrant = {...grant};
        let score = 70; // Base score
        let matchReasons = [];
        
        // 1. ENTITY TYPE MATCHING - highest priority
        if (this.matchesEntityType(scoredGrant)) {
          score += 15; // High boost for matching entity type
          matchReasons.push(`Matches ${this.getEntityTypeDisplayName()}`);
        }
        
        // 2. DEMOGRAPHICS/FOCUS AREA MATCHING - second highest priority
        if (this.matchesDemographicsOrFocus(scoredGrant)) {
          score += 12;
          matchReasons.push(this.getDemographicsFocusMatchReason());
        }
        
        // 3. LOCATION MATCHING - third highest priority
        if (this.matchesLocation(scoredGrant, this.entityDetails.location)) {
          score += 10;
          matchReasons.push(`Located in ${this.getLocationDisplayName(this.entityDetails.location)}`);
        }
        
        // 4. KEYWORD MATCHING - fourth highest priority
        let keywordMatchScore = 0;
        if (this.entityDetails.keywords && this.entityDetails.keywords.length > 0) {
          const keywordMatches = this.getKeywordMatches(scoredGrant);
          keywordMatchScore = Math.min(8, keywordMatches.score);
          
          if (keywordMatches.matches.length > 0) {
            matchReasons.push(`Matches keywords: ${keywordMatches.matches.slice(0, 3).join(', ')}${keywordMatches.matches.length > 3 ? '...' : ''}`);
          }
        }
        score += keywordMatchScore;
        
        // Additional matches for remaining high priority fields
        // HIGH PRIORITY FIELD MATCHING - heavy score influence
        const fieldMatches = this.getFieldMatches(scoredGrant, this.highPriorityFields);
        for (const field of this.highPriorityFields) {
          // Skip fields we've already accounted for
          if (['entity_type', 'location', 'owner_demographics', 'individual_demographics', 'org_demographics', 'focus_area'].includes(field)) {
            continue;
          }
          
          if (fieldMatches[field]) {
            score += 5;
            matchReasons.push(`Matches ${this.getFieldDisplayName(field)}`);
          }
        }
        
        // SECONDARY FIELD MATCHING - moderate score influence
        // Go through all entity details to find matches beyond high priority
        for (const [key, value] of Object.entries(this.entityDetails)) {
          // Skip high priority fields (already counted) and skip keywords/description (counted separately)
          if (this.highPriorityFields.includes(key) || key === 'keywords' || key === 'funding_description' || key === 'entity_type') {
            continue;
          }
          
          if (this.fieldMatchesGrant(key, value, scoredGrant)) {
            score += 3;
            matchReasons.push(`Matches ${this.getFieldDisplayName(key)}`);
          }
        }
        
        // DESCRIPTION MATCHING - additional boost for description matches
        if (this.entityDetails.funding_description) {
          const descriptionMatches = this.getDescriptionMatches(scoredGrant);
          const descriptionScore = Math.min(5, descriptionMatches.score);
          score += descriptionScore;
          
          if (descriptionMatches.matches.length > 0 && descriptionScore > 2) {
            matchReasons.push(`Matches project description terms: ${descriptionMatches.matches.slice(0, 3).join(', ')}${descriptionMatches.matches.length > 3 ? '...' : ''}`);
          }
        }
        
        // Boost for 'priority_match' grants - these matched at least most high priority fields
        if (scoredGrant.priority_match) {
          score += 5;
        }
        
        // Boost for strict matches - these matched ALL high priority fields
        if (scoredGrant.strictMatch) {
          score += 7;
        }
        
        // If grant was flagged as search relevant from backend, give small boost
        if (scoredGrant.search_relevance) {
          score += 3;
        }
        
        // Add slight randomness to prevent ties (range of -1 to +1)
        const randomFactor = Math.floor(Math.random() * 3) - 1;
        score += randomFactor;
        
        // Ensure score stays within reasonable bounds
        score = Math.min(99, Math.max(60, score));
        
        // Update the score and match reasons
        scoredGrant.match_score = Math.round(score);
        scoredGrant.match_reasons = matchReasons;
        
        return scoredGrant;
      });
      
      // Sort grants by match score (highest first)
      filteredGrants.sort((a, b) => b.match_score - a.match_score);
      
      // Separate premium grants from regular grants
      const regularGrants = filteredGrants.filter(grant => !grant.isPremium);
      const premiumGrants = filteredGrants.filter(grant => grant.isPremium);
      
      // Calculate how many regular grants to show (5-10 grants)
      const numRegularToShow = Math.min(
        Math.max(5, Math.floor(regularGrants.length * 0.5)), // At least 5, at most 50% of available grants
        10 // Maximum 10 free grants
      );
      
      // Update premium grant count for display
      this.premiumGrantCount = this.isAdminMode ?
        premiumGrants.length :
        Math.max(5, filteredGrants.length - numRegularToShow); // At least 5 premium grants or whatever is available
        
      // Update premium count in UI
      const premiumCountElement = document.getElementById('premium-count');
      if (premiumCountElement) {
        premiumCountElement.textContent = this.premiumGrantCount;
      }
      
      // In admin mode, show all grants. Otherwise, only show the selected number of regular grants
      this.grants = this.isAdminMode ? 
        filteredGrants : 
        regularGrants.slice(0, numRegularToShow);
      
      console.log('Processed grants:', this.grants);
      console.log('Premium grants count:', this.premiumGrantCount);
    },
    
    /**
     * Get entity type display name for UI
     */
    getEntityTypeDisplayName() {
      const displayNames = {
        'for_profit_business': 'For-profit Business',
        'nonprofit': 'Nonprofit Organization',
        'individual': 'Individual',
        'institution': 'Institution/Organization'
      };
      
      return displayNames[this.entityType] || this.entityType.replace('_', ' ');
    },
    
    /**
     * Get demographic/focus match reason text
     */
    getDemographicsFocusMatchReason() {
      switch (this.entityType) {
        case 'for_profit_business':
          if (this.entityDetails.owner_demographics && this.entityDetails.owner_demographics.length > 0 && !this.entityDetails.owner_demographics.includes('none')) {
            const demographics = this.entityDetails.owner_demographics.map(d => {
              const display = d.replace('_owned', '').replace('_', ' ');
              return display.charAt(0).toUpperCase() + display.slice(1);
            });
            return `For ${demographics.join('/')} owned businesses`;
          }
          return 'Matches business demographics';
          
        case 'nonprofit':
          if (this.entityDetails.focus_area) {
            return `Matches ${this.entityDetails.focus_area.replace('_', ' ')} focus area`;
          }
          return 'Matches organization focus area';
          
        case 'individual':
          if (this.entityDetails.individual_demographics && this.entityDetails.individual_demographics.length > 0 && !this.entityDetails.individual_demographics.includes('none')) {
            const demographics = this.entityDetails.individual_demographics.map(d => {
              const display = d.replace('_', ' ');
              return display.charAt(0).toUpperCase() + display.slice(1);
            });
            return `For ${demographics.join('/')} individuals`;
          }
          return 'Matches individual demographics';
          
        case 'institution':
          return 'Matches institution type';
      }
    },
    
    /**
     * Get location display name
     */
    getLocationDisplayName(location) {
      const displayNames = {
        'united-states': 'United States',
        'global': 'Global',
        'other-us': 'Other US State',
        'international': 'International'
      };
      
      return displayNames[location] || location.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    },
    
    /**
     * Get keyword matches with score and matched terms
     */
    getKeywordMatches(grant) {
      let matches = [];
      let score = 0;
      
      if (!this.entityDetails.keywords || this.entityDetails.keywords.length === 0) {
        return { score, matches };
      }
      
      // Prepare search text from grant
      const searchText = [
        grant.title || '', 
        grant.description || '', 
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      // Check each keyword
      for (const keyword of this.entityDetails.keywords) {
        const lowerKeyword = keyword.toLowerCase();
        
        // Title match (highest score)
        if (grant.title.toLowerCase().includes(lowerKeyword)) {
          score += 2.5;
          matches.push(keyword);
          continue; // Skip other checks for this keyword
        }
        
        // Description match
        if (grant.description.toLowerCase().includes(lowerKeyword)) {
          score += 1.5;
          matches.push(keyword);
          continue;
        }
        
        // Category match
        if (Array.isArray(grant.categories) && grant.categories.some(cat => cat.toLowerCase().includes(lowerKeyword))) {
          score += 1.5;
          matches.push(keyword);
          continue;
        }
        
        // Other fields match
        if (searchText.includes(lowerKeyword)) {
          score += 1;
          matches.push(keyword);
        }
      }
      
      // De-duplicate matched keywords
      matches = [...new Set(matches)];
      
      return { score, matches };
    },
    
    /**
     * Get description matches with score and matched terms
     */
    getDescriptionMatches(grant) {
      let matches = [];
      let score = 0;
      
      if (!this.entityDetails.funding_description) {
        return { score, matches };
      }
      
      // Extract meaningful words from description
      const description = this.entityDetails.funding_description.toLowerCase();
      const stopWords = new Set(['a', 'an', 'the', 'and', 'or', 'but', 'if', 'then', 'else', 'when', 'at', 'from', 'by', 'for', 'with', 'about', 'to', 'in', 'on', 'that', 'this', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'can', 'may', 'might']);
      
      const descWords = description.split(/\s+/).filter(word => 
        word.length > 4 && !stopWords.has(word)
      );
      
      // Prepare search text from grant
      const titleText = grant.title.toLowerCase();
      const descriptionText = grant.description.toLowerCase();
      const contentText = (grant.content || '').toLowerCase();
      
      // Check each meaningful word
      for (const word of descWords) {
        // Title match (highest score)
        if (titleText.includes(word)) {
          score += 0.8;
          matches.push(word);
          continue;
        }
        
        // Description match
        if (descriptionText.includes(word)) {
          score += 0.5;
          matches.push(word);
          continue;
        }
        
        // Content match
        if (contentText.includes(word)) {
          score += 0.3;
          matches.push(word);
        }
      }
      
      // De-duplicate matched words
      matches = [...new Set(matches)];
      
      return { score, matches };
    },
    
    /**
     * Check if a grant matches the entity type (highest priority)
     */
    matchesEntityType(grant) {
      if (!grant) return false;
      
      const entityTypePatterns = {
        'for_profit_business': ['business', 'for-profit', 'company', 'small business', 'startup', 'entrepreneur', 'for profit'],
        'nonprofit': ['nonprofit', 'non-profit', 'not-for-profit', '501(c)(3)', 'charity', 'foundation', 'ngo'],
        'individual': ['individual', 'person', 'artist', 'student', 'researcher', 'scholar'],
        'institution': ['institution', 'organization', 'university', 'college', 'school', 'hospital', 'museum', 'library']
      };
      
      const patterns = entityTypePatterns[this.entityType] || [];
      if (patterns.length === 0) return false;
      
      // Search in categories, eligibility, and title with high priority
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.title || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Check if a grant matches demographics or focus area (second highest priority)
     */
    matchesDemographicsOrFocus(grant) {
      if (!grant) return false;
      
      switch (this.entityType) {
        case 'for_profit_business':
          return this.matchesDemographics(grant, this.entityDetails.owner_demographics);
          
        case 'nonprofit':
          return this.matchesFocusArea(grant, this.entityDetails.focus_area);
          
        case 'individual':
          return this.matchesDemographics(grant, this.entityDetails.individual_demographics);
          
        case 'institution':
          return this.matchesInstitutionType(grant, this.entityDetails.institution_type);
          
        default:
          return false;
      }
    },
    
    /**
     * Check if a grant matches all high priority fields
     */
    matchesAllHighPriorityFields(grant, highPriorityFields) {
      for (const field of highPriorityFields) {
        if (!this.fieldMatchesGrant(field, this.entityDetails[field], grant)) {
          return false;
        }
      }
      return true;
    },
    
    /**
     * Check if a grant matches at least N high priority fields
     */
    matchesSomeHighPriorityFields(grant, highPriorityFields, minMatches) {
      let matchCount = 0;
      
      for (const field of highPriorityFields) {
        if (this.fieldMatchesGrant(field, this.entityDetails[field], grant)) {
          matchCount++;
          if (matchCount >= minMatches) {
            return true;
          }
        }
      }
      
      return false;
    },
    
    /**
     * Get all field matches for a grant
     */
    getFieldMatches(grant, highPriorityFields) {
      const matches = {};
      
      for (const field of highPriorityFields) {
        matches[field] = this.fieldMatchesGrant(field, this.entityDetails[field], grant);
      }
      
      return matches;
    },
    
    /**
     * Check if a grant matches keywords or description
     */
    matchesKeywordsOrDescription(grant) {
      // Check keywords
      if (this.entityDetails.keywords && this.entityDetails.keywords.length > 0) {
        for (const keyword of this.entityDetails.keywords) {
          const lowerKeyword = keyword.toLowerCase();
          
          // Check in title, description, categories and all metadata
          if (grant.title.toLowerCase().includes(lowerKeyword) || 
              grant.description.toLowerCase().includes(lowerKeyword) ||
              (Array.isArray(grant.categories) && grant.categories.some(cat => cat.toLowerCase().includes(lowerKeyword))) ||
              (grant.meta_combined && grant.meta_combined.toLowerCase().includes(lowerKeyword)) ||
              (grant.content && grant.content.toLowerCase().includes(lowerKeyword))) {
            return true;
          }
        }
      }
      
      // Check description
      if (this.entityDetails.funding_description) {
        const description = this.entityDetails.funding_description.toLowerCase();
        const stopWords = new Set(['a', 'an', 'the', 'and', 'or', 'but', 'if', 'then', 'else', 'when', 'at', 'from', 'by', 'for', 'with', 'about', 'to', 'in', 'on', 'that', 'this', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'can', 'may', 'might']);
        
        const significantWords = description.split(/\s+/).filter(word => 
          word.length > 4 && !stopWords.has(word)
        );
        
        // Check for at least 3 significant words
        let matchCount = 0;
        for (const word of significantWords) {
          if (grant.title.toLowerCase().includes(word) || 
              grant.description.toLowerCase().includes(word) ||
              (grant.content && grant.content.toLowerCase().includes(word)) || 
              (grant.meta_combined && grant.meta_combined.toLowerCase().includes(word))) {
            matchCount++;
            if (matchCount >= 3) {
              return true;
            }
          }
        }
      }
      
      return false;
    },
    
    /**
     * Check if a specific field matches a grant with field-specific logic
     */
    fieldMatchesGrant(field, value, grant) {
      if (!value || (Array.isArray(value) && value.length === 0)) {
        return true; // If no value is provided, consider it a match
      }
      
      switch (field) {
        case 'entity_type':
          return this.matchesEntityType(grant);
        
        case 'business_type':
          return this.matchesBusinessType(grant, value);
        
        case 'industry':
          return this.matchesIndustry(grant, value);
        
        case 'years_in_operation':
          return this.matchesYearsInOperation(grant, value);
        
        case 'location':
          return this.matchesLocation(grant, value);
        
        case 'owner_demographics':
        case 'org_demographics':
        case 'individual_demographics':
          return this.matchesDemographics(grant, value);
        
        case 'nonprofit_type':
          return this.matchesNonprofitType(grant, value);
        
        case 'focus_area':
          return this.matchesFocusArea(grant, value);
        
        case 'individual_type':
          return this.matchesIndividualType(grant, value);
        
        case 'funding_need':
          return this.matchesFundingNeed(grant, value);
        
        case 'funding_purpose':
        case 'grant_purpose':
          return this.matchesFundingPurpose(grant, value);
        
        case 'institution_type':
          return this.matchesInstitutionType(grant, value);
        
        case 'tax_status':
          return this.matchesTaxStatus(grant, value);
        
        default:
          return this.matchesGenericField(grant, field, value);
      }
    },
    
    /**
     * Business Type matching
     */
    matchesBusinessType(grant, businessType) {
      if (!grant || !businessType) return false;
      
      const businessTypePatterns = {
        'small_business': ['small business', 'small-business', 'small businesses', 'brick mortar', 'sme', 'small enterprise'],
        'startup': ['startup', 'start-up', 'startups', 'new business', 'early stage', 'emerging business'],
        'medium_business': ['medium business', 'established business', 'growing business', 'mid-size', 'medium-size']
      };
      
      const patterns = businessTypePatterns[businessType] || [];
      if (patterns.length === 0) return false;
      
      // Search in title, description, categories, eligibility, and content
      const searchText = [
        grant.title || '', 
        grant.description || '', 
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Industry matching
     */
    matchesIndustry(grant, industry) {
      if (!grant || !industry) return false;
      
      const industryPatterns = {
        'agriculture': ['agriculture', 'farming', 'food production', 'agricultural', 'farm', 'crops', 'livestock'],
        'construction': ['construction', 'building', 'infrastructure', 'contractor', 'construction industry'],
        'manufacturing': ['manufacturing', 'production', 'industrial', 'factory', 'fabrication'],
        'technology': ['technology', 'tech', 'software', 'digital', 'it', 'computer', 'information technology'],
        'retail': ['retail', 'e-commerce', 'store', 'shop', 'merchant', 'selling', 'commerce'],
        'healthcare': ['healthcare', 'medical', 'health', 'wellness', 'hospital', 'clinic', 'patient care'],
        'education': ['education', 'teaching', 'learning', 'school', 'academic', 'training', 'educational'],
        'hospitality': ['hospitality', 'restaurant', 'hotel', 'tourism', 'food service', 'accommodation'],
        'arts': ['arts', 'creative', 'entertainment', 'culture', 'music', 'film', 'design', 'performing arts'],
        'professional': ['professional services', 'consulting', 'legal', 'accounting', 'advisory', 'business services'],
        'green_energy': ['renewable energy', 'green energy', 'solar', 'wind', 'sustainable energy', 'clean energy'],
        'transportation': ['transportation', 'logistics', 'shipping', 'freight', 'transit', 'trucking'],
        'finance': ['finance', 'financial services', 'banking', 'investment', 'financial', 'money', 'capital']
      };
      
      const patterns = industryPatterns[industry] || [];
      if (patterns.length === 0) return false;
      
      // Search in title, description, categories, industry_focus, and content
      const searchText = [
        grant.title || '', 
        grant.description || '', 
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.industry_focus || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Years in operation matching
     */
    matchesYearsInOperation(grant, yearsInOperation) {
      if (!grant) return false;
      
      // Specific check for minimum years requirement
      if (grant.minimum_years) {
        const minimumYears = parseInt(grant.minimum_years, 10);
        if (!isNaN(minimumYears)) {
          // Map user years to numeric value
          let userYears = 0;
          
          switch(yearsInOperation) {
            case 'pre_launch': userYears = 0; break;
            case '0_1': userYears = 0; break;
            case '1_2': userYears = 1; break;
            case '3_5': userYears = 3; break;
            case '6_10': userYears = 6; break;
            case '10_plus': userYears = 10; break;
            case '11_20': userYears = 11; break;
            case '21_50': userYears = 21; break;
            case '50_plus': userYears = 50; break;
            case '0_5': userYears = 0; break;
            default: userYears = 0;
          }
          
          return userYears >= minimumYears;
        }
      }
      
      // Generic pattern matching for years
      const yearsPatterns = {
        'pre_launch': ['pre-launch', 'pre launch', 'planning stage', 'startup', 'new organization', 'concept stage'],
        '0_1': ['less than 1 year', 'under 1 year', 'new organization', '< 1 year', 'newly established'],
        '1_2': ['1-2 years', '1 to 2 years', 'one to two years', 'early stage', 'recently established'],
        '3_5': ['3-5 years', '3 to 5 years', 'three to five years', 'established', 'developing business'],
        '6_10': ['6-10 years', '6 to 10 years', 'well established', 'experienced'],
        '10_plus': ['more than 10 years', 'over 10 years', '10+ years', 'long-standing', 'mature business'],
        '11_20': ['11-20 years', '11 to 20 years', 'established organization', 'mature organization'],
        '21_50': ['21-50 years', '21 to 50 years', 'long-established', 'decades of experience'],
        '50_plus': ['more than 50 years', 'over 50 years', '50+ years', 'historic', 'longstanding'],
        '0_5': ['0-5 years', 'under 5 years', 'less than 5 years', 'new', 'startup', 'recently established']
      };
      
      const patterns = yearsPatterns[yearsInOperation] || [];
      if (patterns.length === 0) return false;
      
      // Search in eligibility, description, and content
      const searchText = [
        grant.eligibility || '', 
        grant.description || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      // If no explicit years requirement is found, consider it a match
      if (!/years|year old|operating|established|history|stage|experience/i.test(searchText)) {
        return true;
      }
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Enhanced location matching with geographic hierarchy
     */
    matchesLocation(grant, location) {
      if (!grant) return false;
      
      // Handle cases where grant may not have locations array but has location string
      const grantLocations = grant.locations || (grant.location ? [grant.location] : []);
      if (grantLocations.length === 0) return false;
      
      const userLoc = location.toLowerCase();
      
      // Check directly against all locations in the grant
      for (const grantLoc of grantLocations) {
        const lowerGrantLoc = grantLoc.toLowerCase();
        
        // Direct match
        if (lowerGrantLoc === userLoc || lowerGrantLoc.includes(userLoc) || userLoc.includes(lowerGrantLoc)) {
          return true;
        }
      }
      
      // Location aliases for common locations
      const locationAliases = {
        'united-states': ['usa', 'us', 'america', 'united states', 'national', 'nationwide', 'u.s.', 'u.s.a.'],
        'global': ['international', 'worldwide', 'world', 'global', 'all countries', 'any country'],
        'california': ['ca', 'calif', 'cali', 'golden state'],
        'new-york': ['ny', 'new york state', 'empire state', 'nys'],
        'texas': ['tx', 'lone star state'],
        'florida': ['fl', 'sunshine state'],
        'illinois': ['il', 'prairie state'],
        'international': ['global', 'worldwide', 'foreign countries', 'outside us', 'outside united states']
      };
      
      // Check aliases against all grant locations
      if (locationAliases[userLoc]) {
        for (const grantLoc of grantLocations) {
          const lowerGrantLoc = grantLoc.toLowerCase();
          if (locationAliases[userLoc].some(alias => lowerGrantLoc.includes(alias))) {
            return true;
          }
        }
      }
      
      // Geographic hierarchy checks
      // 1. For US states, match with "United States"
      const usStates = ['alabama', 'alaska', 'arizona', 'arkansas', 'california', 'colorado', 
                         'connecticut', 'delaware', 'florida', 'georgia', 'hawaii', 'idaho', 
                         'illinois', 'indiana', 'iowa', 'kansas', 'kentucky', 'louisiana', 
                         'maine', 'maryland', 'massachusetts', 'michigan', 'minnesota', 
                         'mississippi', 'missouri', 'montana', 'nebraska', 'nevada', 
                         'new-hampshire', 'new-jersey', 'new-mexico', 'new-york', 'north-carolina', 
                         'north-dakota', 'ohio', 'oklahoma', 'oregon', 'pennsylvania', 
                         'rhode-island', 'south-carolina', 'south-dakota', 'tennessee', 'texas', 
                         'utah', 'vermont', 'virginia', 'washington', 'west-virginia', 
                         'wisconsin', 'wyoming', 'district-of-columbia', 'other-us'];
      
      // If user selected US state, check if grant covers United States
      if (usStates.includes(userLoc)) {
        for (const grantLoc of grantLocations) {
          const lowerGrantLoc = grantLoc.toLowerCase();
          if (lowerGrantLoc.includes('united states') || lowerGrantLoc.includes('usa') || 
              lowerGrantLoc.includes('national') || lowerGrantLoc.includes('nationwide') || 
              lowerGrantLoc.includes('us') || lowerGrantLoc.includes('u.s.')) {
            return true;
          }
        }
      }
      
      // 2. For "global", match with anything
      if (userLoc === 'global') {
        return true;
      }
      
      // 3. For "international", match with global
      if (userLoc === 'international') {
        for (const grantLoc of grantLocations) {
          const lowerGrantLoc = grantLoc.toLowerCase();
          if (lowerGrantLoc.includes('global') || lowerGrantLoc.includes('world') || 
              lowerGrantLoc.includes('worldwide') || lowerGrantLoc.includes('international')) {
            return true;
          }
        }
      }
      
      // Check for location in eligibility text
      if (grant.eligibility) {
        const eligibilityText = grant.eligibility.toLowerCase();
        
        if (eligibilityText.includes(userLoc) || 
            (locationAliases[userLoc] && locationAliases[userLoc].some(alias => eligibilityText.includes(alias)))) {
          return true;
        }
        
        // Check for "nationwide" or similar in eligibility when user selected a US state
        if (usStates.includes(userLoc) && 
            (eligibilityText.includes('nationwide') || eligibilityText.includes('national') || 
             eligibilityText.includes('all states') || eligibilityText.includes('any state') ||
             eligibilityText.includes('united states') || eligibilityText.includes('across america'))) {
          return true;
        }
      }
      
      // Check content for location references
      if (grant.content) {
        const contentText = grant.content.toLowerCase();
        if (contentText.includes(userLoc) || 
            (locationAliases[userLoc] && locationAliases[userLoc].some(alias => contentText.includes(alias)))) {
          return true;
        }
      }
      
      return false;
    },
    
    /**
     * Demographics matching with improved detection of target groups
     */
    matchesDemographics(grant, demographics) {
      if (!grant || !demographics || !Array.isArray(demographics) || demographics.length === 0) {
        return false;
      }
      
      // If "none" is selected, match grants with no specific demographic focus
      if (demographics.includes('none')) {
        return !this.hasAnyDemographicFocus(grant);
      }
      
      const demographicPatterns = {
        // Women
        'women_owned': ['women-owned', 'women owned', 'female owned', 'women business', 'woman-owned', 'female entrepreneur'],
        'women_led': ['women-led', 'women led', 'female led', 'women executives', 'female leadership'],
        'woman': ['women', 'woman', 'female', 'girls', 'gender equity', 'gender equality'],
        
        // Minority/BIPOC
        'minority_owned': ['minority-owned', 'minority owned', 'diverse business', 'bipoc owned', 'poc owned', 'diverse owned'],
        'bipoc_led': ['bipoc-led', 'bipoc led', 'diverse leadership', 'minority led', 'diverse led'],
        'bipoc': ['bipoc', 'people of color', 'minorities', 'black', 'latina', 'latino', 'hispanic', 'asian', 'african american', 'diversity'],
        
        // Veterans
        'veteran_owned': ['veteran-owned', 'veteran owned', 'veteran entrepreneurs', 'vet owned'],
        'veteran_led': ['veteran-led', 'veteran led', 'veteran leadership', 'vet led'],
        'veteran': ['veteran', 'veterans', 'military', 'service member', 'ex-military', 'former military', 'armed forces'],
        
        // Disabilities
        'disability_owned': ['disability-owned', 'owned by person with disability', 'disabled owned', 'differently abled owned'],
        'disability_led': ['disability-led', 'led by person with disability', 'disabled led'],
        'disability': ['disability', 'disabilities', 'disabled', 'differently abled', 'special needs', 'accessibility', 'ADA', 'inclusive'],
        
        // LGBTQIA+
        'lgbtqia_owned': ['lgbtqia-owned', 'lgbtq owned', 'lgbt owned', 'lgbtqia owned', 'queer owned'],
        'lgbtqia_led': ['lgbtqia-led', 'lgbtq led', 'lgbt led', 'lgbtqia led', 'queer led'],
        'lgbtqia': ['lgbtqia', 'lgbtq', 'lgbt', 'gay', 'lesbian', 'transgender', 'non-binary', 'queer', 'sexual orientation'],
        
        // Rural
        'rural_based': ['rural-based', 'rural', 'small town', 'non-urban', 'countryside', 'rural community'],
        'rural': ['rural', 'small town', 'non-urban', 'countryside', 'farm', 'agricultural community'],
        
        // Other
        'low_income': ['low income', 'low-income', 'economically disadvantaged', 'poverty', 'underserved', 'financial hardship'],
        'first_gen': ['first generation', 'first-generation', 'first gen', 'first-gen', 'first in family']
      };
      
      // Combined search in all relevant fields to maximize match potential
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.demographic_focus || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      // Look for explicit demographic focus in grant
      if (grant.demographic_focus) {
        const demFocus = grant.demographic_focus.toLowerCase();
        for (const demographic of demographics) {
          const patterns = demographicPatterns[demographic] || [];
          if (patterns.some(pattern => demFocus.includes(pattern))) {
            return true;
          }
        }
      }
      
      // Check for demographic terms in various fields
      for (const demographic of demographics) {
        const patterns = demographicPatterns[demographic] || [];
        if (patterns.length > 0 && patterns.some(pattern => searchText.includes(pattern))) {
          return true;
        }
      }
      
      // Special case: Check for demographic categories
      const catText = Array.isArray(grant.categories) ? grant.categories.join(' ').toLowerCase() : '';
      
      if (demographics.includes('women_owned') || demographics.includes('woman')) {
        if (catText.includes('women') || catText.includes('woman') || catText.includes('female')) {
          return true;
        }
      }
      
      if (demographics.includes('minority_owned') || demographics.includes('bipoc')) {
        if (catText.includes('minority') || catText.includes('bipoc') || catText.includes('black') || 
            catText.includes('hispanic') || catText.includes('asian') || catText.includes('latino')) {
          return true;
        }
      }
      
      if (demographics.includes('veteran_owned') || demographics.includes('veteran')) {
        if (catText.includes('veteran') || catText.includes('military')) {
          return true;
        }
      }
      
      if (demographics.includes('disability_owned') || demographics.includes('disability')) {
        if (catText.includes('disability') || catText.includes('disabled') || catText.includes('special needs')) {
          return true;
        }
      }
      
      if (demographics.includes('lgbtqia_owned') || demographics.includes('lgbtqia')) {
        if (catText.includes('lgbtq') || catText.includes('lgbt') || catText.includes('gay') || 
            catText.includes('lesbian') || catText.includes('transgender')) {
          return true;
        }
      }
      
      return false;
    },
    
    /**
     * Check if a grant has any demographic focus
     */
    hasAnyDemographicFocus(grant) {
      const demographicTerms = [
        'women', 'woman', 'female', 'minority', 'bipoc', 'black', 'hispanic', 'latino', 'latina',
        'veteran', 'military', 'disability', 'disabled', 'special needs', 'lgbtq', 'gay', 'lesbian',
        'transgender', 'rural', 'low income', 'underserved', 'disadvantaged', 'first generation'
      ];
      
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.demographic_focus || '',
        grant.title || '',
        grant.meta_combined || ''
      ].join(' ').toLowerCase();
      
      return demographicTerms.some(term => searchText.includes(term));
    },
    
    /**
     * Nonprofit Type matching
     */
    matchesNonprofitType(grant, nonprofitType) {
      if (!grant || !nonprofitType) return false;
      
      const nonprofitTypePatterns = {
        '501c3': ['501c3', '501(c)(3)', 'public charity', 'private foundation', 'tax-exempt', 'charitable organization'],
        '501c4': ['501c4', '501(c)(4)', 'social welfare', 'civic league', 'community organization', 'advocacy'],
        '501c6': ['501c6', '501(c)(6)', 'business league', 'chamber of commerce', 'trade association', 'professional association'],
        'other_nonprofit': ['501c7', '501(c)(7)', 'other nonprofit', 'nonprofit', 'non-profit', 'not-for-profit', 'ngo']
      };
      
      const patterns = nonprofitTypePatterns[nonprofitType] || [];
      if (patterns.length === 0) return false;
      
      // Search in categories, eligibility, description, title, and content
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Focus Area matching with expanded terms for better matching
     */
    matchesFocusArea(grant, focusArea) {
      if (!grant || !focusArea) return false;
      
      const focusAreaPatterns = {
        'education': ['education', 'school', 'learning', 'teaching', 'student', 'academic', 'curriculum', 'classroom', 'educational'],
        'environment': ['environment', 'conservation', 'climate', 'sustainability', 'renewable', 'green', 'ecology', 'environmental', 'nature'],
        'health': ['health', 'healthcare', 'medical', 'wellness', 'hospital', 'patient', 'disease', 'treatment', 'care', 'well-being'],
        'arts': ['arts', 'culture', 'creative', 'museum', 'performing arts', 'visual arts', 'artist', 'cultural', 'artistic', 'exhibition'],
        'community': ['community development', 'community', 'neighborhood', 'local', 'urban development', 'city', 'civic', 'municipal'],
        'civil_rights': ['civil rights', 'advocacy', 'justice', 'equality', 'human rights', 'rights', 'fair', 'equity', 'policy', 'advocate'],
        'religious': ['religious', 'faith', 'church', 'spiritual', 'ministry', 'worship', 'congregation', 'religion', 'temple', 'mosque'],
        'disaster': ['disaster', 'emergency', 'relief', 'crisis', 'humanitarian', 'recovery', 'aid', 'response', 'urgent'],
        'international': ['international', 'global', 'worldwide', 'foreign', 'developing countries', 'cross-border', 'multinational'],
        'animal': ['animal', 'wildlife', 'zoo', 'veterinary', 'pet', 'rescue', 'shelter', 'species', 'fauna', 'conservation'],
        'youth': ['youth', 'children', 'teen', 'adolescent', 'young adult', 'kids', 'juvenile', 'minor', 'childhood', 'young people'],
        'housing': ['housing', 'homeless', 'shelter', 'affordable housing', 'homelessness', 'residence', 'home', 'apartment', 'dwelling'],
        'food': ['food', 'hunger', 'nutrition', 'meal', 'food bank', 'food pantry', 'diet', 'nourishment', 'feed', 'agricultural']
      };
      
      const patterns = focusAreaPatterns[focusArea] || [];
      if (patterns.length === 0) return true; // If focus area is 'other', don't restrict
      
      // Search in categories, eligibility, description, title, and content
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Individual Type matching with expanded patterns
     */
    matchesIndividualType(grant, individualType) {
      if (!grant || !individualType) return false;
      
      const individualTypePatterns = {
        'artist': ['artist', 'creative', 'arts', 'writer', 'musician', 'performer', 'visual artist', 'dancer', 'filmmaker', 'photographer', 'author', 'composer'],
        'student': ['student', 'education', 'school', 'college', 'university', 'academic', 'scholarship', 'tuition', 'degree', 'graduate', 'undergraduate', 'learner'],
        'researcher': ['researcher', 'research', 'academic', 'study', 'science', 'investigation', 'laboratory', 'field work', 'scholar', 'PhD', 'scientific', 'analysis'],
        'entrepreneur': ['entrepreneur', 'business owner', 'startup', 'small business', 'venture', 'self-employed', 'founder', 'business idea', 'enterprise', 'innovator']
      };
      
      const patterns = individualTypePatterns[individualType] || [];
      if (patterns.length === 0) return false;
      
      // Search in categories, eligibility, description, title, and content
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Funding Need matching
     */
    matchesFundingNeed(grant, fundingNeed) {
      if (!grant || !fundingNeed) return false;
      
      const fundingNeedPatterns = {
        'education': ['education', 'tuition', 'school', 'college', 'university', 'scholarship', 'academic', 'degree', 'student', 'learning'],
        'artistic': ['artistic project', 'arts', 'creative project', 'exhibition', 'performance', 'art installation', 'show', 'concert', 'production'],
        'research': ['research project', 'research', 'study', 'investigation', 'academic research', 'experiment', 'data collection', 'fieldwork'],
        'business': ['business startup', 'startup funding', 'new business', 'entrepreneurship', 'venture', 'business idea', 'enterprise'],
        'medical': ['medical expenses', 'healthcare costs', 'treatment', 'medical care', 'health expenses', 'hospital', 'therapy', 'medication'],
        'travel': ['travel', 'study abroad', 'international travel', 'educational travel', 'field trip', 'expedition', 'journey', 'exchange program'],
        'community': ['community project', 'community initiative', 'community development', 'neighborhood', 'local project', 'civic engagement'],
        'professional': ['professional development', 'career advancement', 'skills training', 'certification', 'continuing education', 'workshop'],
        'equipment': ['equipment', 'supplies', 'materials', 'hardware', 'technology purchase', 'tools', 'gear', 'instruments', 'machinery'],
        'living': ['living expenses', 'housing', 'rent', 'basic needs', 'cost of living', 'subsistence', 'daily expenses', 'utilities']
      };
      
      const patterns = fundingNeedPatterns[fundingNeed] || [];
      if (patterns.length === 0) return true; // If funding need is 'other', don't restrict
      
      // Search in categories, eligibility, description, title, and content
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Institution Type matching with expanded patterns
     */
    matchesInstitutionType(grant, institutionType) {
      if (!grant || !institutionType) return false;
      
      const institutionTypePatterns = {
        'education': ['school', 'university', 'college', 'education', 'academic institution', 'educational', 'academy', 'institute', 'campus', 'learning center'],
        'research': ['research', 'academic', 'study', 'research institution', 'laboratory', 'research center', 'institute', 'think tank', 'scientific'],
        'healthcare': ['healthcare', 'hospital', 'medical', 'health', 'clinic', 'health center', 'medical facility', 'care center', 'treatment center'],
        'government': ['government', 'public sector', 'municipal', 'state', 'federal', 'agency', 'department', 'authority', 'administration', 'office'],
        'cultural': ['cultural', 'museum', 'library', 'art center', 'historical society', 'heritage', 'theater', 'gallery', 'cultural center', 'archive']
      };
      
      const patterns = institutionTypePatterns[institutionType] || [];
      if (patterns.length === 0) return false;
      
      // Search in categories, eligibility, description, title, and content
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Tax Status matching
     */
    matchesTaxStatus(grant, taxStatus) {
      if (!grant || !taxStatus) return false;
      
      const taxStatusPatterns = {
        'public': ['public entity', 'government entity', 'public institution', 'state entity', 'federal entity', 'municipal', 'governmental', 'state'],
        'private_nonprofit': ['private nonprofit', '501(c)(3)', '501c3', 'nonprofit', 'non-profit', 'tax-exempt', 'charitable'],
        'private_forprofit': ['for-profit', 'forprofit', 'private company', 'business', 'corporation', 'llc', 'inc', 'for profit', 'commercial'],
        'tribal': ['tribal', 'tribe', 'native american', 'indigenous', 'tribal organization', 'tribal government', 'indian'],
        'other_tax': ['other tax status', 'fiscal sponsor', 'cooperative', 'benefit corporation', 'social enterprise']
      };
      
      const patterns = taxStatusPatterns[taxStatus] || [];
      if (patterns.length === 0) return true; // If tax status is 'other', don't restrict
      
      // Search in eligibility, description, title, and content
      const searchText = [
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Funding Purpose matching with expanded patterns for better results
     */
    matchesFundingPurpose(grant, purpose) {
      if (!grant || !purpose) return false;
      
      const fundingPurposePatterns = {
        // Business expansion
        'expansion': ['expansion', 'business expansion', 'growth', 'scaling', 'market expansion', 'growing', 'enlarge', 'extend'],
        
        // Equipment and technology
        'equipment': ['equipment', 'machinery', 'tools', 'technology acquisition', 'hardware', 'gear', 'apparatus', 'devices'],
        
        // Research and development
        'research': ['research & development', 'r&d', 'research project', 'research funding', 'study', 'investigation', 'product development'],
        
        // Workforce and hiring
        'hiring': ['hiring', 'workforce', 'staff', 'employees', 'job creation', 'employment', 'personnel', 'human resources', 'team'],
        
        // Marketing and sales
        'marketing': ['marketing', 'sales', 'advertising', 'promotion', 'market development', 'outreach', 'publicity', 'brand', 'customer acquisition'],
        
        // Technology adoption
        'technology': ['technology', 'digital transformation', 'software', 'it infrastructure', 'digital', 'tech', 'automation', 'computerization'],
        
        // Program development
        'program': ['program development', 'program expansion', 'new program', 'service delivery', 'initiative', 'project'],
        
        // Capacity building
        'capacity': ['capacity building', 'organizational development', 'staff development', 'capability', 'infrastructure', 'strengthening'],
        
        // Capital expenses
        'capital': ['capital expenses', 'building', 'renovation', 'construction', 'facility', 'infrastructure', 'physical assets'],
        
        // Operating support
        'operating': ['operating support', 'general operating', 'core support', 'unrestricted funding', 'overhead', 'administrative'],
        
        // Technical assistance
        'technical': ['technical assistance', 'consulting', 'expert support', 'professional services', 'advisory', 'guidance', 'expertise'],
        
        // Facilities and infrastructure
        'facilities': ['facilities', 'building', 'space', 'venue', 'real estate', 'property', 'premises', 'location', 'site'],
        
        // Programs and services
        'programs': ['programs', 'services', 'initiatives', 'activities', 'offerings', 'projects', 'interventions'],
        
        // Community outreach
        'community': ['community outreach', 'engagement', 'public programs', 'community services', 'public engagement', 'civic']
      };
      
      // Handle if purpose is a string or array
      let patterns = [];
      
      if (typeof purpose === 'string') {
        patterns = fundingPurposePatterns[purpose] || [];
      } else if (Array.isArray(purpose)) {
        // Combine patterns for all selected purposes
        purpose.forEach(p => {
          if (fundingPurposePatterns[p]) {
            patterns = patterns.concat(fundingPurposePatterns[p]);
          }
        });
      }
      
      if (patterns.length === 0) return true; // If no valid patterns, don't restrict
      
      // Search in categories, eligibility, description, title, and content
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      return patterns.some(pattern => searchText.includes(pattern));
    },
    
    /**
     * Generic field matching for any field not specifically handled
     */
    matchesGenericField(grant, field, value) {
      if (!grant || !value) return false;
      
      // Simple text matching in grant properties
      const searchText = [
        (Array.isArray(grant.categories) ? grant.categories.join(' ') : ''),
        grant.eligibility || '',
        grant.description || '',
        grant.title || '',
        field in grant ? grant[field] : '',
        grant.meta_combined || '',
        grant.content || ''
      ].join(' ').toLowerCase();
      
      // If value is array, check if any value matches
      if (Array.isArray(value)) {
        return value.some(v => searchText.includes(v.toLowerCase()));
      }
      
      // If value is string, check if it matches
      return searchText.includes(value.toLowerCase());
    },
    
    /**
     * Get friendly field name for display
     */
    getFieldDisplayName(field) {
      const fieldNames = {
        'business_type': 'Business Type',
        'industry': 'Industry',
        'years_in_operation': 'Years in Operation',
        'location': 'Location',
        'owner_demographics': 'Owner Demographics',
        'annual_revenue': 'Annual Revenue',
        'funding_purpose': 'Funding Purpose',
        'nonprofit_type': 'Nonprofit Type',
        'focus_area': 'Focus Area',
        'org_demographics': 'Organization Demographics',
        'annual_budget': 'Annual Budget',
        'grant_purpose': 'Grant Purpose',
        'individual_type': 'Individual Category',
        'individual_demographics': 'Demographics',
        'funding_need': 'Funding Need',
        'amount_needed': 'Amount Needed',
        'institution_type': 'Institution Type',
        'tax_status': 'Tax Status',
        'entity_type': 'Entity Type'
      };
      
      return fieldNames[field] || field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    },
    
    // GRANT RENDERING FUNCTIONS
    
    /**
     * Render grants in the UI with categorization by match quality
     * Enhanced with premium teaser section
     */
    renderGrantMatches() {
      const matchesList = document.getElementById('matches-list');
      const matchesCount = document.getElementById('matches-count');
      const noMatches = document.getElementById('no-matches');
      const premiumSection = document.getElementById('premium-section');
      
      if (!matchesList) return;
      
      // Clear any existing grant cards
      matchesList.innerHTML = '';
      
      // Update the match count - show total including premium count in admin mode
      if (matchesCount) {
        matchesCount.textContent = this.isAdminMode ? 
          this.grants.length : 
          (this.grants.length + this.premiumGrantCount);
      }
      
      // Handle no matches case with improved UI
      if (this.grants.length === 0) {
        if (noMatches) {
          noMatches.classList.remove('hidden');
        }
        
        // Hide premium section if no matches
        if (premiumSection) {
          premiumSection.style.display = 'none';
        }
        
        return;
      } else {
        if (noMatches) {
          noMatches.classList.add('hidden');
        }
        
        // Show premium section if we have both matches and premium grants
        if (premiumSection && this.premiumGrantCount > 0) {
          premiumSection.style.display = 'block';
        } else if (premiumSection) {
          premiumSection.style.display = 'none';
        }
      }
      
      // Group grants by match quality
      const highMatches = this.grants.filter(g => g.match_score >= 85);
      const mediumMatches = this.grants.filter(g => g.match_score >= 70 && g.match_score < 85);
      const lowMatches = this.grants.filter(g => g.match_score < 70);
      
      // Render high matches first (if any)
      if (highMatches.length > 0) {
        const highMatchHeader = document.createElement('div');
        highMatchHeader.className = 'eligibility-checker__match-section-header';
        highMatchHeader.innerHTML = `
          <h3>Best Matches (${highMatches.length})</h3>
          <p>These grants closely match your specific criteria</p>
        `;
        matchesList.appendChild(highMatchHeader);
        
        highMatches.forEach(grant => {
          const grantElement = this.createGrantCard(grant);
          matchesList.appendChild(grantElement);
        });
      }
      
      // Render medium matches next (if any)
      if (mediumMatches.length > 0) {
        const mediumMatchHeader = document.createElement('div');
        mediumMatchHeader.className = 'eligibility-checker__match-section-header';
        mediumMatchHeader.innerHTML = `
          <h3>Good Matches (${mediumMatches.length})</h3>
          <p>These grants partially match your criteria</p>
        `;
        matchesList.appendChild(mediumMatchHeader);
        
        mediumMatches.forEach(grant => {
          const grantElement = this.createGrantCard(grant);
          matchesList.appendChild(grantElement);
        });
      }
      
      // Render low matches last (if any)
      if (lowMatches.length > 0) {
        const lowMatchHeader = document.createElement('div');
        lowMatchHeader.className = 'eligibility-checker__match-section-header';
        lowMatchHeader.innerHTML = `
          <h3>Other Opportunities (${lowMatches.length})</h3>
          <p>These grants may require review for eligibility</p>
        `;
        matchesList.appendChild(lowMatchHeader);
        
        lowMatches.forEach(grant => {
          const grantElement = this.createGrantCard(grant);
          matchesList.appendChild(grantElement);
        });
      }
      
      // Add event listeners to grant cards
      this.setupGrantCardEvents();
    },
    
    /**
     * Create a single grant card with improved match information
     * Enhanced with priority match indicators, deadline badges, and match score styling
     */
    createGrantCard(grant) {
      const card = document.createElement('div');
      card.className = `eligibility-checker__match-card ${grant.priority_match ? 'eligibility-checker__match-card--priority' : ''}`;
      card.setAttribute('data-grant-id', grant.id);
      
      // Format and classify deadline for display
      let deadlineFormatted = grant.deadline;
      let deadlineClass = '';
      let deadlineBadge = '';
      
      if (deadlineFormatted !== 'Ongoing') {
        // Check if there are days remaining
        try {
          const deadlineDate = new Date(grant.deadline);
          const today = new Date();
          const diffTime = deadlineDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays > 30) {
            // Regular deadline
            deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
          } else if (diffDays > 14) {
            // Approaching deadline
            deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
            deadlineClass = 'eligibility-checker__deadline-urgent';
            deadlineBadge = `<div class="eligibility-checker__deadline-badge eligibility-checker__deadline-badge--soon">
                              <i class="fas fa-clock"></i> Due Soon
                             </div>`;
          } else if (diffDays > 0) {
            // Urgent deadline
            deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
            deadlineClass = 'eligibility-checker__deadline-critical';
            deadlineBadge = `<div class="eligibility-checker__deadline-badge eligibility-checker__deadline-badge--urgent">
                              <i class="fas fa-exclamation-circle"></i> Urgent
                             </div>`;
          } else if (diffDays === 0) {
            // Due today
            deadlineFormatted = `${grant.deadline} (Today)`;
            deadlineClass = 'eligibility-checker__deadline-critical';
            deadlineBadge = `<div class="eligibility-checker__deadline-badge eligibility-checker__deadline-badge--urgent">
                              <i class="fas fa-exclamation-circle"></i> Due Today
                             </div>`;
          } else {
            // Expired
            deadlineFormatted = `${grant.deadline} (Expired)`;
            deadlineClass = 'eligibility-checker__deadline-expired';
          }
        } catch (e) {
          // If date parsing fails, just use the original deadline
          console.warn('Could not parse deadline:', e);
        }
      } else {
        // Ongoing badge
        deadlineBadge = `<div class="eligibility-checker__deadline-badge eligibility-checker__deadline-badge--ongoing">
                          <i class="fas fa-sync-alt"></i> Ongoing
                         </div>`;
      }
      
      // Determine score badge class
      let scoreClass = '';
      if (grant.match_score >= 90) {
        scoreClass = 'eligibility-checker__score-excellent';
      } else if (grant.match_score >= 80) {
        scoreClass = 'eligibility-checker__score-high';
      } else if (grant.match_score >= 70) {
        scoreClass = 'eligibility-checker__score-medium';
      } else {
        scoreClass = 'eligibility-checker__score-low';
      }
      
      // Add priority match badge if applicable
      const priorityBadge = grant.priority_match ? 
        `<div class="eligibility-checker__priority-badge">
          <i class="fas fa-star"></i> Top Match
         </div>` : '';
      
      // Prepare tags HTML - include both categories and match reasons
      const relevantCategories = this.getRelevantCategories(grant.categories);
      const tagsHTML = relevantCategories
        .map(tag => `<span class="eligibility-checker__match-tag">${tag}</span>`)
        .join('');
      
      // Show top 2 match reasons as match tags
      const matchTagsHTML = grant.match_reasons && grant.match_reasons.length > 0 
        ? grant.match_reasons.slice(0, 2)
            .map(reason => `<span class="eligibility-checker__match-match-tag"><i class="fas fa-check-circle"></i>${reason}</span>`)
            .join('')
        : '';
      
      // Format locations for display
      const locationsDisplay = Array.isArray(grant.locations) && grant.locations.length > 0 
        ? grant.locations.join(', ') 
        : (grant.location || 'Multiple Locations');
      
      // Fill card with grant data
      card.innerHTML = `
        ${priorityBadge}
        ${deadlineBadge}
        
        <div class="eligibility-checker__match-header">
          <h3 class="eligibility-checker__match-title">${grant.title}</h3>
          <span class="eligibility-checker__match-score ${scoreClass}"><i class="fas fa-percentage"></i> ${grant.match_score}%</span>
        </div>
        
        <div class="eligibility-checker__match-content">
          <p class="eligibility-checker__match-description">${grant.description}</p>
          
          <div class="eligibility-checker__match-meta">
            <div class="eligibility-checker__meta-item">
              <i class="fas fa-dollar-sign"></i> ${grant.amount}
            </div>
            
            <div class="eligibility-checker__meta-item">
              <i class="fas fa-calendar-alt"></i> <span class="${deadlineClass}">${deadlineFormatted}</span>
            </div>
            
            <div class="eligibility-checker__meta-item">
              <i class="fas fa-map-marker-alt"></i> ${locationsDisplay}
            </div>
          </div>
          
          <div class="eligibility-checker__match-tags">
            ${matchTagsHTML}
            ${tagsHTML}
          </div>
        </div>
        
        <div class="eligibility-checker__match-footer">
          <button class="eligibility-checker__match-details" data-grant-id="${grant.id}">View Details <i class="fas fa-info-circle"></i></button>
          <a href="${grant.permalink}" class="eligibility-checker__apply-button">Apply <i class="fas fa-arrow-right"></i></a>
        </div>
      `;
      
      return card;
    },
    
    /**
     * Get the most relevant categories for display (limit to 3)
     * Enhanced to prioritize categories matching user criteria
     */
    getRelevantCategories(categories) {
      if (!categories || categories.length === 0) return [];
      
      // Filter categories based on entity type to show the most relevant ones
      const entityTypeKeywords = {
        'for_profit_business': ['business', 'for-profit', 'startup', 'entrepreneur', 'small business'],
        'nonprofit': ['non-profit', 'nonprofit', 'community', '501(c)(3)', 'charity'],
        'individual': ['individual', 'artist', 'student', 'researcher', 'personal'],
        'institution': ['institution', 'education', 'research', 'organization', 'government']
      };
      
      // Demographics keywords to prioritize based on user selections
      let demographicsKeywords = [];
      if (this.entityType === 'for_profit_business' && this.entityDetails.owner_demographics) {
        demographicsKeywords = this.entityDetails.owner_demographics.map(d => d.replace('_owned', '').replace('_', ' '));
      } else if (this.entityType === 'individual' && this.entityDetails.individual_demographics) {
        demographicsKeywords = this.entityDetails.individual_demographics.map(d => d.replace('_', ' '));
      }
      
      // User-provided keywords for additional relevance
      const userKeywords = this.entityDetails.keywords || [];
      
      // First, prioritize categories that match demographics if applicable
      const demographicMatches = categories.filter(cat => 
        demographicsKeywords.some(keyword => cat.toLowerCase().includes(keyword.toLowerCase()))
      );
      
      // Then, prioritize categories that match the entity type
      const keywords = entityTypeKeywords[this.entityType] || [];
      const entityTypeMatches = categories.filter(cat => 
        keywords.some(keyword => cat.toLowerCase().includes(keyword.toLowerCase())) &&
        !demographicMatches.includes(cat) // Don't include items already in demographics matches
      );
      
      // Then, prioritize categories that match user keywords
      const keywordMatches = categories.filter(cat => 
        userKeywords.some(keyword => cat.toLowerCase().includes(keyword.toLowerCase())) &&
        !demographicMatches.includes(cat) && // Don't include items already in other matches
        !entityTypeMatches.includes(cat)
      );
      
      // Combine the prioritized categories
      let prioritizedCategories = [
        ...demographicMatches, 
        ...entityTypeMatches,
        ...keywordMatches
      ];
      
      // If we have too many, limit to 3, otherwise add other categories until we have 3
      if (prioritizedCategories.length > 3) {
        return prioritizedCategories.slice(0, 3);
      } else {
        // Add other categories that aren't already included
        const remainingCategories = categories.filter(
          cat => !prioritizedCategories.includes(cat)
        );
        
        return [...prioritizedCategories, ...remainingCategories].slice(0, 3);
      }
    },
    
    /**
 * Setup event listeners for grant cards - FIXED VERSION
 */
setupGrantCardEvents() {
  // Details button click event
  const detailsButtons = document.querySelectorAll('.eligibility-checker__match-details');
  
  // Remove previous event listeners (to prevent duplicates)
  detailsButtons.forEach(button => {
    // Use cloneNode to remove existing event listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    // Add new event listener
    newButton.addEventListener('click', (e) => {
      e.preventDefault(); // Prevent any default behavior
      const grantId = newButton.getAttribute('data-grant-id');
      const grant = this.grants.find(g => g.id.toString() === grantId);
      
      if (grant) {
        this.showGrantDetails(grant);
      } else {
        console.error('Grant not found with ID:', grantId);
      }
    });
  });
  
  // Also check if we need to add event listeners to the modal close buttons again
  const modalClose = document.getElementById('modal-close');
  const modalBack = document.getElementById('modal-back');
  
  if (modalClose) {
    const newModalClose = modalClose.cloneNode(true);
    modalClose.parentNode.replaceChild(newModalClose, modalClose);
    newModalClose.addEventListener('click', () => {
      document.getElementById('match-modal').classList.remove('active');
    });
  }
  
  if (modalBack) {
    const newModalBack = modalBack.cloneNode(true);
    modalBack.parentNode.replaceChild(newModalBack, modalBack);
    newModalBack.addEventListener('click', () => {
      document.getElementById('match-modal').classList.remove('active');
    });
  }
},
    
    showGrantDetails(grant) {
  console.log('Showing grant details:', grant); // Debug log
  const modal = document.getElementById('match-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalDescription = document.getElementById('modal-description');
  const modalMeta = document.getElementById('modal-meta');
  const modalEligibility = document.getElementById('modal-eligibility');
  const modalMatchList = document.getElementById('modal-match-list');
  
  if (!modal || !modalTitle || !modalDescription || !modalMeta || !modalEligibility || !modalMatchList) {
    console.error('One or more modal elements not found');
    return;
  }
  
  // Set modal content
  modalTitle.textContent = grant.title;
  modalDescription.textContent = grant.description;
      
      // Format deadline for display with same logic as card
      let deadlineFormatted = grant.deadline;
      let deadlineClass = '';
      
      if (deadlineFormatted !== 'Ongoing') {
        try {
          const deadlineDate = new Date(grant.deadline);
          const today = new Date();
          const diffTime = deadlineDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays > 30) {
            deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
          } else if (diffDays > 14) {
            deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
            deadlineClass = 'eligibility-checker__deadline-urgent';
          } else if (diffDays > 0) {
            deadlineFormatted = `${grant.deadline} (${diffDays} days left)`;
            deadlineClass = 'eligibility-checker__deadline-critical';
          } else if (diffDays === 0) {
            deadlineFormatted = `${grant.deadline} (Today)`;
            deadlineClass = 'eligibility-checker__deadline-critical';
          } else {
            deadlineFormatted = `${grant.deadline} (Expired)`;
            deadlineClass = 'eligibility-checker__deadline-expired';
          }
        } catch (e) {
          console.warn('Could not parse deadline:', e);
        }
      }
      
      // Format locations for display
      const locationsDisplay = Array.isArray(grant.locations) && grant.locations.length > 0 
        ? grant.locations.join(', ') 
        : (grant.location || 'Multiple Locations');
      
      // Set meta information with enhanced styling
      modalMeta.innerHTML = `
        <div class="eligibility-checker__meta-item">
          <i class="fas fa-dollar-sign"></i> <strong>Amount:</strong> ${grant.amount}
        </div>
        
        <div class="eligibility-checker__meta-item">
          <i class="fas fa-calendar-alt"></i> <strong>Deadline:</strong> <span class="${deadlineClass}">${deadlineFormatted}</span>
        </div>
        
        <div class="eligibility-checker__meta-item">
          <i class="fas fa-tag"></i> <strong>Type:</strong> ${grant.funding_type || 'Grant'}
        </div>
        
        <div class="eligibility-checker__meta-item">
          <i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> ${locationsDisplay}
        </div>
        
        <div class="eligibility-checker__meta-item">
          <i class="fas fa-percentage"></i> <strong>Match Score:</strong> ${grant.match_score}%
        </div>
        
        <div class="eligibility-checker__meta-item">
          <i class="fas fa-info-circle"></i> <strong>Compatibility:</strong> ${this.getCompatibilityMessage(grant.match_score)}
        </div>
      `;
      
      // Set match criteria with enhanced visual grouping
      if (grant.match_reasons && grant.match_reasons.length > 0) {
        // Group match reasons by priority
        const highPriorityReasons = [];
        const otherReasons = [];
        
        grant.match_reasons.forEach(reason => {
          // Check if reason contains high priority field terms
          const isHighPriority = this.highPriorityFields.some(field => {
            const fieldName = this.getFieldDisplayName(field);
            return reason.includes(fieldName);
          });
          
          if (isHighPriority) {
            highPriorityReasons.push(reason);
          } else {
            otherReasons.push(reason);
          }
        });
        
        // Build HTML with visual distinction between high priority matches
        const highPriorityHTML = highPriorityReasons.map(reason => 
          `<div class="eligibility-checker__match-criteria-item eligibility-checker__priority-match">
            <i class="fas fa-star"></i>${reason}
           </div>`
        ).join('');
        
        const otherReasonsHTML = otherReasons.map(reason => 
          `<div class="eligibility-checker__match-criteria-item">
            <i class="fas fa-check-circle"></i>${reason}
           </div>`
        ).join('');
        
        modalMatchList.innerHTML = highPriorityHTML + otherReasonsHTML;
        
        // Show the match criteria section
        document.getElementById('modal-match-criteria').style.display = 'block';
      } else {
        // Hide the match criteria section if no reasons
        document.getElementById('modal-match-criteria').style.display = 'none';
      }
      
      // Set eligibility criteria with better structure
      let eligibilityHTML = '';
      if (grant.eligibility) {
        // If grant has specific eligibility criteria defined
        const eligibilityCriteria = grant.eligibility.split('\n').filter(line => line.trim() !== '');
        
        if (eligibilityCriteria.length > 0) {
          eligibilityHTML = eligibilityCriteria.map(criteria => 
            `<li class="eligibility-checker__eligibility-item"><i class="fas fa-check-circle"></i> ${criteria.trim()}</li>`
          ).join('');
        } else {
          // Try splitting by periods for sentences if no newlines
          const sentenceEligibility = grant.eligibility.split('.').filter(part => part.trim() !== '');
          if (sentenceEligibility.length > 1) {
            eligibilityHTML = sentenceEligibility.map(criteria => 
              `<li class="eligibility-checker__eligibility-item"><i class="fas fa-check-circle"></i> ${criteria.trim()}.</li>`
            ).join('');
          } else {
            // Try splitting by commas if no periods
            const commaEligibility = grant.eligibility.split(',').filter(part => part.trim() !== '');
            eligibilityHTML = commaEligibility.map(criteria => 
              `<li class="eligibility-checker__eligibility-item"><i class="fas fa-check-circle"></i> ${criteria.trim()}</li>`
            ).join('');
          }
        }
      }
      
      // If no specific eligibility criteria is available or it's empty
      if (!eligibilityHTML) {
        // Add a default message
        eligibilityHTML = `<li class="eligibility-checker__eligibility-item"><i class="fas fa-info-circle"></i> Detailed eligibility criteria available on the grant application page.</li>`;
        
        // Add entity-type specific generic criteria based on categories
        const entityTypeCriteria = this.getEntityTypeEligibilityCriteria(grant.categories);
        if (entityTypeCriteria.length > 0) {
          eligibilityHTML += entityTypeCriteria.map(criteria => 
            `<li class="eligibility-checker__eligibility-item"><i class="fas fa-check-circle"></i> ${criteria}</li>`
          ).join('');
        }
      }
      
      modalEligibility.innerHTML = eligibilityHTML;
      
      // Set Apply button link
      const modalApply = document.getElementById('modal-apply');
      if (modalApply) {
        modalApply.href = grant.permalink;
      }
      
      // Show the modal
      modal.classList.add('active');
    },
    
    /**
     * Get compatibility message based on match score
     */
    getCompatibilityMessage(score) {
      if (score >= 90) {
        return 'Excellent match for your criteria';
      } else if (score >= 80) {
        return 'Strong match for your profile';
      } else if (score >= 70) {
        return 'Good match worth exploring';
      } else if (score >= 60) {
        return 'Partial match - review eligibility';
      } else {
        return 'May require further eligibility review';
      }
    },
    
    /**
     * Generate generic eligibility criteria based on grant categories
     * Enhanced with more detailed entity-specific guidance
     */
    getEntityTypeEligibilityCriteria(categories) {
      let criteria = [];
      
      // Convert categories to lowercase for easier matching
      const lowerCategories = categories ? categories.map(cat => cat.toLowerCase()) : [];
      
      // Add entity type specific criteria
      switch (this.entityType) {
        case 'for_profit_business':
          criteria.push('Must be a registered for-profit business');
          break;
        case 'nonprofit':
          criteria.push('Must be a registered nonprofit organization');
          break;
        case 'individual':
          criteria.push('Open to individuals (not requiring business or nonprofit status)');
          break;
        case 'institution':
          criteria.push('Must be an established institution or organization');
          break;
      }
      
      // Check for common criteria based on category patterns
      if (lowerCategories.some(cat => cat.includes('for-profit') || cat.includes('business'))) {
        if (!criteria.includes('Must be a registered for-profit business')) {
          criteria.push('Must be a registered for-profit business');
        }
        
        if (lowerCategories.some(cat => cat.includes('small business'))) {
          criteria.push('Typically for businesses with fewer than 500 employees');
        }
        
        if (lowerCategories.some(cat => cat.includes('startup'))) {
          criteria.push('May have specific requirements for business age (typically under 5 years)');
        }
      }
      
      if (lowerCategories.some(cat => cat.includes('non-profit') || cat.includes('nonprofit'))) {
        if (!criteria.includes('Must be a registered nonprofit organization')) {
          criteria.push('Must be a registered nonprofit organization');
        }
        
        if (lowerCategories.some(cat => cat.includes('501c3') || cat.includes('501(c)(3)'))) {
          criteria.push('Requires 501(c)(3) tax status');
        } else {
          criteria.push('May require 501(c)(3) or equivalent tax status');
        }
      }
      
      if (lowerCategories.some(cat => cat.includes('individual'))) {
        if (!criteria.includes('Open to individuals (not requiring business or nonprofit status)')) {
          criteria.push('Open to individuals (not requiring business or nonprofit status)');
        }
      }
      
      if (lowerCategories.some(cat => cat.includes('education') || cat.includes('educational'))) {
        criteria.push('Projects or initiatives must have an educational component');
      }
      
      if (lowerCategories.some(cat => cat.includes('research'))) {
        criteria.push('Must involve research activities or outcomes');
      }
      
      // Demographic-specific criteria
      if (lowerCategories.some(cat => cat.includes('women'))) {
        criteria.push('Must be majority women-owned or women-led');
      }
      
      if (lowerCategories.some(cat => cat.includes('minority') || cat.includes('bipoc'))) {
        criteria.push('Must be majority minority-owned or minority-led');
      }
      
      if (lowerCategories.some(cat => cat.includes('veteran'))) {
        criteria.push('Must be veteran-owned or veteran-led');
      }
      
      if (lowerCategories.some(cat => cat.includes('disability') || cat.includes('special persons'))) {
        criteria.push('Must be owned/led by or serving persons with disabilities');
      }
      
      if (lowerCategories.some(cat => cat.includes('lgbtq'))) {
        criteria.push('Must be LGBTQIA+-owned/led or serving the LGBTQIA+ community');
      }
      
      if (lowerCategories.some(cat => cat.includes('rural'))) {
        criteria.push('Must be located in or serving rural communities');
      }
      
      return criteria;
    },
    
    /**
     * Filter grants based on selected filter
     */
    filterGrants(filterType) {
      if (!this.grants || this.grants.length === 0) {
        // Show no matches experience if there are no grants to filter
        this.renderGrantMatches();
        return;
      }
      
      const matchesList = document.getElementById('matches-list');
      if (!matchesList) return;
      
      // Clear current list
      matchesList.innerHTML = '';
      
      let filteredGrants = [];
      
      switch (filterType) {
        case 'high-match':
          // Filter grants with match score >= 85%
          filteredGrants = this.grants.filter(grant => grant.match_score >= 85);
          
          // Render with single section header
          if (filteredGrants.length > 0) {
            const highMatchHeader = document.createElement('div');
            highMatchHeader.className = 'eligibility-checker__match-section-header';
            highMatchHeader.innerHTML = `
              <h3>High Match Grants (${filteredGrants.length})</h3>
              <p>These grants have the highest compatibility with your profile</p>
            `;
            matchesList.appendChild(highMatchHeader);
            
            filteredGrants.forEach(grant => {
              const grantCard = this.createGrantCard(grant);
              matchesList.appendChild(grantCard);
            });
          } else {
            // Show no high matches message
            matchesList.innerHTML = `
              <div class="eligibility-checker__no-matches-container">
                <h3>No High Matches Found</h3>
                <p>Try adjusting your criteria or viewing all matches to see additional opportunities.</p>
                <button id="view-all-matches" class="eligibility-checker__secondary-button">
                  <i class="fas fa-list"></i> View All Matches
                </button>
              </div>
            `;
            
            // Add event listener for view all matches button
            const viewAllBtn = document.getElementById('view-all-matches');
            if (viewAllBtn) {
              viewAllBtn.addEventListener('click', () => {
                const allMatchesBtn = document.querySelector('[data-filter="all"]');
                if (allMatchesBtn) {
                  allMatchesBtn.click();
                } else {
                  this.renderGrantMatches();
                }
              });
            }
          }
          break;
          
        case 'deadline':
          // Enhanced deadline sorting with grouping
          this.renderDeadlineFilteredGrants(matchesList);
          break;
          
        case 'amount':
          // Enhanced amount filtering with better grouping
          this.renderAmountFilteredGrants(matchesList);
          break;
          
        default:
          // Default to all grants sorted by match score and grouped
          this.renderGrantMatches();
          break;
      }
      
      // Set up event listeners for the newly created cards
      this.setupGrantCardEvents();
    },
    
    /**
     * Render grants filtered by deadline with enhanced grouping
     */
    renderDeadlineFilteredGrants(matchesList) {
      const currentDate = new Date();
      
      // Group by deadline proximity with more granular categories
      const urgentDeadlines = []; // Within 14 days
      const soonDeadlines = []; // 15-30 days
      const upcomingDeadlines = []; // 31-90 days
      const futureDeadlines = []; // 91+ days
      const ongoingDeadlines = []; // Ongoing
      const unknownDeadlines = []; // Could not parse
      
      this.grants.forEach(grant => {
        if (grant.deadline === 'Ongoing') {
          ongoingDeadlines.push(grant);
        } else {
          try {
            const deadlineDate = new Date(grant.deadline);
            if (isNaN(deadlineDate.getTime())) {
              unknownDeadlines.push(grant);
            } else {
              const daysDiff = Math.ceil((deadlineDate - currentDate) / (1000 * 60 * 60 * 24));
              
              if (daysDiff <= 0) {
                // Skip expired grants
              } else if (daysDiff <= 14) {
                urgentDeadlines.push(grant);
              } else if (daysDiff <= 30) {
                soonDeadlines.push(grant);
              } else if (daysDiff <= 90) {
                upcomingDeadlines.push(grant);
              } else {
                futureDeadlines.push(grant);
              }
            }
          } catch (e) {
            unknownDeadlines.push(grant);
          }
        }
      });
      
      // Render urgent deadlines
      if (urgentDeadlines.length > 0) {
        const urgentHeader = document.createElement('div');
        urgentHeader.className = 'eligibility-checker__match-section-header';
        urgentHeader.innerHTML = `
          <h3>Urgent Deadlines (${urgentDeadlines.length})</h3>
          <p>Grants closing within the next 14 days - apply soon!</p>
        `;
        matchesList.appendChild(urgentHeader);
        
        // Sort by closest deadline first
        urgentDeadlines.sort((a, b) => {
          return new Date(a.deadline) - new Date(b.deadline);
        });
        
        urgentDeadlines.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render soon deadlines
      if (soonDeadlines.length > 0) {
        const soonHeader = document.createElement('div');
        soonHeader.className = 'eligibility-checker__match-section-header';
        soonHeader.innerHTML = `
          <h3>Upcoming Deadlines (${soonDeadlines.length})</h3>
          <p>Grants closing within 15-30 days</p>
        `;
        matchesList.appendChild(soonHeader);
        
        // Sort by closest deadline first
        soonDeadlines.sort((a, b) => {
          return new Date(a.deadline) - new Date(b.deadline);
        });
        
        soonDeadlines.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render upcoming deadlines
      if (upcomingDeadlines.length > 0) {
        const upcomingHeader = document.createElement('div');
        upcomingHeader.className = 'eligibility-checker__match-section-header';
        upcomingHeader.innerHTML = `
          <h3>Future Deadlines (${upcomingDeadlines.length})</h3>
          <p>Grants closing in 1-3 months</p>
        `;
        matchesList.appendChild(upcomingHeader);
        
        // Sort by closest deadline first
        upcomingDeadlines.sort((a, b) => {
          return new Date(a.deadline) - new Date(b.deadline);
        });
        
        upcomingDeadlines.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render future deadlines
      if (futureDeadlines.length > 0) {
        const futureHeader = document.createElement('div');
        futureHeader.className = 'eligibility-checker__match-section-header';
        futureHeader.innerHTML = `
          <h3>Long-term Deadlines (${futureDeadlines.length})</h3>
          <p>Grants with deadlines more than 3 months away</p>
        `;
        matchesList.appendChild(futureHeader);
        
        // Sort by closest deadline first
        futureDeadlines.sort((a, b) => {
          return new Date(a.deadline) - new Date(b.deadline);
        });
        
        futureDeadlines.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render ongoing deadlines
      if (ongoingDeadlines.length > 0) {
        const ongoingHeader = document.createElement('div');
        ongoingHeader.className = 'eligibility-checker__match-section-header';
        ongoingHeader.innerHTML = `
          <h3>Ongoing Opportunities (${ongoingDeadlines.length})</h3>
          <p>Grants with rolling deadlines or continuous application periods</p>
        `;
        matchesList.appendChild(ongoingHeader);
        
        // Sort ongoing grants by match score instead of deadline
        ongoingDeadlines.sort((a, b) => b.match_score - a.match_score);
        
        ongoingDeadlines.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Show message if no grants in any deadline category
      if (urgentDeadlines.length === 0 && soonDeadlines.length === 0 && 
          upcomingDeadlines.length === 0 && futureDeadlines.length === 0 && 
          ongoingDeadlines.length === 0) {
        matchesList.innerHTML = `
          <div class="eligibility-checker__no-matches-container">
            <h3>No Deadline Information Available</h3>
            <p>The matching grants don't have deadline information that can be filtered.</p>
            <button id="view-all-matches-deadline" class="eligibility-checker__secondary-button">
              <i class="fas fa-list"></i> View All Matches
            </button>
          </div>
        `;
        
        // Add event listener for view all matches button
        const viewAllBtn = document.getElementById('view-all-matches-deadline');
        if (viewAllBtn) {
          viewAllBtn.addEventListener('click', () => {
            const allMatchesBtn = document.querySelector('[data-filter="all"]');
            if (allMatchesBtn) {
              allMatchesBtn.click();
            } else {
              this.renderGrantMatches();
            }
          });
        }
      }
    },
    
    /**
     * Render grants filtered by amount with improved amount detection
     */
    renderAmountFilteredGrants(matchesList) {
      // Helper function to extract amount values
      const extractHighestAmount = (amountStr) => {
        if (!amountStr) return 0;
        
        // Try to find dollar amounts with $ sign
        const matches = amountStr.match(/\$([0-9,]+)/g);
        if (!matches || matches.length === 0) {
          // Check for numeric values without $ sign
          const numericMatches = amountStr.match(/([0-9,]+)/g);
          if (!numericMatches || numericMatches.length === 0) {
            // Check for keywords like "million" or "thousand"
            if (amountStr.toLowerCase().includes('million')) {
              return 1000000;
            } else if (amountStr.toLowerCase().includes('thousand')) {
              return 1000;
            }
            return 0;
          }
          
          return Math.max(...numericMatches.map(m => parseInt(m.replace(/,/g, ''), 10) || 0));
        }
        
        return Math.max(...matches.map(m => parseInt(m.replace(/[\$,]/g, ''), 10) || 0));
      };
      
      // Enhanced grant grouping by amount with more granular categories
      const veryLargeGrants = []; // $250k+
      const largeGrants = []; // $100k-$250k
      const mediumLargeGrants = []; // $50k-$100k
      const mediumGrants = []; // $25k-$50k
      const smallMediumGrants = []; // $10k-$25k
      const smallGrants = []; // $5k-$10k
      const microGrants = []; // $1k-$5k
      const miniGrants = []; // Under $1k
      const unknownAmountGrants = []; // Varies/Unknown
      
      this.grants.forEach(grant => {
        const amount = grant.amount || '';
        
        if (amount.toLowerCase() === 'varies' || amount.toLowerCase() === 'unknown') {
          unknownAmountGrants.push(grant);
          return;
        }
        
        // Try to extract actual amount values
        const highestAmount = extractHighestAmount(amount);
        
        if (highestAmount >= 250000) {
          veryLargeGrants.push(grant);
        } else if (highestAmount >= 100000) {
          largeGrants.push(grant);
        } else if (highestAmount >= 50000) {
          mediumLargeGrants.push(grant);
        } else if (highestAmount >= 25000) {
          mediumGrants.push(grant);
        } else if (highestAmount >= 10000) {
          smallMediumGrants.push(grant);
        } else if (highestAmount >= 5000) {
          smallGrants.push(grant);
        } else if (highestAmount >= 1000) {
          microGrants.push(grant);
        } else if (highestAmount > 0) {
          miniGrants.push(grant);
        } else {
          // Check for keywords in amount string
          if (amount.toLowerCase().includes('million') || 
              amount.toLowerCase().includes('1m') || 
              amount.toLowerCase().includes('$1m')) {
            veryLargeGrants.push(grant);
          } else if (amount.toLowerCase().includes('large') || 
                    amount.toLowerCase().includes('100k') || 
                    amount.toLowerCase().includes('$100k')) {
            largeGrants.push(grant);
          } else if (amount.toLowerCase().includes('medium') || 
                    amount.toLowerCase().includes('50k') || 
                    amount.toLowerCase().includes('$50k')) {
            mediumLargeGrants.push(grant);
          } else if (amount.toLowerCase().includes('small') || 
                    amount.toLowerCase().includes('10k') || 
                    amount.toLowerCase().includes('$10k')) {
            smallMediumGrants.push(grant);
          } else if (amount.toLowerCase().includes('micro') || 
                    amount.toLowerCase().includes('1k') || 
                    amount.toLowerCase().includes('$1k')) {
            microGrants.push(grant);
          } else {
            unknownAmountGrants.push(grant);
          }
        }
      });
      
      // Sort all groups by match score
      [veryLargeGrants, largeGrants, mediumLargeGrants, mediumGrants, 
       smallMediumGrants, smallGrants, microGrants, miniGrants, unknownAmountGrants]
        .forEach(group => group.sort((a, b) => b.match_score - a.match_score));
      
      // Render very large grants
      if (veryLargeGrants.length > 0) {
        const veryLargeHeader = document.createElement('div');
        veryLargeHeader.className = 'eligibility-checker__match-section-header';
        veryLargeHeader.innerHTML = `
          <h3>Major Grants ($250,000+) (${veryLargeGrants.length})</h3>
          <p>Substantial funding opportunities with major potential impact</p>
        `;
        matchesList.appendChild(veryLargeHeader);
        
        veryLargeGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render large grants
      if (largeGrants.length > 0) {
        const largeHeader = document.createElement('div');
        largeHeader.className = 'eligibility-checker__match-section-header';
        largeHeader.innerHTML = `
          <h3>Large Grants ($100,000-$250,000) (${largeGrants.length})</h3>
          <p>Significant funding opportunities for substantial projects</p>
        `;
        matchesList.appendChild(largeHeader);
        
        largeGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render medium-large grants
      if (mediumLargeGrants.length > 0) {
        const mediumLargeHeader = document.createElement('div');
        mediumLargeHeader.className = 'eligibility-checker__match-section-header';
        mediumLargeHeader.innerHTML = `
          <h3>Medium-Large Grants ($50,000-$100,000) (${mediumLargeGrants.length})</h3>
          <p>Substantial funding for mid-sized projects and initiatives</p>
        `;
        matchesList.appendChild(mediumLargeHeader);
        
        mediumLargeGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render medium grants
      if (mediumGrants.length > 0) {
        const mediumHeader = document.createElement('div');
        mediumHeader.className = 'eligibility-checker__match-section-header';
        mediumHeader.innerHTML = `
          <h3>Medium Grants ($25,000-$50,000) (${mediumGrants.length})</h3>
          <p>Meaningful funding for established projects</p>
        `;
        matchesList.appendChild(mediumHeader);
        
        mediumGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render small-medium grants
      if (smallMediumGrants.length > 0) {
        const smallMediumHeader = document.createElement('div');
        smallMediumHeader.className = 'eligibility-checker__match-section-header';
        smallMediumHeader.innerHTML = `
          <h3>Small-Medium Grants ($10,000-$25,000) (${smallMediumGrants.length})</h3>
          <p>Practical funding for smaller projects and initiatives</p>
        `;
        matchesList.appendChild(smallMediumHeader);
        
        smallMediumGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render small grants
      if (smallGrants.length > 0) {
        const smallHeader = document.createElement('div');
        smallHeader.className = 'eligibility-checker__match-section-header';
        smallHeader.innerHTML = `
          <h3>Small Grants ($5,000-$10,000) (${smallGrants.length})</h3>
          <p>Accessible funding for small projects or startup initiatives</p>
        `;
        matchesList.appendChild(smallHeader);
        
        smallGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render micro grants
      if (microGrants.length > 0) {
        const microHeader = document.createElement('div');
        microHeader.className = 'eligibility-checker__match-section-header';
        microHeader.innerHTML = `
          <h3>Micro Grants ($1,000-$5,000) (${microGrants.length})</h3>
          <p>Targeted funding for smaller needs and projects</p>
        `;
        matchesList.appendChild(microHeader);
        
        microGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render mini grants
      if (miniGrants.length > 0) {
        const miniHeader = document.createElement('div');
        miniHeader.className = 'eligibility-checker__match-section-header';
        miniHeader.innerHTML = `
          <h3>Mini Grants (Under $1,000) (${miniGrants.length})</h3>
          <p>Small but meaningful support for specific needs</p>
        `;
        matchesList.appendChild(miniHeader);
        
        miniGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Render unknown amount grants
      if (unknownAmountGrants.length > 0) {
        const unknownHeader = document.createElement('div');
        unknownHeader.className = 'eligibility-checker__match-section-header';
        unknownHeader.innerHTML = `
          <h3>Variable Amount Grants (${unknownAmountGrants.length})</h3>
          <p>Grants with varying award amounts or unspecified funding</p>
        `;
        matchesList.appendChild(unknownHeader);
        
        unknownAmountGrants.forEach(grant => {
          const grantCard = this.createGrantCard(grant);
          matchesList.appendChild(grantCard);
        });
      }
      
      // Show message if no grants with amount info found
      const totalGrants = veryLargeGrants.length + largeGrants.length + mediumLargeGrants.length + 
                          mediumGrants.length + smallMediumGrants.length + smallGrants.length + 
                          microGrants.length + miniGrants.length + unknownAmountGrants.length;
      
      if (totalGrants === 0) {
        matchesList.innerHTML = `
          <div class="eligibility-checker__no-matches-container">
            <h3>No Amount Information Available</h3>
            <p>The matching grants don't have funding amount information that can be filtered.</p>
            <button id="view-all-matches-amount" class="eligibility-checker__secondary-button">
              <i class="fas fa-list"></i> View All Matches
            </button>
          </div>
        `;
        
        // Add event listener for view all matches button
        const viewAllBtn = document.getElementById('view-all-matches-amount');
        if (viewAllBtn) {
          viewAllBtn.addEventListener('click', () => {
            const allMatchesBtn = document.querySelector('[data-filter="all"]');
            if (allMatchesBtn) {
              allMatchesBtn.click();
            } else {
              this.renderGrantMatches();
            }
          });
        }
      }
    },
    
    /**
     * Move to a specific step
     */
    goToStep(step) {
      // Validate step number
      if (step < 1 || step > this.maxStep) return;
      
      // Hide all steps
      const steps = document.querySelectorAll('.eligibility-checker__step-content');
      steps.forEach(s => s.classList.remove('active'));
      
      // Show the selected step
      const currentStep = document.getElementById(`step${step}`);
      if (currentStep) {
        currentStep.classList.add('active');
      }
      
      // Show admin notice if in admin mode and on results step
      if (this.isAdminMode && step === 3) {
        const adminNotice = document.getElementById('admin-notice');
        if (adminNotice) {
          adminNotice.style.display = 'flex';
        }
      }
      
      // Update progress tracker
      this.currentStep = step;
      this.updateProgressBar();
      
      // Scroll to top of form
      const form = document.querySelector('.eligibility-checker__form');
      if (form) {
        form.scrollIntoView({ behavior: 'smooth' });
      }
    },
    
    /**
     * Update progress bar and step indicators
     */
    updateProgressBar() {
      // Update progress bar width
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) {
        const progress = ((this.currentStep - 1) / (this.maxStep - 1)) * 100;
        progressBar.style.width = `${progress}%`;
      }
      
      // Update step indicators
      const steps = document.querySelectorAll('.eligibility-checker__step');
      steps.forEach(step => {
        const stepNumber = parseInt(step.getAttribute('data-step'), 10);
        
        // Reset classes first
        step.classList.remove('active', 'completed');
        
        // Add appropriate class
        if (stepNumber === this.currentStep) {
          step.classList.add('active');
        } else if (stepNumber < this.currentStep) {
          step.classList.add('completed');
        }
      });
    }
  };

  // Initialize the eligibility checker when the DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    EligibilityChecker.init();
  });
  // Enhanced fix for grant modals not opening
document.addEventListener('click', function(event) {
  // Check if the clicked element is a details button or has a parent that is
  let targetButton = event.target.closest('.eligibility-checker__match-details');
  
  if (targetButton) {
    console.log('Details button clicked'); // Debug log
    
    const grantId = targetButton.getAttribute('data-grant-id');
    console.log('Grant ID:', grantId); // Debug log
    
    // Force-open the modal with direct DOM manipulation
    const modal = document.getElementById('match-modal');
    if (modal) {
      console.log('Modal found, activating directly'); // Debug log
      
      // Make sure modal is visible with both CSS and inline style
      modal.classList.add('active');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      
      // Stop propagation to prevent other handlers from interfering
      event.stopPropagation();
      event.preventDefault();
      
      // Find the grant and populate the modal
      const grant = window.grants && window.grants.find(g => g.id.toString() === grantId) || 
                   window.EligibilityChecker && window.EligibilityChecker.grants && 
                   window.EligibilityChecker.grants.find(g => g.id.toString() === grantId);
      
      if (grant) {
        console.log('Grant found, populating modal'); // Debug log
        
        // Set content
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        
        if (modalTitle) modalTitle.textContent = grant.title;
        if (modalDescription) modalDescription.textContent = grant.description;
      }
      
      return false;
    } else {
      console.error('Modal element not found in DOM');
    }
  }
  
  // Also handle modal close buttons with direct DOM manipulation
  if (event.target.closest('#modal-close') || event.target.closest('#modal-back')) {
    console.log('Close button clicked'); // Debug log
    
    const modal = document.getElementById('match-modal');
    if (modal) {
      modal.classList.remove('active');
      modal.style.display = 'none';
      modal.style.visibility = 'hidden';
      modal.style.opacity = '0';
      
      // Stop propagation to prevent other handlers from interfering
      event.stopPropagation();
      event.preventDefault();
      return false;
    }
  }
});

// Also check for global click outside of modal to close it
document.addEventListener('click', function(event) {
  const modal = document.getElementById('match-modal');
  if (!modal) return;
  
  const modalContent = modal.querySelector('.eligibility-checker__modal-content');
  if (!modalContent) return;
  
  // If click is outside of modal content but modal is active
  if (modal.classList.contains('active') && !modalContent.contains(event.target)) {
    // Make sure we're not clicking on a grant card button
    if (!event.target.closest('.eligibility-checker__match-details')) {
      modal.classList.remove('active');
      modal.style.display = 'none';
    }
  }
});

// Make the grant data globally accessible for debugging
if (window.EligibilityChecker && EligibilityChecker.grants) {
  window.grants = EligibilityChecker.grants;
}

// Check modal structure and CSS on page load
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('match-modal');
  if (!modal) {
    console.error('Modal element not found on page load');
  } else {
    console.log('Modal element found on page load');
    
    // Check CSS classes
    console.log('Modal CSS classes:', modal.className);
    
    // Add to page temporarily for testing
    document.body.appendChild(testButton);
  }
});
})();
</script>
</section>
